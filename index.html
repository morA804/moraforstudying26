<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="default">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Mora For Studying - منصة Mora للتعليم | تعلم بدون حدود</title>

    <!-- SEO Meta Tags - Arabic -->
    <meta name="description"
        content="منصة Mora للتعليم - منصة تعليمية عربية متكاملة تدعم التعلم بدون إنترنت. Mora For Studying - Complete Arabic educational platform with offline support." />
    <meta name="keywords"
        content="Mora, منصة Mora, Mora للتعليم, منصة تعليمية Mora, تعليم بدون إنترنت, منصة تعليمية عربية, Mora For Studying, Mora Education, Mora Learning Platform, Mora Offline Learning, Mora Study App" />
    <meta name="author" content="Mora For Studying" />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href="https://yoursite.com" />

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Mora For Studying - منصة تعليمية متكاملة" />
    <meta property="og:description" content="منصة Mora للتعليم - تعلم بدون حدود مع دعم كامل للتعلم بدون إنترنت" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://yoursite.com" />
    <meta property="og:image" content="https://i.postimg.cc/mgdFZ313/IMG-20250414-WA0047-1.jpg" />
    <meta property="og:locale" content="ar_AR" />
    <meta property="og:locale:alternate" content="en_US" />

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Mora For Studying - منصة تعليمية متكاملة" />
    <meta name="twitter:description" content="منصة Mora للتعليم - تعلم بدون حدود" />
    <meta name="twitter:image" content="https://i.postimg.cc/mgdFZ313/IMG-20250414-WA0047-1.jpg" />

    <!-- Performance & Security -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="theme-color" content="#0d0d1a" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <!-- Structured Data for SEO -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "EducationalOrganization",
      "name": "Mora For Studying",
      "alternateName": "Mora",
      "url": "https://yoursite.com",
      "description": "منصة تعليمية عربية متكاملة تدعم التعلم بدون إنترنت",
      "sameAs": [],
      "contactPoint": {
        "@type": "ContactPoint",
        "contactType": "Customer Support",
        "availableLanguage": ["Arabic", "English"]
      }
    }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />
    <script src="https://unpkg.com/phosphor-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/phosphor-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.globe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="manifest"
        href="data:application/json;base64,ewogICJuYW1lIjogIk1vcmEgRm9yIFN0dWR5aW5nIiwKICAic2hvcnRfbmFtZSI6ICJNb3JhIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwZDBkMWEiLAogICJ0aGVtZV9jb2xvciI6ICIjMGQwZDFhIiwKICAiaWNvbnMiOiBbXQp9" />
    <style id="theme-style-root">
        :root {
            --bg-color: #0d0d1a;
            --primary-glow: #00f5c3;
            --primary-glow-rgb: 0, 245, 195;
            --secondary-glow: #a78bfa;
            --secondary-glow-rgb: 167, 139, 250;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --glass-bg: rgba(15, 23, 42, 0.7);
            --glass-border: rgba(0, 245, 195, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.37);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            overflow: hidden;
            transition: background-color 0.5s ease;
            height: 100dvh;
            /* Standard dynamic viewport height */
            width: 100vw;
        }

        #app-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(at 20% 20%, var(--primary-glow) 0px, transparent 30%),
                radial-gradient(at 80% 80%, var(--secondary-glow) 0px, transparent 30%);
            animation: bg-pan 20s linear infinite alternate;
            opacity: 0.1;
            z-index: -1;
            will-change: transform;
        }

        @keyframes bg-pan {
            from {
                transform: scale(1) rotate(0deg);
            }

            to {
                transform: scale(1.2) rotate(45deg);
            }
        }

        @keyframes cinematic-enter {
            from {
                opacity: 0;
                transform: scale(1.1);
                filter: blur(8px);
            }

            to {
                opacity: 1;
                transform: scale(1);
                filter: blur(0);
            }
        }

        @keyframes page-enter {
            from {
                opacity: 0;
                transform: scale(0.98);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes glowing-logo-pulse {

            0%,
            100% {
                box-shadow: 0 0 25px var(--primary-glow), 0 0 50px var(--primary-glow);
            }

            50% {
                box-shadow: 0 0 35px var(--secondary-glow), 0 0 70px var(--secondary-glow);
            }
        }

        @keyframes scroll-text-rtl {
            from {
                transform: translateX(-100%);
            }

            to {
                transform: translateX(100%);
            }
        }

        @keyframes unlocked-3d-float {
            0% {
                transform: translateY(0) rotateY(0deg) scale(1);
                opacity: 0.8;
            }

            50% {
                transform: translateY(-5px) rotateY(180deg) scale(1.1);
                opacity: 1;
            }

            100% {
                transform: translateY(0) rotateY(360deg) scale(1);
                opacity: 0.8;
            }
        }

        @keyframes loading-bar {
            from {
                width: 0%;
            }

            to {
                width: 100%;
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 5px 10px rgba(255, 0, 0, 0);
            }
        }

        @keyframes icon-3d-float {
            0% {
                transform: translate(0, 0) rotateY(0deg) scale(1);
            }

            25% {
                transform: translate(5px, -5px) rotateY(15deg) scale(1.1);
            }

            50% {
                transform: translate(-5px, 0) rotateY(0deg) scale(1);
            }

            75% {
                transform: translate(0, 5px) rotateY(-15deg) scale(1.1);
            }

            100% {
                transform: translate(0, 0) rotateY(0deg) scale(1);
            }
        }

        @keyframes notification-bell {
            0% {
                transform: rotate(0deg);
            }

            10% {
                transform: rotate(14deg);
            }

            20% {
                transform: rotate(-8deg);
            }

            30% {
                transform: rotate(14deg);
            }

            40% {
                transform: rotate(-4deg);
            }

            50% {
                transform: rotate(10deg);
            }

            60% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        @keyframes floating-logo {

            0%,
            100% {
                transform: translateY(0) rotate(0deg);
            }

            25% {
                transform: translateY(-8px) rotate(2deg);
            }

            50% {
                transform: translateY(0) rotate(0deg);
            }

            75% {
                transform: translateY(-4px) rotate(-2deg);
            }
        }

        @keyframes gentle-float {

            0%,
            100% {
                transform: translateY(0) scale(1);
            }

            50% {
                transform: translateY(-6px) scale(1.02);
            }
        }

        @keyframes countUp {
            from {
                opacity: 0;
                transform: scale(0.5) translateY(20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes slide-up {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fade-in {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .animate-slide-up {
            animation: slide-up 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .animate-fade-in {
            animation: fade-in 0.8s ease-out forwards;
        }

        .live-pulse {
            animation: pulse 1.5s infinite;
        }

        .unlocked-icon-3d {
            animation: unlocked-3d-float 5s infinite ease-in-out;
            display: inline-block;
        }

        .page {
            position: absolute;
            width: 100%;
            height: 100dvh;
            /* Use dvh for pages */
            display: none;
            opacity: 0;
            animation: page-enter 0.3s ease-out forwards;
            will-change: transform, opacity;
        }

        .page.active {
            display: flex;
            flex-direction: column;
        }

        #auth-page {
            z-index: 10;
        }

        #auth-page.active,
        #splash-screen.active {
            animation: cinematic-enter 0.9s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        #auth-form-container {
            max-height: 100dvh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-glow) transparent;
        }

        .glass-effect {
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px 0 var(--shadow-color);
        }

        .glowing-logo {
            animation: glowing-logo-pulse 4s infinite ease-in-out;
            will-change: box-shadow;
        }

        .input-field,
        .select-field {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            padding: 0.65rem 1rem;
        }

        .input-field:focus,
        .select-field:focus {
            background: rgba(0, 0, 0, 0.2);
            box-shadow: 0 0 15px var(--primary-glow);
            border-color: var(--primary-glow);
            outline: none;
        }

        .input-field::placeholder {
            color: var(--text-secondary);
        }

        .btn-celestial {
            background: transparent;
            border: 2px solid var(--primary-glow);
            color: var(--primary-glow);
            text-shadow: 0 0 10px var(--primary-glow);
            box-shadow: 0 0 15px var(--primary-glow) inset, 0 0 5px var(--primary-glow);
            transition: all 0.3s ease;
        }

        .btn-celestial:hover:not(:disabled) {
            background: var(--primary-glow);
            color: var(--bg-color);
            transform: scale(1.05);
            box-shadow: 0 0 25px var(--primary-glow) inset, 0 0 20px var(--primary-glow);
            text-shadow: none;
        }

        .btn-celestial:active:not(:disabled) {
            transform: scale(0.98);
            box-shadow: 0 0 10px var(--primary-glow) inset;
        }

        .btn-celestial:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .scrolling-banner {
            transition: transform 0.5s ease;
            font-size: 0.7rem !important;
        }

        .bottom-nav {
            transition: transform 0.5s ease;
            overflow-x: auto;
            flex-wrap: nowrap;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            /* Add safe area protection */
            justify-content: flex-start;
        }

        .bottom-nav::-webkit-scrollbar {
            display: none;
        }

        .bottom-nav {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .bottom-nav-btn {
            flex-shrink: 0;
            position: relative;
        }

        body.focus-mode .scrolling-banner {
            transform: translateY(-100%);
        }

        @media (min-width: 640px) {
            body.focus-mode .bottom-nav {
                transform: translateY(100%);
            }
        }

        @media (max-width: 639px) {
            body.focus-mode .bottom-nav {
                transform: translateY(0);
            }
        }

        body.focus-mode #exit-focus-mode-btn {
            display: flex;
        }

        .notification-badge {
            position: absolute;
            top: 2px;
            right: 8px;
            background-color: #f43f5e;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 1px solid var(--bg-color);
        }

        .scrolling-banner p {
            display: inline-block;
            padding: 4px 0;
            font-size: 0.7rem;
            animation: scroll-text-rtl 25s linear infinite;
            color: var(--primary-glow);
            text-shadow: 0 0 8px var(--primary-glow);
            font-weight: 600;
        }

        .bottom-nav-btn i {
            filter: drop-shadow(0 0 5px var(--primary-glow));
            transition: all 0.3s ease;
        }

        .bottom-nav-btn:hover i {
            filter: drop-shadow(0 0 15px var(--primary-glow));
            transform: scale(1.1) translateY(-2px);
            color: var(--primary-glow);
        }

        .modal {
            display: none;
        }

        .modal.open {
            display: flex;
        }

        #modal-body {
            scrollbar-width: thin;
            scrollbar-color: var(--primary-glow) transparent;
        }

        .social-icon-animated {
            animation: icon-3d-float 6s ease-in-out infinite;
            transition: all 0.3s ease;
        }

        .social-icon-animated:hover {
            transform: scale(1.2);
            filter: drop-shadow(0 0 8px var(--glow-color));
            animation-play-state: paused;
        }

        .live-indicator {
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .notification-indicator {
            position: absolute;
            top: 0;
            right: 0;
            width: 8px;
            height: 8px;
            background-color: #f43f5e;
            border-radius: 50%;
        }

        .admin-nav-btn {
            position: relative;
            transition: all 0.2s ease-in-out;
        }

        .admin-nav-btn:hover:not(.active) {
            transform: translateX(5px);
            background-color: rgba(var(--primary-glow-rgb), 0.1);
        }

        .admin-nav-btn.active {
            background-color: var(--primary-glow);
            color: var(--bg-color);
            font-weight: bold;
            transform: translateX(5px);
        }

        .admin-panel {
            animation: fade-in-up 0.5s ease forwards;
        }

        #admin-dashboard .glass-effect {
            animation: fade-in-up 0.5s ease-out backwards;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            border: 1px solid var(--glass-border);
        }

        #admin-dashboard .glass-effect:hover {
            transform: translateY(-6px) scale(1.02);
            border-color: rgba(var(--primary-glow-rgb), 0.5);
            box-shadow: 0 0 25px rgba(var(--primary-glow-rgb), 0.3),
                0 10px 40px 0 var(--shadow-color);
        }

        .subject-card {
            background-color: rgba(16, 26, 42, 0.75);
            border: 1px solid rgba(var(--primary-glow-rgb), 0.5);
            box-shadow: 0 0 15px rgba(var(--primary-glow-rgb), 0.2);
            transition: all 0.3s ease-out;
        }

        .subject-card:hover {
            transform: translateY(-6px) scale(1.03);
            border-color: rgba(var(--primary-glow-rgb), 1);
            box-shadow: 0 0 25px rgba(var(--primary-glow-rgb), 0.5);
        }

        .footer-text {
            display: none;
        }

        #privacy-rating-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        #privacy-rating-content {
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 500px;
            width: 100%;
            color: var(--text-primary);
        }

        #privacy-rating-content h3 {
            color: var(--primary-glow);
            text-align: center;
            margin-bottom: 1rem;
        }

        #privacy-rating-content p {
            margin: 0.5rem 0;
            line-height: 1.6;
        }

        #privacy-rating-content strong {
            color: var(--secondary-glow);
        }

        #privacy-rating-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        #privacy-rating-buttons button {
            padding: 0.5rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
        }

        #agree-btn {
            background: var(--primary-glow);
            color: var(--bg-color);
        }

        .stylish-friday-msg {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            text-align: center;
            color: var(--text-primary);
            animation: fade-in-up 0.5s ease-out;
        }

        .stylish-friday-msg i {
            font-size: 4rem;
            margin-bottom: 1rem;
            filter: drop-shadow(0 0 10px var(--primary-glow));
        }

        .stylish-friday-msg p {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-glow);
            text-shadow: 0 0 10px rgba(var(--primary-glow-rgb), 0.3);
        }

        .course-actions,
        .book-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .course-btn,
        .book-btn {
            flex: 1;
            padding: 0.4rem 0.6rem;
            font-size: 0.85rem;
            border-radius: 0.375rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .watch-btn {
            background: var(--primary-glow);
            color: var(--bg-color);
        }

        .download-btn {
            background: #4f46e5;
            color: white;
        }

        .watch-btn:hover {
            background: #00d1a0;
        }

        .download-btn:hover {
            background: #4338ca;
        }

        .redirect-modal-icon {
            animation: unlocked-3d-float 4s infinite ease-in-out;
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .meeting-live-indicator {
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .meeting-live-dot {
            width: 12px;
            height: 12px;
            background-color: red;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .meeting-live-text {
            font-size: 0.65rem;
            font-weight: bold;
            color: red;
            white-space: nowrap;
        }

        .poll-item,
        .opinion-item {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            position: relative;
            touch-action: manipulation;
        }

        .poll-header,
        .opinion-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .poll-author,
        .opinion-author {
            font-weight: bold;
            color: var(--primary-glow);
        }

        .poll-time,
        .opinion-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .poll-body,
        .opinion-body {
            margin: 6px 0;
            line-height: 1.5;
        }

        .poll-reactions,
        .opinion-reactions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .reaction-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reaction-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .reaction-count {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-left: 4px;
        }

        #onboarding-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        #onboarding-content {
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 500px;
            width: 100%;
            color: var(--text-primary);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        #onboarding-icon {
            font-size: 3rem;
            margin: 1rem 0;
            color: var(--primary-glow);
            animation: icon-3d-float 4s infinite ease-in-out;
        }

        #onboarding-text {
            margin: 1rem 0;
            line-height: 1.6;
        }

        #onboarding-buttons {
            display: flex;
            justify-content: center;
            margin-top: 1.5rem;
        }

        #onboarding-next-btn {
            padding: 0.5rem 1.5rem;
            background: var(--primary-glow);
            color: var(--bg-color);
            border: none;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
        }

        .download-item {
            background: rgba(30, 41, 59, 0.6);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .download-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        #live-attendance-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #dc2626;
            color: white;
            text-align: center;
            padding: 8px 0;
            font-weight: bold;
            z-index: 100;
            display: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        #live-attendance-banner:hover {
            background: #ef4444;
        }

        .content-policy-notice {
            background: rgba(239, 68, 68, 0.1);
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-radius: 0.375rem;
            font-size: 0.85rem;
            color: #fca5a5;
        }

        .content-policy-notice strong {
            color: #fecaca;
        }

        .lecture-content {
            line-height: 1.8;
            color: #cbd5e1;
            font-size: 1.05rem;
        }

        .lecture-content h1,
        .lecture-content h2,
        .lecture-content h3 {
            color: #60a5fa;
            margin-top: 1.5rem;
            margin-bottom: 0.8rem;
            font-weight: 700;
        }

        .lecture-content p {
            margin-bottom: 1rem;
            color: #e2e8f0;
        }

        .lecture-content strong {
            color: #93c5fd;
        }

        .lecture-content em {
            color: #bae6fd;
            font-style: italic;
        }

        .lecture-content ul,
        .lecture-content ol {
            padding-right: 1.5rem;
            margin-bottom: 1rem;
        }

        .lecture-content li {
            margin-bottom: 0.4rem;
        }

        .lecture-content code {
            background: rgba(30, 41, 59, 0.6);
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: monospace;
            color: #a7f3d0;
        }

        .lecture-content blockquote {
            padding-right: 1rem;
            margin: 1.2rem 0;
            color: #94a3b8;
            font-style: italic;
        }

        /* جداول المحاسبة */
        .lecture-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.2rem 0;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .lecture-content th,
        .lecture-content td {
            border: 1px solid rgba(0, 245, 195, 0.3);
            padding: 0.75rem;
            text-align: center;
            color: #e2e8f0;
        }

        .lecture-content th {
            background: rgba(0, 245, 195, 0.15);
            color: var(--primary-glow);
            font-weight: bold;
        }

        .lecture-content img {
            max-width: 100%;
            height: auto;
        }

        #explanation-content {
            text-align: center;
            padding: 1.5rem;
        }

        #explanation-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid var(--primary-glow);
            box-shadow: 0 0 20px var(--primary-glow);
            margin-bottom: 1rem;
            animation: floating-logo 6s ease-in-out infinite;
        }

        #explanation-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: var(--primary-glow);
            text-shadow: 0 0 8px var(--primary-glow);
        }

        #explanation-subtitle {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        #go-to-channel-btn {
            background: #ff0000;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
            animation: gentle-float 4s ease-in-out infinite;
        }

        #go-to-channel-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(255, 0, 0, 0.7);
        }

        .youtube-3d-icon {
            font-size: 3rem;
            color: #ff0000;
            animation: unlocked-3d-float 3s infinite ease-in-out;
            margin-bottom: 1rem;
        }

        .qr-readable-text {
            position: absolute;
            bottom: 8px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.65rem;
            color: transparent;
            user-select: none;
            pointer-events: none;
            opacity: 0;
        }

        .qr-readable-text::selection {
            background: transparent;
        }

        /* Correction Button - Mobile Optimized */
        .correction-btn {
            background: #f97316;
            color: white;
            padding: 0.3rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 0.75rem;
        }

        .correction-btn:hover {
            background: #ea580c;
        }

        /* Lecture Exam Button - Mobile Optimized */
        .lecture-exam-btn {
            background: #3b82f6;
            color: white;
            padding: 0.3rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 0.75rem;
        }

        .lecture-exam-btn:hover {
            background: #2563eb;
        }

        /* Correction Form Modal */
        #correction-form {
            text-align: center;
        }

        #correction-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid var(--primary-glow);
            box-shadow: 0 0 15px var(--primary-glow);
            margin: 0 auto 1rem;
            display: block;
            animation: glowing-logo-pulse 4s infinite ease-in-out;
            will-change: box-shadow;
        }

        #correction-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-glow);
            margin-bottom: 0.5rem;
        }

        #correction-instructions {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        /* ========== STUDENT CARD STYLES ========== */
        .student-card-container {
            width: 100%;
            max-width: 380px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .student-card {
            /* شفاف تمامًا - بدون خلفية أو إطار */
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0;
        }

        .student-card-content {
            color: white;
            text-align: center;
        }

        .student-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .student-card-title h4 {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .student-card-logo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid var(--primary-glow);
            box-shadow: 0 0 15px var(--primary-glow);
        }

        .student-card-info p {
            margin: 0.4rem 0;
            font-size: 1rem;
        }

        .student-card-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .student-card-value {
            font-weight: bold;
            font-size: 1.1rem;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
        }

        .student-card-id-box {
            margin-top: 1.2rem;
            padding: 0.6rem 0;
        }

        .student-card-id-box .student-card-value {
            font-size: 1.3rem;
            font-family: monospace;
            color: var(--primary-glow);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }

        .student-card-id-box .student-card-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            margin-top: 0.3rem;
        }

        .student-card-qr {
            display: flex;
            justify-content: center;
            margin-top: 1.2rem;
        }

        /* أيقونة احترافية بدل علامة الصح */
        .futuristic-badge {
            font-size: 0.55rem !important;
            color: gold;
            text-shadow: 0 0 6px gold, 0 0 10px gold;
            animation: gentle-float 3s infinite ease-in-out;
        }

        /* Modern Glass Card & Animations */
        /* Result UI Cinematic Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes scaleUp {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }

        .animate-scale-up {
            animation: scaleUp 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .animate-slide-up {
            animation: slideUp 0.8s ease-out forwards;
            opacity: 0;
        }

        /* Cinematic Exams & Audio Styles */
        .exams-cinematic-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .custom-audio-player {
            filter: hue-rotate(150deg) brightness(1.2);
            height: 45px;
            border-radius: 12px;
        }

        @media (max-width: 640px) {
            .exams-cinematic-container {
                padding: 1rem;
            }
        }

        @keyframes cardEntry {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(30px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modern-glass-card {
            background: rgba(255, 255, 255, 0.03) !important;
            /* Even more subtle */
            backdrop-filter: blur(25px) !important;
            /* Stronger blur for better separation without border */
            -webkit-backdrop-filter: blur(25px) !important;
            border: none !important;
            /* STRICTLY NO BORDER */
            border-radius: 32px !important;
            /* Very soft edges (pill-like) */
            box-shadow: none !important;
            /* NO SQUARE/FRAME EFFECT */
            animation: cardEntry 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            overflow: hidden;
        }

        /* Subjects Grid & Animation */
        @keyframes fadeSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .subject-card-modern {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            animation: fadeSlideUp 0.6s ease-out forwards;
            opacity: 0;
            will-change: transform, opacity;
        }

        /* NEW: Weekly Exams Styles */
        .exam-indicator-dot {
            width: 10px;
            height: 10px;
            background-color: #ef4444;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 10px #ef4444;
            animation: pulse-red 2s infinite;
        }

        .exam-alert-badge {
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 0 5px rgba(239, 68, 68, 0.5);
        }

        .exam-check-badge {
            background-color: #22c55e;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 0 5px rgba(34, 197, 94, 0.5);
        }

        .question-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .question-card:hover {
            border-color: rgba(0, 245, 195, 0.2);
            background: rgba(255, 255, 255, 0.05);
        }

        .question-option {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .question-option:hover {
            border-color: var(--primary-glow);
            background: rgba(var(--primary-glow-rgb), 0.05);
        }

        .question-option.selected {
            border-color: var(--primary-glow);
            background: rgba(var(--primary-glow-rgb), 0.15);
            box-shadow: 0 0 15px rgba(var(--primary-glow-rgb), 0.1);
        }

        @keyframes pulse-red {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .exam-timer-fixed {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            background: rgba(13, 13, 26, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 0.5rem 1.5rem;
            border-radius: 99px;
            border: 1px solid var(--primary-glow);
            box-shadow: 0 0 20px rgba(var(--primary-glow-rgb), 0.2);
            font-family: monospace;
            font-weight: bold;
            font-size: 1.25rem;
            color: var(--primary-glow);
        }

        .exam-modal-full {
            width: 100vw !important;
            height: 100vh !important;
            max-width: none !important;
            max-height: none !important;
            border-radius: 0 !important;
        }

        .mcq-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }

        @media (min-width: 640px) {
            .mcq-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .subject-card-modern:hover {
            transform: translateY(-5px) scale(1.02);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        .subject-card-modern:active {
            transform: scale(0.98);
        }

        /* UNIFIED SECTION ANIMATION */
        .unified-anim {
            animation: unifiedEntrance 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards !important;
        }

        @keyframes unifiedEntrance {
            from {
                opacity: 0;
                transform: translateY(15px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .card-interactive {
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            will-change: transform;
        }

        .card-interactive:active {
            transform: scale(0.97);
        }

        /* Mobile Optimization */
        @media (max-width: 640px) {
            .student-card-container {
                padding: 1rem;
                width: 100%;
                display: flex;
                flex-direction: column;
                justify-content: center;
                /* Ensure it fits on screen */
                min-height: calc(100vh - 100px);
            }

            .modern-glass-card {
                padding: 1.25rem !important;
                /* Slightly less padding on mobile */
            }
        }

        /* Student Card Modal Specifics - STRICT NO FRAME/BOX */
        .card-modal-mode {
            background: rgba(0, 0, 0, 0.8) !important;
            /* Darker backdrop for focus */
            backdrop-filter: blur(15px) !important;
        }

        .card-modal-mode .modal-content {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0 !important;
            overflow: visible !important;
            /* Allow glows */
            max-width: 100% !important;
            /* Allow flex centering */
            width: auto !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-modal-mode #modal-title {
            display: none !important;
        }

        .card-modal-mode .modal-close-btn {
            position: fixed;
            top: 30px;
            right: 30px;
            color: white;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            z-index: 60;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-modal-mode .modal-close-btn:active {
            transform: scale(0.9);
        }

        /* Refined Certificate Styles */
        .certificate-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 24px;
            padding: 1.5rem;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .certificate-card:hover {
            transform: translateY(-8px) scale(1.02);
            background: rgba(255, 255, 255, 0.07);
            border-color: rgba(var(--primary-glow-rgb), 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .certificate-preview-thumb {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, rgba(var(--primary-glow-rgb), 0.1), rgba(var(--secondary-glow-rgb), 0.1));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            font-size: 3rem;
            color: var(--primary-glow);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .certificate-preview-wrapper {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            background: white;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
        }

        /* Password Suggestions Styles */
        .password-suggestions-container {
            position: relative;
            width: 100%;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }

        .password-suggestions-list {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid var(--primary-glow);
            border-radius: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0, 245, 195, 0.1);
            backdrop-filter: blur(10px);
        }

        .password-suggestions-list.show {
            display: block;
            animation: fade-in-up 0.3s ease-out;
        }

        .password-suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .password-suggestion-item:hover {
            background: rgba(0, 245, 195, 0.1);
            padding-left: 1.25rem;
        }

        .password-suggestion-item:last-child {
            border-bottom: none;
        }

        .password-suggestion-text {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            color: var(--primary-glow);
            font-weight: bold;
            word-break: break-all;
        }

        .password-suggestion-copy {
            opacity: 0;
            transition: opacity 0.2s;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .password-suggestion-item:hover .password-suggestion-copy {
            opacity: 1;
            color: var(--primary-glow);
        }

        /* CAPTCHA Styles */
        .captcha-container {
            margin-top: 1rem;
            display: block;
            animation: fade-in-up 0.4s ease-out;
        }

        .captcha-checkbox-wrapper {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .captcha-checkbox-wrapper:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-glow);
            box-shadow: 0 0 15px rgba(var(--primary-glow-rgb), 0.2);
        }

        .captcha-box {
            width: 24px;
            height: 24px;
            border: 2px solid var(--primary-glow);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .captcha-box i {
            font-size: 16px;
            color: var(--primary-glow);
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.3s;
        }

        .captcha-checkbox-wrapper.verified .captcha-box {
            background: var(--primary-glow);
        }

        .captcha-checkbox-wrapper.verified .captcha-box i {
            opacity: 1;
            transform: scale(1);
            color: var(--bg-color);
        }

        .captcha-label {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .captcha-logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.6;
        }

        .captcha-logo i {
            font-size: 1.2rem;
            color: var(--primary-glow);
        }

        .captcha-logo span {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* CAPTCHA Grid Modal */
        .captcha-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(15px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .captcha-modal-card {
            background: #fff;
            width: 100%;
            max-width: 380px;
            border-radius: 2px;
            overflow: visible;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: cinematic-enter 0.4s ease-out;
            margin: auto;
        }

        .captcha-header {
            background: #4a90e2;
            color: white;
            padding: 20px;
            text-align: right;
        }

        .captcha-title-small {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .captcha-title-large {
            font-size: 1.5rem;
            font-weight: 800;
            line-height: 1.2;
        }

        .captcha-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            padding: 4px;
            background: #f1f5f9;
            /* Lighter slate background for more professional look */
            width: 100%;
            max-width: 320px;
            /* Force consistent width on all devices */
            margin: 0 auto;
            box-sizing: border-box;
            border-radius: 8px;
        }

        .captcha-img-wrapper {
            position: relative;
            aspect-ratio: 1;
            cursor: pointer;
            overflow: hidden;
        }

        .captcha-img-wrapper img {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: contain;
            /* Ensure full image visibility without cropping */
            background: #fff;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .captcha-img-wrapper.selected img {
            transform: scale(0.85);
        }

        .captcha-img-wrapper.selected::after {
            content: '\e9b5';
            /* Phosphor check icon code or use ::after with background */
            font-family: 'phosphor';
            /* If available as font */
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: #4a90e2;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            z-index: 10;
        }

        /* Alternative for selected icon using SVG if font not working */
        .captcha-img-wrapper.selected::before {
            content: "";
            position: absolute;
            inset: 0;
            border: 4px solid #4a90e2;
            z-index: 5;
        }

        .captcha-footer {
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            border-top: 1px solid #eee;
        }

        .captcha-actions {
            display: flex;
            gap: 15px;
            color: #777;
            font-size: 1.2rem;
        }

        .captcha-actions i {
            cursor: pointer;
            transition: color 0.2s;
        }

        .captcha-actions i:hover {
            color: #333;
        }

        .captcha-verify-btn {
            background: #4a90e2;
            color: white;
            padding: 10px 24px;
            border-radius: 3px;
            font-weight: 700;
            cursor: pointer;
            transition: opacity 0.2s;
            border: none;
        }

        .captcha-verify-btn:hover {
            opacity: 0.9;
        }

        /* Exam Question Card Style - NO BORDERS */
        .question-block {
            background: transparent;
            backdrop-filter: none;
            border: none !important;
            border-radius: 0;
            padding: 1.5rem 0;
            box-shadow: none !important;
            transition: transform 0.3s ease;
        }

        .question-block:hover {
            border: none !important;
        }

        .exam-option-label {
            position: relative;
            flex-direction: row-reverse;
            display: flex;
            align-items: center;
            padding: 16px 8px;
            border-radius: 0;
            background: transparent;
            border: none !important;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            margin-bottom: 12px;
        }

        .exam-option-label:hover {
            background: transparent;
            border: none !important;
            transform: translateX(-4px);
        }

        .exam-option-label.selected {
            background: transparent;
            border: none !important;
            box-shadow: none !important;
        }

        .exam-option-label .radio-custom {
            width: 22px;
            height: 22px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            margin-left: 15px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .exam-option-label.selected .radio-custom {
            border-color: var(--primary-glow);
            background: var(--primary-glow);
        }

        .exam-option-label .radio-inner {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--bg-color);
            transform: scale(0);
            transition: transform 0.2s ease;
        }

        .exam-option-label.selected .radio-inner {
            transform: scale(1);
        }

        /* My Certificates Section Styles */
        .certificate-card {
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 215, 0, 0.1);
            border-radius: 20px;
            padding: 14px;
            margin-bottom: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .certificate-card:hover {
            transform: translateY(-5px);
            border-color: rgba(255, 215, 0, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }


        .certificate-actions {
            display: flex;
            gap: 8px;
            margin-top: auto;
        }

        .certificate-actions button {
            flex: 1;
            min-width: 0;
        }

        .certificate-preview-thumb {
            width: 100%;
            aspect-ratio: 1.4;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border-radius: 12px;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
        }

        .certificate-preview-thumb i {
            font-size: 3rem;
            color: rgba(255, 215, 0, 0.5);
        }

        .cert-status-tag {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 9px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .cert-type-lecture {
            background: rgba(6, 182, 212, 0.15);
            color: #06b6d4;
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .cert-type-weekly {
            background: rgba(168, 85, 247, 0.15);
            color: #a855f7;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }


        /* Certificate Modal */
        .certificate-modal {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .certificate-modal.active {
            display: flex;
        }

        .certificate-modal-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            width: fit-content;
        }




        /* The actual luxurious certificate canvas style (Dark Theme) */
        .luxury-certificate {
            width: 100%;
            max-width: 800px;
            aspect-ratio: 1.414;
            /* A4 Ratio */
            background: #0a0e14;
            /* Deep Black/Blue */
            color: #e2e8f0;
            padding: 40px;
            position: relative;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            border: 8px double rgba(255, 215, 0, 0.15);
            /* Double luxury border */
        }

        .cert-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
        }

        .cert-logo {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            filter: grayscale(0.5) contrast(1.2);
        }

        .cert-platform-name {
            font-size: 1.5rem;
            font-weight: 800;
            color: #ffd700;
            /* Gold */
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .cert-title {
            font-size: 2.2rem;
            font-weight: 900;
            color: #fff;
            margin: 20px 0;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .cert-body {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #94a3b8;
        }

        .cert-student-name {
            font-size: 2.5rem;
            font-weight: 700;
            color: #fff;
            margin: 15px 0;
            font-family: 'Amiri', serif;
            /* Or similar for name */
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            display: inline-block;
            padding-bottom: 5px;
        }

        .cert-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 30px 0;
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 15px;
        }

        .cert-stat-item b {
            color: #ffd700;
            font-size: 1.2rem;
        }

        .cert-stat-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #64748b;
        }

        .cert-footer {
            display: flex;
            justify-content: flex-start;
            align-items: flex-end;
            margin-top: 40px;
        }

        .cert-signature-area {
            text-align: left;
            position: relative;
        }

        .cert-signature-title {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 5px;
        }

        .cert-signature-name {
            font-size: 1.4rem;
            font-weight: bold;
            color: #ffd700;
        }

        /* ===================== LECTURE EXAM TRANSPARENT UI (NO BORDERS) ===================== */
        .lecture-exam-question-card {
            background: transparent;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border: none !important;
            border-radius: 0;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            box-shadow: none !important;
            animation: exam-question-slide-in 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes exam-question-slide-in {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .lecture-exam-question-card:hover {
            background: transparent;
            box-shadow: none !important;
            transform: translateY(0);
            transition: all 0.3s ease;
        }

        .lecture-exam-option {
            background: transparent;
            backdrop-filter: none;
            border: none !important;
            border-radius: 0;
            padding: 1rem 0;
            margin: 0.75rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .lecture-exam-option:hover {
            background: transparent;
            border: none !important;
            transform: translateX(5px);
        }

        .lecture-exam-option.selected {
            background: transparent;
            border: none !important;
            box-shadow: none !important;
        }

        .lecture-exam-submit-btn {
            background: rgba(0, 245, 195, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid var(--primary-glow);
            color: var(--primary-glow);
            padding: 0.75rem 2rem;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 245, 195, 0.2);
        }

        .lecture-exam-submit-btn:hover {
            background: var(--primary-glow);
            color: var(--bg-color);
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(0, 245, 195, 0.4);
        }

        .lecture-exam-result-modal {
            background: linear-gradient(135deg,
                    rgba(0, 245, 195, 0.03) 0%,
                    rgba(167, 139, 250, 0.03) 50%,
                    rgba(0, 245, 195, 0.03) 100%);
            backdrop-filter: blur(60px);
            -webkit-backdrop-filter: blur(60px);
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
            border-radius: 40px;
            padding: 2.5rem 1.5rem;
            text-align: center;
            animation: result-modal-appear 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            opacity: 0;
            transform: scale(0.85) translateY(20px);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4),
                0 0 100px rgba(0, 245, 195, 0.05) inset;
            position: relative;
            overflow: hidden;
            max-width: 95vw;
            max-height: 85vh;
            overflow-y: auto;
        }

        /* Mobile optimization */
        @media (max-width: 640px) {
            .lecture-exam-result-modal {
                padding: 1.5rem 1rem;
                border-radius: 24px;
                max-height: 80vh;
            }
        }

        /* Smooth scrolling and performance optimization */
        .lecture-exam-result-modal {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 245, 195, 0.3) transparent;
        }

        .lecture-exam-result-modal::-webkit-scrollbar {
            width: 6px;
        }

        .lecture-exam-result-modal::-webkit-scrollbar-track {
            background: transparent;
        }

        .lecture-exam-result-modal::-webkit-scrollbar-thumb {
            background: rgba(0, 245, 195, 0.3);
            border-radius: 10px;
        }

        .lecture-exam-result-modal::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 245, 195, 0.5);
        }

        /* Performance optimization for animations */
        #animated-percentage {
            will-change: opacity, transform;
        }

        .animate-slide-up {
            will-change: opacity, transform;
        }

        .animate-fade-in {
            will-change: opacity;
        }

        .lecture-exam-result-modal::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 245, 195, 0.08) 0%, transparent 70%);
            animation: water-ripple 8s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes water-ripple {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.3;
            }

            50% {
                transform: translate(10%, 10%) scale(1.1);
                opacity: 0.5;
            }
        }

        @keyframes result-modal-appear {
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .lecture-exam-exit-btn {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1.5rem;
        }

        .lecture-exam-exit-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-glow);
            color: var(--primary-glow);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 245, 195, 0.3);
        }

        .lecture-exam-score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-glow) 0%, var(--secondary-glow) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2rem auto;
            font-size: 3rem;
            font-weight: bold;
            color: var(--bg-color);
            box-shadow: 0 10px 40px rgba(0, 245, 195, 0.4);
            animation: score-pulse 2s ease-in-out infinite;
        }

        /* Water Modal Mode - Frameless & Transparent */
        #generic-modal.water-modal-mode .modal-content {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            backdrop-filter: none !important;
            padding: 0 !important;
        }

        #generic-modal.water-modal-mode .modal-content>div:first-child {
            border-bottom: none !important;
            margin-bottom: 0 !important;
            padding-bottom: 0 !important;
        }

        #generic-modal.water-modal-mode #modal-title {
            display: none !important;
        }

        #generic-modal.water-modal-mode .modal-close-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 50;
            backdrop-filter: blur(5px);
        }

        .water-effect-container {
            background: linear-gradient(135deg, rgba(0, 245, 195, 0.05) 0%, rgba(167, 139, 250, 0.05) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 2rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            border: none;
            animation: water-pulse 3s ease-in-out infinite alternate;
        }

        @keyframes water-pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 8px 32px 0 rgba(0, 245, 195, 0.1);
            }

            100% {
                transform: scale(1.02);
                box-shadow: 0 15px 45px 0 rgba(0, 245, 195, 0.2);
            }
        }

        @keyframes score-pulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 10px 40px rgba(0, 245, 195, 0.4);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 15px 50px rgba(0, 245, 195, 0.6);
            }
        }

        /* Red Indicator for Lecture Exam Button */
        .lecture-exam-indicator {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 10px;
            height: 10px;
            background-color: #ef4444;
            border-radius: 50%;
            box-shadow: 0 0 10px #ef4444;
            animation: pulse-red 2s infinite;
        }

        /* Counter Animation for Percentage */
        @keyframes countUp {
            0% {
                opacity: 0;
                transform: scale(0.5) translateY(20px);
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Fade In Animation */
        @keyframes animate-fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: animate-fade-in 0.6s ease-out forwards;
            opacity: 0;
        }

        /* Slide Up Animation */
        @keyframes animate-slide-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-up {
            animation: animate-slide-up 0.5s ease-out forwards;
            opacity: 0;
        }

        .cert-signature-image {
            width: 120px;
            opacity: 0.8;
            filter: invert(1);
            margin-top: -10px;
        }

        .certificate-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(20px);
        }

        @media (max-width: 480px) {
            .captcha-modal-card {
                max-width: 100%;
            }

            .luxury-certificate {
                padding: 15px;
                font-size: 0.8rem;
            }

            .cert-title {
                font-size: 1.3rem;
            }

            .cert-student-name {
                font-size: 1.5rem;
            }

            .cert-stats-grid {
                gap: 5px;
                padding: 10px;
            }

            .cert-stat-item b {
                font-size: 0.9rem;
            }

            /* Fix Exam Overflow Issues - Enhanced Mobile */
            .question-block h3 {
                white-space: normal !important;
                word-break: break-word !important;
                overflow-wrap: break-word !important;
                line-height: 1.7 !important;
                font-size: 1.1rem !important;
                padding-right: 0.5rem !important;
            }

            .exam-option-label {
                height: auto !important;
                min-height: auto !important;
                white-space: normal !important;
                display: flex !important;
                align-items: center !important;
                padding: 1rem 0.5rem !important;
            }

            .exam-option-label span {
                white-space: normal !important;
                word-break: break-word !important;
                line-height: 1.6 !important;
                font-size: 0.95rem !important;
                max-width: 100% !important;
            }

            .radio-custom {
                flex-shrink: 0 !important;
                margin-left: 10px !important;
            }

            /* Ensure mobile scrolling */
            #active-exam-overlay,
            #active-lecture-exam-overlay {
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }

            /* Lecture Exam Mobile Improvements */
            .lecture-exam-question-card {
                padding: 1rem 0 !important;
                margin-bottom: 1.5rem !important;
            }

            .lecture-exam-result-modal {
                padding: 2rem 1.5rem !important;
                border-radius: 24px !important;
            }

            .lecture-exam-score-circle {
                width: 120px !important;
                height: 120px !important;
                font-size: 2.5rem !important;
            }
        }

        /* Refined Stylish Friday Message */
        .stylish-friday-msg {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3.5rem;
            margin: 2rem auto;
            max-width: 450px;
            border-radius: 60px 20px 60px 20px;
            /* Organic/Asymmetric Shape */
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            animation: cinematic-enter 1s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            position: relative;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .stylish-friday-msg::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.04), transparent);
            transform: translateX(-100%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }

        .stylish-friday-msg i {
            font-size: 5rem;
            color: var(--primary-glow);
            margin-bottom: 2rem;
            filter: drop-shadow(0 0 30px rgba(var(--primary-glow-rgb), 0.6));
            animation: unlocked-3d-float 6s infinite ease-in-out;
        }

        .stylish-friday-msg p {
            font-size: 1.8rem;
            font-weight: 800;
            color: #fff;
            text-align: center;
            line-height: 1.4;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* Refined Shoun Modal Specifics */
        .shoun-modal-mode {
            background: rgba(7, 7, 15, 0.9) !important;
            backdrop-filter: blur(40px) !important;
            -webkit-backdrop-filter: blur(40px) !important;
        }

        .shoun-modal-mode .modal-content {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0 !important;
            max-width: 550px !important;
            width: 95% !important;
            margin: auto;
        }

        .shoun-floating-btn {
            background: rgba(255, 255, 255, 0.02) !important;
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.3);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .shoun-floating-btn:hover {
            background: rgba(var(--primary-glow-rgb), 0.08) !important;
            border-color: rgba(var(--primary-glow-rgb), 0.2) !important;
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
        }

        @keyframes shoun-blur-in {
            from {
                opacity: 0;
                filter: blur(30px);
                transform: scale(1.1) translateY(30px);
            }

            to {
                opacity: 1;
                filter: blur(0);
                transform: scale(1) translateY(0);
            }
        }

        .shoun-animate {
            animation: shoun-blur-in 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        @keyframes cinematic-enter {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.9);
                filter: blur(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
                filter: blur(0);
            }
        }

        @keyframes unlocked-3d-float {

            0%,
            100% {
                transform: translateY(0) rotateX(0) rotateY(0);
            }

            25% {
                transform: translateY(-10px) rotateX(10deg) rotateY(5deg);
            }

            50% {
                transform: translateY(0) rotateX(0) rotateY(-5deg);
            }

            75% {
                transform: translateY(10px) rotateX(-10deg) rotateY(0);
            }
        }

        /* Water/Glass Modal Mode for Exams */
        .water-modal-mode {
            background: rgba(0, 0, 0, 0.85) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
        }

        .water-modal-mode .modal-content {
            background: transparent !important;
            box-shadow: none !important;
            border: none !important;
            max-width: 600px !important;
            width: 90% !important;
            padding: 0 !important;
        }

        .water-modal-mode #modal-title {
            display: none !important;
            /* Hide default title */
        }

        .water-modal-mode .modal-close-btn {
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: white !important;
            top: 20px !important;
            right: 20px !important;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .water-effect-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 40px;
            padding: 40px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.8s ease-out;
            text-align: center;
        }

        /* Certificate System Styles */
        .certificate-preview-card {
            background: linear-gradient(145deg, rgba(23, 23, 38, 0.8), rgba(13, 13, 26, 0.9));
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .certificate-preview-card:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: var(--primary-glow);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 0 0 20px rgba(var(--primary-glow-rgb), 0.1);
        }

        /* High-Quality Premium Certificate Style */
        .full-certificate-node {
            width: 800px;
            height: 566px;
            background: #fff;
            padding: 40px;
            position: relative;
            border: 15px solid #f8fafc;
            box-shadow: inset 0 0 0 2px rgba(0, 0, 0, 0.05);
            font-family: 'Cairo', sans-serif;
            color: #1e293b;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .cert-bg-pattern {
            position: absolute;
            inset: 0;
            background-image: radial-gradient(#00f5c308 2px, transparent 2px);
            background-size: 20px 20px;
            opacity: 0.5;
            pointer-events: none;
        }

        .cert-border-frame {
            position: absolute;
            inset: 10px;
            border: 2px solid #00f5c320;
            pointer-events: none;
        }

        .cert-corner-decor {
            position: absolute;
            width: 100px;
            height: 100px;
            border: 4px solid #00f5c340;
            pointer-events: none;
        }

        .c-tl {
            top: 0;
            left: 0;
            border-bottom: none;
            border-right: none;
            border-radius: 20px 0 0 0;
        }

        .c-tr {
            top: 0;
            right: 0;
            border-bottom: none;
            border-left: none;
            border-radius: 0 20px 0 0;
        }

        .c-bl {
            bottom: 0;
            left: 0;
            border-top: none;
            border-right: none;
            border-radius: 0 0 0 20px;
        }

        .c-br {
            bottom: 0;
            right: 0;
            border-top: none;
            border-left: none;
            border-radius: 0 0 20px 0;
        }

        .cert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 20px;
            z-index: 10;
        }

        .cert-main-body {
            text-align: center;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            z-index: 10;
        }

        .cert-footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            border-top: 2px solid #f1f5f9;
            padding-top: 20px;
            z-index: 10;
        }

        .cert-signature-font {
            font-family: 'Amiri', serif;
            font-style: italic;
            font-size: 2.5rem;
            color: #0f172a;
            line-height: 1;
        }

        .cert-badge {
            background: linear-gradient(135deg, #00f5c3, #a78bfa);
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 0.8rem;
            box-shadow: 0 4px 12px rgba(0, 245, 195, 0.2);
        }

        /* Certificate Preview Modal - Mobile Optimizations */
        #certificate-preview-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 1rem;
            -webkit-overflow-scrolling: touch;
        }

        #certificate-preview-modal.active {
            display: flex;
        }

        #cert-preview-content {
            width: 100%;
            max-width: 100%;
            position: relative;
        }

        /* ==================== ONBOARDING TOUR STYLES ==================== */
        .tour-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 9998;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .tour-highlight {
            position: relative;
            z-index: 9999 !important;
            pointer-events: auto;
            box-shadow: 0 0 0 4px var(--primary-glow), 0 0 30px rgba(var(--primary-glow-rgb), 0.6) !important;
            border-radius: 12px !important;
            animation: tour-pulse 2s ease-in-out infinite;
        }

        @keyframes tour-pulse {

            0%,
            100% {
                box-shadow: 0 0 0 4px var(--primary-glow), 0 0 30px rgba(var(--primary-glow-rgb), 0.6);
            }

            50% {
                box-shadow: 0 0 0 6px var(--primary-glow), 0 0 50px rgba(var(--primary-glow-rgb), 0.9);
            }
        }

        .tour-tooltip {
            position: fixed;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(30, 41, 59, 0.98));
            border: 2px solid var(--primary-glow);
            border-radius: 16px;
            padding: 1.5rem;
            max-width: 320px;
            z-index: 10000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(var(--primary-glow-rgb), 0.3);
            animation: tour-tooltip-enter 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: auto;
        }

        @keyframes tour-tooltip-enter {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .tour-tooltip-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--primary-glow);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tour-tooltip-description {
            font-size: 0.95rem;
            color: var(--text-primary);
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .tour-tooltip-counter {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 600;
        }

        .tour-tooltip-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: space-between;
        }

        .tour-btn {
            flex: 1;
            padding: 0.65rem 1.25rem;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            outline: none;
        }

        .tour-btn-next {
            background: var(--primary-glow);
            color: var(--bg-color);
            box-shadow: 0 4px 15px rgba(var(--primary-glow-rgb), 0.4);
        }

        .tour-btn-next:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--primary-glow-rgb), 0.6);
        }

        .tour-btn-next:active {
            transform: translateY(0);
        }

        .tour-btn-skip {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tour-btn-skip:hover {
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-primary);
        }

        .tour-btn-ok {
            background: linear-gradient(135deg, var(--primary-glow), var(--secondary-glow));
            color: white;
            box-shadow: 0 4px 20px rgba(var(--primary-glow-rgb), 0.5);
        }

        .tour-btn-ok:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(var(--primary-glow-rgb), 0.7);
        }

        /* Mobile adjustments for tour */
        @media (max-width: 640px) {
            .tour-tooltip {
                max-width: calc(100vw - 2rem);
                padding: 1.25rem;
            }

            .tour-tooltip-title {
                font-size: 1.1rem;
            }

            .tour-tooltip-description {
                font-size: 0.875rem;
            }
        }
    </style>
</head>

<body class="w-full h-[100dvh] overflow-hidden">
    <div id="app-bg"></div>
    <!-- Live Attendance Banner Removed -->
    <div id="app-container" class="w-full h-[100dvh] relative overflow-hidden">
        <!-- Auth Page -->
        <div id="auth-page" class="page justify-center items-end p-4">
            <div id="auth-form-container" class="w-full h-full flex justify-center items-end p-4"></div>
        </div>
        <!-- Privacy Modal -->
        <div id="privacy-rating-modal">
            <div id="privacy-rating-content">
                <h3>سياسة الخصوصية</h3>
                <div id="privacy-text">
                    <p><strong>مقدمة:</strong> نحن في منصة "Mora For Studying" نأخذ خصوصية بياناتك على محمل الجد.</p>
                    <p><strong>البيانات التي نجمعها:</strong> عند إنشاء حساب، نقوم بجمع الاسم، الفرقة، الشعبة، بالإضافة
                        إلى IP Address ونوع الجهاز لأغراض أمنية وتحليلية.</p>
                    <p><strong>استخدام البيانات:</strong> لا يتم مشاركة بياناتك الشخصية مع أي طرف ثالث. تُستخدم البيانات
                        داخليًا لتحسين تجربتك وتأمين المنصة.</p>
                    <p class="font-bold text-red-400 border-t border-red-500/30 pt-3 mt-3">
                        <strong>سياسة الاستخدام العادل:</strong> أي محاولة لإساءة استخدام الموقع، أو نشر محتوى غير لائق،
                        أو التحايل على نظام النقاط سيؤدي إلى <strong>الحظر الفوري والدائم للحساب</strong> دون سابق
                        إنذار.
                    </p>
                </div>
                <div id="privacy-rating-buttons">
                    <button id="agree-btn">موافق</button>
                </div>
            </div>
        </div>
        <!-- Onboarding Modal -->
        <div id="onboarding-modal">
            <div id="onboarding-content">
                <div id="onboarding-icon"><i class="ph-identification-card"></i></div>
                <h3 id="onboarding-title">مرحباً بك في Mora!</h3>
                <p id="onboarding-text">استعد لرحلة تعليمية ممتعة وسهلة مع أفضل الميزات التفاعلية!</p>
                <div id="onboarding-buttons">
                    <button id="onboarding-next-btn">التالي</button>
                </div>
                <div class="absolute -top-4 -right-4 text-5xl animate-bounce">✨</div>
                <div class="absolute -bottom-4 -left-4 text-4xl animate-pulse">📚</div>
            </div>
        </div>
        <!-- Splash Screen -->
        <div id="splash-screen" class="page justify-center items-center p-4 text-center">
            <p id="splash-text" data-text-key="splashScreenMessage"
                class="text-xl font-semibold mb-8 tracking-wider text-shadow" style="color:var(--primary-glow)"></p>
            <div class="w-40 h-1 bg-[var(--glass-border)] rounded-full">
                <div class="h-full bg-[var(--primary-glow)] rounded-full animate-[loading-bar_0.8s_linear_forwards]">
                </div>
            </div>
        </div>
        <!-- Student Dashboard -->
        <div id="student-dashboard" class="page h-[100dvh] w-screen overflow-hidden">
            <div
                class="scrolling-banner absolute top-0 left-0 w-full bg-slate-900/50 backdrop-blur-sm whitespace-nowrap overflow-hidden shadow-lg z-50">
                <p data-text-key="scrollingBannerText"></p>
            </div>
            <header class="p-4 flex justify-between items-center mt-2">
                <div class="flex items-center gap-4">
                    <div id="logo-container" class="relative">
                        <img src="https://i.postimg.cc/mgdFZ313/IMG-20250414-WA0047-1.jpg" alt="Logo"
                            class="w-12 h-12 rounded-full glowing-logo" loading="lazy" decoding="async">
                        <div id="timer-live-indicator"
                            class="hidden absolute -top-1 -right-2 flex items-center gap-1.5 bg-red-600/80 backdrop-blur-sm text-white px-2 py-0.5 rounded-full text-xs font-bold border border-red-400">
                            <div class="w-2 h-2 bg-white rounded-full live-pulse"></div>
                            <span>تركيز</span>
                        </div>
                    </div>
                    <button id="notifications-bell"
                        class="relative text-2xl text-slate-300 hover:text-[var(--primary-glow)] transition">
                        <i class="ph-bell"></i>
                        <div id="notification-dot" class="notification-indicator hidden"></div>
                    </button>
                </div>
                <div class="text-right">
                    <h2 id="welcome-name" class="font-bold text-lg">مرحباً يا ...</h2>
                    <p id="user-details" class="text-xs text-slate-400 mt-1">...</p>
                    <p id="student-id" class="text-xs text-slate-500 mt-1 font-mono"></p>
                </div>
            </header>
            <main class="flex-grow p-4 overflow-y-auto pb-32">
                <div id="materials-list" class="space-y-4 max-w-md mx-auto"></div>
            </main>
            <footer
                class="fixed bottom-[calc(64px+env(safe-area-inset-bottom))] sm:bottom-[60px] left-0 w-full p-2 text-center text-xs pointer-events-none z-40">
                <p class="footer-text" data-text-key="footerText"></p>
            </footer>
            <nav class="bottom-nav fixed bottom-0 right-0 left-0 glass-effect flex text-xs z-50 p-1">
                <!-- Removed Books button -->
                <button onclick="showSubjectSelectionModal('sections')"
                    class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i
                        class="ph-stack-simple text-xl"></i><span>سكاشن</span></button>
                <button id="courses-btn" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i
                        class="ph-cube unlocked-icon-3d text-xl"></i><span>كورسات</span></button>
                <button data-modal="ai-tools-modal" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i
                        class="ph-robot text-xl"></i><span>أدوات AI</span></button>
                <!-- CALCULATOR REMOVED -->
                <button data-modal="opinions-modal" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i
                        class="ph-chats-teardrop text-xl"></i><span>آراء</span></button>
                <button data-modal="polls-modal" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i
                        class="ph-megaphone-simple text-xl"></i><span>استطلاعات</span></button>
                <!-- Meeting Button Removed -->
                <button id="weekly-exams-nav-btn"
                    class="bottom-nav-btn flex flex-col items-center space-y-1 p-2 relative">
                    <i class="ph-clipboard-text text-xl"></i>
                    <span>امتحان أسبوعي</span>
                    <!-- Red dot will be injected via JS if exam exists -->
                </button>
                <button id="digital-card-nav-btn" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i
                        class="ph-identification-card text-xl"></i><span>بطاقتي</span></button>
                <button id="summary-nav-btn" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i
                        class="ph-notebook text-xl"></i><span>تلخيص</span></button>

                <button onclick="openShounSection()" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i
                        class="ph-phone-call text-xl"></i><span>الشئون</span></button>
                <!-- Explanation Button Removed -->
                <button id="privacy-policy-nav-btn" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i
                        class="ph-shield-check text-xl"></i><span>الخصوصية</span></button>
                <button data-modal="support-modal" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i
                        class="ph-headset text-xl"></i><span>الدعم</span></button>
                <button data-modal="about-modal" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i
                        class="ph-info text-xl"></i><span>عنا</span></button>
                <button id="platform-btn" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i
                        class="ph-globe-hemisphere-west text-xl"></i><span>المنصة</span></button>
                <button id="study-timer-nav-btn" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i
                        class="ph-timer text-xl"></i><span>تايمر</span></button>
                <button data-modal="settings-modal" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i
                        class="ph-gear-six text-xl"></i><span>الإعدادات</span></button>
                <button id="account-options-btn" class="bottom-nav-btn flex flex-col items-center space-y-1 p-2"><i
                        class="ph-user-circle text-xl"></i><span>حسابي</span></button>
            </nav>
        </div>



        <!-- Subject Content Page -->
        <div id="subject-content-page" class="page h-[100dvh] w-screen overflow-hidden"></div>
        <!-- Digital Student Card Page -->
        <div id="digital-card-page" class="page h-[100dvh] w-screen overflow-y-auto p-4">
            <div class="max-w-md mx-auto">
                <div class="flex items-center justify-between mb-6">
                    <button id="back-from-card-btn" class="text-2xl hover:text-[var(--primary-glow)] transition">
                        <i class="ph-arrow-right"></i>
                    </button>
                    <h2 class="text-2xl font-bold text-[var(--primary-glow)]">بطاقتي الرقمية</h2>
                    <div class="w-8"></div>
                </div>

                <div class="modern-glass-card card-interactive p-6 space-y-6">
                    <!-- Student Photo -->
                    <div class="flex justify-center">
                        <div
                            class="w-32 h-32 rounded-full bg-gradient-to-br from-[var(--primary-glow)] to-[var(--secondary-glow)] p-1">
                            <div class="w-full h-full rounded-full bg-slate-800 flex items-center justify-center">
                                <i class="ph-user text-6xl text-[var(--primary-glow)]"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Student Info -->
                    <div class="space-y-4">
                        <div class="text-center">
                            <h3 id="card-student-name" class="text-2xl font-bold text-white mb-1"></h3>
                            <p id="card-student-id" class="text-sm text-slate-400"></p>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="glass-effect p-3 rounded-lg">
                                <p class="text-xs text-slate-400 mb-1">الفرقة</p>
                                <p id="card-year" class="font-bold text-white"></p>
                            </div>
                            <div class="glass-effect p-3 rounded-lg">
                                <p class="text-xs text-slate-400 mb-1">الشعبة</p>
                                <p id="card-division" class="font-bold text-white"></p>
                            </div>
                        </div>

                        <div class="glass-effect p-3 rounded-lg">
                            <p class="text-xs text-slate-400 mb-1">البريد الإلكتروني</p>
                            <p id="card-email" class="font-bold text-white text-sm break-all"></p>
                        </div>
                    </div>

                    <!-- QR Code -->
                    <div class="space-y-3">
                        <div class="flex justify-center">
                            <div id="student-qr-code" class="bg-white p-4 rounded-lg"></div>
                        </div>
                        <p class="text-center text-xs text-slate-400">امسح الكود لعرض بياناتي</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="page h-[100dvh] w-screen overflow-hidden">
            <div class="flex flex-col lg:flex-row h-full">
                <aside class="w-full lg:w-72 glass-effect p-4 flex flex-col flex-shrink-0">
                    <h1 class="text-2xl font-bold text-[var(--primary-glow)] mb-8">لوحة التحكم</h1>
                    <nav class="flex-grow flex flex-col space-y-2 overflow-y-auto">
                        <button data-panel="info-panel" class="admin-nav-btn text-right p-3 rounded-lg">لوحة
                            المعلومات</button>
                        <button data-panel="students-panel" class="admin-nav-btn text-right p-3 rounded-lg">إدارة
                            الطلاب</button>
                        <button data-panel="tickets-panel" class="admin-nav-btn text-right p-3 rounded-lg">إدارة
                            الشكاوى</button>
                        <button data-panel="live-stream-panel" class="admin-nav-btn text-right p-3 rounded-lg">إدارة
                            البث المباشر</button>
                        <!-- Removed books from content panel -->
                        <button data-panel="content-panel" class="admin-nav-btn text-right p-3 rounded-lg">إدارة
                            المحتوى</button>
                        <button data-panel="exams-panel"
                            class="admin-nav-btn text-right p-3 rounded-lg flex items-center justify-between">
                            <span>امتحانات الأسبوع</span>
                            <span
                                class="bg-[var(--primary-glow)] text-black text-xs font-bold px-1.5 rounded-full">جديد</span>
                        </button>
                        <button data-panel="text-management-panel" class="admin-nav-btn text-right p-3 rounded-lg">إدارة
                            النصوص</button>
                        <button data-panel="notifications-panel"
                            class="admin-nav-btn text-right p-3 rounded-lg">الإشعارات</button>
                        <button data-panel="courses-panel" class="admin-nav-btn text-right p-3 rounded-lg">إدارة
                            الكورسات</button>
                        <button data-panel="ai-tools-panel" class="admin-nav-btn text-right p-3 rounded-lg">إدارة أدوات
                            AI</button>
                        <button data-panel="opinions-panel" class="admin-nav-btn text-right p-3 rounded-lg">آراء
                            الطلاب</button>
                        <button data-panel="polls-panel" class="admin-nav-btn text-right p-3 rounded-lg">إدارة
                            الاستطلاعات</button>
                        <button data-panel="corrections-panel" class="admin-nav-btn text-right p-3 rounded-lg">تصحيحات
                            المحاضرات</button>
                        <button data-panel="settings-panel" class="admin-nav-btn text-right p-3 rounded-lg">إعدادات
                            الموقع</button>
                        <button data-panel="exam-results-panel" class="admin-nav-btn text-right p-3 rounded-lg">نتائج
                            الامتحانات</button>
                        <button data-panel="lecture-exams-panel"
                            class="admin-nav-btn text-right p-3 rounded-lg flex items-center justify-between">
                            <span>امتحان المحاضرة</span>
                            <span class="bg-cyan-500 text-black text-[8px] px-1 rounded-full font-bold">جديد</span>
                        </button>
                        <button data-panel="lecture-exam-results-panel"
                            class="admin-nav-btn text-right p-3 rounded-lg flex items-center justify-between">
                            <span>نتائج المحاضرة</span>
                            <span class="bg-amber-500 text-black text-[8px] px-1 rounded-full font-bold">جديد</span>
                        </button>
                        <button data-panel="attendance-panel" class="admin-nav-btn text-right p-3 rounded-lg">تسجيل
                            الحضور</button>
                    </nav>
                    <div class="mt-auto flex-shrink-0 pt-4">
                        <button id="admin-logout-btn"
                            class="w-full py-2 rounded-lg text-lg font-bold btn-celestial border-red-500 text-red-500 hover:bg-red-500 hover:text-white">خروج</button>
                    </div>
                </aside>
                <main class="flex-grow p-4 md:p-8 overflow-y-auto">
                    <!-- Existing panels remain unchanged -->
                    <div id="info-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">لوحة المعلومات</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 text-center">
                            <div class="glass-effect p-6 rounded-lg" style="animation-delay: 0.1s;">
                                <h3 class="text-lg text-slate-400">إجمالي الطلاب</h3>
                                <p id="admin-student-count"
                                    class="text-4xl font-bold text-[var(--primary-glow)] mt-2 transition-all">0</p>
                            </div>
                            <div class="glass-effect p-6 rounded-lg" style="animation-delay: 0.2s;">
                                <h3 class="text-lg text-slate-400">إجمالي الآراء</h3>
                                <p id="admin-opinions-count"
                                    class="text-4xl font-bold text-[var(--secondary-glow)] mt-2 transition-all">0</p>
                            </div>
                            <div class="glass-effect p-6 rounded-lg" style="animation-delay: 0.3s;">
                                <h3 class="text-lg text-slate-400">إجمالي الاستطلاعات</h3>
                                <p id="admin-polls-count" class="text-4xl font-bold text-cyan-400 mt-2 transition-all">0
                                </p>
                            </div>
                            <div
                                class="glass-effect p-6 rounded-3xl border border-white/5 flex flex-col items-center justify-center text-center">
                                <p class="text-xs text-slate-400 uppercase tracking-widest mb-2">إجمالي الامتحانات</p>
                                <h3 id="admin-exams-count-badge" class="text-4xl font-black text-[var(--primary-glow)]">
                                    0</h3>
                                <button onclick="clearAllWeeklyExams()"
                                    class="mt-4 text-[10px] text-red-500 hover:text-red-400 font-bold uppercase tracking-tighter border border-red-500/20 px-3 py-1 rounded-full hover:bg-red-500/10 transition">تنظيف
                                    قاعدة البيانات</button>
                            </div>
                            <div class="glass-effect p-6 rounded-lg" style="animation-delay: 0.4s;">
                                <h3 class="text-lg text-slate-400">إجمالي التقييمات</h3>
                                <p id="admin-ratings-count"
                                    class="text-4xl font-bold text-yellow-400 mt-2 transition-all">0</p>
                            </div>
                            <div class="glass-effect p-6 rounded-lg" style="animation-delay: 0.5s;">
                                <h3 class="text-lg text-slate-400">إجمالي الإشعارات</h3>
                                <p id="admin-notifications-count"
                                    class="text-4xl font-bold text-rose-400 mt-2 transition-all">0</p>
                            </div>
                            <div class="glass-effect p-6 rounded-lg" style="animation-delay: 0.6s;">
                                <h3 class="text-lg text-slate-400">تنزيلات التطبيق</h3>
                                <p id="app-downloads-count"
                                    class="text-4xl font-bold text-purple-400 mt-2 transition-all">0</p>
                                <button id="view-downloads-btn"
                                    class="mt-3 py-1.5 px-4 rounded-lg text-sm font-bold btn-celestial">عرض
                                    التنزيلات</button>
                            </div>
                        </div>
                    </div>
                    <div id="live-stream-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">إدارة البث المباشر</h2>
                        <div class="space-y-6 max-w-2xl">
                            <div class="glass-effect p-6 rounded-lg">
                                <h3 class="font-bold text-lg mb-2 text-slate-300">الخطوة 1: ضع رابط البث الأساسي (مرة
                                    واحدة فقط)</h3>
                                <p class="text-xs text-slate-500 mb-4">ضع هنا رابط جوجل ميت الدائم الذي ستستخدمه في كل
                                    محاضراتك.</p>
                                <div class="flex gap-3">
                                    <input type="url" id="meet-link-input"
                                        placeholder="https://meet.google.com/xyz-abcd-efg"
                                        class="w-full rounded-lg input-field">
                                    <button id="save-meet-link-btn"
                                        class="py-2 px-6 rounded-lg font-bold btn-celestial flex-shrink-0">حفظ</button>
                                </div>
                            </div>
                            <div class="glass-effect p-6 rounded-lg text-center">
                                <h3 class="font-bold text-lg mb-2 text-slate-300">الخطوة 2: تحكم في البث المباشر</h3>
                                <p class="text-sm text-slate-400 mb-4">استخدم هذه الأزرار لبدء وإنهاء ظهور إشعار الدخول
                                    عند الطلاب.</p>
                                <div class="flex justify-center items-center gap-3 mb-4">
                                    <p class="text-slate-300">الحالة الحالية:</p>
                                    <span id="stream-status-indicator"
                                        class="px-3 py-1 rounded-full text-sm font-bold"></span>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <button id="start-stream-btn"
                                        class="py-3 rounded-lg font-bold text-lg bg-green-600 text-white hover:bg-green-500 transition shadow-lg shadow-green-500/20 disabled:bg-slate-600 disabled:cursor-not-allowed">🚀
                                        بدء البث الآن</button>
                                    <button id="end-stream-btn"
                                        class="py-3 rounded-lg font-bold text-lg bg-red-600 text-white hover:bg-red-500 transition shadow-lg shadow-red-500/20 disabled:bg-slate-600 disabled:cursor-not-allowed">⏹️
                                        إنهاء البث الآن</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="attendance-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">سجل الحضور</h2>
                        <div id="attendance-list" class="space-y-4">
                            <p class="text-center text-slate-400">جارٍ تحميل سجل الحضور...</p>
                        </div>
                    </div>
                    <div id="tickets-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">إدارة الشكاوى والدعم الفني</h2>
                        <div id="admin-tickets-list" class="space-y-4"></div>
                    </div>
                    <div id="students-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">إدارة الطلاب</h2>
                        <div id="admin-students-list" class="space-y-4"></div>
                    </div>
                    <div id="content-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">إدارة المحتوى</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div>
                                <div class="glass-effect p-6 rounded-lg">
                                    <h3 id="content-form-title" class="text-xl font-bold mb-4">إضافة محتوى جديد</h3>
                                    <!-- Removed books option -->
                                    <select id="content-type-select"
                                        class="w-full rounded-lg select-field appearance-none mb-4">
                                        <option value="lectures">محاضرة</option>
                                        <option value="sections">سكشن</option>
                                    </select>
                                    <select id="content-year-select"
                                        class="w-full rounded-lg select-field appearance-none mb-4">
                                        <option value="">اختر الفرقة</option>
                                        <option value="2">الثانية</option>
                                    </select><select id="content-division-select"
                                        class="w-full rounded-lg select-field appearance-none mb-4">
                                        <option value="">اختر الشعبة</option>
                                        <option value="international">أعمال دولية</option>
                                        <option value="systems">نظم معلومات</option>
                                    </select>
                                    <select id="content-subject-select"
                                        class="w-full rounded-lg select-field appearance-none mb-4">
                                        <option value="">اختر المادة أولاً</option>
                                    </select>
                                    <div class="mb-4">
                                        <label class="block text-sm text-slate-400 mb-2">رفع ملف PDF
                                            (اختياري)</label>
                                        <input id="content-file-input" type="file" accept="application/pdf"
                                            class="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[var(--primary-glow)] file:text-black hover:file:bg-[var(--secondary-glow)] transition file:cursor-pointer custom-file-input">
                                    </div>
                                    <input id="content-title-input" type="text" placeholder="عنوان المحتوى"
                                        class="w-full rounded-lg input-field mb-4"><textarea id="content-body-input"
                                        placeholder="نص المحتوى أو الرابط..." class="w-full rounded-lg input-field mb-4"
                                        rows="4"></textarea>
                                    <div class="flex gap-4"><button id="save-content-btn"
                                            class="w-full py-2 rounded-lg text-sm font-bold btn-celestial">حفظ</button><button
                                            id="cancel-edit-btn"
                                            class="w-full py-2 rounded-lg text-sm font-bold btn-celestial border-yellow-500 text-yellow-500 hover:bg-yellow-500 hover:text-black hidden">إلغاء
                                            التعديل</button></div>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold mb-4">المحتوى المضاف حاليًا</h3>
                                <div id="admin-content-list" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>
                    <div id="text-management-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">إدارة نصوص الموقع</h2>
                        <div id="text-management-form" class="space-y-4"></div>
                        <button id="save-texts-btn"
                            class="w-full max-w-sm mt-6 py-2.5 rounded-lg text-base font-bold btn-celestial">حفظ كل
                            التغييرات</button>
                    </div>
                    <div id="notifications-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">إدارة الإشعارات</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div>
                                <div class="glass-effect p-6 rounded-lg">
                                    <h3 class="text-xl font-bold mb-4">إرسال إشعار جديد</h3><input
                                        id="notification-title-input" type="text" placeholder="عنوان الإشعار (اختياري)"
                                        class="w-full rounded-lg input-field mb-4"><textarea
                                        id="notification-body-input" placeholder="نص الإشعار..."
                                        class="w-full rounded-lg input-field mb-4" rows="4"></textarea><button
                                        id="send-notification-btn"
                                        class="w-full py-2 rounded-lg text-sm font-bold btn-celestial">إرسال</button>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold mb-4">الإشعارات المرسلة</h3>
                                <div id="admin-notifications-list" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>
                    <div id="courses-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">إدارة الكورسات</h2>
                        <div class="glass-effect p-6 rounded-lg mb-6">
                            <h3 class="font-bold mb-4">إضافة فئة كورس جديدة</h3>
                            <input id="course-category-input" type="text" placeholder="اسم الفئة (مثال: المونتاج)"
                                class="w-full rounded-lg input-field mb-4">
                            <button id="add-course-category-btn"
                                class="w-full py-2 rounded-lg font-bold btn-celestial">إضافة فئة</button>
                            <hr class="my-4 border-slate-700/50">
                            <h3 class="font-bold mb-4">إضافة كورس جديد</h3>
                            <select id="course-category-select"
                                class="w-full rounded-lg select-field appearance-none mb-4">
                                <option value="">اختر الفئة</option>
                            </select>
                            <input id="course-title-input" type="text" placeholder="عنوان الكورس"
                                class="w-full rounded-lg input-field mb-4">
                            <textarea id="course-desc-input" placeholder="وصف الكورس"
                                class="w-full rounded-lg input-field mb-4" rows="3"></textarea>
                            <input id="course-url-input" type="text" placeholder="رابط فيديو يوتيوب"
                                class="w-full rounded-lg input-field mb-4">
                            <button id="add-course-btn" class="w-full py-2 rounded-lg font-bold btn-celestial">إضافة
                                الكورس</button>
                        </div>
                        <div id="admin-courses-list" class="space-y-4"></div>
                    </div>
                    <div id="ai-tools-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">إدارة أدوات AI</h2>
                        <div class="glass-effect p-6 rounded-lg mb-6">
                            <h3 class="font-bold mb-4">إضافة أداة جديدة</h3><input id="ai-name-input" type="text"
                                placeholder="اسم الأداة" class="w-full rounded-lg input-field mb-4"><input
                                id="ai-desc-input" type="text" placeholder="وصف الأداة"
                                class="w-full rounded-lg input-field mb-4"><input id="ai-url-input" type="text"
                                placeholder="رابط الأداة" class="w-full rounded-lg input-field mb-4"><button
                                id="add-ai-tool-btn" class="w-full py-2 rounded-lg font-bold btn-celestial">إضافة
                                الأداة</button>
                        </div>
                        <div id="admin-ai-tools-list" class="space-y-4"></div>
                    </div>
                    <div id="opinions-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">آراء الطلاب</h2>
                        <div id="admin-opinions-list" class="space-y-4"></div>
                    </div>
                    <div id="polls-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">إدارة الاستطلاعات</h2>
                        <div id="admin-polls-list" class="space-y-4"></div>
                    </div>
                    <!-- NEW: Corrections Panel -->
                    <div id="corrections-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">تصحيحات المحاضرات</h2>
                        <div id="admin-corrections-list" class="space-y-4">
                            <p class="text-center text-slate-400">جارٍ تحميل طلبات التصحيح...</p>
                        </div>
                    </div>
                    <!-- NEW: Weekly Exams Panel -->
                    <div id="exams-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">إدارة امتحانات الأسبوع</h2>

                        <!-- Filters -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <select id="exam-year-select" class="rounded-lg select-field appearance-none">
                                <option value="2" selected>الثانية</option>
                            </select>
                            <select id="exam-division-select" class="rounded-lg select-field appearance-none">
                                <option value="">اختر الشعبة</option>
                                <option value="international">أعمال دولية</option>
                                <option value="systems">نظم معلومات</option>
                            </select>
                            <select id="exam-subject-select" class="rounded-lg select-field appearance-none">
                                <option value="">اختر المادة</option>
                            </select>
                        </div>

                        <!-- Exam Management Area -->
                        <div id="exam-management-area" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Create New Exam -->
                            <div>
                                <div class="glass-effect p-6 rounded-lg sticky top-4">
                                    <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                                        <i class="ph-plus-circle text-[var(--primary-glow)]"></i>
                                        إنشاء امتحان جديد
                                    </h3>
                                    <input id="exam-title-input" type="text" placeholder="عنوان الامتحان"
                                        class="w-full rounded-lg input-field mb-4">
                                    <div class="mb-4">
                                        <p class="text-sm text-slate-400 mb-2">الأسئلة (50 سؤال)</p>
                                        <div id="questions-builder-container"
                                            class="space-y-3 max-h-[400px] overflow-y-auto custom-scrollbar p-2 border border-white/10 rounded-lg bg-black/20">
                                            <p class="text-center text-slate-500 py-10">اضغط "إضافة سؤال" للبدء</p>
                                        </div>
                                        <button id="add-question-btn"
                                            class="w-full mt-3 py-2 rounded-lg border border-dashed border-slate-500 text-slate-400 hover:text-white hover:border-white transition flex items-center justify-center gap-2">
                                            <i class="ph-plus"></i> إضافة سؤال جديد
                                        </button>
                                    </div>
                                    <div class="flex gap-4 pt-4 border-t border-white/10">
                                        <button id="save-exam-btn"
                                            class="w-full py-3 rounded-lg text-sm font-bold btn-celestial">حفظ ونشر
                                            الامتحان</button>
                                    </div>
                                </div>
                            </div>
                            <!-- Existing Exams List -->
                            <div>
                                <h3 class="text-xl font-bold mb-4">الامتحانات الحالية</h3>
                                <div id="admin-exams-list" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>

                    <!-- NEW: Exam Results Panel -->
                    <div id="exam-results-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">نتائج الامتحانات</h2>
                        <div id="admin-exam-results-list" class="space-y-4">
                            <p class="text-center text-slate-400">جارٍ تحميل نتائج الطلاب...</p>
                        </div>
                    </div>

                    <!-- NEW: Lecture Exams Panel -->
                    <div id="lecture-exams-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">إدارة امتحانات المحاضرات</h2>

                        <!-- Filters -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                            <select id="lecture-exam-year-select" class="rounded-lg select-field appearance-none">
                                <option value="2" selected>الثانية</option>
                            </select>
                            <select id="lecture-exam-division-select" class="rounded-lg select-field appearance-none">
                                <option value="">اختر الشعبة</option>
                                <option value="international">أعمال دولية</option>
                                <option value="systems">نظم معلومات</option>
                            </select>
                            <select id="lecture-exam-subject-select" class="rounded-lg select-field appearance-none">
                                <option value="">اختر المادة</option>
                            </select>
                            <select id="lecture-exam-lecture-select" class="rounded-lg select-field appearance-none">
                                <option value="">اختر المحاضرة</option>
                            </select>
                        </div>

                        <!-- Exam Management Area -->
                        <div id="lecture-exam-management-area" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Create New Exam -->
                            <div>
                                <div class="glass-effect p-6 rounded-lg sticky top-4">
                                    <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                                        <i class="ph-plus-circle text-cyan-400"></i>
                                        إنشاء امتحان محاضرة
                                    </h3>
                                    <input id="lecture-exam-title-input" type="text" placeholder="عنوان الامتحان"
                                        class="w-full rounded-lg input-field mb-4">
                                    <div class="mb-4">
                                        <p class="text-sm text-slate-400 mb-2">الأسئلة</p>
                                        <div id="lecture-questions-builder-container"
                                            class="space-y-3 max-h-[400px] overflow-y-auto custom-scrollbar p-2 border border-white/10 rounded-lg bg-black/20">
                                            <p class="text-center text-slate-500 py-10">اضغط "إضافة سؤال" للبدء</p>
                                        </div>
                                        <button id="lecture-add-question-btn"
                                            class="w-full mt-3 py-2 rounded-lg border border-dashed border-slate-500 text-slate-400 hover:text-white hover:border-white transition flex items-center justify-center gap-2">
                                            <i class="ph-plus"></i> إضافة سؤال جديد
                                        </button>
                                    </div>
                                    <div class="flex gap-4 pt-4 border-t border-white/10">
                                        <button id="save-lecture-exam-btn"
                                            class="w-full py-3 rounded-lg text-sm font-bold btn-celestial">حفظ ونشر
                                            الامتحان</button>
                                    </div>
                                </div>
                            </div>
                            <!-- Existing Exams List -->
                            <div>
                                <h3 class="text-xl font-bold mb-4">الامتحانات الحالية للمحاضرة</h3>
                                <div id="admin-lecture-exams-list" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>

                    <!-- NEW: Lecture Exam Results Panel -->
                    <div id="lecture-exam-results-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">نتائج امتحانات المحاضرات</h2>
                        <div id="admin-lecture-exam-results-list" class="space-y-4">
                            <p class="text-center text-slate-400">جارٍ تحميل نتائج الطلاب...</p>
                        </div>
                    </div>
                    <div id="settings-panel" class="admin-panel hidden">
                        <h2 class="text-3xl font-bold mb-6">إعدادات الموقع</h2>
                        <div class="space-y-4 max-w-2xl">
                            <div class="glass-effect p-6 rounded-lg space-y-4">
                                <label class="flex items-center justify-between cursor-pointer"><span
                                        class="font-bold">تفعيل
                                        قسم الكورسات (أساسي)</span><input type="checkbox" id="courses-toggle"
                                        class="form-checkbox h-5 w-5 text-[var(--primary-glow)] rounded" checked
                                        disabled></label>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    <!-- Generic Modal -->
    <div id="generic-modal"
        class="modal fixed inset-0 bg-black/70 backdrop-blur-md z-[1000] justify-center items-center p-4">
        <div
            class="modal-content glass-effect w-full max-w-lg max-h-[85dvh] overflow-y-auto p-6 rounded-2xl flex flex-col">
            <div class="flex justify-between items-center mb-6 flex-shrink-0 border-b border-white/5 pb-4">
                <h3 id="modal-title" class="text-2xl font-bold text-[var(--primary-glow)]"></h3>
                <button
                    class="modal-close-btn text-3xl hover:text-red-500 transition-all hover:rotate-90 p-2">×</button>
            </div>
            <div id="modal-body" class="overflow-y-auto flex-grow"></div>
        </div>
    </div>
    <!-- Toast Notification -->
    <div id="toast-notification"
        class="fixed top-5 right-5 glass-effect p-4 rounded-lg shadow-lg z-[2000] opacity-0 -translate-y-12 transition-all duration-500">
        <p id="toast-message"></p>
    </div>
    <!-- Exit Focus Mode Button -->
    </button>
    <!-- Certificate Preview Overlay -->
    <div id="certificate-preview-overlay" class="certificate-overlay" onclick="closeCertPreview()">
        <div id="cert-preview-content" class="w-full max-w-4xl flex justify-center items-center"
            onclick="event.stopPropagation()">
            <!-- Cert content injected here -->
        </div>
        <button onclick="closeCertPreview()"
            class="absolute top-6 right-6 text-5xl text-white hover:text-red-500 transition-all">×</button>
    </div>
    <!-- Audio Container -->
    <div id="audio-container" class="hidden">
        <audio id="register-sound" src="https://code-gemini.github.io/Mora-For-Studying/register.mp3"
            preload="auto"></audio>
        <audio id="timer-start-sound" src="https://code-gemini.github.io/Mora-For-Studying/timer-start.mp3"
            preload="auto"></audio>
        <audio id="timer-end-sound" src="https://code-gemini.github.io/Mora-For-Studying/timer-end.mp3"
            preload="auto"></audio>
        <audio id="admin-notification-sound" src="https://code-gemini.github.io/Mora-For-Studying/notification.mp3"
            preload="auto"></audio>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, getDocs, query, where, onSnapshot, deleteDoc, updateDoc, orderBy, serverTimestamp, getDoc, setDoc, limit, writeBatch, arrayUnion, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, uploadBytesResumable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
        const firebaseConfig = { apiKey: "AIzaSyB92ooyA5_tTx1BLDp2EWmqxHuJQ3zqah4", authDomain: "mora-for-studying.firebaseapp.com", projectId: "mora-for-studying", storageBucket: "mora-for-studying.appspot.com", messagingSenderId: "213416531900", appId: "1:213416531900:web:2e4d8bd2a9e1a4e814bdb9" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.log('Persistence failed: Multiple tabs open');
            } else if (err.code == 'unimplemented') {
                console.log('Persistence unimplemented');
            }
        });
        const storage = getStorage(app);
        let currentUser = null;
        let vantaEffect = null;
        let currentEditState = { id: null, collection: null };
        let currentContentUnsubscribe = null;
        let siteSettings = {};
        let siteTexts = {};
        const badWords = [
            "كلب", "خرا", "متناك", "معرص", "خول", "شرموطة", "كس", "زب", "عير", "قحبة", "ابن الوسخة",
            "عاهرة", "زنا", "لعين", "حقير", "وضيع", "سافل", "شاذ", "شاذة", "عاهر", "زانية", "عاهرات",
            "فاسق", "فاسقة", "منحرف", "منحرفة", "ساقطة", "ساقط", "عاهر", "عاهره", "عاهرة", "عاهرات", "عاهر", "عاهره", "عاهرة",
            "ابن وسخه", "ابن وسخة", "ولد وسخ", "بنت وسخة", "وسخ", "وسخه", "وسخة", "هنيكك", "كسمك", "ابن مىه"
        ];
        const defaultTexts = {
            splashScreenMessage: "متنساش تصلي على النبي ﷺ",
            scrollingBannerText: "شكر خاص لإدارة المعهد وأعضاء هيئة التدريس في تطوير هذا الموقع التعليمي ***",
            footerText: "جميع الحقوق محفوظة © Amr lotfy 2025",
            coursesLockedToast: "الكورسات متاحة للجميع الآن!",
            meetingLockedToast: "سوف يتم فتح هذا القسم عند شرح المواد اونلاين",
            pointsInfo_0: "الكورسات مفتوحة للجميع!",
            pointsInfo_other: "الكورسات مفتوحة للجميع!",
            pointsInfo_unlocked: "الكورسات مفتوحة للجميع!",
            addPointsToast: "تمت إضافة 25 نقطة! ✨",
            aboutMain: "هذا الموقع خاص بالفرقة الأولى والثانية لطلاب المعهد العالي للحاسبات والمعلومات بطنطا.",
            aboutDeveloper: "تطوير Amr lotfy",
            aboutSupervisors: "تحت رعاية"
        };
        const textLabels = {
            splashScreenMessage: "رسالة شاشة البداية", scrollingBannerText: "الشريط الإخباري المتحرك", footerText: "جملة الحقوق المحفوظة", coursesLockedToast: "رسالة قفل قسم الكورسات", meetingLockedToast: "رسالة قفل قسم الميتنج", pointsInfo_0: "رسالة النقاط (عندما تكون صفر)", pointsInfo_other: "رسالة النقاط (عندما تكون أكبر من صفر)", pointsInfo_unlocked: "رسالة النقاط (بعد فتح الكورسات)", addPointsToast: "رسالة إضافة النقاط", aboutMain: "فقرة 'عنا' الرئيسية", aboutDeveloper: "جملة المطور", aboutSupervisors: "عنوان 'تحت رعاية'"
        };
        const materials = {
            ar: { '1_international': ['مبادئ المحاسبة الماليه', 'مبادئ الاقتصاد', 'مبادئ القانون', 'لغه اجنبيه (1)', 'مبادئ اداره الاعمال'], '1_systems': ['طرق ومهارات الاتصال', 'رياضيات الاعمال', 'حقوق الانسان', 'التفكير الابتكاري', 'السلوك التنظيمي', 'اساسيات الحاسب وتكتولوچيا المعلومات'], '2_international': ['محاسبه اداريه', 'لغه اجنبيه: 2', 'اداره الانتاج والعمليات', 'مبادئ الاداره الماليه', 'حزم التطبيقات المكتبيه', 'تحليلات الاعمال والتنقيب عن البيانات'], '2_systems': ['مبادئ ادارة التسويق', 'التأمين وادارة المخاطر', 'تكنولوجيا المعلومات والابتكار', 'نظم المعلومات الاداريه', 'اللغه الاجنبيه', 'اداره الجوده الشامله'] },
        };
        // ======================= DEVICE ICON HELPER =======================
        function getDeviceIcon(userAgent) {
            if (!userAgent) return { icon: '💻', name: 'جهاز غير معروف' };
            if (userAgent.includes('iPhone')) {
                return {
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17.25 14.25a6.75 6.75 0 0 1-6.75 6.75H9a6.75 6.75 0 0 1-6.75-6.75V9A6.75 6.75 0 0 1 9 2.25h1.5a6.75 6.75 0 0 1 6.75 6.75v5.25Z" fill="#007AFF"></path><path d="M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" fill="#007AFF"></path></svg>',
                    name: 'iPhone'
                };
            }
            if (userAgent.includes('Android')) {
                return {
                    icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="#3DDC84"></path></svg>',
                    name: 'Android'
                };
            }
            if (userAgent.includes('Windows')) {
                return { icon: '🪟', name: 'Windows PC' };
            }
            if (userAgent.includes('Macintosh')) {
                return { icon: '🍎', name: 'Mac' };
            }
            return { icon: '💻', name: 'جهاز آخر' };
        }
        // ======================= HELPER FUNCTIONS =======================
        function containsPhoneNumber(text) {
            const phonePattern = /(?:\+?20)?\s*1[0-9]{9}|01[0-9]{8}/;
            return phonePattern.test(text.replace(/\s/g, ''));
        }
        function containsAnyDigit(text) {
            return /\d/.test(text);
        }
        function containsBadWord(text) {
            const lowerText = text.toLowerCase();
            return badWords.some(word => lowerText.includes(word));
        }
        function isContentAllowed(text) {
            return !containsBadWord(text) && !containsPhoneNumber(text) && !containsAnyDigit(text);
        }
        async function checkAndHandleContent(text, userId, userName) {
            if (isContentAllowed(text)) return true;
            try {
                const userDocRef = doc(db, "users", userId);
                const userDoc = await getDoc(userDocRef);
                if (!userDoc.exists()) return false;
                const userData = userDoc.data();
                if (userData.isBanned) return false;
                if (userData.hasWarning) {
                    await updateDoc(userDocRef, { isBanned: true });
                    showToast(`تم حظر حسابك نهائيًا بسبب مخالفة سياسة الموقع.`, true);
                    if (currentUser && currentUser.id === userId) {
                        currentUser.isBanned = true;
                        localStorage.setItem('moraUser', JSON.stringify(currentUser));
                        setTimeout(() => {
                            showPage('auth-page');
                            renderAuthForm(false, false);
                            initVantaBackground();
                        }, 3000);
                    }
                    return false;
                } else {
                    await updateDoc(userDocRef, { hasWarning: true });
                    showToast(`تنبيه هام: سيتم حظر حسابك نهائيًا في حالة تكرار نشر محتوى غير لائق أو يحتوي على أرقام.`, true);
                    return false;
                }
            } catch (error) {
                console.error("Error in content check:", error);
                return false;
            }
        }
        async function updateUserActivity(description) {
            if (currentUser && currentUser.id && !currentUser.isAdmin) {
                try {
                    const userDocRef = doc(db, "users", currentUser.id);
                    await updateDoc(userDocRef, {
                        lastActivity: {
                            timestamp: serverTimestamp(),
                            description: description
                        }
                    });
                } catch (error) { }
            }
        }
        function getYoutubeEmbedUrl(url) {
            let videoId = '';
            try {
                if (url.includes('embed')) return url;
                const urlObj = new URL(url);
                if (urlObj.hostname === 'youtu.be') {
                    videoId = urlObj.pathname.slice(1);
                } else if (urlObj.hostname.includes('youtube.com')) {
                    videoId = urlObj.searchParams.get('v');
                }
            } catch (e) { console.error("Invalid URL:", e) }
            return videoId ? `https://www.youtube.com/embed/${videoId}` : null;
        }
        window.openVideoModal = (url) => {
            const embedUrl = getYoutubeEmbedUrl(url);
            if (embedUrl) {
                const videoHTML = `<div class="video-container"><iframe src="${embedUrl}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full h-[70vh] rounded-lg"></iframe></div>`;
                openModalWithContent('مشاهدة الكورس', videoHTML, showCoursesList);
            } else {
                showToast("رابط الفيديو غير صالح، سيتم فتحه في نافذة جديدة.", true);
                window.open(url, '_blank');
            }
        };
        function getSubjectIcon(subjectName) { const lowerCaseName = subjectName.toLowerCase(); for (const key in subjectIcons) { if (lowerCaseName.includes(key)) return subjectIcons[key]; } return subjectIcons['default']; }
        function parseUserAgent(ua) { if (!ua) return 'N/A'; if (ua.includes('Windows')) return 'Windows PC'; if (ua.includes('Macintosh')) return 'Mac'; if (ua.includes('iPhone')) return 'iPhone'; if (ua.includes('Android')) return 'Android'; if (ua.includes('Linux')) return 'Linux'; return 'Unknown Device'; }
        function showPage(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(p => {
                p.classList.remove('active', 'unified-anim');
            });
            const activePage = document.getElementById(pageId);
            activePage.classList.add('active');
            void activePage.offsetWidth; // Reflow
            activePage.classList.add('unified-anim');
        }
        function showToast(message, isError = false) { const t = document.getElementById('toast-notification'), m = document.getElementById('toast-message'); m.textContent = message; t.className = `fixed top-5 right-5 glass-effect p-4 rounded-lg shadow-lg z-[2000] opacity-100 translate-y-0 transition-all duration-500 ${isError ? 'bg-red-900/50 text-white' : 'bg-green-900/50 text-white'}`; setTimeout(() => { t.className = t.className.replace('opacity-100', 'opacity-0').replace('translate-y-0', '-translate-y-12'); }, 4000); }
        const modalCloseBtn = document.querySelector('#generic-modal .modal-close-btn');
        function closeGenericModal() {
            const m = document.getElementById('generic-modal');
            m.classList.remove('open');
            setTimeout(() => m.classList.remove('water-modal-mode'), 500);
        }
        function openModalWithContent(title, body, onClose = closeGenericModal) {
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modal = document.getElementById('generic-modal');

            modalTitle.textContent = title;
            modalBody.innerHTML = body;

            // Apply unified animation to content
            modalBody.classList.remove('unified-anim');
            void modalBody.offsetWidth; // Trigger reflow
            modalBody.classList.add('unified-anim');

            modal.classList.add('open');
            modalCloseBtn.onclick = onClose;
        }
        function initVantaBackground() { try { if (vantaEffect) return; vantaEffect = VANTA.GLOBE({ el: "#auth-page", mouseControls: true, touchControls: true, gyroControls: false, minHeight: 200.00, minWidth: 200.00, scale: 1.00, scaleMobile: 1.00, color: 0x00f5c3, color2: 0xa78bfa, backgroundColor: 0x0d0d1a, size: 1.2 }); } catch (e) { console.error("Vanta failed to initialize", e); } }
        function destroyVantaBackground() { try { if (vantaEffect) { vantaEffect.destroy(); vantaEffect = null; } } catch (e) { console.error("Vanta failed to destroy", e); } }
        function generateCheckDigit(idString) {
            const digits = idString.match(/\d/g);
            if (!digits) return 0;
            const sum = digits.map(Number).reduce((a, b) => a + b, 0);
            return sum % 10;
        }
        window.handleRedirectWithCountdown = (url, message = "جارٍ التوجيه...") => {
            openModalWithContent(message, `
                <div class="text-center p-8">
                    <i class="ph-globe-hemisphere-west text-6xl text-[var(--primary-glow)] mb-4 redirect-modal-icon"></i>
                    <p class="text-lg">جارٍ تحويلك خلال <span id="redirect-countdown" class="font-bold text-xl">3</span> ثوانٍ...</p>
                    <p class="text-xs text-slate-500 mt-4">تطوير Amr lotfy</p>
                </div>
            `);
            let count = 3;
            const countdownEl = document.getElementById('redirect-countdown');
            const interval = setInterval(() => {
                count--;
                if (countdownEl) countdownEl.textContent = count;
                if (count <= 0) {
                    clearInterval(interval);
                    document.getElementById('generic-modal').classList.remove('open');
                    window.open(url, '_blank');
                }
            }, 1000);
        };
        // ======================= CORRECTION SYSTEM =======================
        window.openCorrectionForm = async (lectureId, lectureTitle, subject) => {
            await updateUserActivity(`يفتح نموذج تصحيح للمحاضرة: ${lectureTitle}`);
            const correctionHTML = `
                <div id="correction-form">
                    <img id="correction-logo" src="https://i.postimg.cc/mgdFZ313/IMG-20250414-WA0047-1.jpg" alt="Logo" loading="lazy" decoding="async">
                    <h3 id="correction-title">نموذج تصحيح المحاضرة</h3>
                    <p id="correction-instructions">يرجى كتابة الخطأ الذي لاحظته في المحاضرة أدناه. سيتم مراجعته من قبل الإدارة.</p>
                    <input type="hidden" id="correction-lecture-id" value="${lectureId}">
                    <input type="hidden" id="correction-lecture-title" value="${lectureTitle}">
                    <input type="hidden" id="correction-subject" value="${subject}">
                    <textarea id="correction-text" class="w-full rounded-lg input-field mb-4" rows="5" placeholder="اكتب وصف الخطأ هنا..."></textarea>
                    <button id="submit-correction-btn" class="w-full py-2 rounded-lg font-bold btn-celestial">إرسال التصحيح</button>
                </div>
            `;
            openModalWithContent('إبلاغ عن خطأ', correctionHTML);
            document.getElementById('submit-correction-btn').addEventListener('click', submitCorrection);
        };
        async function submitCorrection() {
            const lectureId = document.getElementById('correction-lecture-id').value;
            const lectureTitle = document.getElementById('correction-lecture-title').value;
            const subject = document.getElementById('correction-subject').value;
            const text = document.getElementById('correction-text').value.trim();
            if (!text) {
                showToast('يرجى كتابة وصف للخطأ.', true);
                return;
            }
            const isAllowed = await checkAndHandleContent(text, currentUser.id, currentUser.name);
            if (!isAllowed) return;
            await addDoc(collection(db, "lecture_corrections"), {
                userId: currentUser.id,
                userName: currentUser.name,
                userYear: currentUser.year,
                userDivision: currentUser.division,
                lectureId,
                lectureTitle,
                subject,
                text,
                status: 'جديد',
                createdAt: serverTimestamp(),
                isReadByAdmin: false,
                adminReply: ''
            });
            showToast('تم إرسال طلب التصحيح بنجاح! شكرًا لك.');
            document.getElementById('generic-modal').classList.remove('open');
        };
        // ======================= EXPLANATION SECTION =======================
        // Explanation section removed
        window.handleExplanationRedirect = () => {
            const channelUrl = 'https://youtube.com/@moralotfy?si=txiqe7Bzj0rzQm2b';
            openModalWithContent('جارٍ التوجيه...', `
                <div class="text-center p-8">
                    <i class="ph-youtube-logo youtube-3d-icon"></i>
                    <p class="text-lg">سيتم تحويلك خلال <span id="redirect-countdown" class="font-bold text-xl">3</span> ثوانٍ...</p>
                    <p class="text-xs text-slate-500 mt-6">تطوير Amr lotfy</p>
                </div>
            `);
            let count = 3;
            const countdownEl = document.getElementById('redirect-countdown');
            const interval = setInterval(() => {
                count--;
                if (countdownEl) countdownEl.textContent = count;
                if (count <= 0) {
                    clearInterval(interval);
                    document.getElementById('generic-modal').classList.remove('open');
                    window.open(channelUrl, '_blank');
                }
            }, 1000);
        };
        // ======================= ONBOARDING =======================
        let currentOnboardingStep = 0;
        let onboardingSteps = [];
        function generateOnboardingStepsFromNav() {
            const navButtons = document.querySelectorAll('.bottom-nav .bottom-nav-btn:not([id="account-options-btn"]):not([data-modal="settings-modal"])');
            const steps = [];
            navButtons.forEach(btn => {
                const icon = btn.querySelector('i').className;
                const title = btn.querySelector('span').textContent;
                const descriptions = {
                    'سكاشن': 'شاهد شرح السكاشن من المحاضرات.',
                    'كورسات': 'تعلم من كورسات مجانية متنوعة.',
                    'أدوات AI': 'استخدم أدوات ذكاء اصطناعي مساعدة.',
                    'آراء': 'شارك رأيك أو اقرأ آراء زملائك.',
                    'استطلاعات': 'شارك في استطلاعات الرأي والمناقشات.',
                    // 'ميتنج': 'انضم إلى البث المباشر للمحاضرات.',
                    'بطاقتي': 'عرض بطاقتك الرقمية مع رمز QR.',
                    'الخصوصية': 'اقرأ سياسة الخصوصية الخاصة بالموقع.',
                    'الدعم': 'تواصل مع فريق الدعم الفني.',
                    'عنا': 'تعرف على فريق التطوير والمشرفين.',
                    'المنصة': 'الانتقال إلى المنصة الرسمية للمعهد.',
                    'تايمر': 'استخدم تايمر المذاكرة لتحسين تركيزك.',
                    // 'شرح': 'شاهد شروحات المحاضرات بالذكاء الاصطناعي.',
                    'تلخيص': 'استخدم أدوات الذكاء الاصطناعي لتلخيص المحاضرات.'
                };
                steps.push({
                    icon: icon,
                    title: title,
                    text: descriptions[title] || 'استكشف هذه الميزة الجديدة.'
                });
            });
            return steps;
        }
        function showOnboarding() {
            if (localStorage.getItem('onboardingCompleted') === 'true') return;
            onboardingSteps = generateOnboardingStepsFromNav();
            document.getElementById('onboarding-modal').style.display = 'flex';
            updateOnboardingStep(0);
        }
        function updateOnboardingStep(step) {
            currentOnboardingStep = step;
            const iconEl = document.getElementById('onboarding-icon');
            const titleEl = document.getElementById('onboarding-title');
            const textEl = document.getElementById('onboarding-text');
            const nextBtn = document.getElementById('onboarding-next-btn');
            const stepData = onboardingSteps[step];
            iconEl.innerHTML = `<i class="${stepData.icon}"></i>`;
            titleEl.textContent = stepData.title;
            textEl.textContent = stepData.text;
            if (step === onboardingSteps.length - 1) {
                nextBtn.textContent = 'إنهاء';
            } else {
                nextBtn.textContent = 'التالي';
            }
        }
        document.getElementById('onboarding-next-btn').addEventListener('click', () => {
            if (currentOnboardingStep < onboardingSteps.length - 1) {
                updateOnboardingStep(currentOnboardingStep + 1);
            } else {
                document.getElementById('onboarding-modal').style.display = 'none';
                localStorage.setItem('onboardingCompleted', 'true');
            }
        });
        // ======================= PASSWORD SUGGESTIONS SYSTEM =======================
        function generateStrongPassword() {
            const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const lowercase = 'abcdefghijklmnopqrstuvwxyz';
            const numbers = '0123456789';
            const symbols = '!@#$%^&*_+-=[]{}|;:,.<>?';

            let password = '';
            password += uppercase[Math.floor(Math.random() * uppercase.length)];
            password += lowercase[Math.floor(Math.random() * lowercase.length)];
            password += numbers[Math.floor(Math.random() * numbers.length)];
            password += symbols[Math.floor(Math.random() * symbols.length)];

            const allChars = uppercase + lowercase + numbers + symbols;
            for (let i = 4; i < 12; i++) {
                password += allChars[Math.floor(Math.random() * allChars.length)];
            }

            return password.split('').sort(() => Math.random() - 0.5).join('');
        }

        function generatePasswordSuggestions() {
            const suggestions = [];
            for (let i = 0; i < 5; i++) {
                suggestions.push(generateStrongPassword());
            }
            return suggestions;
        }

        function showPasswordSuggestions() {
            const suggestionsList = document.getElementById('password-suggestions-list');
            if (!suggestionsList) return;

            const suggestions = generatePasswordSuggestions();
            let html = '';

            suggestions.forEach(password => {
                html += `
                    <div class="password-suggestion-item" onclick="selectPasswordSuggestion('${password}')">
                        <span class="password-suggestion-text">${password}</span>
                        <i class="ph-copy password-suggestion-copy"></i>
                    </div>
                `;
            });

            suggestionsList.innerHTML = html;
            suggestionsList.classList.add('show');
        }

        function hidePasswordSuggestions() {
            const suggestionsList = document.getElementById('password-suggestions-list');
            if (suggestionsList) {
                suggestionsList.classList.remove('show');
            }
        }

        window.selectPasswordSuggestion = (password) => {
            const passField = document.getElementById('auth-password');
            if (passField) {
                passField.value = password;
                passField.type = 'text';
                hidePasswordSuggestions();
                showToast('تم إدراج كلمة المرور المقترحة ✓');
            }
        };

        // ======================= AUTHENTICATION =======================
        function renderAuthForm(isInitial = true, showRegister = false) {
            const authFormContainer = document.getElementById('auth-form-container');
            authFormContainer.innerHTML = `<div class="relative text-center w-full max-w-sm z-20 pb-12" style="animation: fade-in-up 0.5s 0.1s ease-out backwards;"><img src="https://i.postimg.cc/mgdFZ313/IMG-20250414-WA0047-1.jpg" alt="" class="w-28 h-28 rounded-full mb-4 glowing-logo mx-auto" style="animation: fade-in-up 0.5s 0.2s ease-out backwards;" loading="lazy" decoding="async"><h1 class="text-2xl font-bold mb-1 tracking-wider text-shadow" style="color:var(--primary-glow); animation: fade-in-up 0.5s 0.3s ease-out backwards;">Welcome to Mora</h1><p class="text-xs text-slate-300 mb-6" style="animation: fade-in-up 0.5s 0.4s ease-out backwards;">For Studying</p><div id="auth-content"></div></div>`;
            const authContent = document.getElementById('auth-content');
            if (isInitial) {
                authContent.innerHTML = `<div class="space-y-3" style="animation: fade-in-up 0.6s 0.5s ease-out backwards;"><button id="go-to-register-btn" class="w-40 mx-auto block py-1.5 rounded-lg text-sm font-bold btn-celestial">إنشاء حساب</button><button id="go-to-login-btn" class="w-40 mx-auto block py-1.5 rounded-lg text-sm font-bold btn-celestial">تسجيل الدخول</button></div>`;
                document.getElementById('go-to-register-btn').addEventListener('click', () => renderAuthForm(false, true));
                document.getElementById('go-to-login-btn').addEventListener('click', () => renderAuthForm(false, false));
            } else {
                authContent.innerHTML = `<div class="w-full max-w-md mx-auto relative">
                                    <button id="back-to-initial-btn" class="absolute top-0 right-0 text-2xl text-slate-400 hover:text-white transition-transform hover:scale-110"><i class="ph-arrow-right"></i></button>
                                    <div class="space-y-3 pt-8">
                                        <input type="text" id="auth-name" placeholder="الاسم" class="w-full rounded-lg text-center input-field">
                                        ${showRegister ? `
                                            <select id="auth-year" class="w-full rounded-lg text-center select-field appearance-none"><option value="">اختر الفرقة</option><option value="2">الثانية</option></select>
                                            <select id="auth-division" class="w-full rounded-lg text-center select-field appearance-none"><option value="">اختر الشعبة</option><option value="international">أعمال دولية (IB)</option><option value="systems">نظم معلومات (BIS)</option></select>
                                        ` : ''}
                                        <div class="relative">
                                            <input type="password" id="auth-password" placeholder="كلمة المرور" class="w-full rounded-lg text-center input-field pr-10">
                                            <button id="toggle-password" type="button" class="absolute top-1/2 -translate-y-1/2 right-3 text-slate-400 hover:text-white"><i id="eye-icon" class="ph-eye"></i></button>
                                        </div>
                                        ${showRegister ? `
                                            <div class="password-suggestions-container">
                                                <div id="password-suggestions-list" class="password-suggestions-list"></div>
                                            </div>
                                            <p class="text-xs text-slate-400 !-mt-2">اضغط على حقل المرور للحصول على اقتراحات قوية</p>
                                        ` : ''}
                                        <p id="auth-error-msg" class="text-red-400 h-5"></p>
                                        
                                        ${showRegister ? `
                                            <div id="captcha-container" class="captcha-container">
                                                <div id="captcha-checkbox-wrapper" class="captcha-checkbox-wrapper">
                                                    <div class="flex items-center gap-3">
                                                        <div class="captcha-box">
                                                            <i class="ph-check"></i>
                                                        </div>
                                                        <span class="captcha-label">تأكد من أنك لست روبوت 🤖</span>
                                                    </div>
                                                    <div class="captcha-logo">
                                                        <i class="ph-shield-check"></i>
                                                        <span>MORA CAPTCHA</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ` : ''}

                                        <button id="auth-submit-btn" class="w-full py-2 rounded-lg text-sm font-bold btn-celestial">${showRegister ? 'سجل الآن' : 'دخــــول'}</button>
                                        <button id="auth-toggle-btn" type="button" class="text-xs text-slate-400 hover:text-[var(--primary-glow)] transition">${showRegister ? 'لديك حساب بالفعل؟' : 'ليس لديك حساب؟'}</button>
                                    </div>
                                </div>`;
                document.getElementById('back-to-initial-btn').addEventListener('click', () => renderAuthForm(true));
                document.getElementById('auth-toggle-btn').addEventListener('click', () => renderAuthForm(false, !showRegister));
                const submitBtn = document.getElementById('auth-submit-btn');
                const toggleBtn = document.getElementById('auth-toggle-btn');
                const togglePassBtn = document.getElementById('toggle-password');
                if (submitBtn) {
                    const newHandler = showRegister ? handleRegister : handleLogin;
                    submitBtn.onclick = newHandler;
                }
                if (togglePassBtn) {
                    togglePassBtn.onclick = () => {
                        const passInput = document.getElementById('auth-password');
                        const eyeIcon = document.getElementById('eye-icon');
                        const isPassword = passInput.type === 'password';
                        passInput.type = isPassword ? 'text' : 'password';
                        eyeIcon.className = isPassword ? 'ph-eye-slash' : 'ph-eye';
                    };
                }

                if (showRegister) {
                    const passInput = document.getElementById('auth-password');
                    if (passInput) {
                        passInput.addEventListener('focus', showPasswordSuggestions);
                        passInput.addEventListener('blur', () => {
                            setTimeout(hidePasswordSuggestions, 200);
                        });
                    }
                }

                if (showRegister) {
                    setTimeout(() => {
                        initCaptchaListeners();
                        const captchaContainer = document.getElementById('captcha-container');
                        if (captchaContainer) captchaContainer.style.display = 'block';
                    }, 0);
                }
            }
        }
        // ======================= ALPHANUMERIC CAPTCHA SYSTEM =======================
        window.captchaState = {
            verified: false,
            code: ''
        };

        // ======================= RESULT MODAL STATE =======================
        window.isResultModalVisible = false;

        function generateCaptcha() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // No tricky O, 0, I, 1
            let result = '';
            for (let i = 0; i < 5; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            window.captchaState.code = result;
            renderCaptchaDisplay();
        }

        function renderCaptchaDisplay() {
            const display = document.getElementById('captcha-display-text');
            if (display) {
                display.textContent = window.captchaState.code;
            }
        }

        function initCaptchaListeners() {
            const checkbox = document.getElementById('captcha-checkbox-wrapper');
            const verifyBtn = document.getElementById('captcha-verify-btn');
            const refreshBtn = document.getElementById('captcha-refresh-btn');

            if (checkbox) {
                checkbox.onclick = () => {
                    if (window.captchaState.verified) return;
                    document.getElementById('captcha-modal-overlay').style.display = 'flex';
                    generateCaptcha();
                };
            }

            if (verifyBtn) {
                verifyBtn.onclick = () => {
                    const input = document.getElementById('captcha-input-field');
                    if (!input || !input.value.trim()) {
                        showToast('يرجى إدخال الرمز أولاً', true);
                        return;
                    }
                    if (input.value.toUpperCase() === window.captchaState.code) {
                        window.captchaState.verified = true;
                        document.getElementById('captcha-modal-overlay').style.display = 'none';
                        document.getElementById('captcha-checkbox-wrapper').classList.add('verified');
                        showToast('تم التحقق بنجاح ✓ يمكنك الآن إكمال التسجيل');
                    } else {
                        showToast('الرمز غير صحيح ✗ حاول مرة أخرى', true);
                        generateCaptcha();
                        if (input) input.value = '';
                        input.focus();
                    }
                };
            }

            if (refreshBtn) {
                refreshBtn.onclick = () => {
                    generateCaptcha();
                    const input = document.getElementById('captcha-input-field');
                    if (input) {
                        input.value = '';
                        input.focus();
                    }
                };
            }

            // Allow Enter key to verify
            const input = document.getElementById('captcha-input-field');
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && verifyBtn) {
                        verifyBtn.click();
                    }
                });
            }
        }


        window.selectExamOption = (questionIdx, optionIdx) => {
            if (!window.activeExamSession) return;
            window.activeExamSession.answers[questionIdx] = optionIdx;

            // UI Update for selection
            const labels = document.querySelectorAll(`[id^="q${questionIdx}-opt"]`);
            labels.forEach(l => l.classList.remove('selected'));

            const selectedLabel = document.getElementById(`q${questionIdx}-opt${optionIdx}`);
            if (selectedLabel) selectedLabel.classList.add('selected');
        };

        // Intercept Modal Clicks to close if clicking overlay
        document.getElementById('captcha-modal-overlay').onclick = (e) => {
            if (e.target.id === 'captcha-modal-overlay') {
                e.target.style.display = 'none';
            }
        };

        async function handleRegister() {
            if (!window.captchaState.verified) {
                const captchaContainer = document.getElementById('captcha-container');
                if (captchaContainer) {
                    captchaContainer.style.display = 'block';
                    captchaContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    showToast('يرجى التحقق من اختبار الكابتشا أولاً 🛡️', true);
                }
                return;
            }

            const submitBtn = document.getElementById('auth-submit-btn');
            const errorMsg = document.getElementById('auth-error-msg');
            if (!submitBtn || !errorMsg) return;
            submitBtn.disabled = true; submitBtn.textContent = 'جاري التسجيل...';
            errorMsg.textContent = '';
            try {
                const name = document.getElementById('auth-name').value.trim();
                const year = document.getElementById('auth-year').value;
                const division = document.getElementById('auth-division').value;
                const password = document.getElementById('auth-password').value;
                if (!window.captchaState.verified) {
                    const captchaContainer = document.getElementById('captcha-container');
                    if (captchaContainer) {
                        captchaContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        showToast('يرجى التحقق من اختبار الكابتشا أولاً 🛡️', true);
                    }
                    return;
                }

                if (!name || !year || !division || !password) throw new Error('يرجى ملء جميع الحقول');
                if (password.length < 8) throw new Error('كلمة المرور يجب أن تكون 8 أحرف على الأقل');
                const qName = query(collection(db, "users"), where("name", "==", name));
                const nameSnapshot = await getDocs(qName);
                if (!nameSnapshot.empty) throw new Error('هذا الاسم مستخدم بالفعل');
                const yearCode = new Date().getFullYear().toString().slice(-2);
                const divisionCode = division === 'systems' ? 'BIS' : 'IB';
                const qCount = query(collection(db, "users"), where("year", "==", year), where("division", "==", division));
                const countSnapshot = await getDocs(qCount);
                const newStudentNumber = (countSnapshot.size + 1).toString().padStart(4, '0');
                const baseId = `HICMT-${yearCode}-${year}-${divisionCode}-${newStudentNumber}`;
                const checkDigit = generateCheckDigit(baseId);
                const studentId = `${baseId}-${checkDigit}`;
                let ipAddress = 'N/A', city = 'N/A', country = 'N/A';
                try {
                    const ipRes = await fetch('https://api.ipify.org?format=json');
                    if (ipRes.ok) {
                        const ipData = await ipRes.json();
                        ipAddress = ipData.ip;
                        const geoRes = await fetch(`https://ipapi.co/${ipAddress}/json/`);
                        if (geoRes.ok) {
                            const geoData = await geoRes.json();
                            city = geoData.city || 'N/A'; country = geoData.country || 'N/A';
                        }
                    }
                } catch (e) { console.error('GeoIP Error:', e); }
                const isBanned = await getDoc(doc(db, "banned_ips", ipAddress));
                if (isBanned.exists()) throw new Error("هذا الجهاز محظور من استخدام الموقع.");
                const userAgent = navigator.userAgent;
                const newUser = { studentId, name, year, division, password, points: 0, isBanned: false, createdAt: serverTimestamp(), lastActivity: { timestamp: serverTimestamp(), description: "انضم حديثاً" }, completedLectures: [], ipAddress, userAgent, city, country, blogContent: "", coursesUnlocked: true, cardCustomization: {}, hasRated: false, hasAgreedPrivacy: true, hasWarning: false };
                const docRef = await addDoc(collection(db, "users"), newUser);
                currentUser = { id: docRef.id, ...newUser };
                localStorage.setItem('moraUser', JSON.stringify(currentUser));
                destroyVantaBackground();
                document.getElementById('register-sound').play();
                showPage('splash-screen');
            } catch (error) {
                errorMsg.textContent = error.message;
                submitBtn.disabled = false;
                submitBtn.textContent = 'سجل الآن';
            }
        }
        async function handleLogin() {
            const submitBtn = document.getElementById('auth-submit-btn');
            const errorMsg = document.getElementById('auth-error-msg');
            if (!submitBtn || !errorMsg) return;
            submitBtn.disabled = true;
            submitBtn.textContent = 'جاري الدخول...';
            errorMsg.textContent = '';
            try {
                let ipAddress = 'N/A';
                try {
                    const ipRes = await fetch('https://api.ipify.org?format=json');
                    if (ipRes.ok) { const ipData = await ipRes.json(); ipAddress = ipData.ip; }
                } catch (e) { console.error('IP Error:', e); }
                const isBanned = await getDoc(doc(db, "banned_ips", ipAddress));
                if (isBanned.exists()) throw new Error("هذا الجهاز محظور من استخدام الموقع.");
                const name = document.getElementById('auth-name').value.trim();
                const password = document.getElementById('auth-password').value;
                if (!name || !password) throw new Error('يرجى إدخال البيانات');
                if (name === 'admen' && password === 'Amr1221@gmail.com') {
                    destroyVantaBackground();
                    currentUser = { name: 'Admin', isAdmin: true };
                    localStorage.setItem('moraUser', JSON.stringify(currentUser));
                    showPage('splash-screen'); return;
                }
                const q = query(collection(db, "users"), where("name", "==", name), where("password", "==", password));
                const snapshot = await getDocs(q);
                if (snapshot.empty) throw new Error('البيانات غير صحيحة أو يجب عليك إنشاء حساب أولاً');
                const userDoc = snapshot.docs[0];
                if (userDoc.data().isBanned) throw new Error('هذا الحساب محظور');
                destroyVantaBackground();
                currentUser = { id: userDoc.id, ...userDoc.data() };
                await updateUserActivity("سجل الدخول للتو");
                localStorage.setItem('moraUser', JSON.stringify(currentUser));
                showPage('splash-screen');
            } catch (error) {
                errorMsg.textContent = error.message;
                submitBtn.disabled = false;
                submitBtn.textContent = 'دخــــول';
            }
        }
        // ======================= STUDENT DASHBOARD =======================
        function initStudentDashboard() {
            showPage('student-dashboard');
            studentDashboardEl.welcomeName.textContent = `مرحبا يـ ${currentUser.name}`;
            studentDashboardEl.userDetails.textContent = `${currentUser.year === '1' ? "الفرقة الأولى" : "الفرقة الثانية"} - ${currentUser.division === "international" ? "أعمال دولية (IB)" : "نظم معلومات (BIS)"}`;
            studentDashboardEl.studentId.textContent = `ID: ${currentUser.studentId || 'N/A'}`;
            activateNavButtons();
            loadMaterialsForStudent();
            listenToSiteSettings();
            listenForNotifications();
            listenForSupportReplies();
            listenForCorrections();
            initWeeklyExamsIndicator();
            setTimeout(showOnboarding, 800);
        }
        const studentDashboardEl = { welcomeName: document.getElementById('welcome-name'), userDetails: document.getElementById('user-details'), studentId: document.getElementById('student-id'), materialsList: document.getElementById('materials-list') };
        const adminDashboardEl = {
            studentCount: document.getElementById('admin-student-count'),
            notificationsCount: document.getElementById('admin-notifications-count'),
            opinionsCount: document.getElementById('admin-opinions-count'),
            ratingsCount: document.getElementById('admin-ratings-count'),
            studentsList: document.getElementById('admin-students-list'),
            opinionsList: document.getElementById('admin-opinions-list'),
            coursesList: document.getElementById('admin-courses-list'),
            aiToolsList: document.getElementById('admin-ai-tools-list'),
            notificationsList: document.getElementById('admin-notifications-list'),
            pollsCount: document.getElementById('admin-polls-count'),
            pollsList: document.getElementById('admin-polls-list'),
            correctionsList: document.getElementById('admin-corrections-list'),
            examsCount: document.getElementById('admin-exams-count-badge')
        };
        const adminContentPanelEl = { type: document.getElementById('content-type-select'), year: document.getElementById('content-year-select'), division: document.getElementById('content-division-select'), subject: document.getElementById('content-subject-select'), title: document.getElementById('content-title-input'), body: document.getElementById('content-body-input'), saveBtn: document.getElementById('save-content-btn'), formTitle: document.getElementById('content-form-title'), contentList: document.getElementById('admin-content-list'), cancelBtn: document.getElementById('cancel-edit-btn') };
        const subjectIcons = { 'محاسبه': 'ph-calculator', 'اقتصاد': 'ph-chart-bar', 'قانون': 'ph-scales', 'اداره': 'ph-briefcase', 'تسويق': 'ph-megaphone', 'لوچيستيات': 'ph-truck', 'حاسب': 'ph-desktop-tower', 'بيانات': 'ph-database', 'برامج': 'ph-code-simple', 'رياضيات': 'ph-function', 'تطبيقات': 'ph-desktop', 'اتصال': 'ph-chats-circle', 'سلوك': 'ph-users-three', 'تفكير': 'ph-lightbulb', 'انتاج': 'ph-factory', 'انسان': 'ph-hand-heart', 'لغه': 'ph-translate', 'تأمين': 'ph-shield-check', 'جوده': 'ph-star', 'تكنولوجيا': 'ph-cpu', 'نظم': 'ph-tree-structure', 'ابتكار': 'ph-lightbulb', 'default': 'ph-book-open-text' };
        function loadMaterialsForStudent() {
            const userMaterials = materials['ar'][`${currentUser.year}_${currentUser.division}`] || [];

            // Switch to Grid Layout
            studentDashboardEl.materialsList.className = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 pb-24 max-w-4xl mx-auto px-2";

            studentDashboardEl.materialsList.innerHTML = userMaterials.map((mat, index) => {
                const iconClass = getSubjectIcon(mat);
                const delay = index * 100;

                return `
                    <div class="subject-card-modern rounded-2xl p-6 flex items-center justify-between gap-4 cursor-pointer group" 
                         onclick="openSubjectPage('${mat}')"
                         style="animation-delay: ${delay}ms">
                        
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-white/5 flex items-center justify-center group-hover:bg-[var(--primary-glow)] group-hover:text-black transition-colors duration-300">
                                <i class="${iconClass} text-2xl group-hover:scale-110 transition-transform"></i>
                            </div>
                            <div class="flex items-center">
                                <h4 class="text-lg font-bold text-slate-100 group-hover:text-white transition-colors">${mat}</h4>
                            </div>
                        </div>
                        
                        <i class="ph-caret-left text-slate-500 group-hover:text-[var(--primary-glow)] group-hover:-translate-x-1 transition-all"></i>
                    </div>
                `;
            }).join('');
        }
        window.goBackToDashboard = () => { if (currentContentUnsubscribe) currentContentUnsubscribe(); showPage('student-dashboard'); document.getElementById('subject-content-page').innerHTML = ''; }
        window.openSubjectPage = async (subject) => {
            updateUserActivity(`يتصفح مادة: ${subject}`); // Removed await for instant UI response
            const subjectPage = document.getElementById('subject-content-page');
            const pageHTML = `
                <header class="p-4 text-center">
                    <h2 class="text-xl font-bold text-[var(--primary-glow)]">${subject}</h2>
                    <button onclick="goBackToDashboard()" class="text-2xl hover:text-[var(--primary-glow)] transition mt-2"><i class="ph-arrow-right"></i></button>
                    ${!navigator.onLine ? '<p class="text-xs text-yellow-400 mt-1">وضع عدم الاتصال (المحتويات المحفوظة فقط)</p>' : ''}
                </header>
                <main class="flex-grow p-4 overflow-y-auto pb-5"><div id="subject-lectures" class="text-center pt-4"><i class="ph-spinner ph-spin text-2xl"></i></div></main>
            `;
            subjectPage.innerHTML = pageHTML;
            showPage('subject-content-page');
            const lecturesContainer = document.getElementById('subject-lectures');

            // Query for lectures - Firestore persistence handles offline automatically
            const q = query(collection(db, 'lectures'), where("year", "==", currentUser.year), where("division", "==", currentUser.division), where("subject", "==", subject), where("isHidden", "==", false), orderBy('createdAt', 'desc'));

            currentContentUnsubscribe = onSnapshot(q, { includeMetadataChanges: true }, async (snapshot) => {
                if (snapshot.empty) {
                    lecturesContainer.innerHTML = `<p class="text-slate-400 py-4">لا توجد محاضرات منشورة لهذه المادة حالياً.</p>`;
                } else {
                    let contentHTML = '<div class="space-y-3">';
                    if (snapshot.metadata.fromCache) console.log("Loading user lectures from cache");

                    // Check for exams for each lecture
                    for (const doc of snapshot.docs) {
                        const item = doc.data();
                        const isProcessing = item.body === "PROCESSING_UPLOAD...";
                        const clickHandler = isProcessing
                            ? "showToast('جاري تحميل الملف...', true)"
                            : `viewContentDetail('${doc.id}', '${item.title}', '${btoa(encodeURIComponent(item.body))}', '${subject}')`;

                        // Check if exam exists for this lecture AND if student hasn't completed it
                        let showExamIndicator = false;
                        try {
                            const examQuery = query(collection(db, 'lecture_exams'),
                                where('lectureId', '==', doc.id),
                                where('isHidden', '==', false)
                            );
                            const examSnapshot = await getDocs(examQuery);

                            if (!examSnapshot.empty) {
                                // Check if student has completed this exam
                                const resultsQuery = query(collection(db, 'lecture_exam_results'),
                                    where('lectureId', '==', doc.id),
                                    where('userId', '==', currentUser.id)
                                );
                                const resultsSnapshot = await getDocs(resultsQuery);

                                // Show indicator only if exam exists AND student hasn't completed it
                                showExamIndicator = resultsSnapshot.empty;
                            }
                        } catch (e) {
                            console.error('Error checking exam:', e);
                        }

                        // Red indicator on exam button
                        const examButtonHTML = showExamIndicator
                            ? `<button class="lecture-exam-btn relative" onclick="event.stopPropagation(); openLectureExam('${doc.id}', '${item.title}', '${subject}')">
                                امتحان
                                <span class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse"></span>
                               </button>`
                            : `<button class="lecture-exam-btn" onclick="event.stopPropagation(); openLectureExam('${doc.id}', '${item.title}', '${subject}')">امتحان</button>`;

                        contentHTML += `
                            <div class="glass-effect p-3 rounded-lg cursor-pointer hover:bg-slate-500/10 transition-colors" onclick="${clickHandler}">
                                <div class="flex justify-between items-center">
                                    <h4 class="font-bold text-white">${item.title}</h4>
                                </div>
                                ${!isProcessing ? `<div class="mt-2 flex justify-end gap-2">${examButtonHTML}<button class="correction-btn" onclick="event.stopPropagation(); openCorrectionForm('${doc.id}', '${item.title}', '${subject}')">تصحيح</button></div>` : ''}
                            </div>`;
                    }
                    contentHTML += '</div>';
                    // Optional: Show indicator if offline

                    lecturesContainer.innerHTML = contentHTML;
                }
            }, (error) => {
                console.error("Error:", error);
                // If offline and query fails (rare with persistence, but possible if never loaded)
                if (!navigator.onLine) {
                    lecturesContainer.innerHTML = `<p class="text-slate-400 py-4">أنت في وضع عدم الاتصال. يرجى الاتصال بالإنترنت مرة واحدة لتحميل المحتويات.</p>`;
                } else {
                    lecturesContainer.innerHTML = `<p class="text-red-400 py-4">حدث خطأ أثناء تحميل المحاضرات.</p>`;
                }
            });
        };
        // ======================= CONTENT VIEW WITH STYLING & TABLES =======================
        // ======================= LECTURE TOOLS (COPY & TTS) =======================
        // ======================= LECTURE TOOLS (Advanced Copy & TTS) =======================
        let speechUtterance = null;
        window.activeSpeechSynth = null;

        window.copyLectureText = () => {
            const content = document.querySelector('.lecture-content');
            if (!content) return;
            const text = content.innerText;
            navigator.clipboard.writeText(text).then(() => {
                showToast('تم نسخ النص بنجاح');
            }).catch(err => {
                console.error('Copy failed', err);
                showToast('تعذر النسخ، يرجى المحاولة يدوياً', true);
            });
        };

        window.toggleSpeech = () => {
            const synth = window.speechSynthesis;
            const btnIcon = document.querySelector('#lecture-tts-btn i');

            if (!synth) return;

            // Handle Mobile Initialization / Resume on interaction
            if (synth.speaking && !synth.paused) {
                synth.pause();
                if (btnIcon) btnIcon.className = "ph-play-fill text-xl";
                return;
            }

            if (synth.speaking && synth.paused) {
                synth.resume();
                if (btnIcon) btnIcon.className = "ph-pause-fill text-xl";
                return;
            }

            const content = document.querySelector('.lecture-content');
            if (!content) return;

            synth.cancel();

            const text = content.innerText.replace(/\s+/g, ' ').trim();
            if (!text) return;

            // Robust multi-vocal/mobile trigger
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'ar-SA';
            utter.rate = 0.9;
            utter.pitch = 1.0;

            // Fix for iOS/Chrome mobile: Voices must be loaded
            let voices = synth.getVoices();
            if (voices.length > 0) {
                const arabicVoice = voices.find(v => v.lang.includes('ar'));
                if (arabicVoice) utter.voice = arabicVoice;
            }

            utter.onstart = () => {
                if (btnIcon) btnIcon.className = "ph-pause-fill text-xl";
            };

            utter.onend = () => {
                if (btnIcon) btnIcon.className = "ph-speaker-high-fill text-xl";
            };

            utter.onerror = (e) => {
                console.error('TTS Error:', e);
                if (btnIcon) btnIcon.className = "ph-speaker-high-fill text-xl";
            };

            synth.speak(utter);
        };

        window.stopSpeechOnClose = () => {
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
                window.activeSpeechSynth = null;
            }
        };


        // ======================= CONTENT VIEW WITH STYLING & TABLES =======================
        window.viewContentDetail = async (id, title, body, subject) => {
            updateUserActivity(`يشاهد محاضرة: ${title}`);
            const decodedBody = decodeURIComponent(atob(body));

            if (decodedBody === "PROCESSING_UPLOAD...") {
                showToast('جاري تحميل الملف...', true);
                return;
            }

            if (decodedBody.startsWith('http') && (decodedBody.includes('.pdf') || decodedBody.includes('firebasestorage'))) {
                openOfflineSafeContent(title, decodedBody);
                return;
            }

            // Normal Text Content Handling
            let formattedBody = decodedBody;
            const accountingSubjects = ['محاسبه التكاليف', 'محاسبه الشركات', 'مبادئ المحاسبة الماليه'];
            if (accountingSubjects.some(s => subject.includes(s))) {
                formattedBody = formattedBody.replace(/^\|(.+)\|\s*$/gm, (match, row) => {
                    const cells = row.split('|').map(c => c.trim());
                    const tag = cells[0].startsWith('---') ? 'th' : 'td';
                    return `<tr>${cells.map(cell => `<${tag}>${cell}</${tag}>`).join('')}</tr>`;
                });
                formattedBody = formattedBody.replace(/(?:^|\n)(\|.*\|)(\n\|[-| ]+\|)?/g, (match, tableRows) => {
                    return `<table>${tableRows}</table>`;
                });
            }

            // Standard Markdown Formatting
            formattedBody = formattedBody
                .replace(/^(#+\s*.*)$/gm, '<h2>$1</h2>')
                .replace(/^(##+\s*.*)$/gm, '<h3>$1</h3>')
                .replace(/^\*\s+(.*)$/gm, '<li>$1</li>')
                .replace(/(?<!<li>)(<li>.*<\/li>)/g, '<ul>$1</ul>')
                .replace(/(?<!<\/ul>)<\/ul>(?!\s*<\/ul>)/g, '</ul>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.*?)__/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/_(.*?)_/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/^>\s+(.*)$/gm, '<blockquote>$1</blockquote>');

            formattedBody = formattedBody.replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>');
            formattedBody = formattedBody.replace(/<\/ul>\s*<ul>/g, '');

            const isAudio = decodedBody.trim().match(/\.(mp3|wav|ogg|m4a)$/) || decodedBody.startsWith('https://firebasestorage.googleapis.com') && (decodedBody.includes('.mp3') || decodedBody.includes('.wav'));

            const toolsToolbar = `
                <div class="flex items-center justify-between mb-5 pb-3 border-b border-white/5 bg-white/5 -mx-2 px-4 py-3 rounded-t-lg backdrop-blur-md">
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">أدوات المحاضرة</span>
                    <div class="flex gap-3">
                        ${!isAudio ? `
                        <button id="lecture-copy-btn" onclick="copyLectureText()" class="flex items-center gap-2 px-4 py-1.5 rounded-full bg-cyan-500/10 hover:bg-cyan-500/20 text-cyan-400 border border-cyan-500/20 transition-all duration-300 group" title="نسخ النص">
                            <i class="ph-copy text-xl"></i>
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;

            let mainContent = `<div class="lecture-content leading-relaxed text-slate-200">${formattedBody}</div>`;
            if (isAudio) {
                mainContent = `
                    <div class="flex flex-col items-center justify-center p-8 bg-white/5 rounded-2xl border border-white/10 mt-4 animate-scale-up">
                        <div class="w-20 h-20 rounded-full bg-[var(--primary-glow)]/20 flex items-center justify-center mb-6">
                            <i class="ph-headphones text-4xl text-[var(--primary-glow)]"></i>
                        </div>
                        <h4 class="text-lg font-bold text-white mb-6 text-center">${title}</h4>
                        <audio controls playsinline preload="metadata" class="w-full custom-audio-player">
                            <source src="${decodedBody.trim()}" type="audio/mpeg">
                            جهازك لا يدعم مشغل الصوت.
                        </audio>
                        <p class="text-[10px] text-slate-500 mt-6 tracking-widest uppercase">Mobile Optimized Audio System</p>
                    </div>
                `;
            }

            openModalWithContent(title, `<div class="p-2 pt-0">${toolsToolbar}${mainContent}</div>`);
        };

        // ======================= OFFLINE BLOB STORAGE (INDEXED DB) =======================
        const offlineContentManager = {
            dbName: 'MoraOfflineFiles',
            storeName: 'files',
            init: function () {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName);
                        }
                    };
                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            },
            saveFile: async function (url, blob) {
                try {
                    const db = await this.init();
                    return new Promise((resolve, reject) => {
                        const transaction = db.transaction([this.storeName], 'readwrite');
                        const store = transaction.objectStore(this.storeName);
                        store.put(blob, url);
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = () => reject(transaction.error);
                    });
                } catch (e) {
                    console.error("Save file error:", e);
                }
            },
            getFile: async function (url) {
                try {
                    const db = await this.init();
                    return new Promise((resolve, reject) => {
                        const transaction = db.transaction([this.storeName], 'readonly');
                        const store = transaction.objectStore(this.storeName);
                        const request = store.get(url);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                } catch (e) {
                    return null;
                }
            }
        };

        // ======================= OFFLINE SAFE CONTENT LOADER =======================
        window.openOfflineSafeContent = async (title, url) => {
            // Show loading state
            openModalWithContent(title, `<div id="offline-loader" class="text-center p-8"><i class="ph-spinner ph-spin text-4xl text-[var(--primary-glow)]"></i><p class="mt-4 text-slate-300">جاري تحميل الملف...</p></div>`);

            try {
                // 1. Try to get from local DB first
                let blob = await offlineContentManager.getFile(url);
                let loadedFrom = 'Cache';

                if (!blob) {
                    // 2. If not in DB, fetch from network
                    if (!navigator.onLine) throw new Error("Offline and file not cached");

                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response was not ok');
                    blob = await response.blob();
                    loadedFrom = 'Network';

                    // 3. Save to DB for next time
                    offlineContentManager.saveFile(url, blob).then(() => console.log('File cached manually')).catch(e => console.warn('Cache failed', e));
                } else {
                    console.log("Loaded file from Manual IndexedDB");
                }

                const blobUrl = URL.createObjectURL(blob);

                // Replace loader with iframe
                const modalBody = document.querySelector('#generic-modal .modal-body');
                if (modalBody) {
                    const indicator = loadedFrom === 'Cache' ? '<div class="text-xs text-green-400 text-center mb-1">تم التحميل من الذاكرة (أوفلاين)</div>' : '';
                    modalBody.innerHTML = `${indicator}<iframe src="${blobUrl}" class="w-full h-[70vh] rounded-lg bg-white" frameborder="0"></iframe>`;
                }
            } catch (error) {
                console.error("Content load failed:", error);
                const modalBody = document.querySelector('#generic-modal .modal-body');
                if (modalBody) {
                    if (!navigator.onLine) {
                        modalBody.innerHTML = `<div class="text-center p-8"><i class="ph-wifi-slash text-4xl text-yellow-400 mb-4"></i><p>لا يوجد اتصال بالإنترنت وهذا الملف لم يتم فتحه من قبل (غير محفوظ).</p></div>`;
                    } else {
                        modalBody.innerHTML = `<div class="text-center p-8"><i class="ph-warning text-4xl text-red-400 mb-4"></i><p>حدث خطأ أثناء تحميل الملف. تأكد من الاتصال.</p></div>`;
                    }
                }
            }
        };

        // ======================= BOOKS WITH WATCH & DOWNLOAD =======================
        window.showSubjectSelectionModal = (type) => {
            updateUserActivity(`يتصفح قسم ${type === 'books' ? 'الكتب' : 'السكاشن'}`);
            const userMaterials = materials['ar'][`${currentUser.year}_${currentUser.division}`] || [];
            const title = type === 'books' ? 'الكتب' : 'السكاشن';
            if (userMaterials.length === 0) {
                openModalWithContent(title, '<p class="text-center text-slate-400">لا توجد مواد متاحة.</p>');
                return;
            }
            const subjectsHTML = userMaterials.map(mat => `<div class="glass-effect p-3 rounded-lg cursor-pointer hover:bg-[var(--glass-border)] transition" onclick="openContentModal('${type}', '${mat}')"><h4 class="text-lg font-semibold">${mat}</h4></div>`).join('');
            openModalWithContent(`اختر المادة - ${title}`, `<div class="space-y-3">${subjectsHTML}</div>`);
        };
        window.openContentModal = async (type, subject) => {
            const title = `${type === 'books' ? 'الكتب' : 'السكاشن'} - ${subject}`;
            openModalWithContent(title, `<div id="modal-content-list" class="text-center"><i class="ph-spinner ph-spin text-2xl"></i></div>`);
            const container = document.getElementById('modal-content-list');
            const q = query(collection(db, type), where("year", "==", currentUser.year), where("division", "==", currentUser.division), where("subject", "==", subject), where("isHidden", "==", false), orderBy('createdAt', 'desc'));
            currentContentUnsubscribe = onSnapshot(q, (snapshot) => {
                let content = '';
                if (snapshot.empty) {
                    content = `<div class="text-center p-4"><p>لا يوجد محتوى في هذا القسم حالياً.</p></div>`;
                } else {
                    content = '<div class="space-y-3">';
                    snapshot.forEach(doc => {
                        const item = doc.data();
                        const isUrl = item.body.startsWith('http');
                        if (type === 'books' && isUrl) {
                            content += `
                                <div class="glass-effect p-4 rounded-xl">
                                    <h5 class="font-bold text-white text-lg">${item.title}</h5>
                                    <div class="book-actions">
                                        <button class="book-btn watch-btn" onclick="openOfflineSafeContent('${item.title}', '${item.body}')">شاهد</button>
                                        <button class="book-btn download-btn" onclick="window.open('${item.body}', '_blank')">تحميل</button>
                                    </div>
                                </div>
                            `;
                        } else {
                            content += `<div class="glass-effect p-3 rounded-lg"><h4 class="font-bold text-[var(--primary-glow)]">${item.title}</h4>${isUrl ? `<button class="w-full mt-2 py-2 rounded-lg text-sm btn-celestial" onclick="openOfflineSafeContent('${item.title}', '${item.body}')">فتح الملف</button>` : `<p class="text-sm mt-2">${item.body}</p>`}</div>`;
                        }
                    });
                    content += '</div>';
                }
                container.innerHTML = content;
            });
        };
        window.openBookInApp = (url) => {
            openOfflineSafeContent("عرض الكتاب", url);
        };
        window.openIframeModal = (url) => {
            openOfflineSafeContent("عرض الملف", url);
        };
        async function listenToSiteSettings() {
            onSnapshot(doc(db, "settings", "site"), async (doc) => {
                siteSettings = doc.data() || { meetingActive: false, coursesActive: true, isLive: false, meetLink: '' };
                // Meeting and Banner logic removed as requested
            });
        }
        async function showCoursesList() {
            await updateUserActivity("يتصفح قسم الكورسات");
            const q = query(collection(db, "courses"), orderBy("category"));
            const snapshot = await getDocs(q);
            let content = '<div class="space-y-4">';
            if (snapshot.empty) {
                content += '<p class="text-center text-slate-400">لا توجد كورسات متاحة حالياً.</p>';
            } else {
                const coursesByCategory = {};
                snapshot.forEach(doc => {
                    const course = doc.data();
                    const category = course.category || 'متنوع';
                    if (!coursesByCategory[category]) {
                        coursesByCategory[category] = [];
                    }
                    coursesByCategory[category].push({ id: doc.id, ...course });
                });
                for (const category in coursesByCategory) {
                    content += `<h4 class="text-lg font-bold text-[var(--primary-glow)] pt-2 border-b-2 border-[var(--glass-border)] pb-2">${category}</h4>`;
                    coursesByCategory[category].forEach(course => {
                        content += `
                            <div class="glass-effect p-4 rounded-xl">
                                <h5 class="font-bold text-white text-lg">${course.title}</h5>
                                <p class="text-sm text-slate-400 mt-1">${course.desc}</p>
                                <div class="course-actions">
                                    <button class="course-btn watch-btn" onclick="window.openVideoModal('${course.url}')">مشاهدة</button>
                                    <button class="course-btn download-btn" onclick="window.open('${course.url}', '_blank')">تحميل</button>
                                </div>
                            </div>
                         `;
                    });
                }
            }
            content += '</div>';
            openModalWithContent('الكورسات المجانية', content);
        }
        document.getElementById('courses-btn').addEventListener('click', async () => {
            showCoursesList();
        });
        // ======================= MEETING BUTTON HANDLER =======================
        // Meeting section removed
        // ======================= LIVE ATTENDANCE BANNER CLICK =======================
        // Banner click handler removed
        // ======================= SUMMARY SECTION =======================
        document.getElementById('summary-nav-btn').addEventListener('click', () => {
            updateUserActivity("يفتح قسم التلخيص");
            const summaryHTML = `
                <div class="p-4 space-y-4 text-center">
                    <h3 class="text-xl font-bold text-[var(--primary-glow)]">تلخيص المحاضرات</h3>
                    <p class="text-slate-300">استخدم الذكاء الاصطناعي لتلخيص المحاضرات، طرح الأسئلة، وفهم أعمق.</p>
                    <div class="mt-6">
                        <button class="btn-celestial py-2 px-6 rounded-lg font-bold" onclick="handleRedirectWithCountdown('https://chat.deepseek.com/')">
                            الذهاب إلى DeepSeek
                        </button>
                    </div>
                    <p class="text-xs text-slate-500 mt-6">تطوير Amr lotfy</p>
                </div>
            `;
            openModalWithContent('تلخيص', summaryHTML);
        });
        // ======================= POLLS/DISCUSSION FEATURE - GLOBAL =======================
        const emojis = [
            '👍', '👎', '❤️', '🔥', '👏', '😂', '😮', '😢', '😡', '🎉', '💯', '🙏', '👌', '👀', '🤔', '😎', '🤩', '🥳', '😜', '🤪',
            '😇', '🤗', '😏', '😋', '😛', '😴', '🥱', '😷', '🤒', '🤕', '🤢', '🤮', '🤧', '🥵', '🥶', '🥴', '😵', '🤯', '🤠', '🥳',
            '🥸', '😎', '🤓', '🧐', '😕', '😟', '🙁', '☹️', '😮‍💨', '😤', '😠', '🤬', '😈', '👿', '💀', '☠️', '💩', '🤡', '👹', '👺',
            '👻', '👽', '👾', '🤖', '👋', '🤚', '🖐️', '✋', '🖖', '👌', '🤌', '🤏', '✌️', '🤞', '🤟', '🤘', '🤙', '👈', '👉', '👆',
            '🖕', '👇', '☝️', '👍', '👎', '✊', '👊', '🤛', '🤜', '👏', '🙌', '👐', '🤲', '🤝', '🙏', '✍️', '💅', '🤳', '💪', '🦾', '🦿',
            '🦵', '🦶', '👂', '🦻', '👃', '🧠', '🫀', '🫁', '🦷', '🦴', '👀', '👁️', '👅', '👄', '👶', '🧒', '👦', '👧', '🧑', '👱', '👨', '🧔',
            '👩', '🧓', '👴', '👵', '🙍', '🙎', '🙅', '🙆', '💁', '🙋', '🧏', '🙇', '🤦', '🤷', '👮', '🕵️', '💂', '🥷', '👷', '🤴', '👸',
            '👳', '👲', '🧕', '🤵', '👰', '🤰', '🤱', '👼', '🎅', '🤶', '🦸', '🦹', '🧙', '🧚', '🧛', '🧜', '🧝', '🧞', '🧟', '🧌', '💆', '💇',
            '🚶', '🧍', '🧎', '🏃', '💃', '🕺', '🕴️', '👯', '🧖', '🧗', '🤺', '🏇', '⛷️', '🏂', '🏌️', '🏄', '🚣', '🏊', '⛹️', '🏋️', '🚴',
            '🚵', '🤸', '🤼', '🤽', '🤾', '🤹', '🧘', '🛀', '🛌', '👭', '👫', '👬', '💏', '💑', '👪', '🗣️', '👤', '👥', '🫂', '👣', '🦰',
            '🦱', '🦳', '🦲', '🐵', '🐒', '🦍', '🦧', '🐶', '🐕', '🦮', '🐩', '🐺', '🦊', '🦝', '🐱', '🐈', '🦁', '🐯', '🐅', '🐆', '🐴',
            '🐎', '🦄', '🦓', '🦌', '🦬', '🐮', '🐂', '🐃', '🐄', '🐷', '🐖', '🐗', '🐽', '🐏', '🐑', '🐐', '🐪', '🐫', '🦙', '🦒', '🐘',
            '🦣', '🦏', '🦛', '🐭', '🐁', '🐀', '🐹', '🐰', '🐇', '🐿️', '🦫', '🦔', '🦇', '🐻', '🐨', '🐼', '🦥', '🦦', '🦨', '🦘', '🦡',
            '🐾', '🦃', '🐔', '🐓', '🐣', '🐤', '🐥', '🐦', '🐧', '🕊️', '🦅', '🦆', '🦢', '🦉', '🦤', '🪶', '🦩', '🦚', '🦜', '🐸', '🐊',
            '🐢', '🦎', '🐍', '🐲', '🐉', '🦕', '🦖', '🐳', '🐋', '🐬', '🦭', '🐟', '🐠', '🐡', '🦈', '🐙', '🐚', '🐌', '🦋', '🐛', '🐜',
            '🐝', '🪲', '🐞', '🦗', '🪳', '🕷️', '🕸️', '🦂', '🦟', '🪰', '🪱', '🦠', '💐', '🌸', '💮', '🏵️', '🌹', '🥀', '🌺', '🌻', '🌼',
            '🌷', '🌱', '🪴', '🌲', '🌳', '🌴', '🌵', '🌾', '🌿', '☘️', '🍀', '🍁', '🍂', '🍃', '🍇', '🍈', '🍉', '🍊', '🍋', '🍌', '🍍',
            '🥭', '🍎', '🍏', '🍐', '🍑', '🍒', '🍓', '🫐', '🥝', '🍅', '🫒', '🥥', '🥑', '🍆', '🥔', '🥕', '🌽', '🌶️', '🫑', '🥒', '🥬',
            '🥦', '🧄', '🧅', '🍄', '🥜', '🌰', '🍞', '🥐', '🥖', '🫓', '🥨', '🥯', '🥞', '🧇', '🧀', '🍖', '🍗', '🥩', '🥓', '🍔', '🍟',
            '🍕', '🌭', '🥪', '🌮', '🌯', '🫔', '🥙', '🧆', '🥚', '🍳', '🥘', '🍲', '🫕', '🥣', '🥗', '🍿', '🧈', '🧂', '🥫', '🍱', '🍘',
            '🍙', '🍚', '🍛', '🍜', '🍝', '🍠', '🍢', '🍣', '🍤', '🍥', '🥮', '🍡', '🥟', '🥠', '🥡', '🦀', '🦞', '🦐', '🦑', '🦪', '🍦',
            '🍧', '🍨', '🍩', '🍪', '🎂', '🍰', '🧁', '🥧', '🍫', '🍬', '🍭', '🍮', '🍯', '🍼', '🥛', '☕', '🍵', '🍶', '🍾', '🍷', '🍸',
            '🍹', '🍺', '🍻', '🥂', '🥃', '🥤', '🧋', '🧃', '🧉', '🧊', '🥢', '🍽️', '🍴', '🥄', '🔪', '🏺', '🌍', '🌎', '🌏', '🌐', '🗺️',
            '🗾', '🧭', '🏔️', '⛰️', '🌋', '🗻', '🏕️', '🏖️', '🏜️', '🏝️', '🏞️', '🏟️', '🏛️', '🏗️', '🧱', '🪨', '🪵', '🛖', '🏘️', '🏚️',
            '🏠', '🏡', '🏢', '🏣', '🏤', '🏥', '🏦', '🏨', '🏩', '🏪', '🏫', '🏬', '🏭', '🏯', '🏰', '💒', '🗼', '🗽', '⛪', '🕌', '🕍',
            '⛩️', '🕋', '⛲', '⛺', '🌁', '🌃', '🏙️', '🌄', '🌅', '🌆', '🌇', '🌉', '♨️', '🎠', '🎡', '🎢', '💈', '🎪', '🚂', '🚃', '🚄',
            '🚅', '🚆', '🚇', '🚈', '🚉', '🚊', '🚝', '🚞', '🚋', '🚌', '🚍', '🚎', '🚐', '🚑', '🚒', '🚓', '🚔', '🚕', '🚖', '🚗', '🚘',
            '🚙', '🚚', '🚛', '🚜', '🏎️', '🏍️', '🛵', '🦽', '🦼', '🛺', '🚲', '🛴', '🛹', '🛼', '🚏', '🛣️', '🛤️', '🛢️', '⛽', '🚨', '🚥',
            '🚦', '🛑', '🚧', '⚓', '⛵', '🛶', '🚤', '🛳️', '⛴️', '🛥️', '🚢', '✈️', '🛩️', '🛫', '🛬', '🪂', '💺', '🚁', '🚟', '🚠', '🚡',
            '🛰️', '🚀', '🛸', '🛎️', '🧳', '⌛', '⏳', '⌚', '⏰', '⏱️', '⏲️', '🕰️', '🕛', '🕧', '🕐', '🕜', '🕑', '🕝', '🕒', '🕞', '🕓',
            '🕟', '🕔', '🕠', '🕕', '🕖', '🕗', '🕘', '🕙', '🕚', '🕡', '🌑', '🌒', '🌓', '🌔', '🌕', '🌖', '🌗', '🌘', '🌙', '🌚', '🌛',
            '🌜', '🌡️', '☀️', '🌝', '🌞', '🪐', '⭐', '🌟', '🌠', '🌌', '☁️', '⛅', '⛈️', '🌤️', '🌥️', '🌦️', '🌧️', '🌨️', 'heim', '🌪️',
            '🌫️', '🌬️', '🌀', '🌈', '🌂', '☂️', '☔', '⛱️', '⚡', '❄️', '☃️', '⛄', '☄️', '🔥', '💧', '🌊', '🎃', '🎄', '🎆', '🎇', '🧨',
            '✨', '🎈', '🎉', '🎊', '🎋', '🎍', '🎎', '🎏', '🎐', '🎑', '🧧', '🎀', '🎁', '🎗️', '🎟️', '🎫', '🎖️', '🏆', '🏅', '🥇', '🥈',
            '🥉', '⚽', '🏀', '🏈', '⚾', '🥎', '🎾', '🏐', '🏉', '🎱', '🏓', '🏸', '🏒', '🏑', '🥍', '🏏', '🪃', '🥏', '🎯', '🪀', '🎮',
            '🎰', '🎲', '🧩', '♟️', '🎭', '🎨', '🧵', '🪡', '🧶', '🪢', '👓', '🕶️', '🥽', '🥼', '🦺', '👔', '👕', '👖', '🧣', '🧤', '🧥',
            '🧦', '👗', '👘', '🥻', '🩱', '🩲', '🩳', '👙', '👚', '👛', '👜', '👝', '🛍️', '🎒', '🩴', '👞', '👟', '🥾', '🥿', '👠', '👡',
            '🩰', '👢', '👑', '👒', '🎩', '🎓', '🧢', '🪖', '⛑️', '📿', '💄', '💍', '💼', '📕', '📖', '📗', '📘', '📙', '📚', '📓', '📔',
            '📒', '📝', '💼', '📁', '📂', '🗂️', '📅', '📆', '🗒️', '🗓️', '📇', '📈', '📉', '📊', '📋', '📌', '📍', '📎', '🖇️', '📏',
            '📐', '✂️', '🗃️', '🗄️', '🗑️', '🔒', '🔓', '🔏', '🔐', '🔑', '🔨', '🪓', '⛏️', '⚒️', '🛠️', '🗡️', '⚔️', '🔫', '🏹', '🛡️',
            '🪚', '🔧', '🪛', '🔩', '⚙️', '🗜️', '⚖️', '🦯', '🔗', '⛓️', '🪝', '🧰', '🧲', '🪜', '⚗️', '🧪', '🧫', '🧬', '🔬', '🔭', '📡',
            '💉', '🩸', '💊', '🩹', '🩺', '🚪', '🛗', '🪞', '🪟', '🛏️', '🛋️', '🪑', '🚽', '🪠', '🚿', '🛁', '🪤', '🪒', '🧴', '🧷', '🧹',
            '🧺', '🧻', '🪣', '🧼', '🪥', '🧽', '🧯', '🛒', '🚬', '⚰️', '🪦', '⚱️', '🧿', '🪬', '🔮', '📿', '💈', '💣', '🧨', '🧪', '🧫', '🧬',
            '🔬', '🔭', '📡', '💉', '🩸', '💊', '🩹', '🩺', '🚪', '🛗', '🪞', '🪟', '🛏️', '🛋️', '🪑', '🚽', '🪠', '🚿', '🛁', '🪤', '🪒',
            '🧴', '🧷', '🧹', '🧺', '🧻', '🪣', '🧼', '🪥', '🧽', '🧯', '🛒', '🚬', '⚰️', '🪦', '⚱️', '🧿', '🪬', '🔮', '📿', '💈'
        ];

        // ======================= POLLS/DISCUSSION FEATURE - GLOBAL =======================
        async function openPollsView() {
            updateUserActivity("يتصفح الاستطلاعات");
            const pollsHTML = `
                <div class="space-y-4">
                    <div class="content-policy-notice">
                        <strong>تنبيه هام:</strong> يُمنع تمامًا نشر أي محتوى يحتوي على ألفاظ غير لائقة، شتائم، أرقام، أو محتوى مخل. سيتم إصدار تحذير عند المخالفة الأولى، وحظر الحساب نهائيًا عند التكرار.
                    </div>
                    <div>
                        <h4 class="text-lg font-bold text-slate-300 mb-2">ابدأ موضوعًا جديدًا</h4>
                        <textarea id="poll-topic-input" class="w-full rounded-lg input-field" rows="4" placeholder="اكتب سؤالك أو رأيك هنا..."></textarea>
                        <button id="submit-poll-btn" class="w-full mt-2 py-2 rounded-lg font-bold btn-celestial">نشر الموضوع</button>
                    </div>
                    <div>
                        <h4 class="text-lg font-bold text-slate-300 mb-2 border-t border-slate-700/50 pt-4">المواضيع الحالية</h4>
                        <div id="polls-list-container" class="space-y-3 max-h-72 overflow-y-auto">
                            <p class="text-slate-400 text-center">جاري تحميل المواضيع...</p>
                        </div>
                    </div>
                </div>
            `;
            openModalWithContent('الاستطلاعات والمناقشات', pollsHTML);
            document.getElementById('submit-poll-btn').addEventListener('click', submitNewPoll);
            // ✅ بدون فلترة حسب الفرقة أو الشعبة → عام للجميع
            const q = query(collection(db, "polls"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('polls-list-container');
                if (!container) return;
                let listHTML = '';
                if (snapshot.empty) {
                    listHTML = '<p class="text-slate-400 text-center">لا توجد مواضيع للنقاش حاليًا. كن أول من يبدأ!</p>';
                } else {
                    snapshot.forEach(doc => {
                        const poll = doc.data();
                        const divisionText = poll.userDivision === 'international' ? 'أعمال دولية' : 'نظم معلومات';
                        const yearText = poll.userYear === '1' ? 'الفرقة الأولى' : 'الثانية';
                        const dateText = poll.createdAt ? poll.createdAt.toDate().toLocaleString('ar-EG-u-nu-latn', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';
                        listHTML += `
                            <div class="poll-item" data-poll-id="${doc.id}" oncontextmenu="return false;">
                                <div class="poll-header">
                                    <span class="poll-author">${poll.userName}</span>
                                    <span class="poll-time">${dateText}</span>
                                </div>
                                <div class="poll-body">${poll.topic}</div>
                                <div class="poll-reactions" id="reactions-${doc.id}">
                                    <!-- Reactions will be loaded here -->
                                </div>
                                <div class="mt-3">
                                    <textarea id="reply-${doc.id}" class="w-full rounded-lg input-field text-sm" rows="2" placeholder="اكتب ردك..."></textarea>
                                    <button onclick="submitNewReply('${doc.id}')" class="w-full mt-2 py-1.5 rounded-lg text-sm font-bold btn-celestial">رد</button>
                                </div>
                            </div>
                        `;
                    });
                }
                container.innerHTML = listHTML;
                snapshot.forEach(doc => {
                    loadReactions(doc.id, 'polls');
                });
                document.querySelectorAll('.poll-item').forEach(item => {
                    addLongPressReaction(item, 'polls');
                });
            });
        }
        // ======================= OPINIONS VIEW =======================
        async function openOpinionsView() {
            updateUserActivity("يتصفح قسم الآراء");
            const opinionsHTML = `
                <div class="content-policy-notice">
                    <strong>تنبيه هام:</strong> يُمنع تمامًا نشر أي محتوى يحتوي على ألفاظ غير لائقة، شتائم، أرقام، أو محتوى مخل. سيتم إصدار تحذير عند المخالفة الأولى، وحظر الحساب نهائيًا عند التكرار.
                </div>
                <div id="opinions-view" class="space-y-3 mb-4 max-h-60 overflow-y-auto"></div>
                <textarea id="opinion-input" class="w-full rounded-lg input-field mt-4" rows="3" placeholder="اكتب رأيك هنا..."></textarea>
                <button id="submit-opinion-btn" class="w-full mt-2 py-2 rounded-lg font-bold btn-celestial">نشر الرأي</button>
            `;
            openModalWithContent('آراء الطلاب', opinionsHTML);
            const q = query(collection(db, "opinions"), orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('opinions-view');
                if (!container) return;
                let listHTML = '';
                if (snapshot.empty) {
                    listHTML = '<p class="text-center text-slate-400">لا توجد آراء بعد.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const o = doc.data();
                        const dateText = o.createdAt ? o.createdAt.toDate().toLocaleString('ar-EG-u-nu-latn', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '';
                        listHTML += `
                            <div class="opinion-item" data-opinion-id="${doc.id}" oncontextmenu="return false;">
                                <div class="opinion-header">
                                    <span class="opinion-author">${o.name}</span>
                                    <span class="opinion-time">${dateText}</span>
                                </div>
                                <div class="opinion-body">"${o.text}"</div>
                                <div class="opinion-reactions" id="opinions-reactions-${doc.id}">
                                    <!-- Reactions will be loaded here -->
                                </div>
                            </div>
                        `;
                    });
                }
                container.innerHTML = listHTML;
                snapshot.forEach(doc => {
                    loadReactions(doc.id, 'opinions');
                });
                document.querySelectorAll('.opinion-item').forEach(item => {
                    addLongPressReaction(item, 'opinions');
                });
            });
        }
        // ======================= REACTIONS SYSTEM =======================
        function addLongPressReaction(element, collectionName) {
            let pressTimer;
            element.addEventListener('touchstart', () => {
                pressTimer = setTimeout(() => {
                    showReactionPicker(element, collectionName);
                }, 500);
            });
            element.addEventListener('touchend', () => {
                clearTimeout(pressTimer);
            });
            element.addEventListener('mousedown', () => {
                pressTimer = setTimeout(() => {
                    showReactionPicker(element, collectionName);
                }, 500);
            });
            element.addEventListener('mouseup', () => {
                clearTimeout(pressTimer);
            });
            element.addEventListener('mouseleave', () => {
                clearTimeout(pressTimer);
            });
        }
        function showReactionPicker(element, collectionName) {
            const rect = element.getBoundingClientRect();
            const picker = document.createElement('div');
            picker.className = 'glass-effect p-2 rounded-lg flex flex-wrap gap-1 absolute z-50 max-w-xs';
            picker.style.top = `${rect.bottom + window.scrollY}px`;
            picker.style.left = `${rect.left + window.scrollX}px`;
            const sampleEmojis = emojis.slice(0, 20);
            sampleEmojis.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'reaction-btn text-lg';
                btn.textContent = emoji;
                btn.onclick = () => {
                    const id = element.dataset[`${collectionName.slice(0, -1)}Id`];
                    addReaction(id, collectionName, emoji);
                    document.body.removeChild(picker);
                };
                picker.appendChild(btn);
            });
            document.body.appendChild(picker);
            setTimeout(() => {
                if (document.body.contains(picker)) {
                    document.body.removeChild(picker);
                }
            }, 3000);
        }
        async function addReaction(docId, collectionName, emoji) {
            if (!currentUser) return;
            const docRef = doc(db, collectionName, docId);
            try {
                await updateDoc(docRef, {
                    reactions: arrayUnion({
                        userId: currentUser.id,
                        userName: currentUser.name,
                        emoji: emoji,
                        timestamp: serverTimestamp()
                    })
                });
            } catch (error) {
                console.error("Error adding reaction:", error);
            }
        }
        async function loadReactions(docId, collectionName) {
            const docRef = doc(db, collectionName, docId);
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) return;
            const data = docSnap.data();
            const reactions = data.reactions || [];
            const reactionCounts = {};
            reactions.forEach(r => {
                reactionCounts[r.emoji] = (reactionCounts[r.emoji] || 0) + 1;
            });
            const containerId = collectionName === 'polls' ? `reactions-${docId}` : `opinions-reactions-${docId}`;
            const container = document.getElementById(containerId);
            if (!container) return;
            let html = '';
            for (const emoji in reactionCounts) {
                html += `<span class="reaction-btn">${emoji} <span class="reaction-count">${reactionCounts[emoji]}</span></span>`;
            }
            container.innerHTML = html;
        }
        async function submitNewPoll() {
            const input = document.getElementById('poll-topic-input');
            const topic = input.value.trim();
            if (!topic) {
                showToast('لا يمكن نشر موضوع فارغ.', true);
                return;
            }
            const isAllowed = await checkAndHandleContent(topic, currentUser.id, currentUser.name);
            if (!isAllowed) return;
            await addDoc(collection(db, "polls"), {
                userId: currentUser.id,
                userName: currentUser.name,
                userYear: currentUser.year,
                userDivision: currentUser.division,
                topic: topic,
                createdAt: serverTimestamp(),
                isReadByAdmin: false,
                reactions: []
            });
            showToast('تم نشر موضوعك بنجاح!');
            input.value = '';
        }
        async function submitNewReply(pollId) {
            const input = document.getElementById(`reply-${pollId}`);
            const replyText = input.value.trim();
            if (!replyText) {
                showToast('لا يمكن إضافة رد فارغ.', true);
                return;
            }
            const isAllowed = await checkAndHandleContent(replyText, currentUser.id, currentUser.name);
            if (!isAllowed) return;
            const repliesRef = collection(doc(db, "polls", pollId), "replies");
            await addDoc(repliesRef, {
                userId: currentUser.id,
                userName: currentUser.name,
                replyText: replyText,
                createdAt: serverTimestamp(),
                reactions: []
            });
            input.value = '';
        }
        // ======================= WEEKLY EXAMS SYSTEM =======================
        let studentExamIndicators = {};
        let currentAdminQuestions = [];
        let activeExamSession = null; // { exam, timer, secondsRemaining, answers }
        let currentAdminExamsUnsubscribe = null;

        // --- Admin Side ---
        function initWeeklyExamsAdmin() {
            const yearSelect = document.getElementById('exam-year-select');
            const divisionSelect = document.getElementById('exam-division-select');
            const subjectSelect = document.getElementById('exam-subject-select');

            const updateAdminExamSubjects = () => {
                const year = yearSelect.value;
                const division = divisionSelect.value;
                subjectSelect.innerHTML = '<option value="">اختر المادة</option>';
                if (year && division) {
                    const list = materials['ar'][`${year}_${division}`] || [];
                    list.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = opt.textContent = s;
                        subjectSelect.appendChild(opt);
                    });
                    document.getElementById('exam-management-area').classList.remove('hidden');
                } else {
                    document.getElementById('exam-management-area').classList.add('hidden');
                }
                renderAdminExamsList();
            };

            yearSelect.onchange = updateAdminExamSubjects;
            divisionSelect.onchange = updateAdminExamSubjects;
            subjectSelect.onchange = renderAdminExamsList;

            document.getElementById('add-question-btn').onclick = () => {
                if (currentAdminQuestions.length >= 50) {
                    showToast('تم الوصول للحد الأقصى (50 سؤال)', true);
                    return;
                }
                openQuestionTypeSelector();
            };

            document.getElementById('save-exam-btn').onclick = saveWeeklyExam;
            updateAdminExamSubjects();
        }

        // ======================= LECTURE EXAM ADMIN PANEL =======================
        let currentLectureExamQuestions = [];

        function initLectureExamsAdmin() {
            const yearSelect = document.getElementById('lecture-exam-year-select');
            const divisionSelect = document.getElementById('lecture-exam-division-select');
            const subjectSelect = document.getElementById('lecture-exam-subject-select');
            const lectureSelect = document.getElementById('lecture-exam-lecture-select');

            const updateLectureExamSubjects = () => {
                const year = yearSelect.value;
                const division = divisionSelect.value;
                subjectSelect.innerHTML = '<option value="">اختر المادة</option>';
                lectureSelect.innerHTML = '<option value="">اختر المحاضرة</option>';

                if (year && division) {
                    const list = materials['ar'][`${year}_${division}`] || [];
                    list.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = opt.textContent = s;
                        subjectSelect.appendChild(opt);
                    });
                } else {
                    document.getElementById('lecture-exam-management-area').classList.add('hidden');
                }
            };

            const loadLecturesForExam = async () => {
                const year = yearSelect.value;
                const division = divisionSelect.value;
                const subject = subjectSelect.value;

                lectureSelect.innerHTML = '<option value="">اختر المحاضرة</option>';

                if (!year || !division || !subject) {
                    document.getElementById('lecture-exam-management-area').classList.add('hidden');
                    return;
                }

                try {
                    console.log('Loading lectures for:', { year: parseInt(year), division, subject });

                    // Try loading with year as integer first (new format)
                    let q = query(collection(db, 'lectures'),
                        where('year', '==', parseInt(year)),
                        where('division', '==', division),
                        where('subject', '==', subject)
                    );

                    let snapshot = await getDocs(q);
                    console.log('Found lectures (integer year):', snapshot.size);

                    // If no results, try with year as string (old format)
                    if (snapshot.empty) {
                        console.log('Trying with year as string...');
                        q = query(collection(db, 'lectures'),
                            where('year', '==', year),
                            where('division', '==', division),
                            where('subject', '==', subject)
                        );
                        snapshot = await getDocs(q);
                        console.log('Found lectures (string year):', snapshot.size);
                    }

                    if (snapshot.empty) {
                        showToast('لا توجد محاضرات لهذه المادة', true);
                        document.getElementById('lecture-exam-management-area').classList.add('hidden');
                        lectureSelect.innerHTML = '<option value="">لا توجد محاضرات متاحة</option>';
                    } else {
                        // Filter out hidden lectures and collect all lectures
                        const visibleLectures = [];
                        snapshot.forEach(doc => {
                            const lecture = doc.data();
                            // Only include if isHidden is false or doesn't exist
                            if (lecture.isHidden !== true) {
                                visibleLectures.push({
                                    id: doc.id,
                                    data: lecture,
                                    createdAt: lecture.createdAt?.toMillis() || 0
                                });
                            }
                        });

                        // Sort by createdAt in JavaScript (newest first)
                        visibleLectures.sort((a, b) => b.createdAt - a.createdAt);

                        console.log('Visible lectures:', visibleLectures.length);

                        if (visibleLectures.length === 0) {
                            showToast('لا توجد محاضرات ظاهرة لهذه المادة', true);
                            document.getElementById('lecture-exam-management-area').classList.add('hidden');
                            lectureSelect.innerHTML = '<option value="">لا توجد محاضرات متاحة</option>';
                        } else {
                            // Show lecture count
                            lectureSelect.innerHTML = `<option value="">اختر المحاضرة (${visibleLectures.length} محاضرة متاحة)</option>`;

                            visibleLectures.forEach(({ id, data }) => {
                                const opt = document.createElement('option');
                                opt.value = id;
                                opt.textContent = data.title;
                                lectureSelect.appendChild(opt);
                                console.log('Added lecture:', data.title);
                            });

                            document.getElementById('lecture-exam-management-area').classList.remove('hidden');
                        }
                    }
                } catch (error) {
                    console.error('Error loading lectures:', error);
                    showToast('حدث خطأ أثناء تحميل المحاضرات: ' + error.message, true);
                    lectureSelect.innerHTML = '<option value="">خطأ في التحميل</option>';
                }
            };

            yearSelect.onchange = updateLectureExamSubjects;
            divisionSelect.onchange = updateLectureExamSubjects;
            subjectSelect.onchange = loadLecturesForExam;
            lectureSelect.onchange = renderAdminLectureExamsList;

            document.getElementById('lecture-add-question-btn').onclick = () => {
                openLectureQuestionTypeSelector();
            };

            document.getElementById('save-lecture-exam-btn').onclick = saveLectureExam;
            updateLectureExamSubjects();
        }

        function renderLectureQuestionBuilder() {
            const container = document.getElementById('lecture-questions-builder-container');
            if (currentLectureExamQuestions.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-10">اضغط "إضافة سؤال" للبدء</p>';
                return;
            }

            let html = '';
            currentLectureExamQuestions.forEach((q, idx) => {
                const questionTypeLabel = q.type === 'truefalse' ? 'صح/خطأ' : 'اختيار من متعدد';
                const optionsCount = q.type === 'truefalse' ? 2 : 4;

                html += `
                    <div class="bg-white/5 p-4 rounded-lg border border-white/10 space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-bold text-[var(--primary-glow)]">سؤال ${idx + 1} - ${questionTypeLabel}</span>
                            <button onclick="removeLectureQuestion('${q.id}')" class="text-red-400 hover:text-red-300 transition">
                                <i class="ph-trash text-lg"></i>
                            </button>
                        </div>
                        <input type="text" placeholder="اكتب نص السؤال هنا..." value="${q.question}" 
                            onchange="updateLectureQuestion('${q.id}', 'question', this.value)"
                            class="w-full rounded-lg input-field text-sm">
                        <div class="space-y-2">
                            <p class="text-xs text-slate-400">الخيارات (اختر الإجابة الصحيحة):</p>
                            ${q.options.slice(0, optionsCount).map((opt, optIdx) => `
                                <div class="flex gap-2 items-center bg-black/20 p-2 rounded">
                                    <input type="radio" name="correct-${q.id}" ${q.correct === optIdx ? 'checked' : ''}
                                        onchange="updateLectureQuestion('${q.id}', 'correct', ${optIdx})"
                                        class="w-4 h-4 text-[var(--primary-glow)] focus:ring-[var(--primary-glow)]">
                                    <input type="text" placeholder="${q.type === 'truefalse' ? (optIdx === 0 ? 'صح' : 'خطأ') : 'الخيار ' + (optIdx + 1)}" value="${opt}"
                                        onchange="updateLectureQuestionOption('${q.id}', ${optIdx}, this.value)"
                                        class="flex-grow rounded input-field text-sm">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        window.updateLectureQuestion = (id, field, value) => {
            const q = currentLectureExamQuestions.find(q => q.id === id);
            if (q) q[field] = field === 'correct' ? parseInt(value) : value;
        };

        window.updateLectureQuestionOption = (id, optIdx, value) => {
            const q = currentLectureExamQuestions.find(q => q.id === id);
            if (q) q.options[optIdx] = value;
        };

        function openLectureQuestionTypeSelector() {
            const modalHTML = `
                <div class="text-center space-y-6 p-6">
                    <h3 class="text-2xl font-bold text-white mb-4">اختر نوع السؤال</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="addLectureQuestionByType('mcq')" 
                            class="group relative overflow-hidden p-6 rounded-xl bg-gradient-to-br from-cyan-500/20 to-blue-500/20 border-2 border-cyan-500/30 hover:border-cyan-400 transition-all duration-300 hover:scale-105">
                            <div class="absolute inset-0 bg-gradient-to-br from-cyan-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <i class="ph-list-checks text-5xl text-cyan-400 mb-3 block"></i>
                            <h4 class="text-xl font-bold text-white mb-2">اختيار من متعدد</h4>
                            <p class="text-sm text-slate-400">4 خيارات - اختيار واحد صحيح</p>
                        </button>
                        <button onclick="addLectureQuestionByType('truefalse')" 
                            class="group relative overflow-hidden p-6 rounded-xl bg-gradient-to-br from-green-500/20 to-emerald-500/20 border-2 border-green-500/30 hover:border-green-400 transition-all duration-300 hover:scale-105">
                            <div class="absolute inset-0 bg-gradient-to-br from-green-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                            <i class="ph-check-circle text-5xl text-green-400 mb-3 block"></i>
                            <h4 class="text-xl font-bold text-white mb-2">صح أو خطأ</h4>
                            <p class="text-sm text-slate-400">خياران فقط - صح أو خطأ</p>
                        </button>
                    </div>
                </div>
            `;
            openModalWithContent('إضافة سؤال جديد', modalHTML);
        }

        window.addLectureQuestionByType = (type) => {
            const id = Date.now().toString();
            const question = {
                id,
                type: type,
                question: '',
                options: type === 'truefalse' ? ['صح', 'خطأ'] : ['', '', '', ''],
                correct: 0
            };
            currentLectureExamQuestions.push(question);
            renderLectureQuestionBuilder();
            document.getElementById('generic-modal').classList.remove('open');
            showToast(`تم إضافة سؤال ${type === 'truefalse' ? 'صح/خطأ' : 'اختيار من متعدد'}`);
        };

        window.removeLectureQuestion = (id) => {
            currentLectureExamQuestions = currentLectureExamQuestions.filter(q => q.id !== id);
            renderLectureQuestionBuilder();
        };

        async function saveLectureExam() {
            const title = document.getElementById('lecture-exam-title-input').value.trim();
            const lectureId = document.getElementById('lecture-exam-lecture-select').value;
            const year = parseInt(document.getElementById('lecture-exam-year-select').value);
            const division = document.getElementById('lecture-exam-division-select').value;
            const subject = document.getElementById('lecture-exam-subject-select').value;

            if (!title || !lectureId || currentLectureExamQuestions.length === 0) {
                showToast('يرجى ملء جميع الحقول وإضافة أسئلة', true);
                return;
            }

            // Validate questions
            for (let q of currentLectureExamQuestions) {
                if (!q.question.trim()) {
                    showToast('يرجى ملء نص جميع الأسئلة', true);
                    return;
                }
                for (let opt of q.options) {
                    if (!opt.trim()) {
                        showToast('يرجى ملء جميع الخيارات', true);
                        return;
                    }
                }
            }

            try {
                await addDoc(collection(db, 'lecture_exams'), {
                    lectureId: lectureId,
                    title: title,
                    year: year,
                    division: division,
                    subject: subject,
                    questions: currentLectureExamQuestions.map(q => ({
                        question: q.question,
                        options: q.options,
                        correct: q.correct
                    })),
                    duration: 25,
                    isHidden: false,
                    createdAt: serverTimestamp()
                });

                showToast('تم حفظ الامتحان بنجاح');
                document.getElementById('lecture-exam-title-input').value = '';
                currentLectureExamQuestions = [];
                renderLectureQuestionBuilder();
                renderAdminLectureExamsList();
            } catch (error) {
                console.error('Error saving lecture exam:', error);
                showToast('حدث خطأ أثناء الحفظ', true);
            }
        }

        async function renderAdminLectureExamsList() {
            const lectureId = document.getElementById('lecture-exam-lecture-select').value;
            const container = document.getElementById('admin-lecture-exams-list');

            if (!lectureId) {
                container.innerHTML = '<p class="text-slate-400 text-center">اختر محاضرة لعرض امتحاناتها</p>';
                return;
            }

            const q = query(collection(db, 'lecture_exams'),
                where('lectureId', '==', lectureId),
                orderBy('createdAt', 'desc')
            );

            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-slate-400 text-center">لا توجد امتحانات لهذه المحاضرة</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const exam = doc.data();
                    const statusBadge = exam.isHidden
                        ? '<span class="text-xs bg-red-500/20 text-red-400 px-2 py-1 rounded">مخفي</span>'
                        : '<span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded">ظاهر</span>';

                    html += `
                        <div class="glass-effect p-4 rounded-lg">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-bold text-white">${exam.title}</h4>
                                    <p class="text-xs text-slate-400">${exam.questions.length} سؤال • ${exam.duration} دقيقة</p>
                                </div>
                                ${statusBadge}
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button onclick="toggleLectureExamVisibility('${doc.id}', ${exam.isHidden})" 
                                    class="flex-1 py-2 px-3 rounded bg-yellow-600 hover:bg-yellow-500 text-white text-sm font-bold">
                                    ${exam.isHidden ? 'إظهار' : 'إخفاء'}
                                </button>
                                <button onclick="deleteLectureExam('${doc.id}')" 
                                    class="flex-1 py-2 px-3 rounded bg-red-600 hover:bg-red-500 text-white text-sm font-bold">
                                    حذف
                                </button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            });
        }

        window.toggleLectureExamVisibility = async (examId, currentHidden) => {
            try {
                await updateDoc(doc(db, 'lecture_exams', examId), {
                    isHidden: !currentHidden
                });
                showToast(currentHidden ? 'تم إظهار الامتحان' : 'تم إخفاء الامتحان');
            } catch (error) {
                console.error('Error toggling visibility:', error);
                showToast('حدث خطأ', true);
            }
        };

        window.deleteLectureExam = async (examId) => {
            if (!confirm('هل أنت متأكد من حذف هذا الامتحان؟ سيتم حذف جميع النتائج المرتبطة به.')) return;

            try {
                // Delete exam
                await deleteDoc(doc(db, 'lecture_exams', examId));

                // Delete associated results
                const resultsQ = query(collection(db, 'lecture_exam_results'), where('examId', '==', examId));
                const resultsSnap = await getDocs(resultsQ);
                const batch = writeBatch(db);
                resultsSnap.forEach(doc => batch.delete(doc.ref));
                await batch.commit();

                showToast('تم حذف الامتحان والنتائج المرتبطة به');
            } catch (error) {
                console.error('Error deleting exam:', error);
                showToast('حدث خطأ أثناء الحذف', true);
            }
        };

        // ======================= LECTURE EXAM RESULTS ADMIN =======================
        function initLectureExamResults() {
            loadLectureExamResultsAdmin();
        }

        async function loadLectureExamResultsAdmin() {
            const container = document.getElementById('admin-lecture-exam-results-list');

            const q = query(collection(db, 'lecture_exam_results'), orderBy('completedAt', 'desc'));

            onSnapshot(q, async (snapshot) => {
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-slate-400 text-center">لا توجد نتائج حتى الآن</p>';
                    return;
                }

                let html = '';
                for (const resultDoc of snapshot.docs) {
                    const result = resultDoc.data();

                    // Get exam title
                    let examTitle = 'امتحان محذوف';
                    try {
                        const examDoc = await getDoc(doc(db, 'lecture_exams', result.examId));
                        if (examDoc.exists()) {
                            examTitle = examDoc.data().title;
                        }
                    } catch (e) {
                        console.error('Error fetching exam:', e);
                    }

                    const gradeColor = result.percentage >= 70 ? 'text-green-400' : result.percentage >= 50 ? 'text-yellow-400' : 'text-red-400';

                    html += `
                        <div class="glass-effect p-4 rounded-lg">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h4 class="font-bold text-white">${result.userName}</h4>
                                    <p class="text-xs text-slate-400">${examTitle}</p>
                                    <p class="text-[10px] text-slate-500 mt-1">
                                        ${result.completedAt ? new Date(result.completedAt.seconds * 1000).toLocaleString('ar-EG') : ''}
                                    </p>
                                </div>
                                <button onclick="deleteLectureExamResult('${resultDoc.id}')" 
                                    class="text-red-400 hover:text-red-300">
                                    <i class="ph-trash text-lg"></i>
                                </button>
                            </div>
                            <div class="grid grid-cols-4 gap-2 text-center">
                                <div class="bg-white/5 rounded p-2">
                                    <p class="text-xs text-slate-400">صحيح</p>
                                    <p class="text-lg font-bold text-green-400">${result.correctCount}</p>
                                </div>
                                <div class="bg-white/5 rounded p-2">
                                    <p class="text-xs text-slate-400">خطأ</p>
                                    <p class="text-lg font-bold text-red-400">${result.wrongCount}</p>
                                </div>
                                <div class="bg-white/5 rounded p-2">
                                    <p class="text-xs text-slate-400">النسبة</p>
                                    <p class="text-lg font-bold ${gradeColor}">${result.percentage}%</p>
                                </div>
                                <div class="bg-white/5 rounded p-2">
                                    <p class="text-xs text-slate-400">التقدير</p>
                                    <p class="text-sm font-bold ${gradeColor}">${result.grade}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                container.innerHTML = html;
            });
        }

        window.deleteLectureExamResult = async (resultId) => {
            if (!confirm('هل أنت متأكد من حذف هذه النتيجة؟')) return;

            try {
                await deleteDoc(doc(db, 'lecture_exam_results', resultId));
                showToast('تم حذف النتيجة');
            } catch (error) {
                console.error('Error deleting result:', error);
                showToast('حدث خطأ أثناء الحذف', true);
            }
        };
        // ======================= END LECTURE EXAM ADMIN =======================


        function openQuestionTypeSelector() {
            const tfCount = currentAdminQuestions.filter(q => q.type === 'tf').length;
            const mcqCount = currentAdminQuestions.filter(q => q.type === 'mcq').length;

            const content = `
                <div class="grid grid-cols-2 gap-4 p-4">
                    <button onclick="addQuestionToBuilder('tf')" class="p-6 rounded-xl border border-[var(--primary-glow)]/20 hover:bg-[var(--primary-glow)]/10 transition group text-center">
                        <i class="ph-check-square-offset text-3xl mb-2 text-[var(--primary-glow)]"></i>
                        <p class="font-bold">صح / خطأ</p>
                        <p class="text-[10px] text-slate-500 mt-1">${tfCount} / 25</p>
                    </button>
                    <button onclick="addQuestionToBuilder('mcq')" class="p-6 rounded-xl border border-[var(--primary-glow)]/20 hover:bg-[var(--primary-glow)]/10 transition group text-center">
                        <i class="ph-list-bullets text-3xl mb-2 text-[var(--primary-glow)]"></i>
                        <p class="font-bold">اختيار من متعدد</p>
                        <p class="text-[10px] text-slate-500 mt-1">${mcqCount} / 25</p>
                    </button>
                </div>
            `;
            openModalWithContent('اختر نوع السؤال', content);
        }

        window.addQuestionToBuilder = (type) => {
            const tfCount = currentAdminQuestions.filter(q => q.type === 'tf').length;
            const mcqCount = currentAdminQuestions.filter(q => q.type === 'mcq').length;

            if (type === 'tf' && tfCount >= 25) {
                showToast('لقد أكملت 25 سؤال صح وخطأ', true);
                return;
            }
            if (type === 'mcq' && mcqCount >= 25) {
                showToast('لقد أكملت 25 سؤال اختيار من متعدد', true);
                return;
            }

            const id = Date.now().toString();
            currentAdminQuestions.push({ id, type, question: '', options: type === 'tf' ? ['صح', 'خطأ'] : ['', '', '', ''], correct: 0 });
            renderQuestionBuilder();
            closeGenericModal();
        };

        // ======================= LECTURE EXAM SYSTEM =======================
        window.currentLectureExams = [];

        window.launchLectureExamById = (examId, lectureTitle, lectureId, subjectName) => {
            const exam = window.currentLectureExams.find(e => e.id === examId);
            if (!exam) return;

            // Show 3-second preparation timer
            const preparationHTML = `
                <div class="water-effect-container text-center p-10 flex flex-col items-center">
                    <div id="prep-countdown" class="text-7xl font-bold text-[var(--primary-glow)] mb-4 animate-bounce">3</div>
                    <p class="text-xl font-bold text-white mb-2">جاري إعداد الامتحان...</p>
                    <p class="text-sm text-slate-400">يرجى الانتظار...</p>
                    <div class="mt-6 w-full bg-white/5 h-1 rounded-full overflow-hidden">
                        <div class="bg-[var(--primary-glow)] h-full w-full origin-left animate-loading-bar"></div>
                    </div>
                </div>
            `;

            openModalWithContent('بدء الامتحان', preparationHTML);
            document.getElementById('generic-modal').classList.add('water-modal-mode');
            const audio = document.getElementById('timer-start-sound');
            if (audio) audio.play();

            let count = 3;
            const interval = setInterval(() => {
                count--;
                const countEl = document.getElementById('prep-countdown');
                if (countEl) countEl.textContent = count > 0 ? count : 'بدء!';
                if (count <= 0) {
                    clearInterval(interval);
                    startLectureExamSession(exam, lectureTitle, lectureId, subjectName);
                }
            }, 1000);
        };

        window.openLectureExam = async (lectureId, lectureTitle, subject) => {
            updateUserActivity(`يفتح امتحان المحاضرة: ${lectureTitle}`);

            // Fetch Exams
            const q = query(collection(db, "lecture_exams"),
                where("lectureId", "==", lectureId),
                where("isHidden", "==", false)
            );

            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                showToast('لا يوجد امتحان متاح لهذه المحاضرة حالياً', true);
                return;
            }

            // Store exams
            window.currentLectureExams = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Check results
            const resultsQ = query(collection(db, "lecture_exam_results"),
                where("lectureId", "==", lectureId),
                where("userId", "==", currentUser.id)
            );
            const resultsSnap = await getDocs(resultsQ);
            const completedExamIds = new Set(resultsSnap.docs.map(d => d.data().examId));

            // Generate List HTML
            const listHTML = window.currentLectureExams.map((exam, index) => {
                const isCompleted = completedExamIds.has(exam.id);
                // Try to get order from title or index
                const title = exam.title || `امتحان ${index + 1}`;

                if (isCompleted) {
                    return `
                        <div class="water-effect-container p-4 mb-4 text-center opacity-70">
                            <h4 class="font-bold text-lg text-white mb-2">${title}</h4>
                            <p class="text-green-400 font-bold flex items-center justify-center gap-2">
                                <i class="ph-check-circle"></i> تم الحل
                            </p>
                        </div>
                    `;
                } else {
                    return `
                        <div onclick="launchLectureExamById('${exam.id}', '${lectureTitle}', '${lectureId}', '${subject}')" 
                             class="water-effect-container p-4 mb-4 text-center cursor-pointer hover:scale-105 transition-transform group">
                            <h4 class="font-bold text-lg text-white mb-2 group-hover:text-[var(--primary-glow)] transition-colors">${title}</h4>
                            <p class="text-slate-300 group-hover:text-white transition-colors">اضغط للبدء 🚀</p>
                        </div>
                    `;
                }
            }).join('');

            const content = `
                <div class="space-y-4 p-2">
                    <h3 class="text-xl font-bold text-center mb-6 text-white bg-clip-text text-transparent bg-gradient-to-r from-[var(--primary-glow)] to-purple-400">الامتحانات المتاحة</h3>
                    ${listHTML}
                </div>
            `;

            openModalWithContent(`الامتحانات المتاحة`, content);
            document.getElementById('generic-modal').classList.add('water-modal-mode');
        };

        function startLectureExamSession(exam, lectureTitle, lectureId, subjectName) {
            closeGenericModal();
            updateUserActivity(`يؤدي امتحان المحاضرة: ${lectureTitle}`);
            const startTime = Date.now();
            const duration = 25 * 60; // 25 minutes in seconds
            let timeLeft = duration;

            // Full-Screen Mobile Optimized Overlay
            const overlayHTML = `
                <div id="active-lecture-exam-overlay" class="fixed inset-0 z-[5500] bg-slate-950 flex flex-col overflow-y-auto">
                    <!-- Header -->
                    <div class="sticky top-0 z-[5600] bg-slate-900/80 backdrop-blur-xl border-b border-white/5 p-4 flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-bold text-white leading-tight">${exam.title || 'امتحان المحاضرة'}</h2>
                            <p class="text-[10px] text-[var(--primary-glow)] uppercase tracking-widest">${lectureTitle}</p>
                        </div>
                        <!-- Transparent Timer with Animation -->
                        <div id="lecture-exam-timer" class="px-4 py-2 text-2xl font-mono font-bold text-white animate-pulse" style="text-shadow: 0 0 20px rgba(var(--primary-glow-rgb), 0.5);">
                            25:00
                        </div>
                    </div>

                    <!-- Questions Container -->
                    <div class="flex-grow p-4 md:p-8 max-w-3xl mx-auto w-full space-y-10 pb-40">
                        ${(exam.questions || []).map((q, i) => {
                if (!q) return '';
                const questionText = q.question || q.text || 'السؤال غير متوفر';
                const options = q.options || [];

                return `
                            <div class="lecture-exam-question-card">
                                <div class="flex items-start gap-4 mb-6">
                                    <span class="w-10 h-10 rounded-xl bg-[var(--primary-glow)] text-black flex items-center justify-center font-black shrink-0 shadow-[0_0_15px_rgba(var(--primary-glow-rgb),0.3)]">${i + 1}</span>
                                    <h3 class="text-xl font-bold text-white leading-relaxed pt-1">${questionText}</h3>
                                </div>
                                <div class="space-y-3">
                                    ${options.map((opt, optIdx) => {
                    const optionText = opt || 'خيار غير متوفر';
                    return `
                                        <label class="lecture-exam-option group" id="lq${i}-opt${optIdx}" onclick="selectLectureExamOption(${i}, ${optIdx})">
                                            <input type="radio" name="lq${i}" value="${optIdx}" class="hidden">
                                            <div class="radio-custom" style="border: 2px solid rgba(255,255,255,0.3); width: 22px; height: 22px; border-radius: 50%; margin-left: 10px; display: flex; align-items: center; justify-content: center;">
                                                <div class="radio-inner" style="width: 8px; height: 8px; background: var(--primary-glow); border-radius: 50%; transform: scale(0); transition: transform 0.2s;"></div>
                                            </div>
                                            <span class="text-slate-200 font-bold group-hover:text-white transition-colors flex-grow text-right">${optionText}</span>
                                        </label>
                                        `;
                }).join('')}
                                </div>
                            </div>
                            `;
            }).join('')}
                    </div>

                    <!-- Small Transparent Submit Button -->
                    <div class="fixed bottom-8 left-1/2 transform -translate-x-1/2 z-[5600]">
                        <button onclick="finishLectureExam()" class="lecture-exam-submit-btn">
                            تسليم الإمتحان
                        </button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', overlayHTML);

            window.activeLectureExamSession = {
                exam: exam,
                lectureId: lectureId,
                lectureTitle: lectureTitle,
                subjectName: subjectName,
                startTime: startTime,
                secondsRemaining: duration,
                answers: new Array(exam.questions.length).fill(null)
            };

            // Start Timer
            const timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                timeLeft = duration - elapsed;
                window.activeLectureExamSession.secondsRemaining = timeLeft;

                const timerEl = document.getElementById('lecture-exam-timer');
                if (timerEl) {
                    const mins = Math.floor(Math.max(0, timeLeft) / 60);
                    const secs = Math.max(0, timeLeft) % 60;
                    timerEl.innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                    if (timeLeft < 60) timerEl.classList.add('text-red-500', 'animate-pulse');
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    finishLectureExam(true);
                }
            }, 1000);

            window.activeLectureExamInterval = timerInterval;
        }

        window.selectLectureExamOption = (questionIndex, optionIndex) => {
            if (!window.activeLectureExamSession) return;
            window.activeLectureExamSession.answers[questionIndex] = optionIndex;

            // Visual feedback
            const allOptions = document.querySelectorAll(`[id^="lq${questionIndex}-opt"]`);
            allOptions.forEach(opt => {
                opt.classList.remove('selected');
                opt.querySelector('.radio-inner').style.transform = 'scale(0)';
            });
            const selectedOpt = document.getElementById(`lq${questionIndex}-opt${optionIndex}`);
            if (selectedOpt) {
                selectedOpt.classList.add('selected');
                selectedOpt.querySelector('.radio-inner').style.transform = 'scale(1)';
            }
        };

        window.finishLectureExam = async (isAuto = false) => {
            if (!window.activeLectureExamSession) return;
            if (!isAuto && !confirm('هل أنت متأكد من إنهاء الامتحان؟ سيتم حفظ النتيجة الحالية.')) return;

            if (window.activeLectureExamInterval) clearInterval(window.activeLectureExamInterval);

            const { exam, answers, lectureId, lectureTitle, subjectName } = window.activeLectureExamSession;
            let correctCount = 0;
            let wrongCount = 0;

            exam.questions.forEach((q, idx) => {
                if (answers[idx] === parseInt(q.correct)) {
                    correctCount++;
                } else {
                    wrongCount++;
                }
            });

            const totalQuestions = exam.questions ? exam.questions.length : 1;
            const percentage = Math.round((correctCount / totalQuestions) * 100);

            // Calculate grade
            let grade = "راسب";
            if (percentage >= 90) grade = "ممتاز";
            else if (percentage >= 80) grade = "جيد جداً";
            else if (percentage >= 70) grade = "جيد";
            else if (percentage >= 60) grade = "مقبول";

            // Motivational quote
            let quote = "أحسنت واصل الاجتهاد!";
            if (percentage >= 90) quote = "ممتاز! فخورين بيك يا بطل ❤️";
            else if (percentage >= 75) quote = "عاش.. مستوى رائع جداً 💪";
            else if (percentage >= 50) quote = "جيد جداً.. ركز أكتر المرة الجاية 🚀";
            else quote = "لا تيأس.. ذاكر أكتر وهتنجح المرة الجاية 📖";

            // Save to DB
            try {
                const elapsed = Math.floor((Date.now() - window.activeLectureExamSession.startTime) / 1000);
                const m = Math.floor(elapsed / 60);
                const s = elapsed % 60;
                const timeTaken = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

                await addDoc(collection(db, "lecture_exam_results"), {
                    examId: exam.id,
                    lectureId: lectureId,
                    userId: currentUser.id,
                    userName: currentUser.name,
                    answers: answers,
                    correctCount: correctCount,
                    wrongCount: wrongCount,
                    totalQuestions: totalQuestions,
                    percentage: percentage,
                    grade: grade,
                    timeTaken: timeTaken,
                    completedAt: serverTimestamp()
                });

                // Extract lecture number from title (e.g., "المحاضرة 1" or "المحاضرة الأولى")
                let lectureNumber = 1;
                const numMatch = lectureTitle.match(/\d+/);
                if (numMatch) {
                    lectureNumber = parseInt(numMatch[0]);
                } else {
                    const ordinalsMap = { "الأولى": 1, "الثانية": 2, "الثالثة": 3, "الرابعة": 4, "الخامسة": 5, "السادسة": 6, "السابعة": 7, "الثامنة": 8, "التاسعة": 9, "العاشرة": 10 };
                    for (const [key, val] of Object.entries(ordinalsMap)) {
                        if (lectureTitle.includes(key)) {
                            lectureNumber = val;
                            break;
                        }
                    }
                }



                // 🔴 REMOVE RED INDICATOR IMMEDIATELY
                const redDot = document.getElementById(`exam-indicator-${lectureId}`);
                if (redDot) {
                    redDot.remove();
                }

            } catch (error) {
                console.error("Error saving lecture exam result:", error);
                showToast("حدث خطأ أثناء حفظ النتيجة", true);
            }

            // Cleanup exam overlay first
            const overlay = document.getElementById('active-lecture-exam-overlay');
            if (overlay) overlay.remove();
            window.activeLectureExamSession = null;

            // Show beautiful results with water effect
            showLectureExamResults({
                correctCount,
                wrongCount,
                percentage,
                grade,
                quote,
                lectureTitle
            });
        };

        function showLectureExamResults(results) {
            const { correctCount, wrongCount, percentage, grade, quote, lectureTitle } = results;

            // 🔒 LOCK: Prevent any automatic dismissal
            window.lectureResultLock = true;

            // Mark result as visible - prevent auto-close
            window.isResultModalVisible = true;

            // Determine grade color
            let gradeColor = 'text-white';
            if (percentage >= 90) gradeColor = 'text-amber-400';
            else if (percentage >= 75) gradeColor = 'text-emerald-400';
            else if (percentage >= 50) gradeColor = 'text-blue-400';
            else gradeColor = 'text-red-400';

            const resultsHTML = `
                <div class="lecture-exam-result-modal text-center relative">
                    
                    <!-- Decorative Background Glows -->
                    <div class="absolute top-1/4 left-1/4 w-64 h-64 sm:w-96 sm:h-96 bg-[var(--primary-glow)]/5 rounded-full blur-[120px] pointer-events-none animate-pulse" style="animation-duration: 4s;"></div>
                    <div class="absolute bottom-1/4 right-1/4 w-56 h-56 sm:w-80 sm:h-80 bg-[var(--secondary-glow)]/5 rounded-full blur-[100px] pointer-events-none animate-pulse" style="animation-duration: 5s; animation-delay: 1s;"></div>

                    <!-- Title -->
                    <h2 class="text-2xl sm:text-3xl md:text-4xl font-black text-white mb-2 sm:mb-3 relative z-10" style="text-shadow: 0 0 30px rgba(255,255,255,0.15); letter-spacing: 0.05em;">
                        🎉 نتيجة الامتحان
                    </h2>
                    <p class="text-xs sm:text-sm text-[var(--primary-glow)] font-bold uppercase tracking-[0.2em] sm:tracking-[0.3em] mb-6 sm:mb-8 md:mb-12 relative z-10 opacity-70 px-2">${lectureTitle}</p>

                    <!-- Animated Percentage Counter with Water Effect -->
                    <div class="relative z-10 mb-6 sm:mb-8 md:mb-10 flex flex-col items-center justify-center">
                        <div class="relative inline-block">
                            <!-- Water-like background for percentage -->
                            <div class="absolute inset-0 bg-gradient-to-br from-[var(--primary-glow)]/10 to-[var(--secondary-glow)]/10 rounded-full blur-2xl scale-150 animate-pulse" style="animation-duration: 3s;"></div>
                            
                            <!-- Percentage Display - Responsive sizes -->
                            <div id="animated-percentage" class="relative text-6xl sm:text-7xl md:text-8xl lg:text-9xl font-black text-transparent bg-clip-text bg-gradient-to-br from-white via-[var(--primary-glow)] to-[var(--secondary-glow)]" 
                                 style="filter: drop-shadow(0 0 25px rgba(0,245,195,0.4)); 
                                        font-family: 'Arial Black', 'Cairo', sans-serif; 
                                        animation: countUp 2s ease-out forwards; 
                                        opacity: 0;
                                        -webkit-text-stroke: 1px rgba(255,255,255,0.1);">
                                0%
                            </div>
                            
                            <!-- Grade Badge with Glass Effect - Responsive -->
                            <div class="absolute -bottom-3 sm:-bottom-4 md:-bottom-6 left-1/2 -translate-x-1/2 whitespace-nowrap px-4 py-1.5 sm:px-6 sm:py-2 md:px-8 md:py-2.5 rounded-full 
                                        bg-gradient-to-r from-white/10 to-white/5 
                                        border border-white/20 ${gradeColor} font-black text-base sm:text-lg md:text-xl 
                                        backdrop-blur-xl shadow-2xl 
                                        animate-fade-in" 
                                 style="animation-delay: 1.8s; 
                                        box-shadow: 0 10px 40px rgba(0,0,0,0.3), 0 0 20px rgba(255,255,255,0.1) inset;">
                                ${grade}
                            </div>
                        </div>
                    </div>

                    <!-- Stats Grid with Water Glass Effect - Responsive -->
                    <div class="grid grid-cols-2 gap-3 sm:gap-4 md:gap-6 max-w-sm sm:max-w-md mx-auto mb-6 sm:mb-8 md:mb-12 relative z-10 mt-8 sm:mt-12 md:mt-16 px-2">
                        <!-- Wrong Answers -->
                        <div class="bg-gradient-to-br from-red-500/8 to-red-600/5 
                                    backdrop-blur-xl border border-red-500/15 
                                    p-3 sm:p-4 md:p-6 rounded-2xl sm:rounded-3xl flex flex-col items-center justify-center 
                                    group hover:from-red-500/15 hover:to-red-600/10 
                                    transition-all duration-300 
                                    animate-slide-up shadow-xl" 
                             style="animation-delay: 0.3s; box-shadow: 0 10px 30px rgba(239, 68, 68, 0.1);">
                            <i class="ph-x-circle text-2xl sm:text-3xl md:text-4xl text-red-400 mb-1 sm:mb-2 group-hover:scale-110 transition-transform"></i>
                            <span class="text-2xl sm:text-3xl md:text-4xl font-black text-red-400 mb-1 sm:mb-2" style="text-shadow: 0 0 20px rgba(239, 68, 68, 0.3);">${wrongCount}</span>
                            <span class="text-[10px] sm:text-xs md:text-sm text-red-300/80 font-bold tracking-wide">إجابات خاطئة</span>
                        </div>
                        
                        <!-- Correct Answers -->
                        <div class="bg-gradient-to-br from-green-500/8 to-emerald-600/5 
                                    backdrop-blur-xl border border-green-500/15 
                                    p-3 sm:p-4 md:p-6 rounded-2xl sm:rounded-3xl flex flex-col items-center justify-center 
                                    group hover:from-green-500/15 hover:to-emerald-600/10 
                                    transition-all duration-300 
                                    animate-slide-up shadow-xl" 
                             style="animation-delay: 0.5s; box-shadow: 0 10px 30px rgba(34, 197, 94, 0.1);">
                            <i class="ph-check-circle text-2xl sm:text-3xl md:text-4xl text-green-400 mb-1 sm:mb-2 group-hover:scale-110 transition-transform"></i>
                            <span class="text-2xl sm:text-3xl md:text-4xl font-black text-green-400 mb-1 sm:mb-2" style="text-shadow: 0 0 20px rgba(34, 197, 94, 0.3);">${correctCount}</span>
                            <span class="text-[10px] sm:text-xs md:text-sm text-green-300/80 font-bold tracking-wide">إجابات صحيحة</span>
                        </div>
                    </div>

                    <!-- Motivational Quote with Premium Glass Effect - Responsive -->
                    <div class="relative z-10 animate-fade-in max-w-xs sm:max-w-md md:max-w-lg mx-auto px-2" style="animation-delay: 1s;">
                         <div class="relative p-4 sm:p-6 md:p-8 rounded-2xl sm:rounded-[2rem] 
                                     bg-gradient-to-br from-white/8 via-white/4 to-transparent 
                                     border border-white/10 
                                     backdrop-blur-2xl 
                                     shadow-2xl overflow-hidden"
                              style="box-shadow: 0 20px 60px rgba(0,0,0,0.3), 0 0 40px rgba(255,255,255,0.05) inset;">
                            <!-- Quote decoration - Hidden on very small screens -->
                            <div class="hidden sm:block absolute top-2 sm:top-4 right-4 sm:right-6 text-4xl sm:text-5xl md:text-6xl text-[var(--primary-glow)]/10 font-serif">"</div>
                            <div class="hidden sm:block absolute bottom-2 sm:bottom-4 left-4 sm:left-6 text-4xl sm:text-5xl md:text-6xl text-[var(--primary-glow)]/10 font-serif">"</div>
                            
                            <p class="text-base sm:text-lg md:text-xl lg:text-2xl font-bold text-white leading-relaxed relative z-10" 
                               style="text-shadow: 0 2px 20px rgba(0,0,0,0.3);">
                                ${quote}
                            </p>
                         </div>
                    </div>
                </div>
            `;

            openModalWithContent('', resultsHTML);
            document.getElementById('generic-modal').classList.add('water-modal-mode');

            // Override modal close button to work properly
            const closeBtn = document.querySelector('#generic-modal .modal-close-btn');
            if (closeBtn) {
                closeBtn.onclick = (e) => {
                    e.stopPropagation();
                    window.lectureResultLock = false; // Unlock when user clicks X
                    window.isResultModalVisible = false; // Allow closing when user clicks X
                    closeGenericModal();
                };
                closeBtn.style.color = '#ef4444';
                closeBtn.innerHTML = '❌';
            }

            // Animate percentage counter
            setTimeout(() => {
                const percentageEl = document.getElementById('animated-percentage');
                if (percentageEl) {
                    let currentPercentage = 0;
                    const targetPercentage = percentage;
                    const duration = 2000; // 2 seconds
                    const steps = 60;
                    const increment = targetPercentage / steps;
                    const stepDuration = duration / steps;

                    const counter = setInterval(() => {
                        currentPercentage += increment;
                        if (currentPercentage >= targetPercentage) {
                            currentPercentage = targetPercentage;
                            clearInterval(counter);
                        }
                        percentageEl.textContent = Math.round(currentPercentage) + '%';
                    }, stepDuration);
                }
            }, 300);
        }

        // ======================= END LECTURE EXAM SYSTEM =======================


        function renderQuestionBuilder() {
            const container = document.getElementById('questions-builder-container');
            if (currentAdminQuestions.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-10">اضغط "إضافة سؤال" للبدء</p>';
                return;
            }

            container.innerHTML = currentAdminQuestions.map((q, idx) => {
                let optionsHTML = '';
                if (q.type === 'tf') {
                    optionsHTML = `
                        <div class="flex gap-4 mt-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="correct-${q.id}" ${q.correct === 0 ? 'checked' : ''} onchange="updateQuestionData('${q.id}', 'correct', 0)">
                                <span class="text-xs">صح</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="correct-${q.id}" ${q.correct === 1 ? 'checked' : ''} onchange="updateQuestionData('${q.id}', 'correct', 1)">
                                <span class="text-xs">خطأ</span>
                            </label>
                        </div>
                    `;
                } else {
                    optionsHTML = `
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            ${[0, 1, 2, 3].map(i => `
                                <div class="flex items-center gap-2 bg-black/30 p-1 rounded border border-white/5">
                                    <input type="radio" name="correct-${q.id}" ${q.correct === i ? 'checked' : ''} onchange="updateQuestionData('${q.id}', 'correct', ${i})">
                                    <input type="text" placeholder="خيار ${i + 1}" value="${q.options[i]}" oninput="updateQuestionData('${q.id}', 'option', ${i}, this.value)" class="bg-transparent border-none text-[10px] w-full focus:ring-0 p-0">
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                return `
                    <div class="question-card">
                        <div class="flex justify-between items-start mb-2">
                             <span class="text-[10px] py-0.5 px-2 rounded-full ${q.type === 'tf' ? 'bg-amber-500/20 text-amber-500' : 'bg-cyan-500/20 text-cyan-500'} font-bold">
                                ${idx + 1}. ${q.type === 'tf' ? 'صح/خطأ' : 'اختياري'}
                             </span>
                             <button onclick="removeQuestionFromBuilder('${q.id}')" class="text-red-500 hover:text-red-400"><i class="ph-trash"></i></button>
                        </div>
                        <input type="text" placeholder="اكتب السؤال هنا..." value="${q.question}" oninput="updateQuestionData('${q.id}', 'question', null, this.value)" class="w-full bg-black/40 border border-white/10 rounded-lg p-2 text-sm focus:border-[var(--primary-glow)] outline-none">
                        ${optionsHTML}
                    </div>
                `;
            }).join('');

            // Auto scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        window.updateQuestionData = (id, field, index, value) => {
            const q = currentAdminQuestions.find(it => it.id === id);
            if (!q) return;
            if (field === 'question') q.question = value;
            if (field === 'correct') q.correct = parseInt(index);
            if (field === 'option') q.options[index] = value;
        };

        window.removeQuestionFromBuilder = (id) => {
            currentAdminQuestions = currentAdminQuestions.filter(q => q.id !== id);
            renderQuestionBuilder();
        };

        async function saveWeeklyExam() {
            const title = document.getElementById('exam-title-input').value.trim();
            const year = document.getElementById('exam-year-select').value;
            const division = document.getElementById('exam-division-select').value;
            const subject = document.getElementById('exam-subject-select').value;

            if (!title || !year || !division || !subject) {
                showToast('يرجى إكمال جميع الحقول الرئيسية', true);
                return;
            }

            if (currentAdminQuestions.length < 50) {
                if (!confirm(`لقد أضفت ${currentAdminQuestions.length} سؤالاً فقط. هل تود الحفظ رغم ذلك؟ (المطلوب 50 للامتحان المثالي)`)) return;
            }

            const btn = document.getElementById('save-exam-btn');
            btn.disabled = true;
            btn.textContent = 'جاري الحفظ...';

            try {
                const examData = {
                    title,
                    year,
                    division,
                    subject,
                    questions: currentAdminQuestions,
                    createdAt: serverTimestamp(),
                    isHidden: false
                };

                await addDoc(collection(db, "weekly_exams"), examData);
                showToast('تم حفظ ونشر الامتحان بنجاح!');

                // Reset
                document.getElementById('exam-title-input').value = '';
                currentAdminQuestions = [];
                renderQuestionBuilder();
                renderAdminExamsList();
            } catch (e) {
                console.error(e);
                showToast('حدث خطأ أثناء الحفظ', true);
            } finally {
                btn.disabled = false;
                btn.textContent = 'حفظ ونشر الامتحان';
            }
        }

        function renderAdminExamsList() {
            const year = document.getElementById('exam-year-select').value;
            const division = document.getElementById('exam-division-select').value;
            const subject = document.getElementById('exam-subject-select').value;
            const container = document.getElementById('admin-exams-list');

            if (!year || !division || !subject) {
                container.innerHTML = '<p class="text-center text-slate-500 py-4">اختر المادة لعرض الامتحانات</p>';
                return;
            }

            const q = query(collection(db, "weekly_exams"),
                where("year", "==", year),
                where("division", "==", division),
                where("subject", "==", subject),
                orderBy("createdAt", "desc")
            );

            if (currentAdminExamsUnsubscribe) currentAdminExamsUnsubscribe();
            currentAdminExamsUnsubscribe = onSnapshot(q, (snapshot) => {
                let html = '';
                if (snapshot.empty) {
                    html = '<p class="text-center text-slate-500 py-4">لا توجد امتحانات لهذه المادة حالياً.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const exam = doc.data();
                        const dateText = exam.createdAt ? exam.createdAt.toDate().toLocaleDateString('ar-EG') : '';
                        const timeText = exam.createdAt ? exam.createdAt.toDate().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : '';

                        html += `
                            <div class="glass-effect p-4 rounded-xl flex justify-between items-center group hover:bg-white/5 transition">
                                <div>
                                    <h4 class="font-bold text-white">${exam.title}</h4>
                                    <p class="text-[10px] text-slate-400 mt-1">
                                        <i class="ph-calendar"></i> ${dateText} | <i class="ph-clock"></i> ${timeText}
                                    </p>
                                    <p class="text-[10px] text-[var(--primary-glow)] font-bold mt-0.5">${exam.questions.length} سؤال</p>
                                </div>
                                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="toggleExamVisibility('${doc.id}', ${exam.isHidden})" class="p-2 rounded-lg bg-white/5 hover:bg-yellow-500/20 text-yellow-500 transition">
                                        <i class="ph-${exam.isHidden ? 'eye-slash' : 'eye'}"></i>
                                    </button>
                                    <button onclick="deleteWeeklyExam('${doc.id}')" class="p-2 rounded-lg bg-white/5 hover:bg-red-500/20 text-red-500 transition">
                                        <i class="ph-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                }
                container.innerHTML = html;
            });
        }

        window.toggleExamVisibility = async (id, currentIsHidden) => {
            await updateDoc(doc(db, "weekly_exams", id), { isHidden: !currentIsHidden });
            showToast(`تم ${currentIsHidden ? 'إظهار' : 'إخفاء'} الامتحان`);
        };

        window.deleteWeeklyExam = async (id) => {
            if (!confirm('هل أنت متأكد من حذف هذا الامتحان نهائياً؟')) return;
            try {
                await deleteDoc(doc(db, "weekly_exams", id));
                showToast('تم حذف الامتحان بنجاح');
            } catch (e) {
                console.error(e);
                showToast('حدث خطأ أثناء الحذف', true);
            }
        };

        // Complete Database Cleanup for Admin
        window.clearAllWeeklyExams = async () => {
            if (!confirm("⚠️ تحذير: سيتم حذف جميع الامتحانات المسجلة نهائياً! هل أنت متأكد؟")) return;
            showPage('splash-screen');
            try {
                const q = query(collection(db, "weekly_exams"));
                const snap = await getDocs(q);
                const batch = writeBatch(db);
                snap.forEach(d => batch.delete(d.ref));
                await batch.commit();
                showToast("تم تنظيف جميع الامتحانات بنجاح");
            } catch (e) {
                console.error(e);
                showToast("فشلت عملية التنظيف", true);
            } finally {
                initAdminDashboard();
            }
        };

        // --- Student Side ---
        async function initWeeklyExamsIndicator() {
            if (!currentUser || currentUser.isAdmin) return;

            // 1. Fetch all exams for my year/division
            const examsQ = query(collection(db, "weekly_exams"),
                where("year", "==", currentUser.year),
                where("division", "==", currentUser.division),
                where("isHidden", "==", false)
            );

            // 2. Fetch my results
            const resultsQ = query(collection(db, "exam_results"),
                where("userId", "==", currentUser.id)
            );

            onSnapshot(examsQ, (examsSnap) => {
                onSnapshot(resultsQ, (resSnap) => {
                    const completedIds = resSnap.docs.map(d => d.data().examId);
                    window.studentExamIndicators = {};
                    let newExamsTotal = 0;

                    examsSnap.forEach(eDoc => {
                        const exam = eDoc.data();
                        if (!completedIds.includes(eDoc.id)) {
                            window.studentExamIndicators[exam.subject] = true;
                            newExamsTotal++;
                        }
                    });

                    // Update UI
                    updateNavExamBadge(newExamsTotal);
                });
            });
        }

        function updateNavExamBadge(count) {
            const btn = document.getElementById('weekly-exams-nav-btn');
            if (!btn) return;
            let dot = btn.querySelector('.nav-indicator-dot');
            if (count > 0) {
                if (!dot) {
                    dot = document.createElement('span');
                    dot.className = 'nav-indicator-dot absolute top-2 right-4 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-[var(--bg-color)]';
                    btn.appendChild(dot);
                }
            } else if (dot) {
                dot.remove();
            }
        }

        function openWeeklyExamsStudentView() {
            // Clear red dot on click
            updateNavExamBadge(0);
            updateUserActivity("يتصفح قسم الامتحانات الأسبوعية");
            const subjects = materials['ar'][`${currentUser.year}_${currentUser.division}`] || [];

            const listHTML = `
                <div class="exams-cinematic-container space-y-4 p-4 animate-fade-in">
                    <div class="text-center mb-8">
                        <h3 class="text-2xl font-bold text-white tracking-widest uppercase opacity-80">اختر المـــادة</h3>
                        <div class="w-16 h-1 bg-[var(--primary-glow)] mx-auto mt-2 rounded-full opacity-50"></div>
                    </div>
                    <div class="grid grid-cols-1 gap-4">
                        ${subjects.map((s, idx) => {
                const hasPending = window.studentExamIndicators && window.studentExamIndicators[s];
                const dot = hasPending ? '<span class="absolute top-4 right-4 w-3 h-3 bg-red-500 rounded-full shadow-[0_0_15px_#ef4444] animate-pulse"></span>' : '';
                return `
                                <div onclick="openExamsForSubject('${s}')" 
                                     class="relative group cursor-pointer transform transition-all duration-300 hover:scale-[1.02] active:scale-95 animate-slide-up"
                                     style="animation-delay: ${idx * 0.1}s">
                                    <div class="glass-effect p-6 rounded-2xl border border-white/5 bg-white/5 flex items-center justify-between overflow-hidden">
                                        <!-- Ambient Glow -->
                                        <div class="absolute -right-10 -top-10 w-48 h-48 bg-[var(--primary-glow)]/5 rounded-full blur-3xl group-hover:bg-[var(--primary-glow)]/10 transition-colors"></div>
                                        
                                        <div class="flex items-center gap-6 relative z-10">
                                            <div class="w-14 h-14 rounded-xl bg-white/5 flex items-center justify-center text-[var(--primary-glow)] group-hover:bg-[var(--primary-glow)] group-hover:text-black transition-all duration-500">
                                                <i class="${getSubjectIcon(s)} text-2xl group-hover:scale-120"></i>
                                            </div>
                                            <div>
                                                <span class="text-xl font-bold text-white group-hover:text-[var(--primary-glow)] transition-colors">${s}</span>
                                                <p class="text-[10px] text-slate-500 uppercase tracking-widest mt-1">اختر المادة للبدء</p>
                                            </div>
                                        </div>
                                        
                                        <div class="relative z-10">
                                            ${dot}
                                            <i class="ph-caret-left text-slate-500 group-hover:text-[var(--primary-glow)] group-hover:-translate-x-2 transition-all text-xl"></i>
                                        </div>
                                    </div>
                                </div>
                            `;
            }).join('')}
                    </div>
                </div>
            `;

            // Frameless Transparent Modal for Exams
            const modal = document.getElementById('generic-modal');
            modal.classList.add('card-modal-mode'); // Use the same transparent mode as student card

            const onCloseHandler = () => {
                closeGenericModal();
                setTimeout(() => modal.classList.remove('card-modal-mode'), 300);
            };

            openModalWithContent('', listHTML, onCloseHandler);
        }

        window.openExamsForSubject = async (subject) => {
            updateUserActivity(`يستعرض امتحانات: ${subject}`);

            // Show loading state immediately
            const loaderHTML = `
                <div class="exams-cinematic-container space-y-4 p-4 animate-fade-in mb-6">
                    <div class="text-center mb-8">
                       <h3 class="text-2xl font-bold text-white tracking-widest uppercase opacity-90 text-right pr-4">${subject}</h3>
                    </div>
                    <div class="flex justify-center items-center py-20">
                        <div class="w-16 h-16 border-4 border-[var(--primary-glow)] border-t-transparent rounded-full animate-spin"></div>
                    </div>
                </div>`;

            const modalContent = document.getElementById('modal-body');
            if (modalContent) {
                modalContent.innerHTML = loaderHTML;
            } else {
                openModalWithContent('', loaderHTML);
            }

            try {
                // 1. Fetch results first to check status
                const resultsSnap = await getDocs(query(collection(db, "exam_results"), where("userId", "==", currentUser.id)));
                const completedIds = resultsSnap.docs.map(d => d.data().examId);

                // 2. Query exams (Simplified to avoid index errors)
                const q = query(collection(db, "weekly_exams"),
                    where("year", "==", currentUser.year),
                    where("division", "==", currentUser.division),
                    where("subject", "==", subject)
                );

                onSnapshot(q, (snapshot) => {
                    let exams = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        // Manual filtering and sorting
                        if (data.isHidden === false) {
                            exams.push({ id: doc.id, ...data });
                        }
                    });

                    // Sort by createdAt desc locally
                    exams.sort((a, b) => {
                        const tA = a.createdAt ? a.createdAt.toMillis() : 0;
                        const tB = b.createdAt ? b.createdAt.toMillis() : 0;
                        return tB - tA;
                    });

                    let cardsHTML = '';
                    if (exams.length === 0) {
                        cardsHTML = `
                            <div class="stylish-friday-msg">
                                <i class="ph-calendar-blank text-red-500" style="font-size: 3rem;"></i>
                                <p class="text-red-500 font-bold text-2xl" style="margin-top: 1.5rem;">الإمتحان بيترفع كل يوم جمعة</p>
                            </div>
                        `;
                    } else {
                        exams.forEach((exam, idx) => {
                            const isCompleted = completedIds.includes(exam.id);
                            const statusColor = isCompleted ? 'var(--primary-glow)' : 'var(--secondary-glow)';

                            cardsHTML += `
                                <div onclick="${isCompleted ? 'showToast(\'لقد أتممت هذا الامتحان بالفعل\')' : `prepareForExam('${exam.id}')`}" 
                                     class="relative group cursor-pointer transform transition-all duration-300 hover:scale-[1.02] active:scale-95 animate-slide-up"
                                     style="animation-delay: ${idx * 0.1}s">
                                    <div class="glass-effect p-6 rounded-2xl border border-white/5 bg-white/5 flex items-center justify-between overflow-hidden">
                                        <!-- Dynamic Glow -->
                                        <div class="absolute -right-10 -top-10 w-48 h-48 bg-[${statusColor}]/5 rounded-full blur-3xl group-hover:bg-[${statusColor}]/10 transition-colors"></div>
                                        
                                        <div class="flex items-center gap-6 relative z-10">
                                            <div class="w-14 h-14 rounded-xl bg-white/5 flex items-center justify-center text-[${statusColor}] group-hover:bg-[${statusColor}] group-hover:text-black transition-all duration-500">
                                                <i class="ph-exam text-2xl group-hover:scale-120"></i>
                                            </div>
                                            <div>
                                                <span class="text-xl font-bold text-white group-hover:text-[${statusColor}] transition-colors">${exam.title}</span>
                                                <div class="flex items-center gap-2 mt-1">
                                                    <span class="text-[10px] ${isCompleted ? 'text-[var(--primary-glow)] font-bold' : 'text-slate-500'} uppercase tracking-widest">
                                                        ${isCompleted ? 'تم الإكمال' : 'جاهز للبدء'}
                                                    </span>
                                                    ${isCompleted ? '<i class="ph-check-circle text-[var(--primary-glow)] text-xs"></i>' : ''}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="relative z-10">
                                            <i class="ph-caret-left text-slate-500 group-hover:text-[${statusColor}] group-hover:-translate-x-2 transition-all text-xl"></i>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    const listHTML = `
                        <div class="exams-cinematic-container space-y-4 p-4 animate-fade-in mb-6">
                            <div class="text-center mb-8">
                                <div class="flex items-center justify-between gap-6 mb-4 pb-4 border-b border-white/5">
                                    <button onclick="openWeeklyExamsStudentView()" class="w-12 h-12 flex items-center justify-center hover:bg-white/10 rounded-2xl transition-all group/back">
                                        <i class="ph-arrow-right text-slate-400 text-2xl group-hover/back:text-[var(--primary-glow)] group-hover/back:-translate-x-1 transition-all"></i>
                                    </button>
                                    <h3 class="text-2xl font-bold text-white tracking-widest uppercase opacity-90 text-right flex-grow pr-4">${subject}</h3>
                                    <div class="w-12"></div> <!-- Spacer for balance -->
                                </div>
                                <div class="w-24 h-1 bg-[var(--primary-glow)] mx-auto rounded-full opacity-30"></div>
                            </div>
                            <div class="grid grid-cols-1 gap-4">
                                ${cardsHTML}
                            </div>
                        </div>
                    `;

                    // Update list
                    const contentEl = document.getElementById('modal-body');
                    if (contentEl) contentEl.innerHTML = listHTML;
                }, (err) => {
                    console.error("Snapshot error:", err);
                    // Fallback to error message
                    const contentEl = document.getElementById('modal-body');
                    if (contentEl) {
                        contentEl.innerHTML = `
                             <div class="exams-cinematic-container space-y-4 p-4 animate-fade-in mb-6">
                                <div class="text-center mb-8">
                                    <div class="flex items-center justify-between gap-6 mb-4 pb-4 border-b border-white/5">
                                        <button onclick="openWeeklyExamsStudentView()" class="w-12 h-12 flex items-center justify-center hover:bg-white/10 rounded-2xl transition-all group/back">
                                            <i class="ph-arrow-right text-slate-400 text-2xl group-hover/back:text-[var(--primary-glow)] group-hover/back:-translate-x-1 transition-all"></i>
                                        </button>
                                        <h3 class="text-2xl font-bold text-white tracking-widest uppercase opacity-90 text-right flex-grow pr-4">${subject}</h3>
                                        <div class="w-12"></div>
                                    </div>
                                </div>
                                <div class="stylish-friday-msg">
                                    <i class="ph-warning-circle text-red-500" style="font-size: 3rem;"></i>
                                    <p class="text-red-500 font-bold text-2xl" style="margin-top: 1.5rem;">لم يتم رفع امتحان لهذه المادة حتى الآن</p>
                                    <p class="text-red-400 text-sm mt-3" style="opacity: 0.8;">يُرجى الانتظار حتى يقوم الأدمن برفع الامتحان</p>
                                </div>
                             </div>
                         `;
                    }
                });
            } catch (err) {
                console.error(err);
                showToast('فشل في تحميل الامتحانات', true);
            }
        };

        window.prepareForExam = async (examId) => {
            const docSnap = await getDoc(doc(db, "weekly_exams", examId));
            if (!docSnap.exists()) return;
            const exam = { id: docSnap.id, ...docSnap.data() };

            const preparationHTML = `
                <div class="text-center p-10 flex flex-col items-center">
                    <div id="prep-countdown" class="text-7xl font-bold text-[var(--primary-glow)] mb-4 animate-bounce">3</div>
                    <p class="text-xl font-bold text-white mb-2">جاري إعداد الامتحان</p>
                    <p class="text-sm text-slate-400">يرجى الانتظار...</p>
                    <div class="mt-6 w-full bg-white/5 h-1 rounded-full overflow-hidden">
                        <div class="bg-[var(--primary-glow)] h-full w-full origin-left animate-loading-bar"></div>
                    </div>
                </div>
            `;

            openModalWithContent('بدء الامتحان', preparationHTML);
            document.getElementById('timer-start-sound').play();

            let count = 3;
            const interval = setInterval(() => {
                count--;
                const countEl = document.getElementById('prep-countdown');
                if (countEl) countEl.textContent = count > 0 ? count : 'بدء!';
                if (count <= 0) {
                    clearInterval(interval);
                    startWeeklyExamSession(exam);
                }
            }, 1000);
        };

        function startWeeklyExamSession(exam) {
            closeGenericModal();
            updateUserActivity(`يؤدي امتحان: ${exam.title}`);
            const startTime = Date.now();
            const duration = (exam.duration || 25) * 60;
            let timeLeft = duration;

            // Full-Screen Mobile Optimized Overlay
            const overlayHTML = `
                <div id="active-exam-overlay" class="fixed inset-0 z-[5500] bg-slate-950 flex flex-col overflow-y-auto">
                    <!-- Header -->
                    <div class="sticky top-0 z-[5600] bg-slate-900/80 backdrop-blur-xl border-b border-white/5 p-4 flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-bold text-white leading-tight">${exam.title || 'اختبار أسبوعي'}</h2>
                            <p class="text-[10px] text-[var(--primary-glow)] uppercase tracking-widest">${exam.subject || 'بدون مادة'}</p>
                        </div>
                        <div id="exam-timer" class="bg-white/5 px-4 py-2 rounded-xl border border-white/10 text-xl font-mono font-bold text-white shadow-[0_0_15px_rgba(255,255,255,0.05)]">
                            ${Math.floor(duration / 60).toString().padStart(2, '0')}:${(duration % 60).toString().padStart(2, '0')}
                        </div>
                    </div>

                    <!-- Questions Container -->
                    <div class="flex-grow p-4 md:p-8 max-w-3xl mx-auto w-full space-y-10 pb-40">
                        ${(exam.questions || []).map((q, i) => {
                if (!q) return '';
                // Fix: Check q.question (Admin key) first, fall back to q.text
                const questionText = q.question || q.text || 'السؤال غير متوفر';
                const options = q.options || [];

                return `
                            <div class="question-block animate-slide-up" style="animation-delay: ${i * 0.05}s">
                                <div class="flex items-start gap-4 mb-6">
                                    <span class="w-10 h-10 rounded-xl bg-[var(--primary-glow)] text-black flex items-center justify-center font-black shrink-0 shadow-[0_0_15px_rgba(var(--primary-glow-rgb),0.3)]">${i + 1}</span>
                                    <h3 class="text-xl font-bold text-white leading-relaxed pt-1">${questionText}</h3>
                                </div>
                                <div class="space-y-3">
                                    ${options.map((opt, optIdx) => {
                    const optionText = opt || 'خيار غير متوفر';
                    return `
                                        <label class="exam-option-label group" id="q${i}-opt${optIdx}" onclick="selectExamOption(${i}, ${optIdx})">
                                            <input type="radio" name="q${i}" value="${optIdx}" class="hidden">
                                            <div class="radio-custom">
                                                <div class="radio-inner"></div>
                                            </div>
                                            <span class="text-slate-200 font-bold group-hover:text-white transition-colors flex-grow text-right">${optionText}</span>
                                        </label>
                                        `;
                }).join('')}
                                </div>
                            </div>
                            `;
            }).join('')}
                    </div>

                    <!-- Sticky Bottom Action Bar -->
                    <div class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-slate-950 via-slate-950/90 to-transparent pt-10 z-[5600]">
                        <button onclick="finishWeeklyExam()" class="w-full max-w-2xl mx-auto block py-5 rounded-2xl bg-[var(--primary-glow)] text-black font-black text-xl shadow-[0_10px_30px_rgba(var(--primary-glow-rgb),0.3)] hover:scale-[1.02] active:scale-95 transition-all">
                            تسليم وإنهاء الامتحان
                        </button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', overlayHTML);

            window.activeExamSession = {
                exam: exam,
                startTime: startTime,
                secondsRemaining: duration,
                answers: new Array(exam.questions.length).fill(null)
            };

            // Start Timer
            const timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                timeLeft = duration - elapsed;
                window.activeExamSession.secondsRemaining = timeLeft;

                const timerEl = document.getElementById('exam-timer');
                if (timerEl) {
                    const mins = Math.floor(Math.max(0, timeLeft) / 60);
                    const secs = Math.max(0, timeLeft) % 60;
                    timerEl.innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                    if (timeLeft < 60) timerEl.classList.add('text-red-500', 'animate-pulse');
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    finishWeeklyExam(true);
                }
            }, 1000);

            window.activeExamInterval = timerInterval;
        }

        window.finishWeeklyExam = async (isAuto = false) => {
            if (!window.activeExamSession) return;
            if (!isAuto && !confirm('هل أنت متأكد من إنهاء الامتحان؟ سيتم حفظ النتيجة الحالية.')) return;

            if (window.activeExamInterval) clearInterval(window.activeExamInterval);

            const { exam, answers } = window.activeExamSession;
            let correctCount = 0;
            let wrongCount = 0;

            exam.questions.forEach((q, idx) => {
                if (answers[idx] === parseInt(q.correct)) {
                    correctCount++;
                } else {
                    wrongCount++;
                }
            });

            const score = Math.round((correctCount / (exam.questions ? exam.questions.length : 1)) * 100);

            // Motivational quote
            let quote = "أحسنت واصل الاجتهاد!";
            if (score >= 90) quote = "ممتاز! فخورين بيك يا بطل ❤️";
            else if (score >= 75) quote = "عاش.. مستوى رائع جداً 💪";
            else if (score >= 50) quote = "جيد جداً.. ركز أكتر المرة الجاية 🚀";
            else quote = "لا تيأس.. ذاكر أكتر وهتنجح المرة الجاية 📖";

            // Save to DB
            try {
                const elapsed = Math.floor((Date.now() - window.activeExamSession.startTime) / 1000);
                const m = Math.floor(elapsed / 60);
                const s = elapsed % 60;
                const durationStr = `${m}د ${s}ث`;

                await addDoc(collection(db, "exam_results"), {
                    userId: currentUser.id,
                    userName: currentUser.name,
                    examId: exam.id,
                    examTitle: exam.title || 'اختبار أسبوعي',
                    subject: exam.subject || 'بدون مادة',
                    score,
                    correct: correctCount,
                    wrong: wrongCount,
                    total: exam.questions ? exam.questions.length : 0,
                    duration: durationStr,
                    timestamp: serverTimestamp()
                });



            } catch (e) {
                console.error("Failed to save results:", e);
            }

            // Revamped Cinematic Results UI
            const resultsHTML = `
                <div id="exam-result-overlay" class="fixed inset-0 z-[6000] flex items-center justify-center p-4 backdrop-filter backdrop-blur-3xl bg-black/40 animate-fade-in">
                    <div class="text-center w-full max-w-lg transform animate-scale-up">
                        <h2 class="text-2xl font-bold text-[var(--primary-glow)] mb-2 tracking-[0.2em] opacity-80 uppercase">نتيجة الاختبـار</h2>
                        <div id="animated-score" class="text-[120px] font-black text-white leading-none mb-4 drop-shadow-[0_0_30px_rgba(var(--primary-glow-rgb),0.5)]">0%</div>
                        <div class="text-xl font-medium text-slate-300 mb-10 tracking-wide uppercase opacity-70">${exam.title || 'اختبار أسبوعي'}</div>
                        <div class="flex justify-center gap-16 mb-12">
                            <div class="text-center transform animate-slide-up" style="animation-delay: 0.2s">
                                <p id="animated-correct" class="text-4xl font-bold text-green-400">0</p>
                                <p class="text-[10px] text-green-400/60 font-bold tracking-widest uppercase mt-1">صح</p>
                            </div>
                            <div class="text-center transform animate-slide-up" style="animation-delay: 0.3s">
                                <p id="animated-wrong" class="text-4xl font-bold text-red-400">0</p>
                                <p class="text-[10px] text-red-400/60 font-bold tracking-widest uppercase mt-1">خطأ</p>
                            </div>
                        </div>
                        <div id="motivational-quote" class="text-2xl font-bold text-white mb-12 opacity-0 transform translate-y-4 transition-all duration-1000">${quote}</div>
                        

                        <button onclick="closeExamResults()" class="px-12 py-4 rounded-full border border-white/20 bg-white/5 hover:bg-white/10 text-white font-bold text-lg tracking-widest transition-all duration-300 hover:scale-110 active:scale-95 hover:border-[var(--primary-glow)] group">
                            <span class="flex items-center gap-3">العودة للرئيسية <i class="ph-house group-hover:translate-x-[-4px] transition-transform"></i></span>
                        </button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', resultsHTML);

            // Animate Counters Logic
            const animateValue = (id, start, end, duration, isPercent = false) => {
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    const value = Math.floor(progress * (end - start) + start);
                    const el = document.getElementById(id);
                    if (el) el.textContent = value + (isPercent ? '%' : '');
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    } else if (id === 'animated-score') {
                        const quoteEl = document.getElementById('motivational-quote');
                        if (quoteEl) quoteEl.classList.remove('opacity-0', 'translate-y-4');
                    }
                };
                window.requestAnimationFrame(step);
            };

            setTimeout(() => {
                animateValue('animated-score', 0, score, 1500, true);
                animateValue('animated-correct', 0, correctCount, 1500);
                animateValue('animated-wrong', 0, wrongCount, 1500);

                // Auto-issue certificate if passed (50% or more)
                if (score >= 50) {
                    setTimeout(() => issueCertificate(), 2000);
                }
            }, 500);

            // Remove Exam Overlay
            const overlay = document.getElementById('active-exam-overlay');
            if (overlay) overlay.remove();

            window.activeExamSession = null;
        };

        window.closeExamResults = () => {
            const results = document.getElementById('exam-result-overlay');
            if (results) results.remove();
            // Clean dashboard reset
            initStudentDashboard();
            showPage('student-dashboard');
        };



        // =========================================================================
        function activateNavButtons() {
            const weeklyExamsBtn = document.getElementById('weekly-exams-nav-btn');
            if (weeklyExamsBtn) {
                weeklyExamsBtn.addEventListener('click', () => {
                    openWeeklyExamsStudentView();
                });
            }

            const summaryBtn = document.getElementById('summary-nav-btn');
            if (summaryBtn) {
                summaryBtn.addEventListener('click', () => {
                    handleRedirectWithCountdown('https://notebooklm.google/', 'قسم التلخيص');
                });
            }

            /* 
               My Certificates Nav Btn Removed as requested 
            */


            document.getElementById('platform-btn').addEventListener('click', () => {
                handleRedirectWithCountdown('https://tanta-services.online/TantaPortal/studentindex.php?t=first', 'المنصة الرسمية');
            });

            document.querySelectorAll('.bottom-nav-btn[data-modal]').forEach(btn => {
                btn.addEventListener('click', async e => {
                    const type = e.currentTarget.dataset.modal;
                    if (currentContentUnsubscribe) currentContentUnsubscribe();

                    if (type === 'opinions-modal') {
                        openOpinionsView();
                    } else if (type === 'polls-modal') {
                        openPollsView();
                    } else if (type === 'about-modal') {
                        const aboutHTML = `<div class="text-center p-2 flex flex-col items-center space-y-4 w-full">
                            <p class="text-lg text-slate-300" data-text-key="aboutMain"></p>
                            <div class="my-2">
                                <p class="font-bold text-lg text-shadow-lg" style="color:var(--primary-glow)" data-text-key="aboutDeveloper"></p>
                            </div>
                            <hr class="w-full border-t border-[var(--glass-border)]">
                            <p class="font-bold text-slate-400" data-text-key="aboutSupervisors"></p>
                            <div class="space-y-2">
                                <p class="font-bold" style="color:var(--primary-glow); text-shadow: 0 0 10px var(--primary-glow);">ا. د/ عبدالمنعم الدسوقي</p>
                                <p class="font-bold" style="color:var(--primary-glow); text-shadow: 0 0 10px var(--primary-glow);">ا. د/ابراهيم ماريه</p>
                                <p class="font-bold" style="color:var(--primary-glow); text-shadow: 0 0 10px var(--primary-glow);">د/مصطفى عبدالمنعم</p>
                            </div>
                            <hr class="w-full border-t border-[var(--glass-border)]">
                            <div class="flex justify-center items-center gap-6 my-4">
                                <a href="#" onclick="event.preventDefault(); handleRedirectWithCountdown('https://wa.me/201067941806')" class="social-icon-animated text-3xl" style="color: #25D366; --glow-color: #25D366;"><i class="ph-whatsapp-logo"></i></a>
                                <a href="#" onclick="event.preventDefault(); handleRedirectWithCountdown('https://www.facebook.com/share/1CDtFCSPVD/')" class="social-icon-animated text-3xl" style="color: #1877F2; --glow-color: #1877F2; animation-delay: -2s;"><i class="ph-facebook-logo"></i></a>
                                <a href="#" onclick="event.preventDefault(); handleRedirectWithCountdown('mailto:amrloutfy2006@gmail.com')" class="social-icon-animated text-3xl" style="color: #EA4335; --glow-color: #EA4335; animation-delay: -4s;"><i class="ph-envelope"></i></a>
                            </div>
                            <p class="text-xs text-slate-500">تطوير Amr lotfy</p>
                        </div>`;
                        openModalWithContent('عنا', aboutHTML);
                        applySiteTexts();
                    } else if (type === 'settings-modal') {
                        updateUserActivity("يفتح الإعدادات");
                        let themesHTML = '';
                        for (const key in themes) {
                            themesHTML += `<button data-theme="${key}" class="theme-btn py-2 rounded-lg flex items-center justify-center gap-2"> <div class="w-4 h-4 rounded-full border border-slate-500/50" style="background:${themes[key].p}"></div> ${themes[key].n}</button>`;
                        }
                        const settingsHTML = `<div class="space-y-6 p-2"><h4 class="text-lg font-bold text-slate-300">الثيم اللوني</h4><div id="theme-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3">${themesHTML}</div></div>`;
                        openModalWithContent('الإعدادات', settingsHTML);
                        const currentTheme = localStorage.getItem('moraTheme') || 'default';
                        const themeBtn = document.querySelector(`.theme-btn[data-theme="${currentTheme}"]`);
                        if (themeBtn) themeBtn.classList.add('bg-[var(--primary-glow)]', 'text-black', 'font-bold');
                    } else if (type === 'ai-tools-modal') {
                        updateUserActivity("يتصفح أدوات الذكاء الاصطناعي");
                        const q = query(collection(db, "ai_tools"));
                        const snapshot = await getDocs(q);
                        let content = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                        if (snapshot.empty) {
                            content += '<p class="md:col-span-2 text-center">لا توجد أدوات حالياً.</p>';
                        } else {
                            snapshot.forEach(doc => {
                                const t = doc.data();
                                content += `<div onclick="handleRedirectWithCountdown('${t.url}')" class="p-3 rounded-lg cursor-pointer transition-all duration-300 hover:bg-slate-500/20"><h5 class="font-bold text-white">${t.name}</h5><p class="text-xs text-slate-400">${t.desc}</p></div>`;
                            });
                        }
                        content += '</div>';
                        openModalWithContent('أدوات الذكاء الاصطناعي', content);
                    } else if (type === 'support-modal') {
                        updateUserActivity('يفتح قسم الدعم الفني');
                        markStudentTicketsAsRead();
                        const supportHTML = `
                            <div class="space-y-4">
                                <div>
                                    <h4 class="text-lg font-bold text-slate-300 mb-2">تقديم شكوى أو استفسار</h4>
                                    <textarea id="support-problem-input" class="w-full rounded-lg input-field" rows="4" placeholder="اكتب تفاصيل مشكلتك هنا..."></textarea>
                                    <button id="submit-support-ticket-btn" class="w-full mt-2 py-2 rounded-lg font-bold btn-celestial">إرسال</button>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-slate-300 mb-2">تذاكر الدعم الخاصة بك</h4>
                                    <div id="support-tickets-list" class="space-y-3 max-h-60 overflow-y-auto">
                                        <p class="text-slate-400 text-center">جاري تحميل تذاكرك...</p>
                                    </div>
                                </div>
                            </div>`;
                        openModalWithContent('الدعم الفني', supportHTML);
                        const q = query(collection(db, "support_tickets"), where("userId", "==", currentUser.id), orderBy("createdAt", "desc"));
                        onSnapshot(q, (snapshot) => {
                            const container = document.getElementById('support-tickets-list');
                            if (!container) return;
                            if (snapshot.empty) {
                                container.innerHTML = '<p class="text-slate-400 text-center">لا توجد لديك تذاكر دعم سابقة.</p>';
                                return;
                            }
                            let ticketsHTML = '';
                            snapshot.forEach(doc => {
                                const ticket = doc.data();
                                const statusColor = ticket.status === 'تم الرد' ? 'text-green-400' : 'text-yellow-400';
                                const adminReply = ticket.adminReply ? `<div class="mt-2 pt-2 border-t border-slate-600"><p class="text-sm font-bold text-green-400">رد الإدارة:</p><p class="text-sm text-slate-200">${ticket.adminReply}</p></div>` : '';
                                ticketsHTML += `
                                <div class="glass-effect p-3 rounded-lg">
                                    <div class="flex justify-between items-start">
                                        <p class="text-xs text-slate-400">${ticket.createdAt.toDate().toLocaleString('ar-EG')}</p>
                                        <span class="text-sm font-bold ${statusColor}">${ticket.status}</span>
                                    </div>
                                    <p class="mt-2 text-white">${ticket.problem}</p>
                                    ${adminReply}
                                </div>`;
                            });
                            container.innerHTML = ticketsHTML;
                        });
                    }
                });
            });

            document.getElementById('digital-card-nav-btn').addEventListener('click', () => {
                updateUserActivity("يفتح بطاقته الرقمية");

                const modal = document.getElementById('generic-modal');
                modal.classList.add('card-modal-mode');

                const issueDate = currentUser.createdAt && currentUser.createdAt.seconds ? new Date(currentUser.createdAt.seconds * 1000).toLocaleDateString('ar-EG') : new Date().toLocaleDateString('ar-EG');
                const divisionName = currentUser.division === "international" ? "أعمال دولية (IB)" : "نظم معلومات (BIS)";
                const yearName = currentUser.year === '1' ? "الفرقة الأولى" : "الفرقة الثانية";

                let displayId = currentUser.studentId;
                if (!displayId) {
                    const shortId = currentUser.id ? currentUser.id.substring(0, 8).toUpperCase() : 'UNKNOWN';
                    displayId = `LEGACY-${shortId}`;
                }

                const qrText = `الطالب: ${currentUser.name}\nID: ${displayId}\nالفرقة: ${yearName}\nالشعبة: ${divisionName}\nالتسجيل: ${issueDate}`;

                const cardHTML = `
                    <div class="exams-cinematic-container space-y-6 p-4 animate-fade-in">
                        <div class="text-center mb-4">
                            <h3 class="text-2xl font-bold text-white tracking-[0.2em] uppercase opacity-80">بطاقتك الرقمية</h3>
                            <div class="w-20 h-1 bg-gradient-to-r from-transparent via-[var(--primary-glow)] to-transparent mx-auto mt-2 rounded-full opacity-50"></div>
                        </div>

                        <div class="student-card-container w-full flex items-center justify-center p-2 relative perspective-1000 animate-slide-up">
                            <div class="modern-glass-card card-interactive relative w-full h-auto p-8 shadow-2xl transition-transform duration-500 hover:scale-[1.02] border border-white/10">
                                <div class="absolute -top-10 -right-10 w-48 h-48 bg-[var(--primary-glow)] rounded-full blur-[80px] opacity-20 animate-pulse"></div>
                                <div class="absolute -bottom-10 -left-10 w-48 h-48 bg-[var(--secondary-glow)] rounded-full blur-[80px] opacity-20 animate-pulse" style="animation-duration: 4s;"></div>

                                <div class="student-card-content relative z-10">
                                    <div class="student-card-header flex justify-between items-start mb-8 border-b border-white/5 pb-6">
                                        <div class="student-card-title text-right">
                                            <h4 class="text-2xl font-bold text-white tracking-wide">BATAKA <span class="text-[var(--primary-glow)]">ID</span></h4>
                                            <p class="text-[10px] text-slate-400 uppercase tracking-widest mt-1 opacity-80">المعهد العالي للحاسبات والمعلومات وتكنولوجيا الإدارة بطنطا</p>
                                        </div>
                                        <div class="relative">
                                            <img src="https://i.postimg.cc/mgdFZ313/IMG-20250414-WA0047-1.jpg" alt="Logo" class="w-16 h-16 rounded-full border border-[var(--primary-glow)]/30 shadow-[0_0_20px_rgba(0,245,195,0.2)]">
                                            <div class="absolute -bottom-1 -right-1 bg-green-500 w-4 h-4 rounded-full border-2 border-slate-900"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="student-card-info space-y-5">
                                        <div class="text-right">
                                            <p class="text-[10px] text-slate-400 uppercase mb-1">اسم الطالب</p>
                                            <h3 class="font-bold text-white text-2xl leading-tight tracking-tight">${currentUser.name}</h3>
                                        </div>

                                        <div class="grid grid-cols-2 gap-6">
                                            <div>
                                                <p class="text-[10px] text-slate-400 uppercase mb-1">السنة الدراسية</p>
                                                <p class="font-bold text-[var(--primary-glow)] text-lg">${yearName}</p>
                                            </div>
                                            <div>
                                                <p class="text-[10px] text-slate-400 uppercase mb-1">الشعبة</p>
                                                <p class="font-bold text-white text-sm">${divisionName}</p>
                                            </div>
                                        </div>

                                        <div class="pt-4 border-t border-white/5">
                                            <p class="text-[10px] text-slate-400 uppercase mb-1">تاريخ التسجيل</p>
                                            <p class="font-bold text-[var(--primary-glow)] text-sm">${issueDate}</p>
                                        </div>
                                    </div>

                                    <div class="mt-8 pt-6 border-t border-white/10 flex flex-row items-center justify-between gap-4">
                                        <div class="text-right flex-1 min-w-0">
                                            <p class="text-[10px] text-slate-400 uppercase mb-1 font-bold tracking-wider">رقم التعريف (ID)</p>
                                            <p class="font-mono font-bold tracking-widest text-amber-400 opacity-100 whitespace-nowrap overflow-visible" style="font-size: min(15px, 4vw); line-height: 1;">${displayId}</p>
                                        </div>
                                        <div class="qr-container bg-white p-1.5 rounded-xl shadow-lg relative z-20 group-hover:scale-105 transition-transform duration-300">
                                            <div id="student-qr" class="w-20 h-20"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-center pb-4">
                            <p class="text-slate-500 text-[10px] uppercase tracking-[0.3em] opacity-40">Mora Educational Platform • Student Identity</p>
                        </div>
                    </div>
                `;

                const onCloseHandler = () => {
                    closeGenericModal();
                    setTimeout(() => modal.classList.remove('card-modal-mode'), 300);
                };

                openModalWithContent('', cardHTML, onCloseHandler);

                setTimeout(() => {
                    const qrContainer = document.getElementById("student-qr");
                    if (qrContainer) {
                        qrContainer.innerHTML = '';
                        try {
                            if (typeof QRCode !== 'undefined') {
                                new QRCode(qrContainer, {
                                    text: qrText,
                                    width: 80,
                                    height: 80,
                                    colorDark: "#000000",
                                    colorLight: "#ffffff",
                                    correctLevel: QRCode.CorrectLevel.M
                                });
                            }
                        } catch (e) {
                            const apiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrText)}`;
                            qrContainer.innerHTML = `<img src="${apiUrl}" alt="QR Code" class="w-full h-full object-contain">`;
                        }
                        setTimeout(() => {
                            if (!qrContainer.innerHTML || qrContainer.innerHTML.trim() === "") {
                                const apiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrText)}`;
                                qrContainer.innerHTML = `<img src="${apiUrl}" alt="QR Code" class="w-full h-full object-contain">`;
                            }
                        }, 50);
                    }
                }, 300);
            });

            document.getElementById('privacy-policy-nav-btn').addEventListener('click', () => {
                updateUserActivity("يقرأ سياسة الخصوصية");
                openModalWithContent('سياسة الخصوصية', '<div class="p-2 text-sm text-slate-300 space-y-3"><p><strong>مقدمة:</strong> نحن في منصة "Mora For Studying" نأخذ خصوصية بياناتك على محمل الجد.</p><p><strong>البيانات التي نجمعها:</strong> عند إنشاء حساب، نقوم بجمع الاسم، الفرقة، الشعبة، بالإضافة إلى IP Address ونوع الجهاز لأغراض أمنية وتحليلية.</p><p><strong>استخدام البيانات:</strong> لا يتم مشاركة بياناتك الشخصية مع أي طرف ثالث. تستخدم البيانات داخلياً لتحسين تجربتك وتأمين المنصة.</p><p class="font-bold text-red-400 border-t border-red-500/30 pt-3 mt-3"><strong>سياسة الاستخدام العادل:</strong> أي محاولة لإساءة استخدام الموقع، أو نشر محتوى غير لائق، أو التحايل على نظام النقاط سيؤدي إلى <strong>الحظر الفوري والدائم للحساب</strong> دون سابق إنذار.</p><p class="text-xs text-slate-500 text-center pt-3">تطوير Amr lotfy</p></div>');
            });

            document.getElementById('study-timer-nav-btn').addEventListener('click', () => {
                updateUserActivity("يفتح تايمر المذاكرة");
                openModalWithContent('تايمر المذاكرة', `<div class="text-center p-4 flex flex-col items-center"><p id="timer-display" class="text-6xl font-mono tracking-widest mb-6">${formatTime(timerState.duration)}</p><div class="flex gap-4"><button id="timer-start-btn" class="w-24 py-2 rounded-lg text-base font-bold btn-celestial">بدء</button><button id="timer-reset-btn" class="w-24 py-2 rounded-lg text-base font-bold btn-celestial border-amber-500 text-amber-500 hover:bg-amber-500 hover:text-black">إعادة ضبط</button></div></div>`);
                document.getElementById('timer-start-btn').onclick = () => timerState.running ? stopTimer() : startTimer();
                document.getElementById('timer-reset-btn').onclick = () => { stopTimer(); timerState.duration = 25 * 60; updateTimerDisplay(); };
            });

            document.getElementById('account-options-btn').addEventListener('click', () => {
                updateUserActivity("يفتح خيارات الحساب");
                openModalWithContent('خيارات الحساب', `<div class="space-y-3 p-2"><button id="logout-btn" class="w-full text-center p-3 rounded-lg hover:bg-red-500/20 transition text-red-400 font-semibold">تسجيل الخروج</button><button id="clear-data-btn" class="w-full text-center p-3 rounded-lg hover:bg-slate-500/20 transition">محو بياناتي من الجهاز</button></div>`);
            });
        }
        document.body.addEventListener('click', async e => {
            if (e.target.id === 'submit-opinion-btn') {
                const input = document.getElementById('opinion-input');
                const text = input.value.trim();
                if (!text) { showToast('لا يمكن نشر رأي فارغ', true); return; }
                const isAllowed = await checkAndHandleContent(text, currentUser.id, currentUser.name);
                if (!isAllowed) return;
                await updateUserActivity("كتب رأياً جديداً");
                await addDoc(collection(db, "opinions"), { name: currentUser.name, year: currentUser.year, text, createdAt: serverTimestamp(), reactions: [] });
                showToast('تم نشر رأيك بنجاح!');
                document.getElementById('generic-modal').classList.remove('open');
            }
            if (e.target.id === 'submit-support-ticket-btn') {
                const input = document.getElementById('support-problem-input');
                const problem = input.value.trim();
                if (!problem) { showToast('يرجى كتابة وصف للمشكلة.', true); return; }
                await updateUserActivity("أرسل تذكرة دعم");
                await addDoc(collection(db, "support_tickets"), {
                    userId: currentUser.id,
                    userName: currentUser.name,
                    problem: problem,
                    status: 'جديدة',
                    createdAt: serverTimestamp(),
                    adminReply: '',
                    isReadByAdmin: false,
                    isReadByStudent: true
                });
                showToast('تم إرسال مشكلتك بنجاح، سيتم الرد عليك قريباً.');
                input.value = '';
            }
            if (e.target.closest('.theme-btn')) { const themeKey = e.target.closest('.theme-btn').dataset.theme; applyTheme(themeKey); document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('bg-[var(--primary-glow)]', 'text-black', 'font-bold')); e.target.closest('.theme-btn').classList.add('bg-[var(--primary-glow)]', 'text-black', 'font-bold'); }
            if (e.target.id === 'logout-btn') { handleLogout(); }
            if (e.target.id === 'clear-data-btn') { if (confirm('هل أنت متأكد من محو جميع بياناتك؟ سيتم تسجيل خروجك.')) { localStorage.clear(); currentUser = null; document.getElementById('generic-modal').classList.remove('open'); showPage('auth-page'); renderAuthForm(false, true); initVantaBackground(); } }
        });
        let lastNotificationTimestamp = null;
        function listenForNotifications() { const q = query(collection(db, 'notifications'), orderBy('createdAt', 'desc'), limit(1)); onSnapshot(q, (snapshot) => { if (!snapshot.empty) { const latestNotif = snapshot.docs[0].data(); if (!lastNotificationTimestamp || latestNotif.createdAt.toMillis() > lastNotificationTimestamp) { lastNotificationTimestamp = latestNotif.createdAt.toMillis(); showToast(`إشعار جديد: ${latestNotif.body}`); document.getElementById('notification-dot').classList.remove('hidden'); document.getElementById('notifications-bell').querySelector('i').style.animation = 'notification-bell 2s ease-in-out'; setTimeout(() => { document.getElementById('notifications-bell').querySelector('i').style.animation = ''; }, 2000); } } }); }
        document.getElementById('notifications-bell').addEventListener('click', () => { document.getElementById('notification-dot').classList.add('hidden'); openModalWithContent('الإشعارات', '<div id="notifications-list" class="space-y-3"></div>'); const q = query(collection(db, 'notifications'), orderBy('createdAt', 'desc')); onSnapshot(q, (snapshot) => { const listEl = document.getElementById('notifications-list'); if (listEl) { listEl.innerHTML = snapshot.docs.map(doc => { const n = doc.data(); return `<div class="p-3 rounded-lg bg-slate-800/50"><p class="font-bold text-white">${n.title || ''}</p><p>${n.body}</p><p class="text-xs text-slate-500 mt-1">${n.createdAt.toDate().toLocaleString('ar-EG')}</p></div>`; }).join('') || '<p class="text-center text-slate-400">لا توجد إشعارات.</p>'; } }); });
        async function markStudentTicketsAsRead() {
            const q = query(collection(db, "support_tickets"), where("userId", "==", currentUser.id), where("isReadByStudent", "==", false));
            const snapshot = await getDocs(q);
            if (snapshot.empty) return;
            const batch = writeBatch(db);
            snapshot.forEach(doc => {
                batch.update(doc.ref, { isReadByStudent: true });
            });
            await batch.commit();
        }
        function listenForSupportReplies() {
            const supportNavBtn = document.querySelector('[data-modal="support-modal"]');
            if (!supportNavBtn) return;
            const q = query(collection(db, "support_tickets"), where("userId", "==", currentUser.id), where("isReadByStudent", "==", false));
            onSnapshot(q, (snapshot) => {
                const count = snapshot.size;
                let badge = supportNavBtn.querySelector('.notification-badge');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'notification-badge';
                    supportNavBtn.appendChild(badge);
                }
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            });
        }
        // ======================= CORRECTIONS LISTENER =======================
        function listenForCorrections() {
            const correctionsNavBtn = document.querySelector('[data-modal="corrections-modal"]');
            // Not needed for student, only for admin
        }
        async function markAdminItemsAsRead(collectionName) {
            const q = query(collection(db, collectionName), where("isReadByAdmin", "==", false));
            const snapshot = await getDocs(q);
            if (snapshot.empty) return;
            const batch = writeBatch(db);
            snapshot.forEach(doc => {
                batch.update(doc.ref, { isReadByAdmin: true });
            });
            await batch.commit();
        }
        function listenForNewAdminNotifications() {
            const collectionsToWatch = {
                'tickets-panel': 'support_tickets',
                'opinions-panel': 'opinions',
                'polls-panel': 'polls',
                'attendance-panel': 'attendance',
                'corrections-panel': 'lecture_corrections'
            };
            for (const [panelId, collectionName] of Object.entries(collectionsToWatch)) {
                const navBtn = document.querySelector(`[data-panel="${panelId}"]`);
                if (navBtn) {
                    navBtn.addEventListener('click', () => markAdminItemsAsRead(collectionName));
                    const q = query(collection(db, collectionName), where("isReadByAdmin", "==", false));
                    onSnapshot(q, (snapshot) => {
                        const count = snapshot.size;
                        let badge = navBtn.querySelector('.notification-badge');
                        if (!badge) {
                            badge = document.createElement('span');
                            badge.className = 'notification-badge';
                            badge.style.right = 'auto';
                            badge.style.left = '8px';
                            navBtn.appendChild(badge);
                        }
                        if (count > 0) {
                            badge.textContent = count;
                            badge.style.display = 'flex';
                            document.getElementById('admin-notification-sound').play();
                        } else {
                            badge.style.display = 'none';
                        }
                    });
                }
            }
        }
        function showCountdownModal(title, callback) { openModalWithContent(title, `<div class="text-center p-8"><p class="text-lg">سيتم الإجراء خلال <span id="countdown-span" class="font-bold text-xl text-[var(--primary-glow)]">3</span>...</p></div>`); let count = 3; const countdownSpan = document.getElementById('countdown-span'); const interval = setInterval(() => { count--; if (countdownSpan) countdownSpan.textContent = count > 0 ? count + '...' : 'الآن!'; if (count <= 0) { clearInterval(interval); callback(); } }, 1000); }
        function handleLogout() { showCountdownModal('تسجيل الخروج', () => { updateUserActivity("سجل الخروج"); const userToLogOut = { ...currentUser }; localStorage.removeItem('moraUser'); currentUser = null; document.getElementById('generic-modal').classList.remove('open'); showPage('auth-page'); renderAuthForm(false, false); if (userToLogOut && userToLogOut.name) { document.getElementById('auth-name').value = userToLogOut.name; document.getElementById('auth-password').value = userToLogOut.password || ''; } initVantaBackground(); }); }
        // ✅ مراقبة حذف الحساب من لوحة التحكم
        function listenForUserBanOrDeletion() {
            if (!currentUser || currentUser.isAdmin || !currentUser.id) return;
            const userDocRef = doc(db, "users", currentUser.id);
            onSnapshot(userDocRef, (doc) => {
                if (!doc.exists()) {
                    handleImmediateBan("تم حذف حسابك من النظام.");
                    return;
                }
                const data = doc.data();
                if (data.isBanned) {
                    handleImmediateBan("تم حظر حسابك نهائياً.");
                    return;
                }
                currentUser = { id: doc.id, ...data };
                localStorage.setItem('moraUser', JSON.stringify(currentUser));
            });
            let ipAddress = 'N/A';
            fetch('https://api.ipify.org?format=json').then(res => res.json()).then(ipData => {
                ipAddress = ipData.ip;
                const ipDocRef = doc(db, "banned_ips", ipAddress);
                onSnapshot(ipDocRef, (ipDoc) => {
                    if (ipDoc.exists()) {
                        handleImmediateBan("تم حظر جهازك من استخدام الموقع.");
                    }
                });
            }).catch(() => { });
        }
        function handleImmediateBan(message) {
            localStorage.removeItem('moraUser');
            currentUser = null;
            showToast(message, true);
            setTimeout(() => {
                showPage('auth-page');
                renderAuthForm(false, false);
                initVantaBackground();
            }, 3000);
        }
        // ======================= TIMER =======================
        let timerInterval; let timerState = { running: false, duration: 25 * 60 };
        function formatTime(seconds) { const m = Math.floor(seconds / 60); const s = seconds % 60; return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`; }
        function updateTimerDisplay() { const display = document.getElementById('timer-display'); if (display) display.textContent = formatTime(timerState.duration); }
        function startTimer() {
            document.getElementById('timer-start-sound').play();
            const tickingSound = document.getElementById('timer-ticking-sound');
            tickingSound.currentTime = 0;
            tickingSound.play();
            timerState.running = true;
            document.getElementById('timer-start-btn').textContent = 'إيقاف مؤقت';
            document.getElementById('timer-live-indicator').classList.remove('hidden');
            document.getElementById('generic-modal').classList.remove('open');
            timerInterval = setInterval(() => {
                timerState.duration--;
                updateTimerDisplay();
                if (timerState.duration < 0) {
                    stopTimer(true);
                }
            }, 1000);
        }
        function stopTimer(finished = false) {
            const tickingSound = document.getElementById('timer-ticking-sound');
            tickingSound.pause();
            tickingSound.currentTime = 0;
            clearInterval(timerInterval);
            timerState.running = false;
            document.getElementById('timer-live-indicator').classList.add('hidden');
            const startBtn = document.getElementById('timer-start-btn');
            if (startBtn) startBtn.textContent = 'بدء';
            if (finished) {
                document.getElementById('timer-end-sound').play();
                openModalWithContent('انتهى الوقت!', '<div class="text-center p-8"><i class="ph-confetti text-6xl text-[var(--primary-glow)] mb-4"></i><h3 class="text-xl font-bold mb-2">أحسنت!</h3><p class="text-slate-400">لقد أكملت جلسة مذاكرة.</p></div>');
                timerState.duration = 25 * 60;
            }
        }

        // ======================= THEMES =======================
        const themes = { "default": { n: "افتراضي", p: "#00f5c3", s: "#a78bfa" }, "gold": { n: "ذهبي", p: "#f59e0b", s: "#fbbf24" }, "emerald": { n: "زمردي", p: "#10b981", s: "#34d399" }, "crimson": { n: "قرمزي", p: "#dc2626", s: "#f87171" }, "violet": { n: "بنفسجي", p: "#8b5cf6", s: "#c084fc" }, "rose": { n: "وردي", p: "#f43f5e", s: "#fb7185" }, "sky": { n: "سماوي", p: "#0ea5e9", s: "#38bdf8" }, "forest": { n: "غابي", p: "#22c55e", s: "#4ade80" }, "ocean": { n: "محيط", p: "#0891b2", s: "#22d3ee" }, "sunset": { n: "غروب", p: "#f97316", s: "#f59e0b" }, "galaxy": { n: "مجرة", p: "#9333ea", s: "#d946ef" }, "candy": { n: "حلوى", p: "#ec4899", s: "#f87171" }, "lime": { n: "ليموني", p: "#84cc16", s: "#a3e635" }, "fire": { n: "ناري", p: "#f59e0b", s: "#ef4444" }, "ice": { n: "جليدي", p: "#22d3ee", s: "#67e8f9" }, "royal": { n: "ملكي", p: "#d97706", s: "#f59e0b" }, "hacker": { n: "هاكر", p: "#16a34a", s: "#4ade80" }, "retro": { n: "ريترو", p: "#ca8a04", s: "#eab308" }, "sakura": { n: "ساكورا", p: "#f472b6", s: "#fb7185" }, "mint": { n: "نعناع", p: "#2dd4bf", s: "#5eead4" }, "copper": { n: "نحاسي", p: "#b45309", s: "#d97706" }, "lavender": { n: "خزامي", p: "#a78bfa", s: "#c4b5fd" }, "cyber": { n: "سايبر", p: "#ea580c", s: "#f59e0b" }, "sand": { n: "رملي", p: "#ca8a04", s: "#eab308" }, "grape": { n: "عنبي", p: "#9333ea", s: "#a855f7" }, "cherry": { n: "كرزي", p: "#be123c", s: "#e11d48" }, "peach": { n: "خوخي", p: "#f97316", s: "#fb923c" }, "teal": { n: "بطيخي", p: "#0d9488", s: "#14b8a6" }, "indigo": { n: "نيلي", p: "#4f46e5", s: "#6366f1" }, "amber": { n: "عنبري", p: "#d97706", s: "#f59e0b" }, "fuchsia": { n: "فوشيا", p: "#c026d3", s: "#d946ef" } };
        function applyTheme(themeKey) {
            const theme = themes[themeKey];
            if (!theme) return;
            const style = document.getElementById('theme-style-root');
            const hexToRgb = hex => hex.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i, (m, r, g, b) => '#' + r + r + g + g + b + b).substring(1).match(/.{2}/g).map(x => parseInt(x, 16)).join(', ');
            style.innerHTML = `
                :root {
                    --bg-color: #0d0d1a; 
                    --primary-glow: ${theme.p}; --primary-glow-rgb: ${hexToRgb(theme.p)};
                    --secondary-glow: ${theme.s}; --secondary-glow-rgb: ${hexToRgb(theme.s)};
                    --text-primary: #e2e8f0; --text-secondary: #94a3b8;
                    --glass-bg: rgba(15, 23, 42, 0.7); --glass-border: rgba(${hexToRgb(theme.p)}, 0.1);
                    --shadow-color: rgba(0, 0, 0, 0.37);
                }
            ` + style.innerHTML.split('}').slice(1).join('}');
            localStorage.setItem('moraTheme', themeKey);
        }
        // ======================= TEXTS =======================
        function applySiteTexts() {
            document.querySelectorAll('[data-text-key]').forEach(el => {
                const key = el.dataset.textKey;
                if (siteTexts[key]) {
                    el.textContent = siteTexts[key];
                }
            });
        }
        async function listenToSiteContent() {
            const textDocRef = doc(db, 'site_content', 'texts');
            const docSnap = await getDoc(textDocRef);
            if (!docSnap.exists()) {
                await setDoc(textDocRef, defaultTexts);
                siteTexts = defaultTexts;
            } else {
                siteTexts = docSnap.data();
            }
            applySiteTexts();
            onSnapshot(textDocRef, (doc) => {
                siteTexts = doc.data() || defaultTexts;
                applySiteTexts();
            });
        }
        // ======================= ADMIN DASHBOARD =======================
        function initAdminDashboard() {
            showPage('admin-dashboard');
            const navBtns = document.querySelectorAll('.admin-nav-btn'), panels = document.querySelectorAll('.admin-panel');
            navBtns.forEach(btn => btn.addEventListener('click', e => {
                navBtns.forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                panels.forEach(p => {
                    p.classList.add('hidden');
                    p.classList.remove('unified-anim');
                });
                const activePanel = document.getElementById(e.currentTarget.dataset.panel);
                activePanel.classList.remove('hidden');
                void activePanel.offsetWidth; // Trigger reflow
                activePanel.classList.add('unified-anim');
            }));
            navBtns[0].click();
            initWeeklyExamsAdmin();
            initLectureExamsAdmin();
            initLectureExamResults();
            renderAdminExamResults();
            initTextManagementPanel();
            onSnapshot(collection(db, "users"), (snap) => { adminDashboardEl.studentCount.textContent = snap.size; });
            onSnapshot(collection(db, "opinions"), (snap) => { adminDashboardEl.opinionsCount.textContent = snap.size; });
            onSnapshot(collection(db, "polls"), (snap) => { adminDashboardEl.pollsCount.textContent = snap.size; });
            onSnapshot(collection(db, "notifications"), (snap) => { adminDashboardEl.notificationsCount.textContent = snap.size; });
            onSnapshot(collection(db, "weekly_exams"), (snap) => { adminDashboardEl.examsCount.textContent = snap.size; });
            onSnapshot(query(collection(db, "users"), orderBy('lastActivity.timestamp', 'desc')), s => {
                let h = '';
                s.forEach(d => {
                    const u = d.data(), b = u.isBanned || false;
                    const activity = u.lastActivity ? `<p class="text-xs mt-1 text-cyan-400">النشاط الحالي: ${u.lastActivity.description}</p>` : '';
                    const banStatus = b ? '<span class="text-red-400 font-bold">[محظور]</span>' : '';
                    h += `<div class="glass-effect p-4 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-lg text-white">${u.name} ${banStatus}</p>
                                    <p class="text-sm text-slate-400">${u.city || 'N/A'}, ${u.country || 'N/A'}</p>
                                    ${activity}
                                </div>
                                    <button onclick="banIp('${u.ipAddress}')" class="px-3 py-1 text-sm rounded bg-orange-600">IP</button>
                                    <button onclick="toggleBan('${d.id}', ${b})" class="px-3 py-1 text-sm rounded ${b ? 'bg-green-600' : 'bg-yellow-600'}">${b ? 'فك' : 'حظر'}</button>
                                    <button onclick="deleteUser('${d.id}')" class="px-3 py-1 text-sm rounded bg-red-600">حذف</button>
                            </div>
                            <div class="mt-2 pt-2 border-t border-slate-700/50 text-xs text-slate-300">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 font-mono text-[11px]">
                                    <p><b>ID:</b> ${u.studentId || 'NO-ID'}</p>
                                    <p><b>IP:</b> ${u.ipAddress || 'N/A'}</p>
                                    <p><b>التخصص:</b> ${u.year} | ${u.division === 'international' ? 'IB' : 'BIS'}</p>
                                    <p><b>تاريخ التسجيل:</b> ${u.createdAt ? u.createdAt.toDate().toLocaleString('ar-EG') : ''}</p>
                                    <p><b>كلمة المرور:</b> ${u.password}</p>
                                </div>
                            </div>
                          </div>`;
                });
                adminDashboardEl.studentsList.innerHTML = h;
            });
            onSnapshot(query(collection(db, "opinions"), orderBy('createdAt', 'desc')), s => { let h = ''; s.forEach(d => { const o = d.data(); h += `<div class="glass-effect p-4 rounded-lg flex justify-between items-start"><div><p>"${o.text}"</p><p class="text-sm text-slate-400 mt-2 font-bold">${o.name} - فرقة ${o.year}</p></div><button onclick="deleteFromCollection('${d.id}', 'opinions')" class="text-red-500 hover:text-red-400 text-lg"><i class="ph-trash"></i></button></div>`; }); adminDashboardEl.opinionsList.innerHTML = h; });
            onSnapshot(query(collection(db, "polls"), orderBy('createdAt', 'desc')), s => {
                let h = '';
                s.forEach(d => {
                    const poll = d.data();
                    const divisionText = poll.userDivision === 'international' ? 'أعمال دولية' : 'نظم معلومات';
                    const yearText = poll.userYear === '1' ? 'الفرقة الأولى' : 'الثانية';
                    const dateText = poll.createdAt ? poll.createdAt.toDate().toLocaleString('ar-EG') : '';
                    h += `
                        <div class="glass-effect p-4 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-white">${poll.topic}</p>
                                    <p class="text-xs text-slate-400 mt-1">
                                        بواسطة: ${poll.userName} (${yearText} - ${divisionText})<br>
                                        ${dateText}
                                    </p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="toggleAdminRepliesView('replies-${d.id}')" class="px-3 py-1 text-sm rounded bg-sky-600">عرض الردود</button>
                                    <button onclick="deletePollWithReplies('${d.id}')" class="px-3 py-1 text-sm rounded bg-red-600">حذف</button>
                                </div>
                            </div>
                            <div id="replies-${d.id}" class="hidden mt-3 pt-3 border-t border-slate-700/50 space-y-2">
                                <p class="text-center text-slate-400">جاري تحميل الردود...</p>
                            </div>
                        </div>`;
                });
                adminDashboardEl.pollsList.innerHTML = h || '<p class="text-center text-slate-400">لا توجد استطلاعات حالياً.</p>';
            });
            onSnapshot(query(collection(db, "courses"), orderBy('createdAt', 'desc')), s => { let h = ''; s.forEach(d => { const c = d.data(); h += `<div class="glass-effect p-4 rounded-lg flex justify-between items-start"><div><p class="font-bold text-white">${c.title} <span class="text-xs text-slate-400">(${c.category || 'بدون فئة'})</span></p><p class="text-sm text-slate-400">${c.desc}</p></div><button onclick="deleteFromCollection('${d.id}', 'courses')" class="text-red-500 hover:text-red-400 text-lg"><i class="ph-trash"></i></button></div>`; }); adminDashboardEl.coursesList.innerHTML = h; });
            onSnapshot(query(collection(db, "ai_tools"), orderBy('name')), s => { let h = ''; s.forEach(d => { const t = d.data(); h += `<div class="glass-effect p-4 rounded-lg flex justify-between items-start"><div><p class="font-bold text-white">${t.name}</p><p class="text-sm text-slate-400">${t.desc}</p></div><button onclick="deleteFromCollection('${d.id}', 'ai_tools')" class="text-red-500 hover:text-red-400 text-lg"><i class="ph-trash"></i></button></div>`; }); adminDashboardEl.aiToolsList.innerHTML = h; });
            onSnapshot(query(collection(db, "notifications"), orderBy('createdAt', 'desc')), s => { let h = ''; s.forEach(d => { const n = d.data(); h += `<div class="glass-effect p-4 rounded-lg flex justify-between items-start"><div><p class="font-bold text-white">${n.title || ''}</p><p class="text-sm text-slate-300">${n.body}</p><p class="text-xs text-slate-500 mt-2">${n.createdAt.toDate().toLocaleString('ar-EG')}</p></div><button onclick="deleteFromCollection('${d.id}', 'notifications')" class="text-red-500 hover:text-red-400 text-lg"><i class="ph-trash"></i></button></div>`; }); adminDashboardEl.notificationsList.innerHTML = h; });
            onSnapshot(query(collection(db, "support_tickets"), orderBy('createdAt', 'desc')), s => {
                const container = document.getElementById('admin-tickets-list');
                let h = '';
                if (s.empty) { h = '<p class="text-slate-400 text-center">لا توجد شكاوى حالياً.</p>'; }
                s.forEach(d => {
                    const t = d.data();
                    const replySection = t.adminReply
                        ? `<div class="mt-3 pt-3 border-t border-green-500/30"><p class="text-xs text-slate-400">ردك:</p><p class="text-sm text-green-300">${t.adminReply}</p></div>`
                        : `<div class="mt-3"><textarea id="reply-${d.id}" class="w-full rounded-lg input-field" rows="2" placeholder="اكتب ردك هنا..."></textarea><button onclick="replyToTicket('${d.id}')" class="w-full mt-2 py-2 rounded-lg text-sm font-bold btn-celestial">إرسال الرد</button></div>`;
                    const statusBadge = t.status === 'تم الرد' ? 'bg-green-500' : 'bg-yellow-500';
                    h += `<div class="glass-effect p-4 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-white">${t.userName}</p>
                                    <p class="text-xs text-slate-400">${t.createdAt.toDate().toLocaleString('ar-EG')}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-bold text-white px-2 py-1 rounded-full ${statusBadge}">${t.status}</span>
                                    <button onclick="deleteFromCollection('${d.id}', 'support_tickets')" class="text-red-500 hover:text-red-400 text-lg p-1"><i class="ph-trash"></i></button>
                                </div>
                            </div>
                            <p class="mt-3 text-slate-200">${t.problem}</p>
                            ${replySection}
                          </div>`;
                });
                if (container) container.innerHTML = h;
            });
            // ✅ Attendance Panel with Delete Button (only from attendance, not users)
            const attendanceRef = collection(db, "attendance");
            onSnapshot(query(attendanceRef, orderBy("timestamp", "desc")), (snapshot) => {
                const container = document.getElementById('attendance-list');
                if (!container) return;
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-center text-slate-400">لا يوجد حضور مسجل حتى الآن.</p>';
                    return;
                }
                let html = '<div class="space-y-3">';
                snapshot.forEach(doc => {
                    const att = doc.data();
                    const device = parseUserAgent(att.userAgent);
                    const time = att.timestamp ? att.timestamp.toDate().toLocaleString('ar-EG') : 'غير معروف';
                    html += `
                        <div class="glass-effect p-3 rounded-lg flex justify-between items-start">
                            <div>
                                <p class="font-bold text-white">${att.userName}</p>
                                <p class="text-sm text-slate-400">${att.userDivision === 'international' ? 'IB' : 'BIS'} - ${att.userYear}</p>
                                <p class="text-xs text-slate-500 mt-1">الوقت: ${time}</p>
                                <p class="text-xs text-slate-500">الجهاز: ${device} | IP: ${att.ipAddress || 'N/A'}</p>
                            </div>
                            <button onclick="deleteAttendanceRecord('${doc.id}')" class="text-red-500 hover:text-red-400 text-lg p-1"><i class="ph-trash"></i></button>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            });
            // ✅ NEW: Corrections Panel
            const correctionsRef = collection(db, "lecture_corrections");
            onSnapshot(query(correctionsRef, orderBy("createdAt", "desc")), (snapshot) => {
                const container = document.getElementById('admin-corrections-list');
                if (!container) return;
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-center text-slate-400">لا توجد طلبات تصحيح حتى الآن.</p>';
                    return;
                }
                let html = '<div class="space-y-4">';
                snapshot.forEach(doc => {
                    const c = doc.data();
                    const statusColor = c.status === 'تم الرد' ? 'text-green-400' : 'text-yellow-400';
                    const replySection = c.adminReply ? `<div class="mt-2 pt-2 border-t border-green-500/30"><p class="text-xs text-slate-400">ردك:</p><p class="text-sm text-green-300">${c.adminReply}</p></div>` : `<div class="mt-3"><textarea id="correction-reply-${doc.id}" class="w-full rounded-lg input-field" rows="2" placeholder="اكتب ردك هنا..."></textarea><button onclick="replyToCorrection('${doc.id}')" class="w-full mt-2 py-2 rounded-lg text-sm font-bold btn-celestial">إرسال الرد</button></div>`;
                    html += `
                        <div class="glass-effect p-4 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-white">${c.lectureTitle}</p>
                                    <p class="text-sm text-slate-400">المادة: ${c.subject}</p>
                                    <p class="text-xs text-slate-400 mt-1">الطالب: ${c.userName} (${c.userYear} - ${c.userDivision === 'international' ? 'IB' : 'BIS'})</p>
                                    <p class="text-xs text-slate-400">الوقت: ${c.createdAt.toDate().toLocaleString('ar-EG')}</p>
                                    <p class="mt-2 text-white">${c.text}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-bold text-white px-2 py-1 rounded-full ${statusColor}">${c.status}</span>
                                    <button onclick="hideCorrection('${doc.id}', ${c.isHidden || false})" class="px-2 py-1 text-sm rounded ${c.isHidden ? 'bg-green-600' : 'bg-slate-600'}">${c.isHidden ? 'إظهار' : 'إخفاء'}</button>
                                    <button onclick="deleteFromCollection('${doc.id}', 'lecture_corrections')" class="text-red-500 hover:text-red-400 text-lg p-1"><i class="ph-trash"></i></button>
                                </div>
                            </div>
                            ${replySection}
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            });
            listenForNewAdminNotifications();
            // ✅ Robust Subject Update Logic with Direct DOM Access
            const updateSubjects = () => {
                const yearSelect = document.getElementById('content-year-select');
                const divisionSelect = document.getElementById('content-division-select');
                const subjectSelect = document.getElementById('content-subject-select');

                if (!yearSelect || !divisionSelect || !subjectSelect) return;

                const yearVal = yearSelect.value;
                const divisionVal = divisionSelect.value;

                subjectSelect.innerHTML = '<option value="">اختر المادة</option>';

                if (yearVal && divisionVal) {
                    const key = `${yearVal}_${divisionVal}`;
                    const subjectList = materials['ar'][key] || [];

                    subjectList.forEach(subj => {
                        const option = document.createElement('option');
                        option.value = subj;
                        option.textContent = subj;
                        subjectSelect.appendChild(option);
                    });
                }
                displayAdminContent();
            };

            // Explicit bindings
            const yearSel = document.getElementById('content-year-select');
            const divSel = document.getElementById('content-division-select');
            const subjSel = document.getElementById('content-subject-select');
            const typeSel = document.getElementById('content-type-select');

            if (yearSel) yearSel.onchange = updateSubjects;
            if (divSel) divSel.onchange = updateSubjects;
            if (subjSel) subjSel.onchange = displayAdminContent;
            if (typeSel) typeSel.onchange = displayAdminContent;

            // Trigger after short delay
            setTimeout(updateSubjects, 100);
            const siteSettingsRef = doc(db, 'settings', 'site');
            onSnapshot(siteSettingsRef, (docSnap) => {
                const settings = docSnap.data() || {};
                const meetLinkInput = document.getElementById('meet-link-input');
                const statusIndicator = document.getElementById('stream-status-indicator');
                const startBtn = document.getElementById('start-stream-btn');
                const endBtn = document.getElementById('end-stream-btn');
                if (meetLinkInput) meetLinkInput.value = settings.meetLink || '';
                if (settings.isLive) {
                    statusIndicator.textContent = 'مباشر الآن';
                    statusIndicator.className = 'px-3 py-1 rounded-full text-sm font-bold bg-red-500 text-white live-pulse';
                    startBtn.disabled = true;
                    endBtn.disabled = false;
                } else {
                    statusIndicator.textContent = 'متوقف';
                    statusIndicator.className = 'px-3 py-1 rounded-full text-sm font-bold bg-slate-600 text-slate-300';
                    startBtn.disabled = false;
                    endBtn.disabled = true;
                }
            });
            document.getElementById('save-meet-link-btn').addEventListener('click', async () => {
                const link = document.getElementById('meet-link-input').value.trim();
                if (link && link.startsWith('https://meet.google.com/')) {
                    await setDoc(siteSettingsRef, { meetLink: link }, { merge: true });
                    showToast('تم حفظ رابط البث المباشر بنجاح!');
                } else {
                    showToast('الرجاء إدخال رابط جوجل ميت صحيح.', true);
                }
            });
            document.getElementById('start-stream-btn').addEventListener('click', () => setDoc(siteSettingsRef, { isLive: true }, { merge: true }));
            document.getElementById('end-stream-btn').addEventListener('click', () => setDoc(siteSettingsRef, { isLive: false }, { merge: true }));
            // ✅ قسم تحميل التطبيق (Professional Backend Integration - APKPure)
            const apkpureStatsRef = doc(db, "app_stats", "apkpure");
            onSnapshot(apkpureStatsRef, (docSnap) => {
                const data = docSnap.data();
                if (data && data.total_downloads) {
                    const countEl = document.getElementById('app-downloads-count');
                    if (countEl) {
                        countEl.textContent = data.total_downloads;
                        // Add a last updated label if needed
                        if (data.last_updated) {
                            console.log("APKPure Downloads updated at:", data.last_updated.toDate());
                        }
                    }
                }
            });

            // Professional Scraper Function
            async function syncAPKPureDownloads() {
                try {
                    const snap = await getDoc(apkpureStatsRef);
                    const data = snap.data();
                    const now = Date.now();

                    // Throttle sync to once every 4 hours to be professional and avoid IP shadow-bans
                    if (data && data.last_updated && (now - data.last_updated.toMillis() < 14400000)) {
                        return;
                    }

                    // Use a more robust proxy for server-side feel
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent('https://apkpure.com/p/mora.forstudying2')}`;
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error("Proxy error");

                    const result = await response.json();
                    const html = result.contents;

                    // Regex Extraction Logic (ItemProp or JSON-LD interactionCount)
                    let count = null;
                    const jsonLdMatch = html.match(/"interactionCount":\s*"(\d+)"/);
                    if (jsonLdMatch) {
                        count = jsonLdMatch[1];
                    } else {
                        // Fallback pattern for human-readable count
                        const spanMatch = html.match(/<span class="num">([\d,K+M]+)<\/span>/i);
                        if (spanMatch) count = spanMatch[1];
                    }

                    if (count) {
                        await setDoc(apkpureStatsRef, {
                            total_downloads: count,
                            last_updated: serverTimestamp()
                        }, { merge: true });
                    }
                } catch (e) {
                    console.error("APKPure sync error:", e);
                }
            }

            // Trigger sync on admin login
            syncAPKPureDownloads();

            const appDownloadsRef = collection(db, "app_downloads");
            document.getElementById('view-downloads-btn').addEventListener('click', async () => {
                const snapshot = await getDocs(query(appDownloadsRef, orderBy('timestamp', 'desc')));
                let html = '<div class="space-y-3 max-h-80 overflow-y-auto">';
                if (snapshot.empty) {
                    html += '<p class="text-center text-slate-400">لا توجد تنزيلات بعد.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        const device = parseUserAgent(d.userAgent);
                        const time = d.timestamp ? d.timestamp.toDate().toLocaleString('ar-EG') : 'غير معروف';
                        html += `
                            <div class="download-item">
                                <p class="font-bold text-white">${d.userName}</p>
                                <p class="text-sm text-slate-400">${d.userDivision === 'international' ? 'IB' : 'BIS'} - ${d.userYear}</p>
                                <p class="download-meta">الجهاز: ${device} | IP: ${d.ipAddress || 'N/A'} | ${time}</p>
                            </div>
                        `;
                    });
                }
                html += '</div>';
                openModalWithContent('سجل تنزيلات التطبيق', html);
            });
            // ✅ COURSES CATEGORIES
            const coursesRef = collection(db, "courses");
            const categoriesRef = collection(db, "course_categories");
            onSnapshot(categoriesRef, (snapshot) => {
                const select = document.getElementById('course-category-select');
                select.innerHTML = '<option value="">اختر الفئة</option>';
                snapshot.forEach(doc => {
                    const cat = doc.data();
                    const opt = document.createElement('option');
                    opt.value = cat.name;
                    opt.textContent = cat.name;
                    select.appendChild(opt);
                });
            });
            document.getElementById('add-course-category-btn').addEventListener('click', async () => {
                const name = document.getElementById('course-category-input').value.trim();
                if (!name) {
                    showToast('يرجى إدخال اسم الفئة', true);
                    return;
                }
                const q = query(categoriesRef, where("name", "==", name));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    showToast('الفئة موجودة بالفعل', true);
                    return;
                }
                await addDoc(categoriesRef, { name, createdAt: serverTimestamp() });
                document.getElementById('course-category-input').value = '';
                showToast('تمت إضافة الفئة!');
            });
        }
        // ✅ Delete ONLY attendance record (not user)
        window.deleteAttendanceRecord = async (recordId) => {
            if (!confirm('هل أنت متأكد من حذف سجل الحضور لهذا الطالب؟ لن يتمكن من الدخول إلى البث المباشر مستقبلاً، لكن حسابه سيظل نشطًا في الموقع.')) return;
            try {
                await deleteDoc(doc(db, "attendance", recordId));
                showToast('تم حذف سجل الحضور بنجاح.');
            } catch (error) {
                console.error("Error deleting attendance record:", error);
                showToast("حدث خطأ أثناء الحذف.", true);
            }
        };
        async function displayAdminContent() {
            const { type, year, division, subject, contentList } = adminContentPanelEl;
            const coll = type.value;
            const filters = [where("year", "==", year.value), where("division", "==", division.value)];
            if (subject.value) filters.push(where("subject", "==", subject.value));

            if (!year.value || !division.value) {
                contentList.innerHTML = '<p class="text-center text-slate-400">اختر الفرقة والشعبة لعرض المحتوى.</p>';
                return;
            }

            const q = query(collection(db, coll), ...filters);
            onSnapshot(q, (snapshot) => {
                let h = '';
                if (snapshot.empty) {
                    h = '<p class="text-center text-slate-400">لا يوجد محتوى يطابق هذا الفلتر.</p>';
                } else {
                    snapshot.forEach(doc => {
                        const item = doc.data();
                        const isProcessing = item.body === "PROCESSING_UPLOAD...";

                        // "Stealth Mode": No badge, looks like a normal item immediately
                        // We still disable actions internally or handle them gracefully, but visually it's clean

                        const actionButtons = `<div class="flex gap-2">
                                <button onclick="populateContentForm('${doc.id}', '${coll}')" class="text-sky-400 hover:text-sky-300 text-lg"><i class="ph-pencil-simple"></i></button>
                                <button onclick="toggleContentVisibility('${doc.id}', '${coll}', ${item.isHidden || false})" class="text-yellow-400 hover:text-yellow-300 text-lg"><i class="ph ${item.isHidden ? 'ph-eye-slash' : 'ph-eye'}"></i></button>
                                <button onclick="deleteContent('${doc.id}', '${coll}')" class="text-red-500 hover:text-red-400 text-lg"><i class="ph-trash"></i></button>
                               </div>`;

                        h += `<div class="p-3 rounded-lg flex justify-between items-center hover:bg-slate-500/10 transition">
                                <div class="flex items-center">
                                    <p class="font-semibold text-white truncate max-w-[200px]">${item.title} (${item.subject})</p>
                                </div>
                                ${actionButtons}
                              </div>`;
                    });
                }
                contentList.innerHTML = h;
            });
        }
        window.populateContentForm = async (id, coll) => { const docSnap = await getDoc(doc(db, coll, id)); if (docSnap.exists()) { const item = docSnap.data(); adminContentPanelEl.title.value = item.title; adminContentPanelEl.body.value = item.body; adminContentPanelEl.subject.value = item.subject; adminContentPanelEl.formTitle.textContent = 'تعديل المحتوى'; adminContentPanelEl.saveBtn.textContent = 'حفظ التعديلات'; adminContentPanelEl.cancelBtn.classList.remove('hidden'); currentEditState = { id, collection: coll }; } }
        function resetContentForm() { adminContentPanelEl.formTitle.textContent = 'إضافة محتوى جديد'; adminContentPanelEl.saveBtn.textContent = 'حفظ'; adminContentPanelEl.cancelBtn.classList.add('hidden'); adminContentPanelEl.title.value = ''; adminContentPanelEl.body.value = ''; currentEditState = { id: null, collection: null }; }
        async function initTextManagementPanel() {
            const formContainer = document.getElementById('text-management-form');
            const textsRef = doc(db, 'site_content', 'texts');
            let currentTexts = (await getDoc(textsRef)).data() || defaultTexts;
            let formHTML = '';
            for (const key in textLabels) {
                formHTML += `
                    <div class="glass-effect p-4 rounded-lg">
                        <label for="text-${key}" class="block text-sm font-bold text-slate-400 mb-2">${textLabels[key]}</label>
                        <textarea id="text-${key}" data-key="${key}" class="w-full rounded-lg input-field" rows="2">${currentTexts[key] || ''}</textarea>
                    </div>
                `;
            }
            formContainer.innerHTML = formHTML;
            document.getElementById('save-texts-btn').addEventListener('click', async () => {
                const newTexts = {};
                formContainer.querySelectorAll('textarea').forEach(area => {
                    newTexts[area.dataset.key] = area.value;
                });
                try {
                    await setDoc(textsRef, newTexts);
                    showToast("تم حفظ النصوص بنجاح!");
                } catch (e) {
                    showToast("حدث خطأ أثناء الحفظ.", true);
                }
            });
        }
        window.deleteFromCollection = async (id, coll) => { if (confirm('هل أنت متأكد من الحذف؟')) { await deleteDoc(doc(db, coll, id)); showToast('تم الحذف بنجاح.'); } };
        window.deleteContent = (id, coll) => deleteFromCollection(id, coll);
        window.deleteUser = (id) => deleteFromCollection(id, 'users');
        window.toggleBan = async (id, ban) => { if (confirm(`هل أنت متأكد من ${ban ? 'إلغاء حظر' : 'حظر'} هذا الطالب؟`)) { await updateDoc(doc(db, 'users', id), { isBanned: !ban }); showToast('تم تحديث حالة الطالب.'); } };
        window.banIp = async (ip) => {
            if (ip && ip !== 'N/A' && confirm(`هل أنت متأكد من حظر الـ IP: ${ip}؟
سيمنع هذا أي شخص يستخدم هذا الـ IP من دخول الموقع.`)) { await setDoc(doc(db, 'banned_ips', ip), { bannedAt: serverTimestamp() }); showToast(`تم حظر الـ IP ${ip} بنجاح.`); }
        };
        window.toggleContentVisibility = async (id, coll, isHidden) => { await updateDoc(doc(db, coll, id), { isHidden: !isHidden }); showToast(`تم ${isHidden ? 'إظهار' : 'إخفاء'} المحتوى.`); };
        window.replyToTicket = async (ticketId) => {
            const replyText = document.getElementById(`reply-${ticketId}`).value.trim();
            if (!replyText) { showToast("لا يمكن إرسال رد فارغ.", true); return; }
            await updateDoc(doc(db, "support_tickets", ticketId), {
                adminReply: replyText,
                status: "تم الرد",
                resolvedAt: serverTimestamp(),
                isReadByStudent: false
            });
            showToast("تم إرسال الرد بنجاح.");
        };
        // ✅ NEW: Correction Functions
        window.replyToCorrection = async (correctionId) => {
            const replyText = document.getElementById(`correction-reply-${correctionId}`).value.trim();
            if (!replyText) { showToast("لا يمكن إرسال رد فارغ.", true); return; }
            await updateDoc(doc(db, "lecture_corrections", correctionId), {
                adminReply: replyText,
                status: "تم الرد",
                resolvedAt: serverTimestamp(),
                isReadByStudent: false
            });
            showToast("تم إرسال الرد بنجاح.");
        };
        window.hideCorrection = async (id, isHidden) => {
            await updateDoc(doc(db, "lecture_corrections", id), { isHidden: !isHidden });
            showToast(`تم ${isHidden ? 'إظهار' : 'إخفاء'} طلب التصحيح.`);
        };
        document.getElementById('send-notification-btn').addEventListener('click', async () => { const title = document.getElementById('notification-title-input').value.trim(); const body = document.getElementById('notification-body-input').value.trim(); if (!body) { showToast('نص الإشعار لا يمكن أن يكون فارغاً', true); return; } await addDoc(collection(db, 'notifications'), { title, body, createdAt: serverTimestamp() }); showToast('تم إرسال الإشعار بنجاح!'); document.getElementById('notification-title-input').value = ''; document.getElementById('notification-body-input').value = ''; });
        document.getElementById('add-course-btn').addEventListener('click', async () => {
            const title = document.getElementById('course-title-input').value.trim();
            const desc = document.getElementById('course-desc-input').value.trim();
            const category = document.getElementById('course-category-select').value.trim();
            const url = document.getElementById('course-url-input').value.trim();
            if (!title || !desc || !url || !category) { showToast('يرجى ملء جميع الحقول', true); return; }
            await addDoc(collection(db, 'courses'), { title, desc, url, category, createdAt: serverTimestamp() });
            showToast('تمت إضافة الكورس!');
            document.getElementById('course-title-input').value = '';
            document.getElementById('course-desc-input').value = '';
            document.getElementById('course-url-input').value = '';
        });
        document.getElementById('add-ai-tool-btn').addEventListener('click', async () => { const name = document.getElementById('ai-name-input').value.trim(), desc = document.getElementById('ai-desc-input').value.trim(), url = document.getElementById('ai-url-input').value.trim(); if (!name || !desc || !url) { showToast('يرجى ملء جميع الحقول', true); return; } await addDoc(collection(db, 'ai_tools'), { name, desc, url }); showToast('تمت إضافة الأداة!'); document.getElementById('ai-name-input').value = ''; document.getElementById('ai-desc-input').value = ''; document.getElementById('ai-url-input').value = ''; });
        // GLOBAL UPLOAD STATE
        let pendingGlobalUpload = null; // Stores { promise, cancel, task, isFinished }

        // Background Upload Trigger
        document.getElementById('content-file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const { year, division, subject } = adminContentPanelEl;

            // 1. Reset
            if (pendingGlobalUpload) pendingGlobalUpload = null;

            if (!file) return;

            // 2. Validation
            if (!year.value || !division.value || !subject.value) {
                showToast("يرجى اختيار الفرقة والشعبة والمادة أولاً", true);
                e.target.value = '';
                return;
            }

            if (file.type !== 'application/pdf') {
                showToast('يرجى اختيار ملف PDF فقط.', true);
                e.target.value = '';
                return;
            }

            // 3. UI Update
            const infoLabel = e.target.parentElement.querySelector('label');
            infoLabel.innerHTML = `ملف PDF <span class="text-green-400">✔ (جاهز)</span>`;

            // 4. Start Upload
            const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.\-_]/g, '')}`;
            const storageRef = ref(storage, `materials/${year.value}/${division.value}/${subject.value}/${fileName}`);
            const uploadTask = uploadBytesResumable(storageRef, file);

            const uploadPromise = new Promise((resolve, reject) => {
                uploadTask.on('state_changed',
                    (snapshot) => { },
                    (error) => {
                        console.error("Background Upload Error:", error);
                        reject(error);
                    },
                    async () => {
                        const url = await getDownloadURL(uploadTask.snapshot.ref);
                        if (pendingGlobalUpload) pendingGlobalUpload.isFinished = true;
                        resolve(url);
                    }
                );
            });

            pendingGlobalUpload = {
                promise: uploadPromise,
                task: uploadTask,
                isFinished: false
            };
        });

        adminContentPanelEl.saveBtn.addEventListener('click', async () => {
            try {
                const { year, division, subject, title, body, type } = adminContentPanelEl;
                const fileInput = document.getElementById('content-file-input');
                const file = fileInput.files[0];
                let contentBody = body.value.trim();

                if (!contentBody && !file) {
                    showToast('يرجى كتابة المحتوى أو رفع ملف PDF', true);
                    return;
                }

                // Prepare Data
                const data = {
                    year: parseInt(year.value), // Convert to integer to match query
                    division: division.value,
                    subject: subject.value,
                    title: title.value.trim(),
                    body: contentBody || "",
                    createdAt: serverTimestamp(),
                    isHidden: false
                };

                if (!data.year || !data.division || !data.subject || !data.title) {
                    showToast('يرجى ملء جميع الحقول', true);
                    return;
                }

                adminContentPanelEl.saveBtn.disabled = true;

                // STRATEGY: OPTIMISTIC NON-BLOCKING SAVE

                if (currentEditState.id) {
                    // EDIT MODE: We still block for edits to ensure consistency, but it's rare to upload new files on edit
                    if (file) {
                        adminContentPanelEl.saveBtn.textContent = 'جاري الحفظ...';
                        // Resolve upload first
                        let url;
                        if (pendingGlobalUpload) {
                            url = await pendingGlobalUpload.promise;
                        } else {
                            const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.\-_]/g, '')}`;
                            const storageRef = ref(storage, `materials/${year.value}/${division.value}/${subject.value}/${fileName}`);
                            await uploadBytes(storageRef, file);
                            url = await getDownloadURL(storageRef);
                        }
                        data.body = url;
                    }
                    await updateDoc(doc(db, currentEditState.collection, currentEditState.id), data);
                    showToast('تم تحديث المحتوى!');
                    adminContentPanelEl.saveBtn.disabled = false;
                    adminContentPanelEl.saveBtn.textContent = 'حفظ';
                    resetContentForm();
                    displayAdminContent();
                } else {
                    // NEW CREATE MODE: INSTANT OPTIMISTIC SAVE
                    if (file) {
                        data.body = "PROCESSING_UPLOAD..."; // Placeholder

                        // 1. Create Placeholder Doc
                        const docRef = await addDoc(collection(db, type.value), data);

                        // 2. Reset UI IMMEDIATELY (Simulate Instant Save)
                        showToast('تم الحفظ! يتم معالجة الملف في الخلفية...', false); // False = not error
                        resetContentForm();
                        displayAdminContent(); // Show "Processing" item in list

                        if (fileInput) {
                            fileInput.value = '';
                            fileInput.parentElement.querySelector('label').textContent = 'رفع ملف PDF (اختياري)';
                        }
                        adminContentPanelEl.saveBtn.disabled = false;
                        adminContentPanelEl.saveBtn.textContent = 'حفظ'; // Reset button

                        // 3. Continue Upload in Background & Update Doc
                        let uploadPromiseToUse;
                        if (pendingGlobalUpload) {
                            uploadPromiseToUse = pendingGlobalUpload.promise;
                        } else {
                            const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.\-_]/g, '')}`;
                            const storageRef = ref(storage, `materials/${year.value}/${division.value}/${subject.value}/${fileName}`);
                            uploadPromiseToUse = new Promise((resolve, reject) => {
                                const task = uploadBytesResumable(storageRef, file);
                                task.on('state_changed', null, reject, async () => {
                                    resolve(await getDownloadURL(task.snapshot.ref));
                                });
                            });
                        }

                        // Detach this logic from the UI thread
                        uploadPromiseToUse.then(async (url) => {
                            await updateDoc(docRef, { body: url });
                            console.log("Background upload updated doc:", docRef.id);
                            showToast(`تم اكتمال رفع الملف: ${data.title}`, false);
                        }).catch(async (err) => {
                            console.error("Background upload failed:", err);
                            await updateDoc(docRef, {
                                title: data.title + " (فشل الرفع - حاول مرة أخرى)",
                                isHidden: true
                            });
                            showToast(`فشل رفع الملف: ${data.title}`, true);
                        });

                        // Clear global ref
                        pendingGlobalUpload = null;

                    } else {
                        // Text Only - Standard Instant
                        await addDoc(collection(db, type.value), data);
                        showToast('تم حفظ المحتوى مباشرة!');
                        resetContentForm();
                        displayAdminContent();
                        adminContentPanelEl.saveBtn.disabled = false;
                        adminContentPanelEl.saveBtn.textContent = 'حفظ';
                    }
                }
            } catch (e) {
                console.error(e);
                showToast('حدث خطأ: ' + e.message, true);
                adminContentPanelEl.saveBtn.textContent = 'حفظ';
                adminContentPanelEl.saveBtn.disabled = false;
                adminContentPanelEl.saveBtn.style.position = '';
            }
        });
        // ======================= SERVICE WORKER REGISTER =======================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
const CACHE_NAME = 'mora-cache-v3';
const ASSETS_TO_CACHE = [
    './',
    './index.html',
    'https://cdn.tailwindcss.com',
    'https://unpkg.com/phosphor-icons',
    'https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap',
    'https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.globe.min.js',
    'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js'
];

self.addEventListener('install', (event) => {
    self.skipWaiting();
    event.waitUntil(
        caches.open(CACHE_NAME)
            .then((cache) => {
                return cache.addAll(ASSETS_TO_CACHE);
            })
    );
});

self.addEventListener('activate', (event) => {
    event.waitUntil(
        caches.keys().then((cacheNames) => {
            return Promise.all(
                cacheNames.map((cacheName) => {
                    if (cacheName !== CACHE_NAME) {
                        return caches.delete(cacheName);
                    }
                })
            );
        })
    );
    return self.clients.claim();
});

self.addEventListener('fetch', (event) => {
    const url = new URL(event.request.url);

    // 1. Cache Firebase Storage (PDFs, Images, Videos) - Runtime Caching
    if (url.hostname.includes('firebasestorage.googleapis.com') || url.pathname.endsWith('.pdf')) {
        event.respondWith(
            caches.match(event.request).then((cachedResponse) => {
                if (cachedResponse) {
                    return cachedResponse;
                }
                return fetch(event.request).then((networkResponse) => {
                    // Check if we received a valid response
                    if (!networkResponse || networkResponse.status !== 200 || networkResponse.type !== 'cors') {
                        return networkResponse;
                    }
                    // Clone the response
                    const responseToCache = networkResponse.clone();
                    caches.open(CACHE_NAME).then((cache) => {
                        cache.put(event.request, responseToCache);
                    });
                    return networkResponse;
                }).catch(() => {
                    // Optional: Return a placeholder for images if offline and not cached
                    return new Response('Offline content not available', { status: 404, statusText: 'Offline' });
                });
            })
        );
        return;
    }

    // 2. Default Strategy: Cache First, Fallback to Network
    event.respondWith(
        caches.match(event.request)
            .then((response) => {
                return response || fetch(event.request);
            })
            .catch(() => {
                // If offline and request fails (and not in cache)
                if (event.request.mode === 'navigate') {
                    return caches.match('./index.html');
                }
            })
    );
});
`;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                navigator.serviceWorker.register(swUrl) // Scope defaults to path of script (blob path)
                    .then(registration => {
                        console.log('SW registered inline: ', registration);
                        // Optional: Attempt to update immediately
                        registration.update();
                    })
                    .catch(registrationError => {
                        console.warn('SW registration failed: ', registrationError);
                    });
            });
        }
        // Admin: Toggle replies view
        window.toggleAdminRepliesView = (containerId) => {
            const container = document.getElementById(containerId);
            if (!container) return;
            const isHidden = container.classList.contains('hidden');
            if (isHidden) {
                container.classList.remove('hidden');
                const pollId = containerId.replace('replies-', '');
                const pollDocRef = doc(db, "polls", pollId);
                const repliesQuery = query(collection(pollDocRef, "replies"), orderBy("createdAt", "asc"));
                onSnapshot(repliesQuery, (snapshot) => {
                    let repliesHTML = '';
                    if (snapshot.empty) {
                        repliesHTML = '<p class="text-slate-400 text-center">لا توجد ردود.</p>';
                    } else {
                        snapshot.forEach(doc => {
                            const reply = doc.data();
                            repliesHTML += `
                                <div class="p-2 rounded-lg bg-slate-800/50 flex justify-between items-start">
                                    <div>
                                        <p class="text-sm text-slate-200">${reply.replyText}</p>
                                        <p class="text-xs text-slate-500 mt-1">${reply.userName}</p>
                                    </div>
                                    <button onclick="deleteReply('${pollId}', '${doc.id}')" class="text-red-500 hover:text-red-400 text-lg flex-shrink-0 ml-2"><i class="ph-trash"></i></button>
                                </div>
                            `;
                        });
                    }
                    container.innerHTML = repliesHTML;
                });
            } else {
                container.classList.add('hidden');
                container.innerHTML = '<p class="text-center text-slate-400">جاري تحميل الردود...</p>';
            }
        }
        // Admin: Delete poll with replies
        window.deletePollWithReplies = async (pollId) => {
            if (!confirm('هل أنت متأكد من حذف هذا الموضوع وكل الردود المتعلقة به؟ لا يمكن التراجع عن هذا الإجراء.')) return;
            const pollRef = doc(db, 'polls', pollId);
            const repliesRef = collection(pollRef, 'replies');
            const repliesSnapshot = await getDocs(repliesRef);
            const batch = writeBatch(db);
            repliesSnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            await deleteDoc(pollRef);
            showToast('تم حذف الاستطلاع وكل الردود.');
        }
        // Admin: Delete single reply
        window.deleteReply = async (pollId, replyId) => {
            if (!confirm('هل أنت متأكد من حذف هذا الرد؟')) return;
            const replyRef = doc(db, 'polls', pollId, 'replies', replyId);
            await deleteDoc(replyRef);
            showToast('تم حذف الرد.');
        }
        // ======================= SHOUN SECTION =======================
        window.openShounSection = () => {
            updateUserActivity("يتواصل مع شئون الطلاب");
            const content = `
                <div class="shoun-animate p-8 text-center space-y-8">
                    <div class="relative w-24 h-24 mx-auto mb-6">
                         <div class="absolute inset-0 bg-blue-500/20 blur-2xl rounded-full animate-pulse"></div>
                         <div class="relative w-full h-full bg-white/5 backdrop-blur-xl border border-white/10 rounded-3xl flex items-center justify-center shadow-2xl">
                             <i class="ph-phone-call text-5xl text-blue-400 drop-shadow-[0_0_15px_rgba(96,165,250,0.5)]"></i>
                         </div>
                    </div>
                    <div>
                        <h3 class="text-3xl font-black text-white tracking-wider mb-2">شئون الطلاب</h3>
                        <p class="text-slate-400 font-medium opacity-80">اختر القسم الذي ترغب في التواصل معه</p>
                    </div>
                    <div class="grid grid-cols-1 gap-4 mt-6">
                        <button onclick="startDialTimer('01149993043', '1')" class="group relative p-6 rounded-[2rem] shoun-floating-btn overflow-hidden">
                             <div class="absolute inset-0 bg-gradient-to-r from-blue-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                             <div class="flex items-center justify-between relative z-10">
                                <div class="flex items-center gap-5">
                                     <div class="w-14 h-14 rounded-2xl bg-blue-500/10 flex items-center justify-center text-blue-400 group-hover:scale-110 transition-transform">
                                         <i class="ph-phone-call text-3xl"></i>
                                     </div>
                                     <div class="text-right">
                                         <span class="block font-black text-xl text-white">القسم الأول</span>
                                         <span class="text-xs text-blue-400/60 font-medium">متاح الآن للتواصل</span>
                                     </div>
                                </div>
                                <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center group-hover:bg-blue-500/20 transition-colors">
                                    <i class="ph-caret-left text-slate-500 group-hover:text-blue-400 group-hover:-translate-x-1 transition-all"></i>
                                </div>
                             </div>
                        </button>
                        <button onclick="startDialTimer('01146022266', '2')" class="group relative p-6 rounded-[2rem] shoun-floating-btn overflow-hidden">
                             <div class="absolute inset-0 bg-gradient-to-r from-green-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                             <div class="flex items-center justify-between relative z-10">
                                <div class="flex items-center gap-5">
                                     <div class="w-14 h-14 rounded-2xl bg-green-500/10 flex items-center justify-center text-green-400 group-hover:scale-110 transition-transform">
                                         <i class="ph-phone-call text-3xl"></i>
                                     </div>
                                     <div class="text-right">
                                         <span class="block font-black text-xl text-white">القسم الثاني</span>
                                         <span class="text-xs text-green-400/60 font-medium">متاح الآن للتواصل</span>
                                     </div>
                                </div>
                                <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center group-hover:bg-green-500/20 transition-colors">
                                    <i class="ph-caret-left text-slate-500 group-hover:text-green-400 group-hover:-translate-x-1 transition-all"></i>
                                </div>
                             </div>
                        </button>
                    </div>
                </div>
            `;

            const modal = document.getElementById('generic-modal');
            modal.classList.add('shoun-modal-mode');

            const onClose = () => {
                closeGenericModal();
                setTimeout(() => modal.classList.remove('shoun-modal-mode'), 300);
            };

            openModalWithContent('', content, onClose);
        };

        window.startDialTimer = (num, label) => {
            let timeLeft = 3;
            // Capture modal elements
            const modal = document.getElementById('generic-modal');
            const modalContent = modal.querySelector('.modal-content');

            const timerHtml = `
                <div class="p-8 text-center animate-fade-in">
                    <div class="relative w-32 h-32 mx-auto mb-6">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="64" cy="64" r="60" stroke="#1e293b" stroke-width="8" fill="none"></circle>
                            <circle id="timer-circle" cx="64" cy="64" r="60" stroke="#3b82f6" stroke-width="8" fill="none" class="transition-all duration-1000" style="stroke-dasharray: 377; stroke-dashoffset: 0;"></circle>
                        </svg>
                        <div id="shoun-timer-text" class="absolute inset-0 flex items-center justify-center text-5xl font-black text-white">3</div>
                    </div>
                    <h4 class="text-2xl font-bold text-white mb-2">اتصال جاري...</h4>
                    <p class="text-slate-400">التحويل لشئون: ${label}</p>
                </div>
            `;
            modalContent.innerHTML = timerHtml;

            const interval = setInterval(() => {
                timeLeft--;
                const text = document.getElementById('shoun-timer-text');
                const circle = document.getElementById('timer-circle');
                if (text) text.textContent = timeLeft;
                if (circle) circle.style.strokeDashoffset = (377 * (3 - timeLeft)) / 3;

                if (timeLeft <= 0) {
                    clearInterval(interval);
                    window.location.href = `tel:${num}`;
                    closeGenericModal();
                }
            }, 1000);
        };

        // ======================= ADMIN EXAM RESULTS =======================
        async function renderAdminExamResults() {
            const container = document.getElementById('admin-exam-results-list');
            if (!container) return;

            container.innerHTML = '<p class="text-center text-slate-400 py-10">جاري تحميل النتائج...</p>';

            const q = query(collection(db, "exam_results"), orderBy("timestamp", "desc"));
            // Static listener for real-time removal etc.
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-center text-slate-400 py-10">لا توجد نتائج مسجلة بعد.</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(docSnap => {
                    const r = docSnap.data();
                    const date = r.timestamp ? r.timestamp.toDate().toLocaleString('ar-EG') : 'N/A';
                    const grade = r.score >= 90 ? 'امتياز' : r.score >= 75 ? 'جيد جداً' : r.score >= 65 ? 'جيد' : r.score >= 50 ? 'مقبول' : 'راسب';
                    const gradeColor = r.score >= 90 ? 'text-amber-400' : r.score >= 75 ? 'text-blue-400' : r.score >= 50 ? 'text-green-400' : 'text-red-400';
                    const duration = r.duration || 'غير معروف';

                    html += `
                        <div class="glass-effect p-5 rounded-2xl flex flex-col md:flex-row justify-between items-center gap-4 group hover:bg-white/5 transition-all">
                            <div class="flex-grow text-right space-y-1 w-full">
                                <div class="flex items-center gap-2">
                                    <h4 class="text-xl font-bold text-white">${r.userName}</h4>
                                    <span class="text-[10px] px-2 py-0.5 rounded-full bg-white/5 text-slate-400 font-mono">${r.userId}</span>
                                </div>
                                <p class="text-sm text-slate-400">${r.examTitle} - ${r.subject}</p>
                                <div class="flex flex-wrap gap-4 text-xs font-bold mt-2">
                                    <span class="${gradeColor}">${grade} (${r.score}%)</span>
                                    <span class="text-slate-500"><i class="ph-timer"></i> ${duration}</span>
                                    <span class="text-slate-500"><i class="ph-calendar"></i> ${date}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 shrink-0">
                                <button onclick="deleteExamResult('${docSnap.id}')" class="p-3 rounded-xl bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white transition-all">
                                    <i class="ph-trash text-xl"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            });
        }

        window.deleteExamResult = async (id) => {
            if (confirm('هل أنت متأكد من حذف هذه النتيجة؟')) {
                await deleteDoc(doc(db, "exam_results", id));
                showToast("تم حذف النتيجة بنجاح.");
            }
        };

        // Helper to convert numbers to Arabic ordinals
        function getArabicOrdinal(n) {
            const ordinals = ["الأولى", "الثانية", "الثالثة", "الرابعة", "الخامسة", "السادسة", "السابعة", "الثامنة", "التاسعة", "العاشرة", "الحادية عشرة", "الثانية عشرة"];
            return ordinals[n - 1] || n;
        }



        window.openMyCertificates = async () => {
            const content = `
                <div class="text-center mb-8">
                    <div class="w-20 h-20 bg-gradient-to-br from-amber-400 to-amber-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-[0_0_30px_rgba(251,191,36,0.4)] animate-pulse">
                        <i class="ph-medal text-4xl text-white"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">شهادتي</h2>
                    <p class="text-slate-400 text-sm max-w-xs mx-auto">هنا تجد جميع شهادات التقدير التي حصلت عليها بعد اجتياز الامتحانات بنجاح 🎓</p>
                </div>

                <div id="certificates-grid" class="grid grid-cols-1 gap-4 pb-20">
                    <div class="flex justify-center py-10">
                        <div class="w-8 h-8 border-4 border-[var(--primary-glow)] border-t-transparent rounded-full animate-spin"></div>
                    </div>
                </div>
            `;

            openModalWithContent('شهادتي', content);

            // Fetch certificates from both sources
            try {
                const localKey = `user_certificates_${currentUser.id}`;
                const deletedKey = `deleted_certificates_${currentUser.id}`;

                // Get local certificates
                let localCerts = [];
                try {
                    localCerts = JSON.parse(localStorage.getItem(localKey) || '[]');
                } catch (e) {
                    console.error('Error reading local certificates:', e);
                }

                // Get deleted IDs
                let deletedIds = [];
                try {
                    deletedIds = JSON.parse(localStorage.getItem(deletedKey) || '[]');
                } catch (e) {
                    console.error('Error reading deleted certificates:', e);
                }

                let allCerts = [...localCerts];

                // Try to fetch from Firebase if online
                if (navigator.onLine) {
                    try {
                        const q = query(
                            collection(db, 'student_certificates'),
                            where('userId', '==', currentUser.id),
                            orderBy('createdAt', 'desc')
                        );
                        const snapshot = await getDocs(q);

                        const firebaseCerts = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));

                        // Merge: Firebase takes priority, then add local-only certs
                        const mergedMap = new Map();

                        // Add Firebase certs first
                        firebaseCerts.forEach(cert => {
                            if (!deletedIds.includes(cert.id)) {
                                mergedMap.set(cert.id, cert);
                            }
                        });

                        // Add local certs that aren't in Firebase
                        localCerts.forEach(cert => {
                            if (!mergedMap.has(cert.id) && !deletedIds.includes(cert.id)) {
                                mergedMap.set(cert.id, cert);
                            }
                        });

                        allCerts = Array.from(mergedMap.values());

                        // Save merged results to localStorage
                        localStorage.setItem(localKey, JSON.stringify(allCerts));

                    } catch (error) {
                        console.error('Error fetching from Firebase:', error);
                        // Continue with local certs only
                    }
                } else {
                    // Filter out deleted certs when offline
                    allCerts = localCerts.filter(cert => !deletedIds.includes(cert.id));
                }

                const grid = document.getElementById('certificates-grid');
                if (!grid) return;

                if (allCerts.length === 0) {
                    grid.innerHTML = `
                        <div class="text-center py-10 opacity-70">
                            <i class="ph-certificate text-6xl text-slate-600 mb-4 block"></i>
                            <p class="text-slate-400">لم تحصل على شهادات حتى الآن</p>
                            <p class="text-xs text-slate-500 mt-2">شارك في الامتحانات للحصول على شهادات!</p>
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = allCerts.map(cert => {
                    const date = cert.createdAt?.seconds
                        ? new Date(cert.createdAt.seconds * 1000).toLocaleDateString('ar-EG')
                        : (cert.createdAt?.toDate ? cert.createdAt.toDate().toLocaleDateString('ar-EG') : 'حديثاً');

                    const time = cert.createdAt?.seconds
                        ? new Date(cert.createdAt.seconds * 1000).toLocaleTimeString('ar-EG')
                        : (cert.createdAt?.toDate ? cert.createdAt.toDate().toLocaleTimeString('ar-EG') : '');

                    return `
                        <div class="certificate-preview-card">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 rounded-lg shrink-0 bg-gradient-to-br from-amber-400/20 to-amber-600/20 border border-amber-400/30 flex items-center justify-center">
                                    <i class="ph-medal text-3xl text-amber-400"></i>
                                </div>
                                
                                <div class="flex-grow min-w-0">
                                    <h4 class="font-bold text-white truncate mb-1">${cert.subjectName || cert.subject || 'مادة عامة'}</h4>
                                    <p class="text-xs text-[var(--primary-glow)] truncate mb-2">
                                        ${cert.examType === 'lecture'
                            ? `${cert.lectureTitle || 'امتحان محاضرة'}`
                            : `${cert.weeklyExamTitle || cert.examTitle || 'امتحان أسبوعي'}`}
                                    </p>
                                    <div class="flex items-center gap-3 text-[10px] text-slate-400">
                                        <span class="bg-white/5 px-2 py-1 rounded flex items-center gap-1">
                                            <i class="ph-calendar"></i> ${date}
                                        </span>
                                        ${time ? `<span class="bg-white/5 px-2 py-1 rounded flex items-center gap-1">
                                            <i class="ph-clock"></i> ${time}
                                        </span>` : ''}
                                        <span class="bg-green-500/20 text-green-400 px-2 py-1 rounded font-bold">
                                            ${cert.percentage}%
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="certificate-actions">
                                <button class="btn-preview" data-cert-id="${cert.id}">
                                    <i class="ph-eye"></i> معاينة
                                </button>
                                <button class="btn-download" data-cert-id="${cert.id}">
                                    <i class="ph-download"></i> تحميل
                                </button>
                                <button class="btn-delete" data-cert-id="${cert.id}">
                                    <i class="ph-trash"></i> حذف
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error("Error in openMyCertificates:", error);
                const grid = document.getElementById('certificates-grid');
                if (grid) grid.innerHTML = `<p class="text-red-400 text-center">حدث خطأ أثناء تحميل الشهادات</p>`;
            }
        };

        window.createCertificateAfterExam = async (data) => {
            try {
                const certData = {
                    ...data,
                    createdAt: serverTimestamp(),
                    issuedAt: serverTimestamp()
                };

                // Save to BOTH collections for full compatibility
                // 1. Save to student_certificates (new system)
                const docRef = await addDoc(collection(db, 'student_certificates'), certData);

                // 2. Save to certificates (old system)
                await addDoc(collection(db, 'certificates'), {
                    ...certData,
                    examTitle: data.weeklyExamTitle || data.lectureTitle || data.examTitle || 'امتحان',
                    subject: data.subjectName || data.subject || 'مادة عامة',
                    correct: data.correctCount,
                    total: data.totalQuestions
                });

                // Save to localStorage immediately
                const localKey = `user_certificates_${currentUser.id}`;
                let localCerts = [];
                try {
                    localCerts = JSON.parse(localStorage.getItem(localKey) || '[]');
                } catch (e) {
                    console.error('Error reading local certificates:', e);
                }

                // Add new certificate with Firebase ID
                const newCert = {
                    id: docRef.id,
                    ...data,
                    createdAt: { seconds: Math.floor(Date.now() / 1000) },
                    issuedAt: { seconds: Math.floor(Date.now() / 1000) }
                };
                localCerts.unshift(newCert);
                localStorage.setItem(localKey, JSON.stringify(localCerts));

                showToast('🎓 تم إصدار شهادة تقدير جديدة!');
            } catch (error) {
                console.error("Error creating certificate:", error);

                // If Firebase fails, save locally only
                const localKey = `user_certificates_${currentUser.id}`;
                let localCerts = [];
                try {
                    localCerts = JSON.parse(localStorage.getItem(localKey) || '[]');
                } catch (e) {
                    console.error('Error reading local certificates:', e);
                }

                const newCert = {
                    id: `local_${Date.now()}`,
                    ...data,
                    createdAt: { seconds: Math.floor(Date.now() / 1000) },
                    issuedAt: { seconds: Math.floor(Date.now() / 1000) }
                };
                localCerts.unshift(newCert);
                localStorage.setItem(localKey, JSON.stringify(localCerts));

                showToast('🎓 تم حفظ الشهادة محلياً!');
            }
        };

        // Generate QR Code for certificate verification
        const generateQRCodeDataURL = (certNumber) => {
            const qrContainer = document.createElement('div');
            qrContainer.style.display = 'none';
            document.body.appendChild(qrContainer);

            try {
                new QRCode(qrContainer, {
                    text: `https://moraforstudying.com/verify/${certNumber}`,
                    width: 100,
                    height: 100,
                    colorDark: '#d4af37',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });

                const canvas = qrContainer.querySelector('canvas');
                const dataURL = canvas ? canvas.toDataURL() : '';
                document.body.removeChild(qrContainer);
                return dataURL;
            } catch (e) {
                document.body.removeChild(qrContainer);
                return '';
            }
        };

        // ======================= HELPER FUNCTIONS FOR CERTIFICATES =======================

        // Detect gender from Arabic name
        window.detectGender = (name) => {
            if (!name) return 'الطالب';
            const femaleEndings = ['ة', 'اء', 'ى'];
            const femaleNames = ['فاطمة', 'عائشة', 'خديجة', 'مريم', 'زينب', 'سارة', 'نور', 'هدى', 'أسماء', 'رقية'];

            const nameLower = name.trim();
            if (femaleEndings.some(ending => nameLower.endsWith(ending))) return 'الطالبة';
            if (femaleNames.some(fn => nameLower.includes(fn))) return 'الطالبة';
            return 'الطالب';
        };

        // Convert number to Arabic ordinal
        window.getArabicOrdinal = (num) => {
            const ordinals = {
                1: 'الأولى', 2: 'الثانية', 3: 'الثالثة', 4: 'الرابعة', 5: 'الخامسة',
                6: 'السادسة', 7: 'السابعة', 8: 'الثامنة', 9: 'التاسعة', 10: 'العاشرة',
                11: 'الحادية عشرة', 12: 'الثانية عشرة', 13: 'الثالثة عشرة', 14: 'الرابعة عشرة', 15: 'الخامسة عشرة',
                16: 'السادسة عشرة', 17: 'السابعة عشرة', 18: 'الثامنة عشرة', 19: 'التاسعة عشرة', 20: 'العشرون'
            };
            return ordinals[num] || `رقم ${num}`;
        };

        // Helper to ensure certificate has a number
        window.ensureCertificateNumber = (cert) => {
            if (!cert.certificateNumber) {
                const year = new Date().getFullYear();
                cert.certificateNumber = `MORA-${year}-${Date.now().toString(36).toUpperCase()}${Math.random().toString(36).substr(2, 4).toUpperCase()}`;

                // Update in background if possible
                if (navigator.onLine && cert.id) {
                    try {
                        updateDoc(doc(db, "student_certificates", cert.id), { certificateNumber: cert.certificateNumber })
                            .catch(e => console.log('Silently failed to update cert number', e));
                    } catch (e) { }
                }
            }
            return cert.certificateNumber;
        };

        // Core function to generate Certificate HTML
        // Now accepts direct parameters or extracts them from cert object
        window.getCertificateHTML = (cert, certNumber, qrCodeDataURL, motivationalMsg, date) => {
            // Ensure defaults if optional params missing
            if (!certNumber) certNumber = ensureCertificateNumber(cert);
            if (!date) date = new Date(cert.createdAt?.seconds * 1000 || Date.now()).toLocaleDateString('ar-EG');
            if (!qrCodeDataURL) qrCodeDataURL = generateQRCodeDataURL(certNumber);

            if (!motivationalMsg) {
                if (cert.percentage >= 95) motivationalMsg = "إنجاز استثنائي يستحق كل التقدير";
                else if (cert.percentage >= 90) motivationalMsg = "أداء متميز يعكس الجد والاجتهاد";
                else if (cert.percentage >= 80) motivationalMsg = "مستوى رائع، استمر في التفوق";
                else if (cert.percentage >= 70) motivationalMsg = "نتيجة جيدة، واصل المسيرة";
                else if (cert.percentage >= 60) motivationalMsg = "بداية موفقة نحو النجاح";
                else motivationalMsg = "مع تمنياتنا بدوام التوفيق والنجاح";
            }

            if (cert.examType === 'lecture') {
                return `
                    <div id="cert-node-${cert.id}" style="width:600px;min-height:850px;background:linear-gradient(135deg,#1a2332 0%,#0f1419 50%,#1a2332 100%);position:relative;overflow:hidden;font-family:'Cairo',sans-serif;box-shadow:none;border-radius:0;padding:50px 45px 65px;display:flex;flex-direction:column;gap:22px">
                        <!-- Background Pattern -->
                        <div style="position:absolute;top:0;left:0;right:0;bottom:0;opacity:0.04;background-image:radial-gradient(circle at 20% 50%,#d4af37 1px,transparent 1px),radial-gradient(circle at 80% 50%,#d4af37 1px,transparent 1px);background-size:50px 50px;pointer-events:none"></div>
                        
                        <!-- Golden Border Frame -->
                        <div style="position:absolute;inset:20px;border:3px solid;border-image:linear-gradient(135deg,#d4af37,#f4e4c1,#d4af37) 1;pointer-events:none;border-radius:16px"></div>
                        <div style="position:absolute;inset:28px;border:1.5px solid rgba(212,175,55,0.3);pointer-events:none;border-radius:14px"></div>
                        
                        <!-- Corner Decorations -->
                        <div style="position:absolute;top:15px;right:15px;width:70px;height:70px;border-top:4px solid #d4af37;border-right:4px solid #d4af37;border-radius:0 14px 0 0"></div>
                        <div style="position:absolute;top:15px;left:15px;width:70px;height:70px;border-top:4px solid #d4af37;border-left:4px solid #d4af37;border-radius:14px 0 0 0"></div>
                        <div style="position:absolute;bottom:15px;right:15px;width:70px;height:70px;border-bottom:4px solid #d4af37;border-right:4px solid #d4af37;border-radius:0 0 14px 0"></div>
                        <div style="position:absolute;bottom:15px;left:15px;width:70px;height:70px;border-bottom:4px solid #d4af37;border-left:4px solid #d4af37;border-radius:0 0 0 14px"></div>
                        
                        <!-- Logo Section -->
                        <div style="text-align:center;position:relative;z-index:10;margin-top:8px">
                            <div style="width:100px;height:100px;margin:0 auto 15px;border-radius:50%;background:linear-gradient(135deg,#d4af37,#f4e4c1);padding:4px;box-shadow:0 12px 30px rgba(212,175,55,0.5)">
                                <div style="width:100%;height:100%;border-radius:50%;background:#1a2332;display:flex;align-items:center;justify-content:center;overflow:hidden">
                                    <img src="https://i.postimg.cc/mgdFZ313/IMG-20250414-WA0047-1.jpg" style="width:70%;height:70%;object-fit:cover;border-radius:50%;opacity:0.95" alt="Logo">
                                </div>
                            </div>
                            <h1 style="font-size:28px;font-weight:900;margin:0;background:linear-gradient(135deg,#d4af37,#f4e4c1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:1px">Mora For Studying</h1>
                            <div style="width:120px;height:3px;background:linear-gradient(90deg,transparent,#d4af37,transparent);margin:12px auto"></div>
                        </div>

                        <!-- Certificate Title -->
                        <div style="text-align:center;position:relative;z-index:10">
                            <h2 style="font-size:48px;font-weight:900;color:#d4af37;margin:0;letter-spacing:2px;text-shadow:0 4px 8px rgba(212,175,55,0.4)">CERTIFICATE</h2>
                            <p style="font-size:20px;color:#f4e4c1;margin:8px 0 0;font-weight:600;letter-spacing:3px">Of ACHIEVEMENT</p>
                            <div style="width:160px;height:4px;background:linear-gradient(90deg,transparent,#d4af37,transparent);margin:15px auto"></div>
                        </div>

                        <!-- Main Text -->
                        <div style="text-align:center;position:relative;z-index:10;margin:10px 0">
                            <p style="font-size:16px;color:#cbd5e1;margin:0;font-weight:600;line-height:2">تشهد منصة <span style="color:#d4af37;font-weight:800">Mora For Studying</span></p>
                            <p style="font-size:16px;color:#cbd5e1;margin:6px 0 0;font-weight:600;line-height:2">بأن الطالب المذكور اسمه أدناه قد أتم اجتياز الاختبار بنجاح،</p>
                            <p style="font-size:16px;color:#cbd5e1;margin:6px 0 0;font-weight:600;line-height:2">وذلك وفقًا للمعايير التعليمية المعتمدة بالمنصة.</p>
                        </div>

                        <!-- Student Name Box -->
                        <div style="margin:18px 0;padding:32px 40px;background:linear-gradient(135deg,rgba(212,175,55,0.15),rgba(244,228,193,0.1));border:3px solid #d4af37;border-radius:20px;position:relative;z-index:10;box-shadow:0 8px 25px rgba(212,175,55,0.25)">
                            <h3 style="font-size:42px;font-weight:900;color:#f4e4c1;margin:0;text-align:center;letter-spacing:1px;text-shadow:0 2px 4px rgba(0,0,0,0.5)">${cert.userName}</h3>
                            <div style="width:200px;height:3px;background:linear-gradient(90deg,transparent,#d4af37,transparent);margin:15px auto 0"></div>
                        </div>

                        <!-- Grade and Percentage ONLY -->
                        <div style="display:flex;justify-content:center;gap:20px;margin:20px 0;position:relative;z-index:10">
                            <div style="flex:1;max-width:250px;background:linear-gradient(135deg,#d4af37,#f4e4c1);padding:25px 20px;border-radius:16px;text-align:center;box-shadow:0 10px 30px rgba(212,175,55,0.4)">
                                <p style="font-size:12px;color:#1a2332;margin:0 0 10px;font-weight:900;letter-spacing:1px">النسبة المئوية</p>
                                <p style="font-size:42px;font-weight:900;color:#1a2332;margin:0">${cert.percentage}%</p>
                                <div style="width:80px;height:2px;background:#1a2332;margin:12px auto 8px"></div>
                                <p style="font-size:13px;color:#1a2332;margin:0;font-weight:800">التقدير: ${cert.grade}</p>
                            </div>
                        </div>

                        <!-- Footer Section -->
                        <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-top:auto;padding-top:25px;border-top:3px solid rgba(212,175,55,0.3);position:relative;z-index:10">
                            <div style="text-align:left;flex:1">
                                <p style="font-size:12px;color:#94a3b8;margin:0 0 12px;font-weight:700;letter-spacing:1.5px">مسؤول المنصة</p>
                                <p style="font-size:34px;font-weight:400;background:linear-gradient(135deg,#d4af37,#f4e4c1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin:0;font-family:'Brush Script MT','Segoe Script',cursive;letter-spacing:2px">𝑨𝒎𝒓 𝑳𝒐𝒕𝒇𝒚</p>
                                <div style="width:120px;height:3px;background:linear-gradient(90deg,#d4af37,transparent);margin-top:10px"></div>
                            </div>
                            <div style="text-align:right;flex:1;display:flex;flex-direction:column;align-items:flex-end;gap:10px">
                                <div>
                                    <p style="font-size:12px;color:#94a3b8;margin:0 0 10px;font-weight:700;letter-spacing:1.5px">رقم الشهادة</p>
                                    <p style="font-size:14px;font-weight:900;color:#d4af37;margin:0;font-family:'Courier New',monospace;letter-spacing:1.5px;direction:ltr;text-align:right">${certNumber}</p>
                                    <p style="font-size:12px;color:#94a3b8;margin:8px 0 0;font-weight:600;direction:rtl">${date}</p>
                                </div>
                                ${qrCodeDataURL ? `<img src="${qrCodeDataURL}" style="width:70px;height:70px;border:2px solid #b8941f;border-radius:8px;padding:4px;background:white" alt="QR Code">` : ''}
                            </div>
                        </div>

                        <div style="position:absolute;bottom:35px;left:50%;transform:translateX(-50%);width:90px;height:90px;border-radius:50%;background:linear-gradient(135deg,#b8941f,#d4af37);display:flex;align-items:center;justify-content:center;box-shadow:0 10px 25px rgba(184,148,31,0.5);z-index:11">
                            <div style="position:absolute;inset:5px;background:#f8f6f1;border-radius:50%"></div>
                            <i class="ph-seal-check" style="font-size:50px;background:linear-gradient(135deg,#b8941f,#8b7355);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;position:relative;z-index:1"></i>
                        </div>
                    </div>`;
            } else {
                return `
                    <div id="cert-node-${cert.id}" style="width:600px;min-height:850px;background:linear-gradient(135deg,#fdfbf7 0%,#f8f6f1 50%,#f0ebe5 100%);position:relative;overflow:hidden;font-family:'Cairo',sans-serif;box-shadow:none;border-radius:0;padding:50px 45px 65px;display:flex;flex-direction:column;gap:22px">
                        <!-- Background Pattern -->
                        <div style="position:absolute;top:0;left:0;right:0;bottom:0;opacity:0.04;background-image:radial-gradient(circle at 25px 25px,#d4af37 2%,transparent 0%),radial-gradient(circle at 75px 75px,#d4af37 2%,transparent 0%);background-size:100px 100px;pointer-events:none"></div>
                        
                        <!-- Red Diagonal Ribbon -->
                        <div style="position:absolute;top:60px;left:-80px;width:350px;height:120px;background:linear-gradient(135deg,#c41e3a 0%,#8b0000 100%);transform:rotate(-45deg);box-shadow:0 8px 20px rgba(196,30,58,0.4);z-index:5">
                            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:100%;text-align:center">
                                <div style="display:flex;align-items:center;justify-content:center;gap:15px">
                                    <div style="width:70px;height:70px;border-radius:50%;background:linear-gradient(135deg,#d4af37,#f4e4c1);padding:3px;box-shadow:0 6px 15px rgba(212,175,55,0.5)">
                                        <div style="width:100%;height:100%;border-radius:50%;background:#c41e3a;display:flex;align-items:center;justify-content:center">
                                            <i class="ph-medal" style="font-size:35px;color:#d4af37"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Golden Border Frame -->
                        <div style="position:absolute;inset:20px;border:3px solid;border-image:linear-gradient(135deg,#d4af37,#f4e4c1,#d4af37) 1;pointer-events:none;border-radius:16px"></div>
                        <div style="position:absolute;inset:28px;border:1.5px solid rgba(212,175,55,0.3);pointer-events:none;border-radius:14px"></div>
                        
                        <!-- Corner Decorations -->
                        <div style="position:absolute;top:15px;right:15px;width:70px;height:70px;border-top:4px solid #d4af37;border-right:4px solid #d4af37;border-radius:0 14px 0 0"></div>
                        <div style="position:absolute;bottom:15px;left:15px;width:70px;height:70px;border-bottom:4px solid #d4af37;border-left:4px solid #d4af37;border-radius:0 0 0 14px"></div>
                        
                        <!-- Logo Section -->
                        <div style="text-align:center;position:relative;z-index:10;margin-top:8px">
                            <div style="width:100px;height:100px;margin:0 auto 15px;border-radius:50%;background:linear-gradient(135deg,#d4af37,#f4e4c1);padding:4px;box-shadow:0 12px 30px rgba(212,175,55,0.5)">
                                <div style="width:100%;height:100%;border-radius:50%;background:#fdfbf7;display:flex;align-items:center;justify-content:center;overflow:hidden">
                                    <img src="https://i.postimg.cc/mgdFZ313/IMG-20250414-WA0047-1.jpg" style="width:70%;height:70%;object-fit:cover;border-radius:50%;opacity:0.95" alt="Logo">
                                </div>
                            </div>
                            <h1 style="font-size:28px;font-weight:900;margin:0;background:linear-gradient(135deg,#d4af37,#b8941f);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:1px">Mora For Studying</h1>
                            <div style="width:120px;height:3px;background:linear-gradient(90deg,transparent,#d4af37,transparent);margin:12px auto"></div>
                        </div>

                        <!-- Certificate Title -->
                        <div style="text-align:center;position:relative;z-index:10">
                            <h2 style="font-size:48px;font-weight:900;color:#d4af37;margin:0;letter-spacing:2px;text-shadow:0 4px 8px rgba(212,175,55,0.3)">CERTIFICATE</h2>
                            <div style="width:160px;height:4px;background:linear-gradient(90deg,transparent,#d4af37,transparent);margin:15px auto"></div>
                        </div>

                        <!-- Main Text -->
                        <div style="text-align:center;position:relative;z-index:10;margin:10px 0">
                            <p style="font-size:16px;color:#5a4a3a;margin:0;font-weight:600;line-height:2">تشهد منصة <span style="color:#d4af37;font-weight:800">Mora For Studying</span></p>
                            <p style="font-size:16px;color:#5a4a3a;margin:6px 0 0;font-weight:600;line-height:2">بأن الطالب المذكور اسمه أدناه قد أتم اجتياز الاختبار بنجاح،</p>
                            <p style="font-size:16px;color:#5a4a3a;margin:6px 0 0;font-weight:600;line-height:2">وذلك وفقًا للمعايير التعليمية المعتمدة بالمنصة.</p>
                        </div>

                        <!-- Student Name Box -->
                        <div style="margin:18px 0;padding:32px 40px;background:linear-gradient(135deg,rgba(212,175,55,0.12),rgba(244,228,193,0.18));border:3px solid #d4af37;border-radius:20px;position:relative;z-index:10;box-shadow:0 8px 25px rgba(212,175,55,0.25)">
                            <h3 style="font-size:42px;font-weight:900;color:#2c2416;margin:0;text-align:center;letter-spacing:1px">${cert.userName}</h3>
                            <div style="width:200px;height:3px;background:linear-gradient(90deg,transparent,#d4af37,transparent);margin:15px auto 0"></div>
                        </div>

                        <!-- Grade and Percentage ONLY -->
                        <div style="display:flex;justify-content:center;gap:20px;margin:20px 0;position:relative;z-index:10">
                            <div style="flex:1;max-width:250px;background:linear-gradient(135deg,#d4af37,#f4e4c1);padding:25px 20px;border-radius:16px;text-align:center;box-shadow:0 10px 30px rgba(212,175,55,0.4)">
                                <p style="font-size:12px;color:#2c2416;margin:0 0 10px;font-weight:900;letter-spacing:1px">النسبة المئوية</p>
                                <p style="font-size:42px;font-weight:900;color:#2c2416;margin:0">${cert.percentage}%</p>
                                <div style="width:80px;height:2px;background:#2c2416;margin:12px auto 8px"></div>
                                <p style="font-size:13px;color:#2c2416;margin:0;font-weight:800">التقدير: ${cert.grade}</p>
                            </div>
                        </div>

                        <!-- Footer Section -->
                        <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-top:auto;padding-top:25px;border-top:3px solid rgba(212,175,55,0.3);position:relative;z-index:10">
                            <div style="text-align:left;flex:1">
                                <p style="font-size:12px;color:#8b7355;margin:0 0 12px;font-weight:700;letter-spacing:1.5px">مسؤول المنصة</p>
                                <p style="font-size:34px;font-weight:400;background:linear-gradient(135deg,#d4af37,#b8941f);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin:0;font-family:'Brush Script MT','Segoe Script',cursive;letter-spacing:2px">𝑨𝒎𝒓 𝑳𝒐𝒕𝒇𝒚</p>
                                <div style="width:120px;height:3px;background:linear-gradient(90deg,#d4af37,transparent);margin-top:10px"></div>
                            </div>
                            <div style="text-align:right;flex:1;display:flex;flex-direction:column;align-items:flex-end;gap:10px">
                                <div>
                                    <p style="font-size:12px;color:#8b7355;margin:0 0 10px;font-weight:700;letter-spacing:1.5px">رقم الشهادة</p>
                                    <p style="font-size:14px;font-weight:900;color:#d4af37;margin:0;font-family:'Courier New',monospace;letter-spacing:1.5px;direction:ltr;text-align:right">${certNumber}</p>
                                    <p style="font-size:12px;color:#6b5a4a;margin:8px 0 0;font-weight:600;direction:rtl">${date}</p>
                                </div>
                                ${qrCodeDataURL ? `<img src="${qrCodeDataURL}" style="width:70px;height:70px;border:2px solid #b8941f;border-radius:8px;padding:4px;background:white" alt="QR Code">` : ''}
                            </div>
                        </div>

                        <div style="position:absolute;bottom:35px;left:50%;transform:translateX(-50%);width:90px;height:90px;border-radius:50%;background:linear-gradient(135deg,#b8941f,#d4af37);display:flex;align-items:center;justify-content:center;box-shadow:0 10px 25px rgba(184,148,31,0.5);z-index:11">
                            <div style="position:absolute;inset:5px;background:#f8f6f1;border-radius:50%"></div>
                            <i class="ph-seal-check" style="font-size:50px;background:linear-gradient(135deg,#b8941f,#8b7355);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;position:relative;z-index:1"></i>
                        </div>
                    </div>`;
            }
        };

        window.viewCertificate = (cert) => {
            const date = new Date(cert.createdAt?.seconds * 1000 || Date.now()).toLocaleDateString('ar-EG');

            // Detect gender automatically
            const studentGender = detectGender(cert.userName);

            // Generate unique certificate number
            const year = new Date().getFullYear();
            const certNumber = cert.certificateNumber || `MORA-${year}-${Date.now().toString(36).toUpperCase()}${Math.random().toString(36).substr(2, 4).toUpperCase()}`;

            // Store certificate number if not exists
            if (!cert.certificateNumber) {
                cert.certificateNumber = certNumber;
                if (navigator.onLine && cert.id) {
                    try {
                        updateDoc(doc(db, "student_certificates", cert.id), { certificateNumber: certNumber });
                    } catch (e) { console.log('Certificate number update pending'); }
                }
            }

            // Generate QR Code
            const qrCodeDataURL = generateQRCodeDataURL(certNumber);

            // Motivational message based on grade
            let motivationalMsg = "مع تمنياتنا بدوام التوفيق والنجاح";
            if (cert.percentage >= 95) motivationalMsg = "إنجاز استثنائي يستحق كل التقدير";
            else if (cert.percentage >= 90) motivationalMsg = "أداء متميز يعكس الجد والاجتهاد";
            else if (cert.percentage >= 80) motivationalMsg = "مستوى رائع، استمر في التفوق";
            else if (cert.percentage >= 70) motivationalMsg = "نتيجة جيدة، واصل المسيرة";
            else if (cert.percentage >= 60) motivationalMsg = "بداية موفقة نحو النجاح";

            let certHTML = '';

            // ============ LECTURE EXAM CERTIFICATE ============
            if (cert.examType === 'lecture') {
                const lectureText = `المحاضرة ${getArabicOrdinal(cert.lectureNumber || 1)}`;

                certHTML = `
                    <div id="full-cert-node-${cert.id}" style="width:600px;min-height:850px;background:linear-gradient(135deg,#1a2332 0%,#0f1419 50%,#1a2332 100%);position:relative;overflow:hidden;font-family:'Cairo',sans-serif;box-shadow:0 30px 60px rgba(0,0,0,0.5);border-radius:20px;padding:50px 45px 65px;display:flex;flex-direction:column;gap:22px">
                        <!-- Background Pattern -->
                        <div style="position:absolute;top:0;left:0;right:0;bottom:0;opacity:0.04;background-image:radial-gradient(circle at 20% 50%,#d4af37 1px,transparent 1px),radial-gradient(circle at 80% 50%,#d4af37 1px,transparent 1px);background-size:50px 50px;pointer-events:none"></div>
                        
                        <!-- Golden Border Frame -->
                        <div style="position:absolute;inset:20px;border:3px solid;border-image:linear-gradient(135deg,#d4af37,#f4e4c1,#d4af37) 1;pointer-events:none;border-radius:16px"></div>
                        <div style="position:absolute;inset:28px;border:1.5px solid rgba(212,175,55,0.3);pointer-events:none;border-radius:14px"></div>
                        
                        <!-- Corner Decorations -->
                        <div style="position:absolute;top:15px;right:15px;width:70px;height:70px;border-top:4px solid #d4af37;border-right:4px solid #d4af37;border-radius:0 14px 0 0"></div>
                        <div style="position:absolute;top:15px;left:15px;width:70px;height:70px;border-top:4px solid #d4af37;border-left:4px solid #d4af37;border-radius:14px 0 0 0"></div>
                        <div style="position:absolute;bottom:15px;right:15px;width:70px;height:70px;border-bottom:4px solid #d4af37;border-right:44px solid #d4af37;border-radius:0 0 14px 0"></div>
                        <div style="position:absolute;bottom:15px;left:15px;width:70px;height:70px;border-bottom:4px solid #d4af37;border-left:4px solid #d4af37;border-radius:0 0 0 14px"></div>
                        
                        <!-- Logo Section -->
                        <div style="text-align:center;position:relative;z-index:10;margin-top:8px">
                            <div style="width:100px;height:100px;margin:0 auto 15px;border-radius:50%;background:linear-gradient(135deg,#d4af37,#f4e4c1);padding:4px;box-shadow:0 12px 30px rgba(212,175,55,0.5)">
                                <div style="width:100%;height:100%;border-radius:50%;background:#1a2332;display:flex;align-items:center;justify-content:center;overflow:hidden">
                                    <img src="https://i.postimg.cc/mgdFZ313/IMG-20250414-WA0047-1.jpg" style="width:70%;height:70%;object-fit:cover;border-radius:50%;opacity:0.95" alt="Logo">
                                </div>
                            </div>
                            <h1 style="font-size:28px;font-weight:900;margin:0;background:linear-gradient(135deg,#d4af37,#f4e4c1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:1px">Mora For Studying</h1>
                            <div style="width:120px;height:3px;background:linear-gradient(90deg,transparent,#d4af37,transparent);margin:12px auto"></div>
                        </div>

                        <!-- Certificate Title -->
                        <div style="text-align:center;position:relative;z-index:10">
                            <h2 style="font-size:48px;font-weight:900;color:#d4af37;margin:0;letter-spacing:2px;text-shadow:0 4px 8px rgba(212,175,55,0.4)">CERTIFICATE</h2>
                            <p style="font-size:20px;color:#f4e4c1;margin:8px 0 0;font-weight:600;letter-spacing:3px">Of ACHIEVEMENT</p>
                            <div style="width:160px;height:4px;background:linear-gradient(90deg,transparent,#d4af37,transparent);margin:15px auto"></div>
                        </div>

                        <!-- Main Text -->
                        <div style="text-align:center;position:relative;z-index:10;margin:10px 0">
                            <p style="font-size:16px;color:#cbd5e1;margin:0;font-weight:600;line-height:2">تشهد منصة <span style="color:#d4af37;font-weight:800">Mora For Studying</span></p>
                            <p style="font-size:16px;color:#cbd5e1;margin:6px 0 0;font-weight:600;line-height:2">بأن الطالب المذكور اسمه أدناه قد أتم اجتياز الاختبار بنجاح،</p>
                            <p style="font-size:16px;color:#cbd5e1;margin:6px 0 0;font-weight:600;line-height:2">وذلك وفقًا للمعايير التعليمية المعتمدة بالمنصة.</p>
                        </div>

                        <!-- Student Name Box -->
                        <div style="margin:18px 0;padding:32px 40px;background:linear-gradient(135deg,rgba(212,175,55,0.15),rgba(244,228,193,0.1));border:3px solid #d4af37;border-radius:20px;position:relative;z-index:10;box-shadow:0 8px 25px rgba(212,175,55,0.25)">
                            <h3 style="font-size:42px;font-weight:900;color:#f4e4c1;margin:0;text-align:center;letter-spacing:1px;text-shadow:0 2px 4px rgba(0,0,0,0.5)">${cert.userName}</h3>
                            <div style="width:200px;height:3px;background:linear-gradient(90deg,transparent,#d4af37,transparent);margin:15px auto 0"></div>
                        </div>

                        <!-- Grade and Percentage ONLY -->
                        <div style="display:flex;justify-content:center;gap:20px;margin:20px 0;position:relative;z-index:10">
                            <div style="flex:1;max-width:250px;background:linear-gradient(135deg,#d4af37,#f4e4c1);padding:25px 20px;border-radius:16px;text-align:center;box-shadow:0 10px 30px rgba(212,175,55,0.4)">
                                <p style="font-size:12px;color:#1a2332;margin:0 0 10px;font-weight:900;letter-spacing:1px">النسبة المئوية</p>
                                <p style="font-size:42px;font-weight:900;color:#1a2332;margin:0">${cert.percentage}%</p>
                                <div style="width:80px;height:2px;background:#1a2332;margin:12px auto 8px"></div>
                                <p style="font-size:13px;color:#1a2332;margin:0;font-weight:800">التقدير: ${cert.grade}</p>
                            </div>
                        </div>

                        <!-- Footer Section -->
                        <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-top:auto;padding-top:25px;border-top:3px solid rgba(212,175,55,0.3);position:relative;z-index:10">
                            <div style="text-align:left;flex:1">
                                <p style="font-size:12px;color:#94a3b8;margin:0 0 12px;font-weight:700;letter-spacing:1.5px">مسؤول المنصة</p>
                                <p style="font-size:34px;font-weight:400;background:linear-gradient(135deg,#d4af37,#f4e4c1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin:0;font-family:'Brush Script MT','Segoe Script',cursive;letter-spacing:2px">𝑨𝒎𝒓 𝑳𝒐𝒕𝒇𝒚</p>
                                <div style="width:120px;height:3px;background:linear-gradient(90deg,#d4af37,transparent);margin-top:10px"></div>
                            </div>
                            <div style="text-align:right;flex:1;display:flex;flex-direction:column;align-items:flex-end;gap:10px">
                                <div>
                                    <p style="font-size:12px;color:#94a3b8;margin:0 0 10px;font-weight:700;letter-spacing:1.5px">رقم الشهادة</p>
                                    <p style="font-size:14px;font-weight:900;color:#d4af37;margin:0;font-family:'Courier New',monospace;letter-spacing:1.5px;direction:ltr;text-align:right">${certNumber}</p>
                                    <p style="font-size:12px;color:#94a3b8;margin:8px 0 0;font-weight:600;direction:rtl">${date}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Official Seal -->
                        <div style="position:absolute;bottom:40px;left:50%;transform:translateX(-50%);width:95px;height:95px;border-radius:50%;background:linear-gradient(135deg,#d4af37,#f4e4c1);display:flex;align-items:center;justify-content:center;box-shadow:0 12px 30px rgba(212,175,55,0.6);z-index:11">
                            <div style="position:absolute;inset:6px;background:#1a2332;border-radius:50%"></div>
                            <i class="ph-seal-check" style="font-size:55px;background:linear-gradient(135deg,#d4af37,#f4e4c1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;position:relative;z-index:1"></i>
                        </div>
                    </div>`;
            } else {
                // ============ WEEKLY EXAM CERTIFICATE ============
                certHTML = `
                    <div id="full-cert-node-${cert.id}" style="width:600px;min-height:850px;background:linear-gradient(135deg,#fdfbf7 0%,#f8f6f1 50%,#f0ebe5 100%);position:relative;overflow:hidden;font-family:'Cairo',sans-serif;box-shadow:0 30px 60px rgba(0,0,0,0.3);border-radius:20px;padding:50px 45px 65px;display:flex;flex-direction:column;gap:22px">
                        <!-- Background Pattern -->
                        <div style="position:absolute;top:0;left:0;right:0;bottom:0;opacity:0.04;background-image:radial-gradient(circle at 25px 25px,#d4af37 2%,transparent 0%),radial-gradient(circle at 75px 75px,#d4af37 2%,transparent 0%);background-size:100px 100px;pointer-events:none"></div>
                        
                        <!-- Red Diagonal Ribbon -->
                        <div style="position:absolute;top:60px;left:-80px;width:350px;height:120px;background:linear-gradient(135deg,#c41e3a 0%,#8b0000 100%);transform:rotate(-45deg);box-shadow:0 8px 20px rgba(196,30,58,0.4);z-index:5">
                            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:100%;text-align:center">
                                <div style="display:flex;align-items:center;justify-content:center;gap:15px">
                                    <div style="width:70px;height:70px;border-radius:50%;background:linear-gradient(135deg,#d4af37,#f4e4c1);padding:3px;box-shadow:0 6px 15px rgba(212,175,55,0.5)">
                                        <div style="width:100%;height:100%;border-radius:50%;background:#c41e3a;display:flex;align-items:center;justify-content:center">
                                            <i class="ph-medal" style="font-size:35px;color:#d4af37"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Golden Border Frame -->
                        <div style="position:absolute;inset:20px;border:3px solid;border-image:linear-gradient(135deg,#d4af37,#f4e4c1,#d4af37) 1;pointer-events:none;border-radius:16px"></div>
                        <div style="position:absolute;inset:28px;border:1.5px solid rgba(212,175,55,0.3);pointer-events:none;border-radius:14px"></div>
                        
                        <!-- Corner Decorations -->
                        <div style="position:absolute;top:15px;right:15px;width:70px;height:70px;border-top:4px solid #d4af37;border-right:4px solid #d4af37;border-radius:0 14px 0 0"></div>
                        <div style="position:absolute;bottom:15px;left:15px;width:70px;height:70px;border-bottom:4px solid #d4af37;border-left:4px solid #d4af37;border-radius:0 0 0 14px"></div>
                        
                        <!-- Logo Section -->
                        <div style="text-align:center;position:relative;z-index:10;margin-top:8px">
                            <div style="width:100px;height:100px;margin:0 auto 15px;border-radius:50%;background:linear-gradient(135deg,#d4af37,#f4e4c1);padding:4px;box-shadow:0 12px 30px rgba(212,175,55,0.5)">
                                <div style="width:100%;height:100%;border-radius:50%;background:#fdfbf7;display:flex;align-items:center;justify-content:center;overflow:hidden">
                                    <img src="https://i.postimg.cc/mgdFZ313/IMG-20250414-WA0047-1.jpg" style="width:70%;height:70%;object-fit:cover;border-radius:50%;opacity:0.95" alt="Logo">
                                </div>
                            </div>
                            <h1 style="font-size:28px;font-weight:900;margin:0;background:linear-gradient(135deg,#d4af37,#b8941f);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:1px">Mora For Studying</h1>
                            <div style="width:120px;height:3px;background:linear-gradient(90deg,transparent,#d4af37,transparent);margin:12px auto"></div>
                        </div>

                        <!-- Certificate Title -->
                        <div style="text-align:center;position:relative;z-index:10">
                            <h2 style="font-size:48px;font-weight:900;color:#d4af37;margin:0;letter-spacing:2px;text-shadow:0 4px 8px rgba(212,175,55,0.3)">CERTIFICATE</h2>
                            <div style="width:160px;height:4px;background:linear-gradient(90deg,transparent,#d4af37,transparent);margin:15px auto"></div>
                        </div>

                        <!-- Main Text -->
                        <div style="text-align:center;position:relative;z-index:10;margin:10px 0">
                            <p style="font-size:16px;color:#5a4a3a;margin:0;font-weight:600;line-height:2">تشهد منصة <span style="color:#d4af37;font-weight:800">Mora For Studying</span></p>
                            <p style="font-size:16px;color:#5a4a3a;margin:6px 0 0;font-weight:600;line-height:2">بأن الطالب المذكور اسمه أدناه قد أتم اجتياز الاختبار بنجاح،</p>
                            <p style="font-size:16px;color:#5a4a3a;margin:6px 0 0;font-weight:600;line-height:2">وذلك وفقًا للمعايير التعليمية المعتمدة بالمنصة.</p>
                        </div>

                        <!-- Student Name Box -->
                        <div style="margin:18px 0;padding:32px 40px;background:linear-gradient(135deg,rgba(212,175,55,0.12),rgba(244,228,193,0.18));border:3px solid #d4af37;border-radius:20px;position:relative;z-index:10;box-shadow:0 8px 25px rgba(212,175,55,0.25)">
                            <h3 style="font-size:42px;font-weight:900;color:#2c2416;margin:0;text-align:center;letter-spacing:1px">${cert.userName}</h3>
                            <div style="width:200px;height:3px;background:linear-gradient(90deg,transparent,#d4af37,transparent);margin:15px auto 0"></div>
                        </div>

                        <!-- Grade and Percentage ONLY -->
                        <div style="display:flex;justify-content:center;gap:20px;margin:20px 0;position:relative;z-index:10">
                            <div style="flex:1;max-width:250px;background:linear-gradient(135deg,#d4af37,#f4e4c1);padding:25px 20px;border-radius:16px;text-align:center;box-shadow:0 10px 30px rgba(212,175,55,0.4)">
                                <p style="font-size:12px;color:#2c2416;margin:0 0 10px;font-weight:900;letter-spacing:1px">النسبة المئوية</p>
                                <p style="font-size:42px;font-weight:900;color:#2c2416;margin:0">${cert.percentage}%</p>
                                <div style="width:80px;height:2px;background:#2c2416;margin:12px auto 8px"></div>
                                <p style="font-size:13px;color:#2c2416;margin:0;font-weight:800">التقدير: ${cert.grade}</p>
                            </div>
                        </div>

                        <!-- Footer Section -->
                        <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-top:auto;padding-top:25px;border-top:3px solid rgba(212,175,55,0.3);position:relative;z-index:10">
                            <div style="text-align:left;flex:1">
                                <p style="font-size:12px;color:#8b7355;margin:0 0 12px;font-weight:700;letter-spacing:1.5px">مسؤول المنصة</p>
                                <p style="font-size:34px;font-weight:400;background:linear-gradient(135deg,#d4af37,#b8941f);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin:0;font-family:'Brush Script MT','Segoe Script',cursive;letter-spacing:2px">𝑨𝒎𝒓 𝑳𝒐𝒕𝒇𝒚</p>
                                <div style="width:120px;height:3px;background:linear-gradient(90deg,#d4af37,transparent);margin-top:10px"></div>
                            </div>
                            <div style="text-align:right;flex:1;display:flex;flex-direction:column;align-items:flex-end;gap:10px">
                                <div>
                                    <p style="font-size:12px;color:#8b7355;margin:0 0 10px;font-weight:700;letter-spacing:1.5px">رقم الشهادة</p>
                                    <p style="font-size:14px;font-weight:900;color:#d4af37;margin:0;font-family:'Courier New',monospace;letter-spacing:1.5px;direction:ltr;text-align:right">${certNumber}</p>
                                    <p style="font-size:12px;color:#6b5a4a;margin:8px 0 0;font-weight:600;direction:rtl">${date}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Official Seal -->
                        <div style="position:absolute;bottom:40px;left:50%;transform:translateX(-50%);width:95px;height:95px;border-radius:50%;background:linear-gradient(135deg,#d4af37,#f4e4c1);display:flex;align-items:center;justify-content:center;box-shadow:0 12px 30px rgba(212,175,55,0.6);z-index:11">
                            <div style="position:absolute;inset:6px;background:#fdfbf7;border-radius:50%"></div>
                            <i class="ph-seal-check" style="font-size:55px;background:linear-gradient(135deg,#d4af37,#b8941f);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;position:relative;z-index:1"></i>
                        </div>
                    </div>`;
            }
        };

        window.viewCertificate = (cert) => {
            const date = new Date(cert.createdAt?.seconds * 1000 || Date.now()).toLocaleDateString('ar-EG');

            // Detect gender automatically
            const studentGender = detectGender(cert.userName);

            // Generate unique certificate number
            const year = new Date().getFullYear();
            const certNumber = cert.certificateNumber || `MORA-${year}-${Date.now().toString(36).toUpperCase()}${Math.random().toString(36).substr(2, 4).toUpperCase()}`;

            // Store certificate number if not exists
            if (!cert.certificateNumber) {
                cert.certificateNumber = certNumber;
                if (navigator.onLine && cert.id) {
                    try {
                        updateDoc(doc(db, "student_certificates", cert.id), { certificateNumber: certNumber });
                    } catch (e) { console.log('Certificate number update pending'); }
                }
            }

            // Generate QR Code
            const qrCodeDataURL = generateQRCodeDataURL(certNumber);

            // Motivational message based on grade
            let motivationalMsg = "مع تمنياتنا بدوام التوفيق والنجاح";
            if (cert.percentage >= 95) motivationalMsg = "إنجاز استثنائي يستحق كل التقدير";
            else if (cert.percentage >= 90) motivationalMsg = "أداء متميز يعكس الجد والاجتهاد";
            else if (cert.percentage >= 80) motivationalMsg = "مستوى رائع، استمر في التفوق";
            else if (cert.percentage >= 70) motivationalMsg = "نتيجة جيدة، واصل المسيرة";
            else if (cert.percentage >= 60) motivationalMsg = "بداية موفقة نحو النجاح";

            let certHTML = '';

            // ============ LECTURE EXAM CERTIFICATE ============
            if (cert.examType === 'lecture') {
                const lectureText = `المحاضرة ${getArabicOrdinal(cert.lectureNumber || 1)}`;

                certHTML = `
                    <div id="full-cert-node-${cert.id}" style="width:600px;min-height:850px;background:linear-gradient(135deg,#1a2332 0%,#0f1419 50%,#1a2332 100%);position:relative;overflow:hidden;font-family:'Cairo',sans-serif;box-shadow:0 30px 60px rgba(0,0,0,0.5);border-radius:20px;padding:50px 45px 65px;display:flex;flex-direction:column;gap:22px">
                        <!-- Background Pattern -->
                        <div style="position:absolute;top:0;left:0;right:0;bottom:0;opacity:0.04;background-image:radial-gradient(circle at 20% 50%,#d4af37 1px,transparent 1px),radial-gradient(circle at 80% 50%,#d4af37 1px,transparent 1px);background-size:50px 50px;pointer-events:none"></div>
                        
                        <!-- Golden Border Frame -->
                        <div style="position:absolute;inset:20px;border:3px solid;border-image:linear-gradient(135deg,#d4af37,#f4e4c1,#d4af37) 1;pointer-events:none;border-radius:16px"></div>
                        <div style="position:absolute;inset:28px;border:1.5px solid rgba(212,175,55,0.3);pointer-events:none;border-radius:14px"></div>
                        
                        <!-- Corner Decorations -->
                        <div style="position:absolute;top:15px;right:15px;width:70px;height:70px;border-top:4px solid #d4af37;border-right:4px solid #d4af37;border-radius:0 14px 0 0"></div>
                        <div style="position:absolute;top:15px;left:15px;width:70px;height:70px;border-top:4px solid #d4af37;border-left:4px solid #d4af37;border-radius:14px 0 0 0"></div>
                        <div style="position:absolute;bottom:15px;right:15px;width:70px;height:70px;border-bottom:4px solid #d4af37;border-right:4px solid #d4af37;border-radius:0 0 14px 0"></div>
                        <div style="position:absolute;bottom:15px;left:15px;width:70px;height:70px;border-bottom:4px solid #d4af37;border-left:4px solid #d4af37;border-radius:0 0 0 14px"></div>
                        
                        <!-- Logo Section -->
                        <div style="text-align:center;position:relative;z-index:10;margin-top:8px">
                            <div style="width:100px;height:100px;margin:0 auto 15px;border-radius:50%;background:linear-gradient(135deg,#d4af37,#f4e4c1);padding:4px;box-shadow:0 12px 30px rgba(212,175,55,0.5)">
                                <div style="width:100%;height:100%;border-radius:50%;background:#1a2332;display:flex;align-items:center;justify-content:center;overflow:hidden">
                                    <img src="https://i.postimg.cc/mgdFZ313/IMG-20250414-WA0047-1.jpg" style="width:70%;height:70%;object-fit:cover;border-radius:50%;opacity:0.95" alt="Logo">
                                </div>
                            </div>
                            <h1 style="font-size:28px;font-weight:900;margin:0;background:linear-gradient(135deg,#d4af37,#f4e4c1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:1px">Mora For Studying</h1>
                            <div style="width:120px;height:3px;background:linear-gradient(90deg,transparent,#d4af37,transparent);margin:12px auto"></div>
                        </div>

                        <!-- Certificate Title -->
                        <div style="text-align:center;position:relative;z-index:10">
                            <h2 style="font-size:48px;font-weight:900;color:#d4af37;margin:0;letter-spacing:2px;text-shadow:0 4px 8px rgba(212,175,55,0.4)">CERTIFICATE</h2>
                            <p style="font-size:20px;color:#f4e4c1;margin:8px 0 0;font-weight:600;letter-spacing:3px">Of ACHIEVEMENT</p>
                            <div style="width:160px;height:4px;background:linear-gradient(90deg,transparent,#d4af37,transparent);margin:15px auto"></div>
                        </div>

                        <!-- Main Text -->
                        <div style="text-align:center;position:relative;z-index:10;margin:10px 0">
                            <p style="font-size:16px;color:#cbd5e1;margin:0;font-weight:600;line-height:2">تشهد منصة <span style="color:#d4af37;font-weight:800">Mora For Studying</span></p>
                            <p style="font-size:16px;color:#cbd5e1;margin:6px 0 0;font-weight:600;line-height:2">بأن الطالب المذكور اسمه أدناه قد أتم اجتياز الاختبار بنجاح،</p>
                            <p style="font-size:16px;color:#cbd5e1;margin:6px 0 0;font-weight:600;line-height:2">وذلك وفقًا للمعايير التعليمية المعتمدة بالمنصة.</p>
                        </div>

                        <!-- Student Name Box -->
                        <div style="margin:18px 0;padding:32px 40px;background:linear-gradient(135deg,rgba(212,175,55,0.15),rgba(244,228,193,0.1));border:3px solid #d4af37;border-radius:20px;position:relative;z-index:10;box-shadow:0 8px 25px rgba(212,175,55,0.25)">
                            <h3 style="font-size:42px;font-weight:900;color:#f4e4c1;margin:0;text-align:center;letter-spacing:1px;text-shadow:0 2px 4px rgba(0,0,0,0.5)">${cert.userName}</h3>
                            <div style="width:200px;height:3px;background:linear-gradient(90deg,transparent,#d4af37,transparent);margin:15px auto 0"></div>
                        </div>

                        <!-- Grade and Percentage ONLY -->
                        <div style="display:flex;justify-content:center;gap:20px;margin:20px 0;position:relative;z-index:10">
                            <div style="flex:1;max-width:250px;background:linear-gradient(135deg,#d4af37,#f4e4c1);padding:25px 20px;border-radius:16px;text-align:center;box-shadow:0 10px 30px rgba(212,175,55,0.4)">
                                <p style="font-size:12px;color:#1a2332;margin:0 0 10px;font-weight:900;letter-spacing:1px">النسبة المئوية</p>
                                <p style="font-size:42px;font-weight:900;color:#1a2332;margin:0">${cert.percentage}%</p>
                                <div style="width:80px;height:2px;background:#1a2332;margin:12px auto 8px"></div>
                                <p style="font-size:13px;color:#1a2332;margin:0;font-weight:800">التقدير: ${cert.grade}</p>
                            </div>
                        </div>

                        <!-- Footer Section -->
                        <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-top:auto;padding-top:25px;border-top:3px solid rgba(212,175,55,0.3);position:relative;z-index:10">
                            <div style="text-align:left;flex:1">
                                <p style="font-size:12px;color:#94a3b8;margin:0 0 12px;font-weight:700;letter-spacing:1.5px">مسؤول المنصة</p>
                                <p style="font-size:34px;font-weight:400;background:linear-gradient(135deg,#d4af37,#f4e4c1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin:0;font-family:'Brush Script MT','Segoe Script',cursive;letter-spacing:2px">𝑨𝒎𝒓 𝑳𝒐𝒕𝒇𝒚</p>
                                <div style="width:120px;height:3px;background:linear-gradient(90deg,#d4af37,transparent);margin-top:10px"></div>
                            </div>
                            <div style="text-align:right;flex:1;display:flex;flex-direction:column;align-items:flex-end;gap:10px">
                                <div>
                                    <p style="font-size:12px;color:#94a3b8;margin:0 0 10px;font-weight:700;letter-spacing:1.5px">رقم الشهادة</p>
                                    <p style="font-size:14px;font-weight:900;color:#d4af37;margin:0;font-family:'Courier New',monospace;letter-spacing:1.5px;direction:ltr;text-align:right">${certNumber}</p>
                                    <p style="font-size:12px;color:#94a3b8;margin:8px 0 0;font-weight:600;direction:rtl">${date}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Official Seal -->
                        <div style="position:absolute;bottom:40px;left:50%;transform:translateX(-50%);width:95px;height:95px;border-radius:50%;background:linear-gradient(135deg,#d4af37,#f4e4c1);display:flex;align-items:center;justify-content:center;box-shadow:0 12px 30px rgba(212,175,55,0.6);z-index:11">
                            <div style="position:absolute;inset:6px;background:#1a2332;border-radius:50%"></div>
                            <i class="ph-seal-check" style="font-size:55px;background:linear-gradient(135deg,#d4af37,#f4e4c1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;position:relative;z-index:1"></i>
                        </div>
                    </div>`;
            } else {
                // ============ WEEKLY EXAM CERTIFICATE ============
                certHTML = `
                    <div id="full-cert-node-${cert.id}" style="width:600px;min-height:850px;background:linear-gradient(135deg,#fdfbf7 0%,#f8f6f1 50%,#f0ebe5 100%);position:relative;overflow:hidden;font-family:'Cairo',sans-serif;box-shadow:0 30px 60px rgba(0,0,0,0.3);border-radius:20px;padding:50px 45px 65px;display:flex;flex-direction:column;gap:22px">
                        <!-- Background Pattern -->
                        <div style="position:absolute;top:0;left:0;right:0;bottom:0;opacity:0.04;background-image:radial-gradient(circle at 25px 25px,#d4af37 2%,transparent 0%),radial-gradient(circle at 75px 75px,#d4af37 2%,transparent 0%);background-size:100px 100px;pointer-events:none"></div>
                        
                        <!-- Red Diagonal Ribbon -->
                        <div style="position:absolute;top:60px;left:-80px;width:350px;height:120px;background:linear-gradient(135deg,#c41e3a 0%,#8b0000 100%);transform:rotate(-45deg);box-shadow:0 8px 20px rgba(196,30,58,0.4);z-index:5">
                            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:100%;text-align:center">
                                <div style="display:flex;align-items:center;justify-content:center;gap:15px">
                                    <div style="width:70px;height:70px;border-radius:50%;background:linear-gradient(135deg,#d4af37,#f4e4c1);padding:3px;box-shadow:0 6px 15px rgba(212,175,55,0.5)">
                                        <div style="width:100%;height:100%;border-radius:50%;background:#c41e3a;display:flex;align-items:center;justify-content:center">
                                            <i class="ph-medal" style="font-size:35px;color:#d4af37"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Golden Border Frame -->
                        <div style="position:absolute;inset:20px;border:3px solid;border-image:linear-gradient(135deg,#d4af37,#f4e4c1,#d4af37) 1;pointer-events:none;border-radius:16px"></div>
                        <div style="position:absolute;inset:28px;border:1.5px solid rgba(212,175,55,0.3);pointer-events:none;border-radius:14px"></div>
                        
                        <!-- Corner Decorations -->
                        <div style="position:absolute;top:15px;right:15px;width:70px;height:70px;border-top:4px solid #d4af37;border-right:4px solid #d4af37;border-radius:0 14px 0 0"></div>
                        <div style="position:absolute;bottom:15px;left:15px;width:70px;height:70px;border-bottom:4px solid #d4af37;border-left:4px solid #d4af37;border-radius:0 0 0 14px"></div>
                        
                        <!-- Logo Section -->
                        <div style="text-align:center;position:relative;z-index:10;margin-top:8px">
                            <div style="width:100px;height:100px;margin:0 auto 15px;border-radius:50%;background:linear-gradient(135deg,#d4af37,#f4e4c1);padding:4px;box-shadow:0 12px 30px rgba(212,175,55,0.5)">
                                <div style="width:100%;height:100%;border-radius:50%;background:#fdfbf7;display:flex;align-items:center;justify-content:center;overflow:hidden">
                                    <img src="https://i.postimg.cc/mgdFZ313/IMG-20250414-WA0047-1.jpg" style="width:70%;height:70%;object-fit:cover;border-radius:50%;opacity:0.95" alt="Logo">
                                </div>
                            </div>
                            <h1 style="font-size:28px;font-weight:900;margin:0;background:linear-gradient(135deg,#d4af37,#b8941f);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:1px">Mora For Studying</h1>
                            <div style="width:120px;height:3px;background:linear-gradient(90deg,transparent,#d4af37,transparent);margin:12px auto"></div>
                        </div>

                        <!-- Certificate Title -->
                        <div style="text-align:center;position:relative;z-index:10">
                            <h2 style="font-size:48px;font-weight:900;color:#d4af37;margin:0;letter-spacing:2px;text-shadow:0 4px 8px rgba(212,175,55,0.3)">CERTIFICATE</h2>
                            <div style="width:160px;height:4px;background:linear-gradient(90deg,transparent,#d4af37,transparent);margin:15px auto"></div>
                        </div>

                        <!-- Main Text -->
                        <div style="text-align:center;position:relative;z-index:10;margin:10px 0">
                            <p style="font-size:16px;color:#5a4a3a;margin:0;font-weight:600;line-height:2">تشهد منصة <span style="color:#d4af37;font-weight:800">Mora For Studying</span></p>
                            <p style="font-size:16px;color:#5a4a3a;margin:6px 0 0;font-weight:600;line-height:2">بأن الطالب المذكور اسمه أدناه قد أتم اجتياز الاختبار بنجاح،</p>
                            <p style="font-size:16px;color:#5a4a3a;margin:6px 0 0;font-weight:600;line-height:2">وذلك وفقًا للمعايير التعليمية المعتمدة بالمنصة.</p>
                        </div>

                        <!-- Student Name Box -->
                        <div style="margin:18px 0;padding:32px 40px;background:linear-gradient(135deg,rgba(212,175,55,0.12),rgba(244,228,193,0.18));border:3px solid #d4af37;border-radius:20px;position:relative;z-index:10;box-shadow:0 8px 25px rgba(212,175,55,0.25)">
                            <h3 style="font-size:42px;font-weight:900;color:#2c2416;margin:0;text-align:center;letter-spacing:1px">${cert.userName}</h3>
                            <div style="width:200px;height:3px;background:linear-gradient(90deg,transparent,#d4af37,transparent);margin:15px auto 0"></div>
                        </div>

                        <!-- Grade and Percentage ONLY -->
                        <div style="display:flex;justify-content:center;gap:20px;margin:20px 0;position:relative;z-index:10">
                            <div style="flex:1;max-width:250px;background:linear-gradient(135deg,#d4af37,#f4e4c1);padding:25px 20px;border-radius:16px;text-align:center;box-shadow:0 10px 30px rgba(212,175,55,0.4)">
                                <p style="font-size:12px;color:#2c2416;margin:0 0 10px;font-weight:900;letter-spacing:1px">النسبة المئوية</p>
                                <p style="font-size:42px;font-weight:900;color:#2c2416;margin:0">${cert.percentage}%</p>
                                <div style="width:80px;height:2px;background:#2c2416;margin:12px auto 8px"></div>
                                <p style="font-size:13px;color:#2c2416;margin:0;font-weight:800">التقدير: ${cert.grade}</p>
                            </div>
                        </div>

                        <!-- Footer Section -->
                        <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-top:auto;padding-top:25px;border-top:3px solid rgba(212,175,55,0.3);position:relative;z-index:10">
                            <div style="text-align:left;flex:1">
                                <p style="font-size:12px;color:#8b7355;margin:0 0 12px;font-weight:700;letter-spacing:1.5px">مسؤول المنصة</p>
                                <p style="font-size:34px;font-weight:400;background:linear-gradient(135deg,#d4af37,#b8941f);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin:0;font-family:'Brush Script MT','Segoe Script',cursive;letter-spacing:2px">𝑨𝒎𝒓 𝑳𝒐𝒕𝒇𝒚</p>
                                <div style="width:120px;height:3px;background:linear-gradient(90deg,#d4af37,transparent);margin-top:10px"></div>
                            </div>
                            <div style="text-align:right;flex:1;display:flex;flex-direction:column;align-items:flex-end;gap:10px">
                                <div>
                                    <p style="font-size:12px;color:#8b7355;margin:0 0 10px;font-weight:700;letter-spacing:1.5px">رقم الشهادة</p>
                                    <p style="font-size:14px;font-weight:900;color:#d4af37;margin:0;font-family:'Courier New',monospace;letter-spacing:1.5px;direction:ltr;text-align:right">${certNumber}</p>
                                    <p style="font-size:12px;color:#6b5a4a;margin:8px 0 0;font-weight:600;direction:rtl">${date}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Official Seal -->
                        <div style="position:absolute;bottom:40px;left:50%;transform:translateX(-50%);width:95px;height:95px;border-radius:50%;background:linear-gradient(135deg,#d4af37,#f4e4c1);display:flex;align-items:center;justify-content:center;box-shadow:0 12px 30px rgba(212,175,55,0.6);z-index:11">
                            <div style="position:absolute;inset:6px;background:#fdfbf7;border-radius:50%"></div>
                            <i class="ph-seal-check" style="font-size:55px;background:linear-gradient(135deg,#d4af37,#b8941f);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;position:relative;z-index:1"></i>
                        </div>
                    </div>`;
            }

            return certHTML;
        };

        window.viewCertificate = (cert) => {
            const certHTML = getCertificateHTML(cert);
            const previewModal = document.getElementById('certificate-preview-overlay');
            const previewContent = document.getElementById('cert-preview-content');

            if (!previewModal || !previewContent) {
                console.error('Certificate modal elements not found');
                showToast('خطأ في عرض الشهادة', true);
                return;
            }

            // Using flexbox centering with specific scaling wrapper
            previewContent.innerHTML = `
                <div style="position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:0;z-index:50;width:100%;height:100%;pointer-events:none;">
                    
                    <!-- Scrolling/Scaling Container -->
                    <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;pointer-events:auto;">
                        
                        <!-- The Scaled Wrapper -->
                        <div id="cert-wrapper-${cert.id}" style="width:600px;height:850px;display:flex;align-items:center;justify-content:center;transform-origin:center;transition:transform 0.1s ease-out;flex-shrink:0;">
                            ${certHTML}
                        </div>
                        
                    </div>
                    
                    <!-- Floating Buttons -->
                    <div style="position:absolute;bottom:30px;left:0;right:0;display:flex;justify-content:center;gap:15px;z-index:100;pointer-events:auto;padding:0 20px;">
                        <button onclick="downloadCertificate('${cert.id}')" class="bg-gradient-to-r from-[#d4af37] to-[#f4e4c1] text-[#2c2416] px-6 py-3 rounded-full font-bold shadow-[0_8px_20px_rgba(0,0,0,0.3)] hover:scale-105 active:scale-95 transition-all flex items-center gap-2 border border-[#d4af37]/50 backdrop-blur-md">
                            <i class="ph-download-simple text-xl"></i>
                            <span>تحميل</span>
                        </button>
                        <button onclick="closeCertPreview()" class="bg-black/60 text-white px-6 py-3 rounded-full font-bold shadow-[0_8px_20px_rgba(0,0,0,0.3)] hover:bg-black/80 active:scale-95 transition-all backdrop-blur-md border border-white/10">
                            إغلاق
                        </button>
                    </div>
                </div>
            `;

            previewModal.classList.add('active');
            previewModal.style.display = 'flex';

            // Dynamic Scaling Logic for 100% Mobile Full Screen
            const updateScale = () => {
                const wrapper = document.getElementById(`cert-wrapper-${cert.id}`);
                if (!wrapper) return;

                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;

                // Original dims
                const certWidth = 600;
                const certHeight = 850;

                // Calculate safe area
                // Mobile: almost full width/height
                // Desktop: add some padding
                const isMobile = viewportWidth < 768;

                // Horizontal padding
                const hPadding = isMobile ? 10 : 60; // 5px each side on mobile

                // Vertical padding (needs space for buttons at bottom)
                // Buttons are approx 60px high + 30px bottom = 90px reserved
                const vPadding = isMobile ? 100 : 120;

                const availableWidth = viewportWidth - hPadding;
                const availableHeight = viewportHeight - vPadding;

                // Determine limiting dimension
                const scaleX = availableWidth / certWidth;
                const scaleY = availableHeight / certHeight;

                // Fit optimally
                let scale = Math.min(scaleX, scaleY);

                // Prevent over-scaling on huge screens, but allow full shrinkage
                if (scale > 1.2) scale = 1.2;

                wrapper.style.transform = `scale(${scale})`;
            };

            // Run scaling immediately and on resize
            // Using requestAnimationFrame ensures layout is ready
            requestAnimationFrame(() => {
                updateScale();
                // Double check after a slight delay for mobile browsers address bar movement
                setTimeout(updateScale, 100);
            });

            window.addEventListener('resize', updateScale);

            // Cleanup on close
            const cleanup = () => {
                window.removeEventListener('resize', updateScale);
            };

            // Override global cleanup
            const originalClose = window.closeCertPreview;
            window.closeCertPreview = () => {
                if (originalClose) originalClose();
                cleanup();
                const modal = document.getElementById('certificate-preview-overlay');
                if (modal) {
                    modal.classList.remove('active');
                    modal.style.display = 'none';
                    // Clear content to free memory
                    setTimeout(() => { if (!modal.classList.contains('active')) document.getElementById('cert-preview-content').innerHTML = ''; }, 300);
                }
            };

            // Background click close
            previewModal.onclick = (e) => {
                if (e.target === previewModal) {
                    window.closeCertPreview();
                }
            };
        };

        // ======================= CERTIFICATE ACTIONS =======================
        // helper to get cert data
        const getCertData = async (id) => {
            // Try cache/local storage first
            const localKey = `user_certificates_${currentUser.id} `;
            const localCerts = JSON.parse(localStorage.getItem(localKey) || '[]');
            const found = localCerts.find(c => c.id === id);
            if (found) return found;

            // Try firebase - check both collections
            try {
                if (navigator.onLine) {
                    // Try student_certificates first (new system)
                    let docSnap = await getDoc(doc(db, "student_certificates", id));
                    if (docSnap.exists()) return { id: docSnap.id, ...docSnap.data() };

                    // Try certificates (old system)
                    docSnap = await getDoc(doc(db, "certificates", id));
                    if (docSnap.exists()) return { id: docSnap.id, ...docSnap.data() };
                }
            } catch (e) { console.error(e); }
            return null;
        };

        window.previewCertificate = async (id) => {
            try {
                // Validate certificate ID
                if (!id) {
                    console.error('Preview error: No certificate ID provided');
                    showToast('خطأ: معرف الشهادة غير موجود', true);
                    return;
                }

                // Get certificate data
                const cert = await getCertData(id);
                if (!cert) {
                    console.error('Preview error: Certificate data not found for ID:', id);
                    showToast('لم يتم العثور على بيانات الشهادة', true);
                    return;
                }

                // Validate required certificate fields
                if (!cert.userName || !cert.percentage || !cert.grade) {
                    console.error('Preview error: Missing required certificate fields:', cert);
                    showToast('بيانات الشهادة غير مكتملة', true);
                    return;
                }

                showToast('جاري تحضير الشهادة...');

                // Verify html2canvas is loaded
                if (typeof html2canvas === 'undefined') {
                    console.error('Preview error: html2canvas library not loaded');
                    showToast('خطأ: مكتبة التحويل غير محملة', true);
                    return;
                }

                // Create off-screen container
                const container = document.createElement('div');
                container.style.cssText = 'position:fixed;left:-9999px;top:0;width:600px;height:850px;z-index:-9999;visibility:visible;background:#ffffff;';
                document.body.appendChild(container);

                try {
                    // Generate certificate HTML
                    const certHTML = getCertificateHTML(cert);
                    if (!certHTML || certHTML.trim() === '') {
                        throw new Error('Certificate HTML generation failed');
                    }
                    container.innerHTML = certHTML;

                    // Verify certificate element exists
                    const certElement = container.firstElementChild;
                    if (!certElement) {
                        throw new Error('Certificate element not found in container');
                    }

                    // Wait for all images to load
                    const images = Array.from(container.querySelectorAll('img'));
                    if (images.length > 0) {
                        await Promise.all(images.map(img => {
                            if (img.complete) return Promise.resolve();
                            return new Promise((resolve) => {
                                img.onload = () => resolve();
                                img.onerror = () => resolve(); // Continue even if image fails
                                setTimeout(() => resolve(), 3000); // Timeout after 3s
                            });
                        }));
                    }

                    // Wait for fonts and rendering
                    await new Promise(r => setTimeout(r, 800));

                    // SAFETY PATCH: Intercept addColorStop to prevent "non-finite value" errors
                    const originalAddColorStop = CanvasGradient.prototype.addColorStop;
                    CanvasGradient.prototype.addColorStop = function (offset, color) {
                        try {
                            if (!isFinite(offset)) {
                                // console.warn('Fixed non-finite gradient offset:', offset);
                                offset = 0; // Fallback to 0 to prevent crash
                            }
                            originalAddColorStop.call(this, offset, color);
                        } catch (e) {
                            // console.warn('Suppressed addColorStop error:', e);
                        }
                    };

                    let canvas;
                    try {
                        // Generate PNG using html2canvas
                        canvas = await html2canvas(certElement, {
                            scale: 2,
                            useCORS: true,
                            allowTaint: false,
                            backgroundColor: '#ffffff',
                            logging: false,
                            width: 600,
                            height: 850,
                            windowWidth: 600,
                            windowHeight: 850,
                            onclone: (doc) => {
                                // Ensure strict dimensions on cloned element
                                const el = doc.getElementById(`cert-node-${cert.id}`) || doc.getElementById(`full-cert-node-${cert.id}`);
                                if (el) {
                                    el.style.width = '600px';
                                    el.style.height = '850px';
                                }
                            }
                        });
                    } finally {
                        // RESTORE: Always restore the original function
                        CanvasGradient.prototype.addColorStop = originalAddColorStop;
                    }

                    // Validate canvas
                    if (!canvas || canvas.width === 0 || canvas.height === 0) {
                        throw new Error('Canvas generation failed or has zero dimensions');
                    }

                    // Convert to PNG data URL
                    const imageDataURL = canvas.toDataURL('image/png', 1.0);

                    // Validate PNG data URL
                    if (!imageDataURL || !imageDataURL.startsWith('data:image/png;base64,')) {
                        throw new Error('Invalid PNG data URL generated');
                    }

                    // Get preview modal elements
                    const previewModal = document.getElementById('certificate-preview-overlay');
                    const previewContent = document.getElementById('cert-preview-content');

                    if (!previewModal || !previewContent) {
                        throw new Error('Preview modal elements not found in DOM');
                    }

                    // Store image data globally for download
                    window.currentCertificateImage = imageDataURL;
                    window.currentCertificateId = id;
                    window.currentCertificateName = cert.userName || 'Student';

                    // Display PNG image in modal
                    previewContent.innerHTML = `
                        <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;">
                            <img src="${imageDataURL}" 
                                 style="max-width:100%;max-height:calc(100vh - 150px);width:auto;height:auto;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.5);" 
                                 alt="Certificate Preview" 
                                 onerror="console.error('Failed to display certificate image');" />
                            
                            <div style="position:fixed;bottom:30px;left:0;right:0;display:flex;justify-content:center;gap:15px;z-index:100;padding:0 20px;">
                                <button onclick="downloadCurrentCertificate()" class="bg-gradient-to-r from-[#d4af37] to-[#f4e4c1] text-[#2c2416] px-6 py-3 rounded-full font-bold shadow-[0_8px_20px_rgba(0,0,0,0.3)] hover:scale-105 active:scale-95 transition-all flex items-center gap-2 border border-[#d4af37]/50 backdrop-blur-md">
                                    <i class="ph-download-simple text-xl"></i>
                                    <span>تحميل الشهادة</span>
                                </button>
                                <button onclick="closeCertPreview()" class="bg-black/60 text-white px-6 py-3 rounded-full font-bold shadow-[0_8px_20px_rgba(0,0,0,0.3)] hover:bg-black/80 active:scale-95 transition-all backdrop-blur-md border border-white/10">
                                    إغلاق
                                </button>
                            </div>
                        </div>
                    `;

                    // Show modal
                    previewModal.classList.add('active');
                    previewModal.style.display = 'flex';

                    console.log('Certificate preview successful. Image size:', imageDataURL.length, 'bytes');
                    showToast('تم عرض الشهادة بنجاح ✅');

                } finally {
                    // Always cleanup container
                    if (container && container.parentNode) {
                        container.parentNode.removeChild(container);
                    }
                }

            } catch (err) {
                console.error('Certificate preview failed:', err);
                console.error('Error stack:', err.stack);
                showToast(`فشل عرض الشهادة: ${err.message}`, true);
            }
        };

        window.closeCertPreview = () => {
            // Immediate close, no waiting for Firebase or any async operations
            const modal = document.getElementById('certificate-preview-overlay');
            if (modal) {
                modal.classList.remove('active');
                modal.style.display = 'none';
            }
        };

        window.downloadCertificate = async (id) => {
            const btn = document.querySelector(`button[data-cert-id="${id}"].btn-download`) ||
                document.querySelector(`button[onclick="downloadCertificate('${id}')"]`);

            const originalContent = btn ? btn.innerHTML : '';
            if (btn) {
                btn.innerHTML = '<i class="ph-spinner animate-spin"></i>';
                btn.disabled = true;
            }

            try {
                // Validate certificate ID
                if (!id) {
                    throw new Error('No certificate ID provided');
                }

                showToast('جاري تحضير الشهادة للتحميل...');

                // Get certificate data
                const cert = await getCertData(id);
                if (!cert) {
                    throw new Error('Certificate data not found');
                }

                // Validate required fields
                if (!cert.userName || !cert.percentage || !cert.grade) {
                    throw new Error('Missing required certificate fields');
                }

                // Verify html2canvas is loaded
                if (typeof html2canvas === 'undefined') {
                    throw new Error('html2canvas library not loaded');
                }

                // Create off-screen container
                const container = document.createElement('div');
                container.style.cssText = 'position:fixed;left:-9999px;top:0;width:600px;height:850px;z-index:-9999;visibility:visible;background:#ffffff;';
                document.body.appendChild(container);

                try {
                    // Generate certificate HTML
                    const certHTML = getCertificateHTML(cert);
                    if (!certHTML || certHTML.trim() === '') {
                        throw new Error('Certificate HTML generation failed');
                    }
                    container.innerHTML = certHTML;

                    // Verify certificate element
                    const certElement = container.firstElementChild;
                    if (!certElement) {
                        throw new Error('Certificate element not found');
                    }

                    // Wait for images to load
                    const images = Array.from(container.querySelectorAll('img'));
                    if (images.length > 0) {
                        await Promise.all(images.map(img => {
                            if (img.complete) return Promise.resolve();
                            return new Promise((resolve) => {
                                img.onload = () => resolve();
                                img.onerror = () => resolve();
                                setTimeout(() => resolve(), 3000);
                            });
                        }));
                    }

                    // Wait for fonts and rendering
                    await new Promise(r => setTimeout(r, 800));

                    // SAFETY PATCH: Intercept addColorStop to prevent "non-finite value" errors
                    const originalAddColorStop = CanvasGradient.prototype.addColorStop;
                    CanvasGradient.prototype.addColorStop = function (offset, color) {
                        try {
                            if (!isFinite(offset)) {
                                offset = 0; // Fallback
                            }
                            originalAddColorStop.call(this, offset, color);
                        } catch (e) {
                            // Suppress error
                        }
                    };

                    let canvas;
                    try {
                        // Generate high-resolution PNG (3x for print quality)
                        canvas = await html2canvas(certElement, {
                            scale: 3,
                            useCORS: true,
                            allowTaint: false,
                            backgroundColor: '#ffffff',
                            logging: false,
                            width: 600,
                            height: 850,
                            windowWidth: 600,
                            windowHeight: 850,
                            onclone: (doc) => {
                                const el = doc.getElementById(`cert-node-${cert.id}`) || doc.getElementById(`full-cert-node-${cert.id}`);
                                if (el) {
                                    el.style.width = '600px';
                                    el.style.height = '850px';
                                }
                            }
                        });
                    } finally {
                        // RESTORE
                        CanvasGradient.prototype.addColorStop = originalAddColorStop;
                    }

                    // Validate canvas
                    if (!canvas || canvas.width === 0 || canvas.height === 0) {
                        throw new Error('Canvas generation failed');
                    }

                    const fileName = `Certificate_${(cert.userName || 'Student').replace(/\s+/g, '_')}_${Date.now()}.png`;

                    // Try blob download first (better for large files)
                    let downloadSuccess = false;
                    try {
                        await new Promise((resolve, reject) => {
                            canvas.toBlob((blob) => {
                                if (!blob) {
                                    reject(new Error('Blob creation failed'));
                                    return;
                                }

                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.style.display = 'none';
                                a.href = url;
                                a.download = fileName;
                                document.body.appendChild(a);
                                a.click();

                                setTimeout(() => {
                                    document.body.removeChild(a);
                                    URL.revokeObjectURL(url);
                                    resolve();
                                }, 1000);
                            }, 'image/png', 1.0);
                        });
                        downloadSuccess = true;
                    } catch (blobErr) {
                        console.warn('Blob download failed, trying data URL fallback:', blobErr);
                    }

                    // Fallback to data URL if blob failed
                    if (!downloadSuccess) {
                        const dataUrl = canvas.toDataURL('image/png', 1.0);
                        if (!dataUrl || !dataUrl.startsWith('data:image/png;base64,')) {
                            throw new Error('Invalid PNG data URL');
                        }

                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = dataUrl;
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        setTimeout(() => document.body.removeChild(a), 1000);
                    }

                    console.log('Certificate download successful:', fileName);
                    showToast('تم تحميل الشهادة بنجاح ✅');

                } finally {
                    // Cleanup container
                    if (container && container.parentNode) {
                        container.parentNode.removeChild(container);
                    }
                }

            } catch (err) {
                console.error('Certificate download failed:', err);
                console.error('Error stack:', err.stack);
                showToast(`فشل تحميل الشهادة: ${err.message}`, true);
            } finally {
                // Restore button state
                if (btn) {
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                }
            }
        };

        // Helper function to download from preview
        window.downloadCurrentCertificate = () => {
            if (!window.currentCertificateImage) {
                showToast('لا توجد شهادة للتحميل', true);
                return;
            }

            const fileName = `Certificate_${window.currentCertificateName.replace(/\s+/g, '_')}_${window.currentCertificateId}.png`;
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = window.currentCertificateImage;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => document.body.removeChild(a), 1000);
            showToast('تم التحميل بنجاح ✅');
        };

        window.deleteCertificate = async (id) => {
            if (!confirm('هل أنت متأكد تماماً من حذف هذه الشهادة؟ لا يمكن التراجع عن هذا الإجراء.')) return;

            // Remove from UI immediately (optimistic update)
            const certCard = document.querySelector(`[data-cert-id="${id}"]`)?.closest('.cert-card');
            if (certCard) certCard.remove();

            const localKey = `user_certificates_${currentUser.id}`;
            const deletedKey = `deleted_certificates_${currentUser.id}`;

            try {
                // 1. Delete from Local Storage
                const current = JSON.parse(localStorage.getItem(localKey) || '[]');
                const newCerts = current.filter(c => c.id !== id);
                localStorage.setItem(localKey, JSON.stringify(newCerts));

                // 2. Track deleted ID
                const deleted = JSON.parse(localStorage.getItem(deletedKey) || '[]');
                if (!deleted.includes(id)) {
                    deleted.push(id);
                    localStorage.setItem(deletedKey, JSON.stringify(deleted));
                }

                // 3. Delete from Firebase
                if (navigator.onLine) {
                    // Try both collections just in case
                    try { await deleteDoc(doc(db, "student_certificates", id)); } catch (e) { }
                    try { await deleteDoc(doc(db, "certificates", id)); } catch (e) { }
                    showToast('تم الحذف بنجاح ✅');
                } else {
                    showToast('تم الحذف محلياً (سيتم المزامنة عند الاتصال)');
                }

                // Refresh grid to be sure
                if (window.openMyCertificates) openMyCertificates();

            } catch (e) {
                console.error('Error deleting certificate:', e);
                showToast('حدث خطأ أثناء الحذف');
            }
        };


        // ✅ 2️⃣ Event Delegation for Certificate Actions (Global Listener)
        document.addEventListener("click", function (e) {
            // Find closest button if click is on icon inside
            const targetBtn = e.target.closest('button');
            if (!targetBtn) return;

            // Check for classes
            if (targetBtn.matches(".btn-preview")) {
                const id = targetBtn.dataset.certId;
                if (id) previewCertificate(id);
            } else if (targetBtn.matches(".btn-download")) {
                const id = targetBtn.dataset.certId;
                if (id) downloadCertificate(id);
            } else if (targetBtn.matches(".btn-delete")) {
                const id = targetBtn.dataset.certId;
                if (id) deleteCertificate(id);
            }
        });

        // ======================= INITIALIZATION =======================
        window.addEventListener('load', async () => {
            if (!navigator.onLine) {
                showToast('أنت في وضع عدم الاتصال. سيتم تحميل البيانات المحفوظة.', true);
            }
            window.addEventListener('online', () => showToast('تم استعادة الاتصال بالإنترنت!'));
            window.addEventListener('offline', () => showToast('انقطع الاتصال بالإنترنت.', true));

            await listenToSiteContent();
            const savedTheme = localStorage.getItem('moraTheme') || 'default';
            applyTheme(savedTheme);
            const savedUser = localStorage.getItem('moraUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showPage('splash-screen');
                window.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden') {
                        updateUserActivity("غادر الموقع");
                    } else {
                        updateUserActivity("عاد للموقع");
                    }
                });
                listenForUserBanOrDeletion();
            } else {
                showPage('auth-page');
                renderAuthForm();
                initVantaBackground();
            }
        });
        document.getElementById('splash-screen').addEventListener('animationend', () => {
            // Snappy transition
            if (currentUser.isAdmin) {
                initAdminDashboard();
            } else {
                initStudentDashboard();
            }
        });
        document.getElementById('admin-logout-btn').addEventListener('click', handleLogout);
        document.getElementById('exit-focus-mode-btn').addEventListener('click', () => { document.querySelector('.bottom-nav-btn[data-modal="settings-modal"]').click(); });
        document.getElementById('generic-modal').addEventListener('click', e => {
            if (e.target.classList.contains('modal')) {
                // Prevent auto-close if result is visible
                if (!window.lectureResultLock && !window.isResultModalVisible && modalCloseBtn.onclick) {
                    modalCloseBtn.onclick();
                }
            }
        });
        modalCloseBtn.addEventListener('click', () => {
            // Only close if explicitly clicked by user or result is not visible
            if (!window.lectureResultLock && modalCloseBtn.onclick) {
                modalCloseBtn.onclick();
            }
        });
        // [ANTIGRAVITY CLEANUP]
        // Restore navigation logic
        window.activateNavButtons = function () {
            const navButtons = document.querySelectorAll('.bottom-nav-btn');
            navButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Update active state
                    navButtons.forEach(b => {
                        b.classList.remove('active', 'text-amber-400');
                        b.style.color = '';
                    });
                    document.querySelectorAll('.bottom-nav-label').forEach(l => {
                        l.classList.remove('text-amber-400');
                        l.style.color = '';
                    });

                    btn.classList.add('active', 'text-amber-400');
                    if (btn.nextElementSibling && btn.nextElementSibling.classList.contains('bottom-nav-label')) {
                        btn.nextElementSibling.classList.add('text-amber-400');
                    }

                    const pageId = btn.dataset.page;
                    const modalId = btn.dataset.modal;

                    if (pageId) {
                        showPage(pageId);
                        window.scrollTo(0, 0);
                    }
                    if (modalId) {
                        const modal = document.getElementById(modalId);
                        if (modal) {
                            modal.classList.add('active');
                            modal.style.display = 'flex';
                        }
                    }
                });
            });
        };

        // Ensure activateNavButtons runs by monkey-patching initStudentDashboard if needed
        if (typeof initStudentDashboard === 'function') {
            const originalInit = initStudentDashboard;
            initStudentDashboard = async function () {
                await originalInit();
                if (window.activateNavButtons) window.activateNavButtons();
            };
        } else {
            // Fallback
            window.addEventListener('load', () => {
                if (window.activateNavButtons) window.activateNavButtons();
            });
        }


        // Disable certificate functions (Cleanup)
        window.openMyCertificates = async () => { console.log('Certificates disabled'); };
        window.createCertificateAfterExam = async () => { };
        window.viewCertificate = async () => { };
        window.downloadCertificate = async () => { };
        window.deleteCertificate = async () => { };

        // Remove legacy overlay from DOM
        const legacyOverlay = document.getElementById('certificate-preview-overlay');
        if (legacyOverlay) legacyOverlay.remove();

        // ==================== ONBOARDING TOUR SYSTEM ====================
        class OnboardingTourManager {
            constructor() {
                this.currentStep = 0;
                this.isActive = false;
                this.overlay = null;
                this.tooltip = null;
                this.currentHighlight = null;

                // Define all tour steps with selectors and descriptions
                this.tourSteps = [
                    {
                        selector: 'button[onclick*="sections"]',
                        title: 'سكاشن',
                        description: 'شاهد سكاشن المادة من هنا',
                        icon: 'ph-stack-simple'
                    },
                    {
                        selector: '#courses-btn',
                        title: 'كورسات',
                        description: 'كورسات تعليمية مجانية ومفيدة',
                        icon: 'ph-cube'
                    },
                    {
                        selector: 'button[data-modal="ai-tools-modal"]',
                        title: 'أدوات AI',
                        description: 'أدوات ذكاء اصطناعي لمساعدتك',
                        icon: 'ph-robot'
                    },
                    {
                        selector: 'button[data-modal="opinions-modal"]',
                        title: 'آراء',
                        description: 'شارك رأيك وتفاعل مع زملائك',
                        icon: 'ph-chats-teardrop'
                    },
                    {
                        selector: 'button[data-modal="polls-modal"]',
                        title: 'استطلاعات',
                        description: 'شارك في الاستطلاعات المهمة',
                        icon: 'ph-megaphone-simple'
                    },
                    {
                        selector: '#weekly-exams-nav-btn',
                        title: 'امتحان أسبوعي',
                        description: 'اختبر معلوماتك بامتحانات أسبوعية',
                        icon: 'ph-clipboard-text'
                    },
                    {
                        selector: '#digital-card-nav-btn',
                        title: 'بطاقتي',
                        description: 'بطاقتك الرقمية الخاصة',
                        icon: 'ph-identification-card'
                    },
                    {
                        selector: '#summary-nav-btn',
                        title: 'تلخيص',
                        description: 'احصل على ملخصات المواد',
                        icon: 'ph-notebook'
                    },
                    {
                        selector: 'button[onclick*="openShounSection"]',
                        title: 'الشئون',
                        description: 'تواصل مع الشئون الطلابية',
                        icon: 'ph-phone-call'
                    },
                    {
                        selector: '#privacy-policy-nav-btn',
                        title: 'الخصوصية',
                        description: 'اطلع على سياسة الخصوصية',
                        icon: 'ph-shield-check'
                    },
                    {
                        selector: 'button[data-modal="support-modal"]',
                        title: 'الدعم',
                        description: 'احصل على المساعدة والدعم الفني',
                        icon: 'ph-headset'
                    },
                    {
                        selector: 'button[data-modal="about-modal"]',
                        title: 'عنا',
                        description: 'تعرف على المنصة والفريق',
                        icon: 'ph-info'
                    },
                    {
                        selector: '#platform-btn',
                        title: 'المنصة',
                        description: 'معلومات عن المنصة التعليمية',
                        icon: 'ph-globe-hemisphere-west'
                    },
                    {
                        selector: '#study-timer-nav-btn',
                        title: 'تايمر',
                        description: 'نظم وقت دراستك بفعالية',
                        icon: 'ph-timer'
                    },
                    {
                        selector: 'button[data-modal="settings-modal"]',
                        title: 'الإعدادات',
                        description: 'خصص تجربتك في المنصة',
                        icon: 'ph-gear-six'
                    },
                    {
                        selector: '#account-options-btn',
                        title: 'حسابي',
                        description: 'إدارة حسابك الشخصي',
                        icon: 'ph-user-circle'
                    }
                ];
            }

            shouldShowTour() {
                try {
                    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                    if (!currentUser.id) return false;

                    const tourKey = `hasCompletedOnboarding_${currentUser.id}`;
                    const hasCompleted = localStorage.getItem(tourKey);
                    return !hasCompleted;
                } catch (e) {
                    console.error('Error checking tour status:', e);
                    return false;
                }
            }

            async startTour() {
                if (this.isActive) return;

                // Wait for page to be fully loaded
                await new Promise(resolve => setTimeout(resolve, 500));

                this.isActive = true;
                this.currentStep = 0;
                this.createOverlay();
                this.showStep(0);
            }

            createOverlay() {
                // Create dark overlay
                this.overlay = document.createElement('div');
                this.overlay.className = 'tour-overlay';
                document.body.appendChild(this.overlay);
            }

            showStep(stepIndex) {
                // Validate step index
                const validSteps = this.tourSteps.filter(step => {
                    const element = document.querySelector(step.selector);
                    return element !== null;
                });

                if (stepIndex >= validSteps.length) {
                    this.completeTour();
                    return;
                }

                const step = validSteps[stepIndex];
                const element = document.querySelector(step.selector);

                if (!element) {
                    // Skip to next step if element not found
                    this.showStep(stepIndex + 1);
                    return;
                }

                // Remove previous highlight
                if (this.currentHighlight) {
                    this.currentHighlight.classList.remove('tour-highlight');
                }

                // Highlight current element
                element.classList.add('tour-highlight');
                this.currentHighlight = element;

                // Scroll element into view
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Create or update tooltip
                this.showTooltip(step, stepIndex, validSteps.length);
            }

            showTooltip(step, stepIndex, totalSteps) {
                // Remove existing tooltip
                if (this.tooltip) {
                    this.tooltip.remove();
                }

                // Create tooltip
                this.tooltip = document.createElement('div');
                this.tooltip.className = 'tour-tooltip';

                const isLastStep = stepIndex === totalSteps - 1;

                this.tooltip.innerHTML = `
                    <div class="tour-tooltip-title">
                        <i class="${step.icon}"></i>
                        <span>${step.title}</span>
                    </div>
                    <div class="tour-tooltip-description">${step.description}</div>
                    <div class="tour-tooltip-counter">${stepIndex + 1} من ${totalSteps}</div>
                    <div class="tour-tooltip-buttons">
                        ${!isLastStep ? '<button class="tour-btn tour-btn-skip">تخطي</button>' : ''}
                        <button class="tour-btn ${isLastStep ? 'tour-btn-ok' : 'tour-btn-next'}">
                            ${isLastStep ? 'موافق ✓' : 'التالي →'}
                        </button>
                    </div>
                `;

                document.body.appendChild(this.tooltip);

                // Position tooltip
                this.positionTooltip();

                // Add event listeners
                const nextBtn = this.tooltip.querySelector('.tour-btn-next, .tour-btn-ok');
                const skipBtn = this.tooltip.querySelector('.tour-btn-skip');

                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        if (isLastStep) {
                            this.completeTour();
                        } else {
                            this.nextStep();
                        }
                    });
                }

                if (skipBtn) {
                    skipBtn.addEventListener('click', () => this.skipTour());
                }
            }

            positionTooltip() {
                if (!this.tooltip || !this.currentHighlight) return;

                const rect = this.currentHighlight.getBoundingClientRect();
                const tooltipRect = this.tooltip.getBoundingClientRect();

                // Try to position above the element
                let top = rect.top - tooltipRect.height - 20;
                let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);

                // If tooltip goes above viewport, position below
                if (top < 20) {
                    top = rect.bottom + 20;
                }

                // Keep tooltip within horizontal bounds
                if (left < 20) {
                    left = 20;
                } else if (left + tooltipRect.width > window.innerWidth - 20) {
                    left = window.innerWidth - tooltipRect.width - 20;
                }

                this.tooltip.style.top = `${top}px`;
                this.tooltip.style.left = `${left}px`;
            }

            nextStep() {
                this.currentStep++;
                this.showStep(this.currentStep);
            }

            skipTour() {
                this.completeTour();
            }

            completeTour() {
                // Save completion state
                try {
                    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                    if (currentUser.id) {
                        const tourKey = `hasCompletedOnboarding_${currentUser.id}`;
                        localStorage.setItem(tourKey, 'true');
                    }
                } catch (e) {
                    console.error('Error saving tour completion:', e);
                }

                // Clean up
                this.isActive = false;

                if (this.currentHighlight) {
                    this.currentHighlight.classList.remove('tour-highlight');
                    this.currentHighlight = null;
                }

                if (this.tooltip) {
                    this.tooltip.remove();
                    this.tooltip = null;
                }

                if (this.overlay) {
                    this.overlay.remove();
                    this.overlay = null;
                }
            }
        }

        // Initialize tour manager
        const tourManager = new OnboardingTourManager();

        // Hook into student dashboard initialization
        const originalShowPage = window.showPage;
        window.showPage = function (pageId) {
            if (originalShowPage) {
                originalShowPage(pageId);
            }

            // Start tour when student dashboard is shown
            if (pageId === 'student-dashboard' && tourManager.shouldShowTour()) {
                setTimeout(() => {
                    tourManager.startTour();
                }, 1000);
            }
        };

        // ==================== OFFLINE FUNCTIONALITY ====================
        class NetworkStatusManager {
            constructor() {
                this.isOnline = navigator.onLine;
                this.init();
            }

            init() {
                // Listen for online/offline events
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    console.log('App is now online');
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    console.log('App is now offline');
                });
            }

            getStatus() {
                return navigator.onLine;
            }
        }

        // Initialize network status manager
        const networkStatus = new NetworkStatusManager();

        // Ensure all navigation works offline by wrapping in fail-safe
        function safeNavigate(callback) {
            try {
                if (typeof callback === 'function') {
                    callback();
                }
            } catch (error) {
                console.error('Navigation error:', error);
                // Don't show error to user, just log it
            }
        }

        // Make showPage fail-safe
        const _originalShowPage = window.showPage;
        window.showPage = function (pageId) {
            try {
                // Hide all pages
                document.querySelectorAll('.page').forEach(p => {
                    p.classList.remove('active');
                    p.style.display = 'none';
                });

                // Show target page
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                    targetPage.style.display = 'flex';
                }

                // Call original if exists
                if (_originalShowPage && _originalShowPage !== window.showPage) {
                    _originalShowPage(pageId);
                }

                // Start tour if needed
                if (pageId === 'student-dashboard' && tourManager.shouldShowTour()) {
                    setTimeout(() => tourManager.startTour(), 1000);
                }
            } catch (error) {
                console.error('Error in showPage:', error);
                // Fallback: at least try to show the page
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.style.display = 'flex';
                }
            }
        };

        // Ensure exam exit button works offline
        document.addEventListener('click', function (e) {
            // Check if click is on exam exit button
            const exitBtn = e.target.closest('button[onclick*="exitExam"], button[onclick*="goBack"], .modal-close-btn');
            if (exitBtn) {
                // Ensure it works even offline
                e.stopPropagation();
                // The onclick handler will execute normally
            }
        }, true);

        // ==================== ADMIN DELETE ALL STUDENTS ====================
        window.deleteAllStudentsInSection = async function () {
            try {
                // Get current filter values
                const yearSelect = document.getElementById('admin-year-filter');
                const divisionSelect = document.getElementById('admin-division-filter');

                if (!yearSelect || !divisionSelect) {
                    showToast('لم يتم العثور على عناصر التصفية', true);
                    return;
                }

                const year = yearSelect.value;
                const division = divisionSelect.value;

                if (!year || !division) {
                    showToast('الرجاء اختيار الفرقة والشعبة أولاً', true);
                    return;
                }

                // Show confirmation dialog
                const confirmed = confirm(
                    `⚠️ تحذير: هل أنت متأكد من حذف جميع الطلاب في:\n\n` +
                    `الفرقة: ${year === '2' ? 'الثانية' : year}\n` +
                    `الشعبة: ${division === 'international' ? 'أعمال دولية' : 'نظم معلومات'}\n\n` +
                    `هذا الإجراء لا يمكن التراجع عنه!`
                );

                if (!confirmed) return;

                // Double confirmation for safety
                const doubleConfirm = confirm('تأكيد نهائي: هل أنت متأكد تماماً من الحذف؟');
                if (!doubleConfirm) return;

                // Get all students
                const studentsSnapshot = await getDocs(collection(db, 'students'));
                let deletedCount = 0;

                // Delete students matching the filter
                const deletePromises = [];
                studentsSnapshot.forEach(docSnapshot => {
                    const student = docSnapshot.data();
                    if (student.year === year && student.division === division) {
                        deletePromises.push(deleteDoc(doc(db, 'students', docSnapshot.id)));
                        deletedCount++;
                    }
                });

                if (deletedCount === 0) {
                    showToast('لا يوجد طلاب في هذا القسم', false);
                    return;
                }

                // Execute all deletions
                await Promise.all(deletePromises);

                showToast(`تم حذف ${deletedCount} طالب بنجاح`, false);

                // Refresh the students list
                if (typeof displayAdminStudents === 'function') {
                    displayAdminStudents();
                }

                // Update student count
                if (typeof updateAdminCounts === 'function') {
                    updateAdminCounts();
                }

            } catch (error) {
                console.error('Error deleting students:', error);
                showToast('حدث خطأ أثناء الحذف: ' + error.message, true);
            }
        };

        // Add delete button to students panel
        function addDeleteAllButton() {
            const studentsPanel = document.getElementById('students-panel');
            if (!studentsPanel) return;

            // Check if button already exists
            if (document.getElementById('delete-all-students-btn')) return;

            // Create filter section if it doesn't exist
            let filterSection = studentsPanel.querySelector('.admin-students-filters');
            if (!filterSection) {
                filterSection = document.createElement('div');
                filterSection.className = 'admin-students-filters glass-effect p-4 rounded-lg mb-6';
                filterSection.innerHTML = `
                    <h3 class="text-lg font-bold mb-4">تصفية الطلاب</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <select id="admin-year-filter" class="rounded-lg select-field appearance-none">
                            <option value="">كل الفرق</option>
                            <option value="2">الثانية</option>
                        </select>
                        <select id="admin-division-filter" class="rounded-lg select-field appearance-none">
                            <option value="">كل الشعب</option>
                            <option value="international">أعمال دولية</option>
                            <option value="systems">نظم معلومات</option>
                        </select>
                        <button id="delete-all-students-btn" 
                                onclick="deleteAllStudentsInSection()"
                                class="py-2 px-4 rounded-lg font-bold bg-red-600 text-white hover:bg-red-500 transition shadow-lg shadow-red-500/20">
                            🗑️ حذف جميع الطلاب في هذا القسم
                        </button>
                    </div>
                `;

                const title = studentsPanel.querySelector('h2');
                if (title) {
                    title.after(filterSection);
                }
            }
        }

        // Add button when admin panel loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(addDeleteAllButton, 1000);
        });

        // Also add when students panel is shown
        const adminNavButtons = document.querySelectorAll('[data-panel="students-panel"]');
        adminNavButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                setTimeout(addDeleteAllButton, 500);
            });
        });

        // ==================== INSTANT LOGOUT SYSTEM ====================
        /**
         * Instant Logout Function - Works offline & online
         * Response time: < 50ms
         * Clears all storage and redirects immediately
         */
        window.instantLogout = function () {
            const startTime = performance.now();

            try {
                // 1. Clear localStorage immediately
                localStorage.clear();

                // 2. Clear sessionStorage
                sessionStorage.clear();

                // 3. Clear IndexedDB (non-blocking)
                if ('indexedDB' in window) {
                    indexedDB.databases().then(dbs => {
                        dbs.forEach(db => {
                            try {
                                indexedDB.deleteDatabase(db.name);
                            } catch (e) {
                                // Ignore errors
                            }
                        });
                    }).catch(() => { });
                }

                // 4. Clear all cookies
                document.cookie.split(";").forEach(c => {
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                });

                // 5. Background API call (non-blocking) - only if online
                if (navigator.onLine && currentUser?.id) {
                    // Use keepalive to ensure request completes even after page unload
                    fetch('/api/logout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: currentUser.id }),
                        keepalive: true
                    }).catch(() => { }); // Ignore errors
                }

                const endTime = performance.now();
                console.log(`Logout completed in ${(endTime - startTime).toFixed(2)}ms`);

                // 6. Redirect immediately
                window.location.href = window.location.origin + window.location.pathname;

            } catch (error) {
                console.error('Logout error:', error);
                // Force redirect even if error occurs
                window.location.href = window.location.origin + window.location.pathname;
            }
        };

        // Alias for backward compatibility
        window.handleLogout = window.instantLogout;

        // ==================== SERVICE WORKER FOR OFFLINE SUPPORT ====================
        if ('serviceWorker' in navigator) {
            // Inline Service Worker using Blob
            const swCode = `
                const CACHE_NAME = 'mora-v1';
                const urlsToCache = [
                    '/',
                    '/index.html'
                ];
                
                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => cache.addAll(urlsToCache))
                            .catch(err => console.log('Cache error:', err))
                    );
                });
                
                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => {
                                if (response) {
                                    return response;
                                }
                                return fetch(event.request).catch(() => {
                                    // Return offline page if available
                                    return caches.match('/');
                                });
                            })
                    );
                });
                
                self.addEventListener('activate', event => {
                    event.waitUntil(
                        caches.keys().then(cacheNames => {
                            return Promise.all(
                                cacheNames.map(cacheName => {
                                    if (cacheName !== CACHE_NAME) {
                                        return caches.delete(cacheName);
                                    }
                                })
                            );
                        })
                    );
                });
            `;

            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);

            navigator.serviceWorker.register(swUrl)
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('SW registration failed:', err));
        }

        // ==================== SECURITY IMPROVEMENTS ====================

        /**
         * XSS Protection - Sanitize HTML
         */
        window.sanitizeHTML = function (str) {
            if (!str) return '';
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        };

        /**
         * CSRF Token Generation
         */
        window.generateCSRFToken = function () {
            const token = Array.from(crypto.getRandomValues(new Uint8Array(32)))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
            sessionStorage.setItem('csrf_token', token);
            return token;
        };

        /**
         * Encrypt sensitive data before storing
         */
        window.encryptData = function (data) {
            try {
                return btoa(JSON.stringify(data));
            } catch (e) {
                return data;
            }
        };

        /**
         * Decrypt sensitive data
         */
        window.decryptData = function (data) {
            try {
                return JSON.parse(atob(data));
            } catch (e) {
                return data;
            }
        };

        // ==================== PERFORMANCE OPTIMIZATIONS ====================

        /**
         * Debounce function for performance
         */
        window.debounce = function (func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        /**
         * Throttle function for performance
         */
        window.throttle = function (func, limit) {
            let inThrottle;
            return function (...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        };

        /**
         * Lazy load images
         */
        window.lazyLoadImages = function () {
            const images = document.querySelectorAll('img[data-src]');
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                        observer.unobserve(img);
                    }
                });
            });

            images.forEach(img => imageObserver.observe(img));
        };

        // ==================== ERROR HANDLING ====================

        /**
         * Global error handler
         */
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            // Log to analytics if available
            if (window.gtag) {
                gtag('event', 'exception', {
                    description: e.error?.message || 'Unknown error',
                    fatal: false
                });
            }
            return true; // Prevent default error handling
        });

        /**
         * Unhandled promise rejection handler
         */
        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled promise rejection:', e.reason);
            // Log to analytics if available
            if (window.gtag) {
                gtag('event', 'exception', {
                    description: e.reason?.message || 'Promise rejection',
                    fatal: false
                });
            }
        });

        // ==================== SITEMAP GENERATOR ====================

        /**
         * Generate sitemap.xml dynamically
         */
        window.generateSitemap = function () {
            const baseUrl = window.location.origin;
            const urls = [
                { loc: '/', priority: '1.0' },
                { loc: '/student', priority: '0.8' },
                { loc: '/admin', priority: '0.5' }
            ];

            const xml = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
${urls.map(url => `    <url>
        <loc>${baseUrl}${url.loc}</loc>
        <priority>${url.priority}</priority>
        <changefreq>weekly</changefreq>
    </url>`).join('\n')}
</urlset>`;

            return xml;
        };

        // ==================== ROBOTS.TXT GENERATOR ====================

        /**
         * Generate robots.txt content
         */
        window.generateRobotsTxt = function () {
            const baseUrl = window.location.origin;
            return `User-agent: *
Allow: /

Sitemap: ${baseUrl}/sitemap.xml`;
        };

        // ==================== INITIALIZATION ====================

        // Initialize lazy loading
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', lazyLoadImages);
        } else {
            lazyLoadImages();
        }

        // Generate CSRF token on page load
        if (!sessionStorage.getItem('csrf_token')) {
            generateCSRFToken();
        }

        console.log('✅ Onboarding Tour, Offline Support, and Admin Features Loaded Successfully');
    </script>

    <audio id="timer-start-sound" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.m4a"
        preload="auto"></audio>
    <audio id="timer-ticking-sound" src="https://assets.mixkit.co/active_storage/sfx/3003/3003-preview.m4a" loop
        preload="auto"></audio>
    <audio id="timer-end-sound" src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.m4a"
        preload="auto"></audio>
    <!-- Alphanumeric CAPTCHA Modal Overlay -->
    <div id="captcha-modal-overlay" class="captcha-modal-overlay">
        <div id="captcha-modal-card" class="captcha-modal-card"
            style="padding: 24px; border-radius: 20px; text-align: center; border: 1px solid #4a90e2; background: #0f172a;">
            <div class="captcha-header-v2 mb-6">
                <i class="ph-shield-check text-5xl text-[#4a90e2] mb-2"></i>
                <h3 class="text-xl font-bold text-white">تحقق أمني</h3>
                <p class="text-sm text-slate-400">يرجى كتابة الرمز الظاهر بالأسفل</p>
            </div>

            <div
                class="captcha-display-box mb-6 p-6 rounded-xl bg-white/5 border border-white/10 relative overflow-hidden group">
                <div
                    class="absolute inset-0 bg-gradient-to-r from-blue-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                </div>
                <div id="captcha-display-text"
                    class="text-4xl font-black text-white tracking-[0.4em] select-none italic"
                    style="text-shadow: 0 0 15px rgba(74, 144, 226, 0.5); font-family: 'Courier New', Courier, monospace;">
                    ...</div>
            </div>

            <input id="captcha-input-field" type="text" placeholder="اكتب الرمز هنا..." maxlength="5"
                class="w-full bg-white/10 border border-white/10 rounded-xl p-4 text-center text-xl font-bold text-white mb-6 outline-none focus:border-[#4a90e2] transition-colors"
                autocomplete="off">

            <div class="flex gap-4">
                <button id="captcha-refresh-btn"
                    class="flex-1 py-3 rounded-xl bg-white/5 border border-white/10 text-white font-bold hover:bg-white/10 transition-colors flex items-center justify-center gap-2">
                    <i class="ph-arrows-clockwise"></i> رمز جديد
                </button>
                <button id="captcha-verify-btn"
                    class="flex-[2] py-3 rounded-xl bg-[#4a90e2] text-white font-bold shadow-lg shadow-blue-500/20 hover:scale-[1.02] active:scale-95 transition-all">تحقق
                    الآن</button>
            </div>
        </div>
    </div>


</body>

</html>